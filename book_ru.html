<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
    "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
<meta http-equiv="Content-Type" content="application/xhtml+xml; charset=UTF-8" />
<meta name="generator" content="AsciiDoc 9.0.4" />
<title>Паттерны архитектуры и Python</title>
<style type="text/css">
/* Shared CSS for AsciiDoc xhtml11 and html5 backends */

/* Default font. */
body {
  font-family: Georgia,serif;
}

/* Title font. */
h1, h2, h3, h4, h5, h6,
div.title, caption.title,
thead, p.table.header,
#toctitle,
#author, #revnumber, #revdate, #revremark,
#footer {
  font-family: Arial,Helvetica,sans-serif;
}

body {
  margin: 1em 5% 1em 5%;
}

a {
  color: blue;
  text-decoration: underline;
}
a:visited {
  color: fuchsia;
}

em {
  font-style: italic;
  color: navy;
}

strong {
  font-weight: bold;
  color: #083194;
}

h1, h2, h3, h4, h5, h6 {
  color: #527bbd;
  margin-top: 1.2em;
  margin-bottom: 0.5em;
  line-height: 1.3;
}

h1, h2, h3 {
  border-bottom: 2px solid silver;
}
h2 {
  padding-top: 0.5em;
}
h3 {
  float: left;
}
h3 + * {
  clear: left;
}
h5 {
  font-size: 1.0em;
}

div.sectionbody {
  margin-left: 0;
}

hr {
  border: 1px solid silver;
}

p {
  margin-top: 0.5em;
  margin-bottom: 0.5em;
}

ul, ol, li > p {
  margin-top: 0;
}
ul > li     { color: #aaa; }
ul > li > * { color: black; }

.monospaced, code, pre {
  font-family: "Courier New", Courier, monospace;
  font-size: inherit;
  color: navy;
  padding: 0;
  margin: 0;
}
pre {
  white-space: pre-wrap;
}

#author {
  color: #527bbd;
  font-weight: bold;
  font-size: 1.1em;
}
#email {
}
#revnumber, #revdate, #revremark {
}

#footer {
  font-size: small;
  border-top: 2px solid silver;
  padding-top: 0.5em;
  margin-top: 4.0em;
}
#footer-text {
  float: left;
  padding-bottom: 0.5em;
}
#footer-badges {
  float: right;
  padding-bottom: 0.5em;
}

#preamble {
  margin-top: 1.5em;
  margin-bottom: 1.5em;
}
div.imageblock, div.exampleblock, div.verseblock,
div.quoteblock, div.literalblock, div.listingblock, div.sidebarblock,
div.admonitionblock {
  margin-top: 1.0em;
  margin-bottom: 1.5em;
}
div.admonitionblock {
  margin-top: 2.0em;
  margin-bottom: 2.0em;
  margin-right: 10%;
  color: #606060;
}

div.content { /* Block element content. */
  padding: 0;
}

/* Block element titles. */
div.title, caption.title {
  color: #527bbd;
  font-weight: bold;
  text-align: left;
  margin-top: 1.0em;
  margin-bottom: 0.5em;
}
div.title + * {
  margin-top: 0;
}

td div.title:first-child {
  margin-top: 0.0em;
}
div.content div.title:first-child {
  margin-top: 0.0em;
}
div.content + div.title {
  margin-top: 0.0em;
}

div.sidebarblock > div.content {
  background: #ffffee;
  border: 1px solid #dddddd;
  border-left: 4px solid #f0f0f0;
  padding: 0.5em;
}

div.listingblock > div.content {
  border: 1px solid #dddddd;
  border-left: 5px solid #f0f0f0;
  background: #f8f8f8;
  padding: 0.5em;
}

div.quoteblock, div.verseblock {
  padding-left: 1.0em;
  margin-left: 1.0em;
  margin-right: 10%;
  border-left: 5px solid #f0f0f0;
  color: #888;
}

div.quoteblock > div.attribution {
  padding-top: 0.5em;
  text-align: right;
}

div.verseblock > pre.content {
  font-family: inherit;
  font-size: inherit;
}
div.verseblock > div.attribution {
  padding-top: 0.75em;
  text-align: left;
}
/* DEPRECATED: Pre version 8.2.7 verse style literal block. */
div.verseblock + div.attribution {
  text-align: left;
}

div.admonitionblock .icon {
  vertical-align: top;
  font-size: 1.1em;
  font-weight: bold;
  text-decoration: underline;
  color: #527bbd;
  padding-right: 0.5em;
}
div.admonitionblock td.content {
  padding-left: 0.5em;
  border-left: 3px solid #dddddd;
}

div.exampleblock > div.content {
  border-left: 3px solid #dddddd;
  padding-left: 0.5em;
}

div.imageblock div.content { padding-left: 0; }
span.image img { border-style: none; vertical-align: text-bottom; }
a.image:visited { color: white; }

dl {
  margin-top: 0.8em;
  margin-bottom: 0.8em;
}
dt {
  margin-top: 0.5em;
  margin-bottom: 0;
  font-style: normal;
  color: navy;
}
dd > *:first-child {
  margin-top: 0.1em;
}

ul, ol {
    list-style-position: outside;
}
ol.arabic {
  list-style-type: decimal;
}
ol.loweralpha {
  list-style-type: lower-alpha;
}
ol.upperalpha {
  list-style-type: upper-alpha;
}
ol.lowerroman {
  list-style-type: lower-roman;
}
ol.upperroman {
  list-style-type: upper-roman;
}

div.compact ul, div.compact ol,
div.compact p, div.compact p,
div.compact div, div.compact div {
  margin-top: 0.1em;
  margin-bottom: 0.1em;
}

tfoot {
  font-weight: bold;
}
td > div.verse {
  white-space: pre;
}

div.hdlist {
  margin-top: 0.8em;
  margin-bottom: 0.8em;
}
div.hdlist tr {
  padding-bottom: 15px;
}
dt.hdlist1.strong, td.hdlist1.strong {
  font-weight: bold;
}
td.hdlist1 {
  vertical-align: top;
  font-style: normal;
  padding-right: 0.8em;
  color: navy;
}
td.hdlist2 {
  vertical-align: top;
}
div.hdlist.compact tr {
  margin: 0;
  padding-bottom: 0;
}

.comment {
  background: yellow;
}

.footnote, .footnoteref {
  font-size: 0.8em;
}

span.footnote, span.footnoteref {
  vertical-align: super;
}

#footnotes {
  margin: 20px 0 20px 0;
  padding: 7px 0 0 0;
}

#footnotes div.footnote {
  margin: 0 0 5px 0;
}

#footnotes hr {
  border: none;
  border-top: 1px solid silver;
  height: 1px;
  text-align: left;
  margin-left: 0;
  width: 20%;
  min-width: 100px;
}

div.colist td {
  padding-right: 0.5em;
  padding-bottom: 0.3em;
  vertical-align: top;
}
div.colist td img {
  margin-top: 0.3em;
}

@media print {
  #footer-badges { display: none; }
}

#toc {
  margin-bottom: 2.5em;
}

#toctitle {
  color: #527bbd;
  font-size: 1.1em;
  font-weight: bold;
  margin-top: 1.0em;
  margin-bottom: 0.1em;
}

div.toclevel0, div.toclevel1, div.toclevel2, div.toclevel3, div.toclevel4 {
  margin-top: 0;
  margin-bottom: 0;
}
div.toclevel2 {
  margin-left: 2em;
  font-size: 0.9em;
}
div.toclevel3 {
  margin-left: 4em;
  font-size: 0.9em;
}
div.toclevel4 {
  margin-left: 6em;
  font-size: 0.9em;
}

span.aqua { color: aqua; }
span.black { color: black; }
span.blue { color: blue; }
span.fuchsia { color: fuchsia; }
span.gray { color: gray; }
span.green { color: green; }
span.lime { color: lime; }
span.maroon { color: maroon; }
span.navy { color: navy; }
span.olive { color: olive; }
span.purple { color: purple; }
span.red { color: red; }
span.silver { color: silver; }
span.teal { color: teal; }
span.white { color: white; }
span.yellow { color: yellow; }

span.aqua-background { background: aqua; }
span.black-background { background: black; }
span.blue-background { background: blue; }
span.fuchsia-background { background: fuchsia; }
span.gray-background { background: gray; }
span.green-background { background: green; }
span.lime-background { background: lime; }
span.maroon-background { background: maroon; }
span.navy-background { background: navy; }
span.olive-background { background: olive; }
span.purple-background { background: purple; }
span.red-background { background: red; }
span.silver-background { background: silver; }
span.teal-background { background: teal; }
span.white-background { background: white; }
span.yellow-background { background: yellow; }

span.big { font-size: 2em; }
span.small { font-size: 0.6em; }

span.underline { text-decoration: underline; }
span.overline { text-decoration: overline; }
span.line-through { text-decoration: line-through; }

div.unbreakable { page-break-inside: avoid; }


/*
 * xhtml11 specific
 *
 * */

div.tableblock {
  margin-top: 1.0em;
  margin-bottom: 1.5em;
}
div.tableblock > table {
  border: 3px solid #527bbd;
}
thead, p.table.header {
  font-weight: bold;
  color: #527bbd;
}
p.table {
  margin-top: 0;
}
/* Because the table frame attribute is overridden by CSS in most browsers. */
div.tableblock > table[frame="void"] {
  border-style: none;
}
div.tableblock > table[frame="hsides"] {
  border-left-style: none;
  border-right-style: none;
}
div.tableblock > table[frame="vsides"] {
  border-top-style: none;
  border-bottom-style: none;
}


/*
 * html5 specific
 *
 * */

table.tableblock {
  margin-top: 1.0em;
  margin-bottom: 1.5em;
}
thead, p.tableblock.header {
  font-weight: bold;
  color: #527bbd;
}
p.tableblock {
  margin-top: 0;
}
table.tableblock {
  border-width: 3px;
  border-spacing: 0px;
  border-style: solid;
  border-color: #527bbd;
  border-collapse: collapse;
}
th.tableblock, td.tableblock {
  border-width: 1px;
  padding: 4px;
  border-style: solid;
  border-color: #527bbd;
}

table.tableblock.frame-topbot {
  border-left-style: hidden;
  border-right-style: hidden;
}
table.tableblock.frame-sides {
  border-top-style: hidden;
  border-bottom-style: hidden;
}
table.tableblock.frame-none {
  border-style: hidden;
}

th.tableblock.halign-left, td.tableblock.halign-left {
  text-align: left;
}
th.tableblock.halign-center, td.tableblock.halign-center {
  text-align: center;
}
th.tableblock.halign-right, td.tableblock.halign-right {
  text-align: right;
}

th.tableblock.valign-top, td.tableblock.valign-top {
  vertical-align: top;
}
th.tableblock.valign-middle, td.tableblock.valign-middle {
  vertical-align: middle;
}
th.tableblock.valign-bottom, td.tableblock.valign-bottom {
  vertical-align: bottom;
}


/*
 * manpage specific
 *
 * */

body.manpage h1 {
  padding-top: 0.5em;
  padding-bottom: 0.5em;
  border-top: 2px solid silver;
  border-bottom: 2px solid silver;
}
body.manpage h2 {
  border-style: none;
}
body.manpage div.sectionbody {
  margin-left: 3em;
}

@media print {
  body.manpage div#toc { display: none; }
}
.highlight .hll { background-color: #ffffcc }
.highlight  { background: #f8f8f8; }
.highlight .c { color: #408080; font-style: italic } /* Comment */
.highlight .err { border: 1px solid #FF0000 } /* Error */
.highlight .k { color: #008000; font-weight: bold } /* Keyword */
.highlight .o { color: #666666 } /* Operator */
.highlight .cm { color: #408080; font-style: italic } /* Comment.Multiline */
.highlight .cp { color: #BC7A00 } /* Comment.Preproc */
.highlight .c1 { color: #408080; font-style: italic } /* Comment.Single */
.highlight .cs { color: #408080; font-style: italic } /* Comment.Special */
.highlight .gd { color: #A00000 } /* Generic.Deleted */
.highlight .ge { font-style: italic } /* Generic.Emph */
.highlight .gr { color: #FF0000 } /* Generic.Error */
.highlight .gh { color: #000080; font-weight: bold } /* Generic.Heading */
.highlight .gi { color: #00A000 } /* Generic.Inserted */
.highlight .go { color: #808080 } /* Generic.Output */
.highlight .gp { color: #000080; font-weight: bold } /* Generic.Prompt */
.highlight .gs { font-weight: bold } /* Generic.Strong */
.highlight .gu { color: #800080; font-weight: bold } /* Generic.Subheading */
.highlight .gt { color: #0040D0 } /* Generic.Traceback */
.highlight .kc { color: #008000; font-weight: bold } /* Keyword.Constant */
.highlight .kd { color: #008000; font-weight: bold } /* Keyword.Declaration */
.highlight .kn { color: #008000; font-weight: bold } /* Keyword.Namespace */
.highlight .kp { color: #008000 } /* Keyword.Pseudo */
.highlight .kr { color: #008000; font-weight: bold } /* Keyword.Reserved */
.highlight .kt { color: #B00040 } /* Keyword.Type */
.highlight .m { color: #666666 } /* Literal.Number */
.highlight .s { color: #BA2121 } /* Literal.String */
.highlight .na { color: #7D9029 } /* Name.Attribute */
.highlight .nb { color: #008000 } /* Name.Builtin */
.highlight .nc { color: #0000FF; font-weight: bold } /* Name.Class */
.highlight .no { color: #880000 } /* Name.Constant */
.highlight .nd { color: #AA22FF } /* Name.Decorator */
.highlight .ni { color: #999999; font-weight: bold } /* Name.Entity */
.highlight .ne { color: #D2413A; font-weight: bold } /* Name.Exception */
.highlight .nf { color: #0000FF } /* Name.Function */
.highlight .nl { color: #A0A000 } /* Name.Label */
.highlight .nn { color: #0000FF; font-weight: bold } /* Name.Namespace */
.highlight .nt { color: #008000; font-weight: bold } /* Name.Tag */
.highlight .nv { color: #19177C } /* Name.Variable */
.highlight .ow { color: #AA22FF; font-weight: bold } /* Operator.Word */
.highlight .w { color: #bbbbbb } /* Text.Whitespace */
.highlight .mf { color: #666666 } /* Literal.Number.Float */
.highlight .mh { color: #666666 } /* Literal.Number.Hex */
.highlight .mi { color: #666666 } /* Literal.Number.Integer */
.highlight .mo { color: #666666 } /* Literal.Number.Oct */
.highlight .sb { color: #BA2121 } /* Literal.String.Backtick */
.highlight .sc { color: #BA2121 } /* Literal.String.Char */
.highlight .sd { color: #BA2121; font-style: italic } /* Literal.String.Doc */
.highlight .s2 { color: #BA2121 } /* Literal.String.Double */
.highlight .se { color: #BB6622; font-weight: bold } /* Literal.String.Escape */
.highlight .sh { color: #BA2121 } /* Literal.String.Heredoc */
.highlight .si { color: #BB6688; font-weight: bold } /* Literal.String.Interpol */
.highlight .sx { color: #008000 } /* Literal.String.Other */
.highlight .sr { color: #BB6688 } /* Literal.String.Regex */
.highlight .s1 { color: #BA2121 } /* Literal.String.Single */
.highlight .ss { color: #19177C } /* Literal.String.Symbol */
.highlight .bp { color: #008000 } /* Name.Builtin.Pseudo */
.highlight .vc { color: #19177C } /* Name.Variable.Class */
.highlight .vg { color: #19177C } /* Name.Variable.Global */
.highlight .vi { color: #19177C } /* Name.Variable.Instance */
.highlight .il { color: #666666 } /* Literal.Number.Integer.Long */


/* Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */

@import url("//fonts.googleapis.com/css?family=Noto+Sans:300,600italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700");
@import url(//asciidoctor.org/stylesheets/asciidoctor.css); /* Default asciidoc style framework - important */

/* customisations by harry */

h1, h2, h3, h4, h5, h6 {
    position: relative;
}

a.anchor {
    top: 0;
}

/* hide inline ditaa/plantuml source listings for images */
.image-source {
    display: none
}
/* make formal codeblocks a bit nicer */
.exampleblock > .content {
    padding: 2px;
    background-color: white;
    border: 0;
    margin-bottom: 2em;
}
.exampleblock .title {
    text-align: right;
}

/* prev/next chapter links at bottom of page */
.prev_and_next_chapter_links {
    margin: 10px;
}
.prev_chapter_link {
    float: left;
}
.next_chapter_link {
    float: right;
}


/* a few tweaks to existing styles */
#toc li {
    margin-top: 0.5em;
}

#footnotes hr {
    width: 100%;
}

/* end customisations by harry */


/* CUSTOMISATIONS */

/* Change the values in root for quick customisation. If you want even more fine grain... venture further. */

:root{
--maincolor:#FFFFFF;
--primarycolor:#2c3e50;
--secondarycolor:#ba3925;
--tertiarycolor: #186d7a;
--sidebarbackground:#CCC;
--linkcolor:#b71c1c;
--linkcoloralternate:#f44336;
--white:#FFFFFF;
--black:#000000;
}

/* Text styles */
h1{color:var(--primarycolor) !important;}

h2,h3,h4,h5,h6{color:var(--secondarycolor) !important;}

.title{color:var(--tertiarycolor) !important; font-family:"Noto Sans",sans-serif !important;font-style: normal !important; font-weight: normal !important;}
p{font-family: "Noto Sans",sans-serif !important}

/* Table styles */
th{font-family: "Noto Sans",sans-serif !important}

/* Responsiveness fixes */
video {
  max-width: 100%;
}

@media all and (max-width: 600px) {
table {
  width: 55vw!important;
  font-size: 3vw;
}
</style>
<script type="text/javascript">
/*<![CDATA[*/
var asciidoc = {  // Namespace.

/////////////////////////////////////////////////////////////////////
// Table Of Contents generator
/////////////////////////////////////////////////////////////////////

/* Author: Mihai Bazon, September 2002
 * http://students.infoiasi.ro/~mishoo
 *
 * Table Of Content generator
 * Version: 0.4
 *
 * Feel free to use this script under the terms of the GNU General Public
 * License, as long as you do not remove or alter this notice.
 */

 /* modified by Troy D. Hanson, September 2006. License: GPL */
 /* modified by Stuart Rackham, 2006, 2009. License: GPL */

// toclevels = 1..4.
toc: function (toclevels) {

  function getText(el) {
    var text = "";
    for (var i = el.firstChild; i != null; i = i.nextSibling) {
      if (i.nodeType == 3 /* Node.TEXT_NODE */) // IE doesn't speak constants.
        text += i.data;
      else if (i.firstChild != null)
        text += getText(i);
    }
    return text;
  }

  function TocEntry(el, text, toclevel) {
    this.element = el;
    this.text = text;
    this.toclevel = toclevel;
  }

  function tocEntries(el, toclevels) {
    var result = new Array;
    var re = new RegExp('[hH]([1-'+(toclevels+1)+'])');
    // Function that scans the DOM tree for header elements (the DOM2
    // nodeIterator API would be a better technique but not supported by all
    // browsers).
    var iterate = function (el) {
      for (var i = el.firstChild; i != null; i = i.nextSibling) {
        if (i.nodeType == 1 /* Node.ELEMENT_NODE */) {
          var mo = re.exec(i.tagName);
          if (mo && (i.getAttribute("class") || i.getAttribute("className")) != "float") {
            result[result.length] = new TocEntry(i, getText(i), mo[1]-1);
          }
          iterate(i);
        }
      }
    }
    iterate(el);
    return result;
  }

  var toc = document.getElementById("toc");
  if (!toc) {
    return;
  }

  // Delete existing TOC entries in case we're reloading the TOC.
  var tocEntriesToRemove = [];
  var i;
  for (i = 0; i < toc.childNodes.length; i++) {
    var entry = toc.childNodes[i];
    if (entry.nodeName.toLowerCase() == 'div'
     && entry.getAttribute("class")
     && entry.getAttribute("class").match(/^toclevel/))
      tocEntriesToRemove.push(entry);
  }
  for (i = 0; i < tocEntriesToRemove.length; i++) {
    toc.removeChild(tocEntriesToRemove[i]);
  }

  // Rebuild TOC entries.
  var entries = tocEntries(document.getElementById("content"), toclevels);
  for (var i = 0; i < entries.length; ++i) {
    var entry = entries[i];
    if (entry.element.id == "")
      entry.element.id = "_toc_" + i;
    var a = document.createElement("a");
    a.href = "#" + entry.element.id;
    a.appendChild(document.createTextNode(entry.text));
    var div = document.createElement("div");
    div.appendChild(a);
    div.className = "toclevel" + entry.toclevel;
    toc.appendChild(div);
  }
  if (entries.length == 0)
    toc.parentNode.removeChild(toc);
},


/////////////////////////////////////////////////////////////////////
// Footnotes generator
/////////////////////////////////////////////////////////////////////

/* Based on footnote generation code from:
 * http://www.brandspankingnew.net/archive/2005/07/format_footnote.html
 */

footnotes: function () {
  // Delete existing footnote entries in case we're reloading the footnodes.
  var i;
  var noteholder = document.getElementById("footnotes");
  if (!noteholder) {
    return;
  }
  var entriesToRemove = [];
  for (i = 0; i < noteholder.childNodes.length; i++) {
    var entry = noteholder.childNodes[i];
    if (entry.nodeName.toLowerCase() == 'div' && entry.getAttribute("class") == "footnote")
      entriesToRemove.push(entry);
  }
  for (i = 0; i < entriesToRemove.length; i++) {
    noteholder.removeChild(entriesToRemove[i]);
  }

  // Rebuild footnote entries.
  var cont = document.getElementById("content");
  var spans = cont.getElementsByTagName("span");
  var refs = {};
  var n = 0;
  for (i=0; i<spans.length; i++) {
    if (spans[i].className == "footnote") {
      n++;
      var note = spans[i].getAttribute("data-note");
      if (!note) {
        // Use [\s\S] in place of . so multi-line matches work.
        // Because JavaScript has no s (dotall) regex flag.
        note = spans[i].innerHTML.match(/\s*\[([\s\S]*)]\s*/)[1];
        spans[i].innerHTML =
          "[<a id='_footnoteref_" + n + "' href='#_footnote_" + n +
          "' title='View footnote' class='footnote'>" + n + "</a>]";
        spans[i].setAttribute("data-note", note);
      }
      noteholder.innerHTML +=
        "<div class='footnote' id='_footnote_" + n + "'>" +
        "<a href='#_footnoteref_" + n + "' title='Return to text'>" +
        n + "</a>. " + note + "</div>";
      var id =spans[i].getAttribute("id");
      if (id != null) refs["#"+id] = n;
    }
  }
  if (n == 0)
    noteholder.parentNode.removeChild(noteholder);
  else {
    // Process footnoterefs.
    for (i=0; i<spans.length; i++) {
      if (spans[i].className == "footnoteref") {
        var href = spans[i].getElementsByTagName("a")[0].getAttribute("href");
        href = href.match(/#.*/)[0];  // Because IE return full URL.
        n = refs[href];
        spans[i].innerHTML =
          "[<a href='#_footnote_" + n +
          "' title='View footnote' class='footnote'>" + n + "</a>]";
      }
    }
  }
},

install: function(toclevels) {
  var timerId;

  function reinstall() {
    asciidoc.footnotes();
    if (toclevels) {
      asciidoc.toc(toclevels);
    }
  }

  function reinstallAndRemoveTimer() {
    clearInterval(timerId);
    reinstall();
  }

  timerId = setInterval(reinstall, 500);
  if (document.addEventListener)
    document.addEventListener("DOMContentLoaded", reinstallAndRemoveTimer, false);
  else
    window.onload = reinstallAndRemoveTimer;
}

}
asciidoc.install(1);
/*]]>*/
</script>
</head>
<body class="book">
<div id="header">
<h1>Паттерны архитектуры и Python</h1>
<div id="toc">
  <div id="toctitle">Table of Contents</div>
  <noscript><p><b>JavaScript must be enabled in your browser to display the table of contents.</b></p></noscript>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="preface">Предисловие</h2>
<div class="sectionbody">
<div class="paragraph"><p>Возможно, вам интересно, кто мы и почему написали эту книгу.</p></div>
<div class="paragraph"><p>В конце последнего издания книги
<a href="http://www.obeythetestinggoat.com"><em>Test-Driven Development with Python</em></a> (O&#8217;Reilly),
Гарри поймал себя на том, что задает массу вопросов по архитектуре. Например, как лучше всего структурировать ваше приложение, чтобы его было легко тестировать? Имеется ли ввиду, что это про покрытие модульными тестами вашей основной бизнес-логики и что бы количество необходимых вам интеграционных и сквозных тестов было бы минимизировано? Он дал расплывчатые ссылки на «Гексагональную архитектуру», «Порты и адаптеры» и "Functional Core, Imperative Shell", но если бы он был честен, ему пришлось бы признать, что это не то, что он действительно до конца понял, принял или применял на практике.</p></div>
<div class="paragraph"><p>Тут ему посчастливилось столкнуться с Бобом, у которого есть ответы на все эти вопросы.</p></div>
<div class="paragraph"><p>Боб стал архитектором программного обеспечения, потому что никто из его команды этим не занимался. Оказалось, что он неплохо справлялся с этим, но ему посчастливилось столкнуться с Яном Купером, который научил его новым способам написания кода и мышления в этй области.</p></div>
<div class="sect2">
<h3 id="_управление_сложностью_решение_бизнес_задач">Управление Сложностью, Решение Бизнес-Задач</h3>
<div class="paragraph"><p>Мы оба работаем в MADE.com, европейской компании электронной коммерции, которая продает мебель онлайн; там мы применяем методы, описанные в этой книге, для создания распределенных систем, моделирующих реальные бизнес-проблемы. Наш пример домена&#8201;&#8212;&#8201;первая система, созданная Бобом для MADE, и эта книга-попытка записать все то, чему мы должны научить новых программистов, когда они присоединяются к одной из наших команд.</p></div>
<div class="paragraph"><p>MADE.com управляет глобальной цепочкой поставок грузов от тоговых партнеров и производителей. В целях сохранения затрат на нзком уровне, мы стараемся оптимизировать доставку запасов на наши склады, чтобы у нас не было непроданных товаров, застрявших на складах.</p></div>
<div class="paragraph"><p>В идеале диван, который вы хотите купить, прибудет в порт в тот самый день, когда вы решите его купить, и мы отправим его прямо к вам домой, даже не храня. <span class=".keep-together">Получение</span> правильного времени-это сложный балансирующий акт, когда товары прибывают на контейнеровозе в течение трех месяцев. По пути вещи ломаются или повреждаются водой, штормы вызывают неожиданные задержки, логистические партнеры неправильно обращаются с товарами, документы пропадают, клиенты меняют свое мнение и изменяют свои заказы и так далее.</p></div>
<div class="paragraph"><p>Мы решаем эти проблемы, создавая интеллектуальное программное обеспечение, представляющее виды операций, происходящих в реальном мире, чтобы мы могли автоматизировать как можно большую часть бизнеса.</p></div>
</div>
<div class="sect2">
<h3 id="_почему_python">Почему Python?</h3>
<div class="paragraph"><p>Если вы читаете эту книгу, то вероятно, не нужно убеждать вас в том, что Python великолепен, поэтому реальный вопрос заключается в следующем: "Зачем сообществу <em>Python</em> нужна такая книга?" Ответ заключается в популярности и зрелости Python: хотя Python, вероятно, является самым быстрорастущим языком программирования в мире и приближается к вершине абсолютной таблицы популярности, он только начинает решать те проблемы, над которыми мир C# и Java работал в течение многих лет. Стартапы становятся реальным бизнесом; веб-приложения и скриптовые автоматизации становятся (говорю шепотом) <em>enterprise</em> <span class=".keep-together"><em>software</em></span>.</p></div>
<div class="paragraph"><p>В мире Python мы часто цитируем Дзен Python: "Должен существовать один и, желательно, только один очевидный способ сделать это."<span class="footnote"><br />[<code>python -c "import this"</code>]<br /></span> К сожалению, по мере роста размера проекта наиболее очевидный способ решения задач не всегда помогает вам управлять сложностью и меняющимися требованиями.</p></div>
<div class="paragraph"><p>Ни один из методов и шаблонов, которые мы обсуждаем в этой книге, не является новым, но по большей части они являются новыми для мира Python. И эта книга не является заменой классики в этой области, такой как <em>Domain-Driven Design</em> Эрика Эванса или <em>Patterns of Enterprise Application Architecture</em> Мартина Фаулера (оба опубликованы Addison-Wesley <span class=".keep-together">Professional</span>), на которые мы часто ссылаемся и призываем вас пойти и прочитать.</p></div>
<div class="paragraph"><p>Но все классические примеры кода в литературе, как правило, написаны на Java или <span class="keep-together">C++/#</span>, и если вы человек из рядов Python и не использовали ни один из этих языков в течение длительного времени (или вообще никогда), то эти листинги кода могут быть довольно&#8230;трудными. Видимо это и есть причина, по которой последнее издание другого классического текста, Fowler&#8217;s <em>Refactoring</em> (Addison-Wesley Professional), написано в JavaScript.</p></div>
</div>
<div class="sect2 pagebreak-before less_space">
<h3 id="_tdd_ddd_и_event_driven_architecture">TDD, DDD, и Event-Driven Architecture</h3>
<div class="paragraph"><p>В порядке популярности назовём три инструмента для управления сложностью:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
<em>Test-driven development</em> (TDD) Разработка на основе тестов. Помогает нам создавать правильный код и проводить рефакторинг или добавлять новые функции, не опасаясь регресса. Но бывает сложно извлечь максимальную пользу из наших тестов: как сделать так, чтобы они выполнялись как можно быстрее? Чтобы мы получили как можно больше покрытия и обратной связи от быстрых модульных тестов без зависимостей (dependency-free unit tests) и имели минимальное количество более медленных, нестабильных сквозных (end-to-end) тестов?
</p>
</li>
<li>
<p>
<em>Domain-driven design</em> (DDD)  Разработка на основе поведения. Просит нас сосредоточить наши усилия на построении хорошей модели бизнес-сферы, но как мы можем убедиться, чтобы наши модели не были обременены инфраструктурными проблемами и их не было трудно изменить?
</p>
</li>
<li>
<p>
<em>Loose coupling</em> Слабосвязанные (микросервисы), интегрированные через сообщения (иногда называемые <em>reactive microservices</em>), являются хорошо зарекомендовавшим себя решением проблемы управления сложностью в нескольких приложениях или бизнес-доменах. Но не всегда очевидно, как сделать так, чтобы они соответствовали широко распространённым инструментам мира Python-Flask, Django, Celery и так далее.
</p>
</li>
</ol></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note" />
</td>
<td class="content">Не пугайтесь, если вы не работаете с микросервисами (или не заинтересованы в них).  Подавляющее большинство моделей, которые мы обсудим, включая большую часть материалов событийной архитектуры, абсолютно применимы в монолитной архитектуре.</td>
</tr></table>
</div>
<div class="paragraph"><p>Наша цель в этой книге-представить несколько классических архитектурных моделей и показать, как они поддерживают TDD, DDD и event-driven сервисы.  Мы надеемся, что он послужит ориентиром для их реализации в питоническом ключе, и что люди смогут использовать его в качестве первого шага к дальнейшим исследованиям в этой области.</p></div>
</div>
<div class="sect2">
<h3 id="_кому_следует_прочитать_эту_книгу">Кому следует прочитать эту книгу</h3>
<div class="paragraph"><p>Вот несколько мыслей, которые мы предполагаем справедливо сказать о вас, дорогой читатель:</p></div>
<div class="ulist"><ul>
<li>
<p>
Вы были близки к некоторым достаточно сложным приложениям Python.
</p>
</li>
<li>
<p>
Вы видели, а может сами испытали ту боль, которая приходит вместе с попыткой справиться с этой сложностью.
</p>
</li>
<li>
<p>
Вы не обязательно знаете что-либо о DDD или любом из классических шаблонов архитектуры приложений.
</p>
</li>
</ul></div>
<div class="paragraph"><p>Мы структурируем наши исследования архитектурных паттернов вокруг примера приложения, выстраивая его главу за главой. Мы используем TDD на работе, поэтому обычно сначала показываем списки тестов, а затем их реализацию. Если вы не привыкли работать с тестом, сначала это может показаться немного странным, но мы надеемся, что вы скоро привыкнете видеть код "используемым" (то есть снаружи), прежде чем увидите, как он построен внутри.</p></div>
<div class="paragraph"><p>Мы используем некоторые специфические фреймворки и технологии Python, включая Flask, SQLAlchemy и pytest, а также Docker и Redis. Если вы уже знакомы с ними, то это не повредит, но вряд ли это необходимо.  Одной из наших главных целей в этой книге является построение архитектуры, для которой конкретные технологические решения становятся второстепенными деталями реализации.</p></div>
</div>
<div class="sect2">
<h3 id="_краткий_обзор_того_что_будет_дальше">Краткий обзор того, что будет дальше</h3>
<div class="paragraph"><p>Книга разделена на две части; Вот некоторые темы, которые мы рассмотрим, и главы, в которых они живут.</p></div>
<div class="sect3">
<h4 id="_a_data_type_xref_data_xrefstyle_chap_num_title_href_part1_часть1_a"><a data-type="xref" data-xrefstyle="chap-num-title" href="#part1">#Часть1</a></h4>
<div class="dlist"><dl>
<dt class="hdlist1">
Domain modeling и DDD (Chapters <a href="#chapter_01_domain_model">1</a>, <a href="#chapter_02_repository">2</a> и <a href="#chapter_07_aggregate">7</a>)
</dt>
<dd>
<p>
    На каком-то уровне каждый усвоил урок, что сложные бизнес-задачи должны быть отражены в коде, в виде модели предметной области.     Но почему всегда кажется, что это так трудно сделать, не запутавшись в инфраструктурных проблемах, наших веб-фреймворках или чем-то еще?     В первой главе мы даем широкий обзор <em>domain modeling</em> и DDD, а также показываем, как начать работу с моделью, которая не имеет внешних зависимостей и быстрых модульных тестов. Позже мы вернемся к шаблонам DDD, чтобы обсудить, как выбрать правильный агрегат и как этот выбор связан с вопросами целостности данных.
</p>
</dd>
<dt class="hdlist1">
Repository, Service Layer, и Unit of Work patterns (Chapters <a href="#chapter_02_repository">2</a>, <a href="#chapter_04_service_layer">4</a>, и <a href="#chapter_05_high_gear_low_gear">5</a>)
</dt>
<dd>
<p>
    В этих трех главах мы представляем три тесно связанных и взаимно усиливающих друг друга паттерна, которые поддерживают наше стремление сохранить модель свободной от посторонних зависимостей.  Мы выстроим слой абстракции вокруг постоянного хранилища, и уровень сервиса, чтобы определить точки входа в нашу систему и захватить основные варианты использования. Мы покажем, как этот слой позволяет легко создавать тонкие точки входа в нашу систему, будь то API Flask или CLI (Command Line Interface - Интерфейс командной строки).
</p>
</dd>
</dl></div>
<div class="dlist"><dl>
<dt class="hdlist1">
Некоторые соображения о тестировании и абстракциях (Chapter <a href="#chapter_03_abstractions">3</a> и <a href="#chapter_05_high_gear_low_gear">5</a>)
</dt>
<dd>
<p>
    После представления первой абстракции (паттерна Repository) воспользуемся возможностью для общего обсуждения того, как выбирать абстракции и какова их роль в выборе того, как наше программное обеспечение связано друг с другом. После знакомства с шаблоном Service Layer, немного поговорим о построении <em>test pyramid</em> и написании модульных тестов на максимально возможном уровне абстракции.
</p>
</dd>
</dl></div>
</div>
<div class="sect3">
<h4 id="_a_data_type_xref_data_xrefstyle_chap_num_title_href_part2_часть2_a"><a data-type="xref" data-xrefstyle="chap-num-title" href="#part2">#Часть2</a></h4>
<div class="dlist"><dl>
<dt class="hdlist1">
Архитектура, управляемая событиями (Chapters <a href="#chapter_08_events_and_message_bus">8</a>-<a href="#chapter_11_external_events">11</a>)
</dt>
<dd>
<p>
    Мы вводим еще три взаимно усиливающих шаблона: Domain Events, Message Bus, и Handler patterns. События домена (Domain Events)-это средство передачи идеи о том, что некоторые взаимодействия с системой являются триггерами для других. Мы используем шину сообщений <em>Message Bus</em>, чтобы позволить действиям вызывать события и вызывать соответствующие <em>handlers</em> (обработчики).     Мы переходим к обсуждению того, как события могут быть использованы в качестве шаблона для интеграции между службами в архитектуре микросервисов. Наконец, мы различаем команды и события. Наше приложение теперь по сути является системой обработки сообщений.
</p>
</dd>
<dt class="hdlist1">
Разделение ответственности по командам и запросам (<a href="#chapter_12_cqrs">[chapter_12_cqrs]</a>)
</dt>
<dd>
<p>
    Мы приводим пример разделения ответственности команд-запросов с событиями и без событий.
</p>
</dd>
<dt class="hdlist1">
Инъекция зависимостей (<a href="#chapter_13_dependency_injection">[chapter_13_dependency_injection]</a>)
</dt>
<dd>
<p>
    Мы приводим в порядок наши явные и неявные зависимости и реализуем простую структуру внедрения зависимостей.
</p>
</dd>
</dl></div>
</div>
<div class="sect3">
<h4 id="_дополнительный_контент">Дополнительный контент</h4>
<div class="dlist"><dl>
<dt class="hdlist1">
Как мне добраться туда отсюда? (<a href="#epilogue_1_how_to_get_there_from_here">[epilogue_1_how_to_get_there_from_here]</a>)
</dt>
<dd>
<p>
    Реализация архитектурных шаблонов всегда выглядит легко, когда вы показываете простой пример, начиная с нуля, но многие из вас, вероятно, зададутся вопросом, как применить эти принципы к существующему программному обеспечению. Мы дадим несколько указаний в эпилоге и некоторые ссылки для дальнейшего чтения.
</p>
</dd>
</dl></div>
</div>
</div>
<div class="sect2">
<h3 id="_пример_кода_и_кодирование_вместе">Пример кода и кодирование вместе</h3>
<div class="paragraph"><p>Вы читаете книгу, но вы, вероятно, согласитесь с нами, когда мы скажем, что лучший способ узнать о коде-это код.  Большую часть того, что мы знаем, мы узнали из общения с людьми, написания кода с ними и обучения на практике, и мы хотели бы воссоздать этот опыт как можно больше для вас в этой книге.</p></div>
<div class="paragraph"><p>В результате мы построили книгу вокруг одного примера проекта (хотя иногда мы приводим и другие примеры). Мы будем развивать этот проект по мере продвижения глав, как если бы вы были в паре с нами, и мы объясняем, что мы делаем и почему на каждом этапе.</p></div>
<div class="paragraph"><p>Но чтобы по-настоящему разобраться с этими шаблонами, вам нужно повозиться с кодом и почувствовать, как он работает. Вы найдете весь код на GitHub; у каждой главы есть своя ветка. Вы также можете найти <a href="https://github.com/cosmicpython/code/branches/all">список</a> веток на GitHub.</p></div>
<div class="paragraph pagebreak-before"><p>Вот три способа кодирования вместе с книгой:</p></div>
<div class="ulist"><ul>
<li>
<p>
Начните свой собственное репозиторий и попробуйте создать приложение, как это делаем мы, следуя примерам из листингов в книге и время от времени заглядывая в наше репо за подсказками. Однако предупреждаю: если вы читали предыдущую книгу Гарри и кодировали вместе с ней, вы обнаружите, что эта книга требует от вас проявить больше самостоятельности; вам, возможно, придется сильно полагаться на рабочие версии на GitHub.
</p>
</li>
<li>
<p>
Попробуйте применить каждый шаблон, главу за главой, к вашему собственному (желательно маленькому/игрушечному) проекту и посмотрите, сможете ли вы заставить его работать для вашего варианта использования.  Высокий риск/высокая награда (и, кроме того, достаточные усилия!). Возможно придётся изрядно попотеть, чтобы заставить какие то вещи работать в соответствии со спецификой вашего проекта, но, с другой стороны, вероятно вы, узнаете много полезного.
</p>
</li>
<li>
<p>
В каждой главе мы описываем "Упражнение для читателя" и даём ссылки на GitHub, где вы можете скачать частично готовый код для главы с несколькими недостающими частями, чтобы написать его самостоятельно.
</p>
</li>
</ul></div>
<div class="paragraph"><p>Особенно если вы намереваетесь применить некоторые из этих паттернов в своих собственных проектах, работа с простым примером-отличный способ безопасно практиковаться.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/tip.png" alt="Tip" />
</td>
<td class="content">По крайней мере, выполняйте «git checkout» кода из нашего репозитория при чтении каждой главы. Возможность сразу же увидеть код в контексте реального работающего приложения поможет ответить на множество вопросов по ходу дела и сделает все более реальным. Вы найдете инструкции, как это сделать, в начале каждой главы.</td>
</tr></table>
</div>
</div>
<div class="sect2">
<h3 id="_лицензия">Лицензия</h3>
<div class="paragraph"><p>Код (и онлайн-версия книги) находится под лицензией Creative Commons CC BY-NC-ND, что означает, что вы можете свободно копировать и делиться им с кем угодно в некоммерческих целях, если вы дать указание. Если вы хотите повторно использовать какой-либо контент из этой книги и у вас есть какие-либо опасения по поводу лицензии, свяжитесь с O&#8217;Reilly <a class="email"
href="mailto:permissions@oreilly.com"><em>permissions@oreilly.com</em></a>.</p></div>
<div class="paragraph"><p>Печатное издание лицензируется по-другому; см. страницу об авторских правах.</p></div>
</div>
<div class="sect2">
<h3 id="_условные_обозначения_используемые_в_этой_книге">Условные обозначения, используемые в этой книге</h3>
<div class="paragraph"><p>В этой книге используются следующие типографские условные обозначения:</p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
<em>Курсив</em>
</dt>
<dd>
<p>
Указывает новые термины, URL-адреса, адреса электронной почты, имена файлов и расширения файлов.
</p>
</dd>
<dt class="hdlist1">
<code>Постоянная ширина</code>
</dt>
<dd>
<p>
Используется для листинга программ, а также в абзацах для обозначения программных элементов, таких как имена переменных или функций, базы данных, типы данных, переменные среды, операторы и ключевые слова.
</p>
</dd>
<dt class="hdlist1">
<strong><code>Постоянная ширина жирный шрифт</code></strong>
</dt>
<dd>
<p>
Показывает команды или другой текст, который должен быть набран буквально пользователем.
</p>
</dd>
<dt class="hdlist1">
<em><code>Курсив постоянной ширины</code></em>
</dt>
<dd>
<p>
Показывает текст, который должен быть заменен пользовательскими значениями или значениями, определяемыми контекстом.
</p>
</dd>
</dl></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/tip.png" alt="Tip" />
</td>
<td class="content">
<div class="paragraph"><p>Этот элемент означает подсказку или предложение.</p></div>
</td>
</tr></table>
</div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note" />
</td>
<td class="content">
<div class="paragraph"><p>Этот элемент обозначает общее примечание.</p></div>
</td>
</tr></table>
</div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/warning.png" alt="Warning" />
</td>
<td class="content">
<div class="paragraph"><p>Этот элемент указывает на предупреждение или предостережение.</p></div>
</td>
</tr></table>
</div>
</div>
<div class="sect2">
<h3 id="_онлайн_обучение_o_8217_reilly">Онлайн-обучение O&#8217;Reilly</h3>
<div class="admonitionblock ormenabled">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note" />
</td>
<td class="content">
<div class="paragraph"><p>Более 40 лет <a href="http://oreilly.com" class="orm:hideurl"><em class="hyperlink">O’Reilly Media</em></a> предоставляет технологии и бизнес-тренинги, знания и идеи, чтобы помочь компаниям добиться успеха.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>Наша уникальная сеть экспертов и новаторов делится своими знаниями и опытом с помощью книг, статей, конференций и нашей онлайн-платформы обучения. Платформа онлайн-обучения O&#8217;Reilly предоставляет вам доступ по требованию к живым учебным курсам, углубленным учебным путям, интерактивным средам кодирования и обширной коллекции текстов и видео от O&#8217;Reilly и более чем 200 других издателей. Для получения дополнительной информации, пожалуйста, посетите сайт <a href="http://oreilly.com" class="orm:hideurl"><em>http://oreilly.com</em></a>.</p></div>
</div>
<div class="sect2">
<h3 id="_как_связаться_с_o_8217_reilly">Как связаться с  O&#8217;Reilly</h3>
<div class="paragraph"><p>Пожалуйста, направляйте комментарии и вопросы, касающиеся этой книги, издателю:</p></div>
<ul class="simplelist">
  <li>O’Reilly Media, Inc.</li>
  <li>1005 Gravenstein Highway North</li>
  <li>Sebastopol, CA 95472</li>
  <li>800-998-9938 (in the United States or Canada)</li>
  <li>707-829-0515 (international or local)</li>
  <li>707-829-0104 (fax)</li>
</ul>
<div class="paragraph"><p>У нас есть веб-страница для этой книги, где мы перечисляем ошибки, примеры и любую дополнительную информацию. Вы можете получить доступ к этой странице по адресу <a href="https://oreil.ly/architecture-patterns-python">https://oreil.ly/architecture-patterns-python</a>.</p></div>
<!--Don't forget to update the link above.-->
<div class="paragraph"><p>Email <a class="email" href="mailto:bookquestions@oreilly.com"><em>bookquestions@oreilly.com</em></a> для  комментариев и технических вопросов по этой книге.</p></div>
<div class="paragraph"><p>Для получения дополнительной информации о наших книгах, курсах, конференциях и новостях посетите наш веб-сайт по адресу <a href="http://www.oreilly.com">http://www.oreilly.com</a>.</p></div>
<div class="paragraph"><p>Найдите нас на Facebook: <a href="http://facebook.com/oreilly">http://facebook.com/oreilly</a></p></div>
<div class="paragraph"><p>Следите за нами в Twitter: <a href="http://twitter.com/oreillymedia">http://twitter.com/oreillymedia</a></p></div>
<div class="paragraph"><p>Смотрите нас на YouTube: <a href="http://www.youtube.com/oreillymedia">http://www.youtube.com/oreillymedia</a></p></div>
</div>
<div class="sect2">
<h3 id="_благодарности">Благодарности</h3>
<div class="paragraph"><p>Нашим техническим обозревателям Дэвиду Седдону, Эду Юнгу и Хайнеку Шлаваку: мы абсолютно не заслуживаем вас. Вы все невероятно преданные, добросовестные и строгие. Каждый из вас безмерно умен, и ваши разные точки зрения были полезны и дополняли друг друга. Спасибо вам от всего сердца.</p></div>
<div class="paragraph"><p>Огромное спасибо всем нашим читателям за их комментарии и
предложения:
Йен Купер, Абдулла Арифф, Джонатан Мейер, Гил Гонсалвес, Матье Чоплин, Бен Джадсон, Джеймс Грегори, Лукаш Лехович, Клинтон Рой, Виторино Араужо, Сьюзан Гудбоди, Джош Харвуд, Дэниел Батлер, Лю Хайбин, Джимми Вергиа Игнасиа Игнас Канестрани, Ренне Роча, Педроаби, Ашиа Завадук, Йостейн Лейра, Брэндон Роудс, Язепс Баско, Симкимсия, Адриен Брюнет и многие другие; приносим свои извинения, если мы пропустили Вас в этом списке.</p></div>
<div class="paragraph"><p>Супер-мега-спасибо нашему редактору Корбину Коллинзу за его нежное щебетание и за то, что он неутомимый защитник читателя. В такой же степени выражаем благодарность производственному персоналу Кэтрин Тозер, Шэрон Уилки, Эллен Траутман-Заиг и Ребекке Демарест за вашу преданность делу, профессионализм и внимание к деталям. Эта книга неизмеримо улучшена благодаря вам.</p></div>
<div class="paragraph"><p>Любые ошибки, оставшиеся в книге, естественно, являются нашими собственными.</p></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="introduction">Введение</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_почему_наш_дизайн_такой_неудачный">Почему Наш Дизайн Такой НЕУДАЧНЫЙ?</h3>
<div class="paragraph"><p>Что приходит на ум, когда вы слышите слово <em>хаос</em>? Возможно, вы думаете о шумной фондовой бирже или о своей кухне по утрам&#8201;&#8212;&#8201;все запутано и перемешано. Когда вы думаете о слове <em>порядок</em>, возможно, вы думаете о пустой комнате, безмятежной и спокойной. Однако для ученых хаос характеризуется однородностью (sameness), а порядок&#8201;&#8212;&#8201;сложностью (difference).</p></div>
<div class="paragraph"><p>Например, ухоженный сад&#8201;&#8212;&#8201;это упорядоченная система. Садоводы определяют границы дорожками и забором, размечают клумбы или огороды. Со временем сад развивается, становясь все богаче и гуще; но без целенаправленных усилий сад разрастется. Сорняки и травы будут заглушать другие растения, покрывая дорожки, пока в конце концов все их части не станут снова такими же&#8201;&#8212;&#8201;дикими и неуправляемыми.</p></div>
<div class="paragraph"><p>Программные системы тоже склонны к хаосу. Когда мы впервые начинаем строить новую систему, у нас есть грандиозные идеи, что наш код будет чистым и хорошо упорядоченным, но со временем мы обнаруживаем, что он включает ненужные и оборванные элементы кода и заканчивается запутанной трясиной менеджеров классов и утилитных модулей. Мы обнаруживаем, что наша разумная многослойная архитектура рухнула сама по себе, как какая то безделушка. Хаотические программные системы характеризуются одинаковостью функций: обработчики API, которые знают предметную область и отправляют электронную почту и выполняют регистрацию; классы «бизнес-логики», которые не выполняют вычислений, но выполняют ввод-вывод; и все вместе со всем остальным, так что изменение любой части системы чревато опасностью. Это настолько распространено, что у разработчиков программного обеспечения есть собственный термин для обозначения хаоса: антипаттерн "the Big Ball of Mud" (Большой шар грязи или нелитературно по русски говнокод :) ) (<a href="#bbom_image">[bbom_image]</a>).</p></div>
<div class="imageblock" id="bbom_image">
<div class="content">
<img src="images/apwp_0001.png" alt="images/apwp_0001.png" />
</div>
<div class="title">Figure 1. A real-life dependency diagram (source: <a href="https://oreil.ly/dbGTW">"Enterprise Dependency: Big Ball of Yarn"</a> by Alex Papadimoulis)</div>
</div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/tip.png" alt="Tip" />
</td>
<td class="content">Говнокод&#8201;&#8212;&#8201;естественное состояние программного обеспечения, так же как болезнь&#8201;&#8212;&#8201;естественное состояние вашего сада. Чтобы предотвратить коллапс, нужны энергия и направление.</td>
</tr></table>
</div>
<div class="paragraph"><p>К счастью, методы, позволяющие избежать этого, не сложны.</p></div>
</div>
<div class="sect2">
<h3 id="_инкапсуляции_и_абстракции">Инкапсуляции и абстракции</h3>
<div class="paragraph"><p>Инкапсуляция и абстракция&#8201;&#8212;&#8201;это инструменты, к которым мы все как программисты инстинктивно стремимся, даже если не все используем именно эти слова. Позвольте нам ненадолго остановиться на них, поскольку они являются постоянной фоновой темой книги.</p></div>
<div class="paragraph"><p>Термин <em>инкапсуляция</em> охватывает две тесно связанные идеи: упрощение поведения и скрытие данных. В этом обсуждении мы используем первое. Мы инкапсулируем поведение, определяя задачу, которую необходимо выполнить в нашем коде, и передаём эту задачу четко определенному объекту или функции. И называем этот объект или функцию <em>абстракцией</em>.</p></div>
<div class="paragraph"><p>Взгляните на следующие два фрагмента кода Python:</p></div>
<div class="exampleblock" id="urllib_example">
<div class="title">Example 1. Выполним поиск с помощью urllib</div>
<div class="content">
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">json</span>
<span class="kn">from</span> <span class="nn">urllib.request</span> <span class="kn">import</span> <span class="n">urlopen</span>
<span class="kn">from</span> <span class="nn">urllib.parse</span> <span class="kn">import</span> <span class="n">urlencode</span>

<span class="n">params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">q</span><span class="o">=</span><span class="s1">&#39;Sausages&#39;</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;json&#39;</span><span class="p">)</span>
<span class="n">handle</span> <span class="o">=</span> <span class="n">urlopen</span><span class="p">(</span><span class="s1">&#39;http://api.duckduckgo.com&#39;</span> <span class="o">+</span> <span class="s1">&#39;?&#39;</span> <span class="o">+</span> <span class="n">urlencode</span><span class="p">(</span><span class="n">params</span><span class="p">))</span>
<span class="n">raw_text</span> <span class="o">=</span> <span class="n">handle</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf8&#39;</span><span class="p">)</span>
<span class="n">parsed</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">raw_text</span><span class="p">)</span>

<span class="n">results</span> <span class="o">=</span> <span class="n">parsed</span><span class="p">[</span><span class="s1">&#39;RelatedTopics&#39;</span><span class="p">]</span>
<span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
    <span class="k">if</span> <span class="s1">&#39;Text&#39;</span> <span class="ow">in</span> <span class="n">r</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;FirstURL&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; - &#39;</span> <span class="o">+</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;Text&#39;</span><span class="p">])</span>
</pre></div></div></div>
</div></div>
<div class="exampleblock" id="requests_example">
<div class="title">Example 2. Сделаем поиск с запросами</div>
<div class="content">
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">requests</span>

<span class="n">params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">q</span><span class="o">=</span><span class="s1">&#39;Sausages&#39;</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;json&#39;</span><span class="p">)</span>
<span class="n">parsed</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;http://api.duckduckgo.com/&#39;</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">)</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>

<span class="n">results</span> <span class="o">=</span> <span class="n">parsed</span><span class="p">[</span><span class="s1">&#39;RelatedTopics&#39;</span><span class="p">]</span>
<span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
    <span class="k">if</span> <span class="s1">&#39;Text&#39;</span> <span class="ow">in</span> <span class="n">r</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;FirstURL&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; - &#39;</span> <span class="o">+</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;Text&#39;</span><span class="p">])</span>
</pre></div></div></div>
</div></div>
<div class="paragraph"><p>Оба кода делают одно и то же: они отправляют закодированные в форме значения на URL-адрес, чтобы использовать API поисковой системы. Но второе проще читать и понимать, потому что оно работает на более высоком уровне абстракции.</p></div>
<div class="paragraph"><p>Мы можем сделать еще один шаг вперед, определив и назвав задачу, которую нам хотелось бы, чтобы код выполнял для нас, и используем еще более высокоуровневую абстракцию, чтобы сделать ее явной:</p></div>
<div class="exampleblock" id="ddg_example">
<div class="title">Example 3. Поиск с помощью клиентской библиотеки duckduckgo</div>
<div class="content">
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">duckduckpy</span>
<span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">duckduckpy</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;Sausages&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">related_topics</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">first_url</span><span class="p">,</span> <span class="s1">&#39; - &#39;</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
</pre></div></div></div>
</div></div>
<div class="paragraph"><p>Инкапсуляция поведения с помощью абстракций-это мощный инструмент для того, чтобы сделать код более выразительным, более тестируемым и более простым в обслуживании.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note" />
</td>
<td class="content">В литературе, посвященной объектно-ориентированному (ОО) миру, одна из классических характеристик этого подхода называется
    <a href="http://www.wirfs-brock.com/Design.html"><em>responsibility-driven design</em></a>;
    в нем используются слова  <em>roles (роли)</em> и <em>responsibilities (обязанности)</em>, а не <em>tasks (задачи)</em>. Главное&#8201;&#8212;&#8201;думать о коде с точки зрения поведения, а не с точки зрения данных или алгоритмов.<span class="footnote"><br />[Если вы сталкивались с карточками class-responsibility-collaborator (CRC), то они основаны на одном и том же: размышления об <em>responsibilities ответственности</em> поможет вам решить, как разделить составляющие на части.]<br /></span></td>
</tr></table>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Abstractions и ABCs</div>
<div class="paragraph"><p>В традиционном объектно-ориентированном языке, таком как Java или C\#, вы можете использовать абстрактный базовый класс (ABC) или интерфейс для определения абстракции. В Python вы можете (и мы иногда используем) использовать ABC, но вы также можете положиться на Duck typing  <a href="https://docs-python.ru/tutorial/osnovnye-vstroennye-tipy-python/utinaja-tipizatsija-duck-typing/"><em>(если это похоже на утку и крякает как утка, то это утка)</em></a>.</p></div>
<div class="paragraph"><p>Абстракция может означать просто «общедоступный API того, что вы используете»&#8201;&#8212;&#8201;например, имя функции плюс некоторые аргументы.</p></div>
</div></div>
<div class="paragraph"><p>Большинство шаблонов в этой книге связаны с выбором абстракции, поэтому вы увидите множество примеров в каждой главе. Кроме того,
<a href="#chapter_03_abstractions">[chapter_03_abstractions]</a>  конкретно обсуждает некоторые общие эвристики для выбора абстракций.</p></div>
</div>
<div class="sect2">
<h3 id="_многоуровневое_представление">Многоуровневое представление</h3>
<div class="paragraph"><p>Инкапсуляция и абстракция помогают нам скрывать детали и защищать целостность наших данных, но нам также необходимо помнить о взаимодействии между нашими объектами и функциями. Когда одна функция, модуль или объект использует другую, мы говорим, что одна <em>depends on (зависима)</em> от другой. Эти зависимости образуют своего рода сеть или граф.</p></div>
<div class="paragraph"><p>В большом комке грязи зависимости выходят из-под контроля (как вы видели в
<a href="#bbom_image">[bbom_image]</a>). Изменение одного узла графа становится затруднительным, поскольку оно может повлиять на многие другие части системы. Слоистые архитектуры являются одним из способов решения этой проблемы. В многоуровневой архитектуре мы разделяем наш код на отдельные категории или роли и вводим правила касающеся того, какие категории кода могут вызывать друг друга.</p></div>
<div class="paragraph"><p>Одним из наиболее распространенных примеров является трехслойная архитектура, показанная на рис.
<a href="#layered_architecture1">[layered_architecture1]</a>.</p></div>
<div class="imageblock width-75" id="layered_architecture1">
<div class="content">
<img src="images/apwp_0002.png" alt="images/apwp_0002.png" />
</div>
<div class="title">Figure 2. Многоуровневая архитектура</div>
</div>
<div class="listingblock image-source">
<div class="content">
<pre><code>[ditaa, apwp_0002]
+----------------------------------------------------+
|                Уровень представления               |
+----------------------------------------------------+
                          |
                          V
+----------------------------------------------------+
|                 Бизнес-логика                      |
+----------------------------------------------------+
                          |
                          V
+----------------------------------------------------+
|                  Уровень базы данных               |
+----------------------------------------------------+</code></pre>
</div></div>
<div class="paragraph"><p>Многоуровневая архитектура является, пожалуй, наиболее распространенным шаблоном для построения business software&#8201;&#8212;&#8201;коммерческого ПО. В этой модели у нас есть компоненты пользовательского интерфейса, которые могут быть веб-страницей, API или командной строкой; эти компоненты пользовательского интерфейса взаимодействуют со слоем бизнес-логики, который содержит наши бизнес-правила и наши рабочие процессы; и, наконец, у нас есть уровень базы данных, который отвечает за хранение и извлечение данных.</p></div>
<div class="paragraph"><p>До конца этой книги мы будем систематически выворачивать эту модель наизнанку, следуя одному простому принципу.</p></div>
</div>
<div class="sect2">
<h3 id="dip">The Dependency Inversion Principle (Принцип инверсии зависимостей)</h3>
<div class="paragraph"><p>Возможно, вы уже знакомы с <em>принципом инверсии зависимостей</em> (DIP), потому что это <em>D</em> в SOLID. <span class="footnote"><br />[SOLID&#8201;&#8212;&#8201;это аббревиатура от пяти принципов объектно-ориентированного проектирования Роберта К. Мартина: единственная ответственность, открытость для расширения, но закрытость для модификации, подстановка Лискова, сегрегация интерфейсов и инверсия зависимостей. See <a href="https://oreil.ly/UFM7U">"S.O.L.I.D: The First 5 Principles of Object-Oriented Design"</a> by Samuel Oloruntoba.]<br /></span></p></div>
<div class="paragraph"><p>К сожалению, мы не можем проиллюстрировать DIP, используя три небольших листинга кода, как мы это делали для инкапсуляции. Однако вся <a href="#Часть1">[Часть1]</a> по сути представляет собой отработанный пример реализации DIP во всем приложении, так что вы получите множество конкретных примеров.</p></div>
<div class="paragraph"><p>А пока можно поговорить о формальном определении DIP:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
Модули высокого уровня не должны зависеть от модулей низкого уровня. И то и другое должно зависеть от абстракций.
</p>
</li>
<li>
<p>
Абстракции не должны зависеть от деталей. Вместо этого детали должны зависеть от абстракций.
</p>
</li>
</ol></div>
<div class="paragraph"><p>Но что это значит? Давайте разберемся по крупицам.</p></div>
<div class="paragraph"><p><em>Модули высокого уровня</em> это код, который действительно волнует вашу организацию.
Возможно, вы работаете в фармацевтической компании, и ваши высокоуровневые модули имеют дело с пациентами и испытаниями. Возможно, вы работаете в банке, и ваши высокоуровневые модули управляют сделками и биржами. Высокоуровневые модули программной системы-это функции, классы и пакеты, которые имеют дело с нашими концепциями реального мира.</p></div>
<div class="paragraph"><p>Напротив, <em>низкоуровневые модули</em>&#8201;&#8212;&#8201;это код, который вашей организации не важен. Маловероятно, что ваш отдел кадров будет в восторге от файловых систем или сетевых сокетов. Нечасто вы обсуждаете SMTP, HTTP или AMQP со своим финансовым отделом. Для наших нетехнических заинтересованных сторон эти низкоуровневые концепции не интересны и не актуальны. Все, что их волнует,&#8201;&#8212;&#8201;это правильность работы высокоуровневых концепций. Если расчет заработной платы выполняется вовремя, вашему бизнесу вряд ли будет важно, выполняется ли это задание cron или временная функция, выполняемая в Kubernetes.</p></div>
<div class="paragraph"><p><em>Depends on (зависит от)</em> не обязательно означает <em>imports</em> или <em>calls</em>, а скорее несёт более общую идею о том, что один модуль <em>knows about (знает о)</em> или <em>needs (нуждается в)</em> другом модуле.</p></div>
<div class="paragraph"><p>И мы уже упоминали <em>abstractions</em>: это упрощенные интерфейсы, которые инкапсулируют поведение, подобно тому, как наш модуль duckduckgo инкапсулирует API поисковой системы.</p></div>
<div class="quoteblock">
<div class="content">
<div class="paragraph"><p>Все проблемы в информатике можно решить, добавив еще один косвеный уровень.</p></div>
</div>
<div class="attribution">
&#8212; David Wheeler
</div></div>
<div class="paragraph"><p>Итак, первая часть DIP говорит, что наш бизнес и код не должны зависеть от технических деталей; вместо этого оба должны использовать абстракции.</p></div>
<div class="paragraph"><p>Почему? В широком смысле, потому что мы хотим иметь возможность изменять их независимо друг от друга. Модули высокого уровня должны быть легко изменены в соответствии с потребностями бизнеса. Низкоуровневые модули (детали) часто на практике сложнее изменить: подумайте о рефакторинге для изменения имени функции по сравнению с определением, тестированием и развертыванием миграции базы данных для изменения имени столбца. Мы не хотим, чтобы изменения бизнес-логики замедлялись, потому что они тесно связаны с деталями инфраструктуры низкого уровня. Но точно так же важно иметь возможность изменять детали инфраструктуры, когда это необходимо (например, подумайте о сегментировании базы данных), без необходимости вносить изменения в бизнес-уровень. Добавление абстракции между ними (знаменитый дополнительный слой косвенности) позволяет им изменяться (более) независимо друг от друга.</p></div>
<div class="paragraph"><p>Вторая часть еще более загадочна. «Абстракции не должны зависеть от деталей» кажется достаточно ясным, но «Детали должны зависеть от абстракций» трудно себе представить. Как мы можем получить абстракцию, которая не зависит от деталей, которые она абстрагирует? К тому времени, когда мы дойдем до <a href="#chapter_04_service_layer">[chapter_04_service_layer]</a>, у нас будет конкретный пример, который должен прояснить все это.</p></div>
</div>
<div class="sect2">
<h3 id="_место_для_всей_нашей_бизнес_логики_модель_предметной_области_the_domain_model">Место для Всей Нашей Бизнес-логики: Модель Предметной Области (The Domain Model)</h3>
<div class="paragraph"><p>Но прежде чем мы сможем вывернуть нашу трехуровневую архитектуру наизнанку, нам нужно больше поговорить об этом среднем слое: высокоуровневых модулях или бизнес-логике. Одна из наиболее распространенных причин, по которой наши проекты идут "как-то не так", заключается в том, что бизнес-логика распространяется по всем слоям нашего приложения, что затрудняет ее идентификацию, понимание и изменение.</p></div>
<div class="paragraph"><p><a href="#chapter_01_domain_model">[chapter_01_domain_model]</a> показывает, как построить бизнес-уровень с помощью шаблона <em>Domain Model</em>. Остальные шаблоны в <a href="#part1">[part1]</a> показывают, как мы можем сохранить модель предметной области легко изменяемой и свободной от низкоуровневых проблем, выбирая правильные абстракции и постоянно применяя DIP.</p></div>
</div>
</div>
</div>
<div class="quoteblock">
<div class="content">
<div class="paragraph"><p>Большинство разработчиков никогда не видели модель предметной области (domain model), только модель данных(data model).</p></div>
</div>
<div class="attribution">
<em>DDD EU 2017</em><br />
&#8212; Cyrille Martraire
</div></div>
<div class="paragraph"><p>Большинство разработчиков, с которыми мы говорим об архитектуре, испытывают мучительное предчувствие, что все могло бы быть лучше. Они часто пытаются спасти систему, которая каким-то образом вышла из строя, и пытаются вернуть какую-то структуру в комок грязи.
Они знают, что их бизнес-логика не должна распространяться повсюду, но они не знают, как это исправить.</p></div>
<div class="paragraph"><p>Мы обнаружили, что многие разработчики, когда их просят спроектировать новую систему, немедленно приступают к построению схемы базы данных, а объектная модель рассматривается как нечто запоздалое. Вот тут-то все и начинает идти наперекосяк. Вместо этого <em>поведение должно стоять на первом месте и определять наши требования к хранилищу.</em> В конце концов, наших клиентов не волнует модель данных. Их волнует, что _ делает_ система.; в противном случае они просто использовали бы электронную таблицу.</p></div>
<div class="paragraph"><p>Первая часть книги посвящена тому, как построить богатую объектную модель с помощью TDD (в <a href="#chapter_01_domain_model">[chapter_01_domain_model]</a>), а затем рассмотрим, как уберечь эту модель от технических проблем. Покажем, как создавать код, игнорирующий персистентность, и как создавать стабильные API-интерфейсы вокруг нашего домена, чтобы мы могли проводить агрессивный рефакторинг.</p></div>
<div class="paragraph"><p>Для этого мы представляем четыре ключевых шаблона проектирования:</p></div>
<div class="ulist"><ul>
<li>
<p>
<a href="#chapter_02_repository">Repository pattern</a>, абстракция над идеей постоянного хранения
</p>
</li>
<li>
<p>
Шаблон <a href="#chapter_04_service_layer">Service Layer</a> четко определяет, где начинаются и заканчиваются наши варианты использования
</p>
</li>
<li>
<p>
<a href="#chapter_06_uow">Unit of Work pattern</a> для обеспечения атомарных операций
</p>
</li>
<li>
<p>
<a href="#chapter_07_aggregate">Aggregate pattern</a> для обеспечения целостности наших данных
</p>
</li>
</ul></div>
<div class="paragraph pagebreak-before"><p>Если вам нужна картина того, куда мы в итоге придем, взгляните на
<a href="#part1_components_diagram">[part1_components_diagram]</a>, но не волнуйтесь, если для вас все эта графика не имеет смысла!  Мы разберём каждую фигуру изображенную на рисунке, одну за другой, на протяжении всей этой части книги.</p></div>
<div class="imageblock width-90" id="part1_components_diagram">
<div class="content">
<img src="images/apwp_p101.png" alt="images/apwp_p101.png" />
</div>
<div class="title">Figure 3. Диаграмма компонентов для нашего приложения в конце <a href="#part1">[part1]</a></div>
</div>
<div class="paragraph"><p>Мы также уделим немного времени, чтобы поговорить о
<a href="#chapter_03_abstractions">coupling and abstractions</a>, проиллюстрировав это на простом примере, который показывает, как и почему мы выбираем наши абстракции.</p></div>
<div class="paragraph"><p>Три приложения являются дальнейшими целями исследованиями содержания Части I:</p></div>
<div class="ulist"><ul>
<li>
<p>
<a href="#appendix_project_structure">[appendix_project_structure]</a> это описание инфраструктуры для нашего примера кода: как мы строим и запускаем образы Docker, где мы управляем информацией о конфигурации и как мы запускаем различные типы тестов.
</p>
</li>
<li>
<p>
<a href="#appendix_csvs">[appendix_csvs]</a> это своего рода контент типа "proof is in the pudding", показывающий, как легко поменять всю нашу инфраструктуру—API Flask, ORM и Postgres-на совершенно другую модель ввода-вывода, включающую CLI и CSV.
</p>
</li>
<li>
<p>
Наконец, <a href="#appendix_django">[appendix_django]</a> может представлять интерес, если вам интересно, как эти паттерны могут выглядеть при использовании Django вместо Flask и SQLAlchemy.
</p>
</li>
</ul></div>
<div class="sect1">
<h2 id="chapter_01_domain_model">Domain Modeling</h2>
<div class="sectionbody">
<div class="paragraph"><p>В этой главе рассматривается, как можно моделировать бизнес-процессы с помощью кода таким образом, чтобы он был полностью совместим с TDD (Test Driven Development).  Обсудим, почему моделирование домена имеет значение, и рассмотрим несколько ключевых шаблонов для моделирования доменов: Entity, Value Object, и Domain Service.</p></div>
<div class="paragraph"><p><a href="#maps_chapter_01_notext">[maps_chapter_01_notext]</a> это простое визуальное представление для нашего шаблона Domain Model. В этой главе мы расскажем о некоторых деталях, а когда перейдем к другим главам, то построим все вокруг Domain Model, но вы всегда должны быть в состоянии найти эти маленькие формы в центре.</p></div>
<div class="imageblock" id="maps_chapter_01_notext">
<div class="content">
<img src="images/apwp_0101.png" alt="images/apwp_0101.png" />
</div>
<div class="title">Figure 4. Иллюстрация прототипа нашей модели предметной области (Domain Model)</div>
</div>
<div class="sect2 pagebreak-before less_space">
<h3 id="_что_такое_domain_model">Что такое Domain Model?</h3>
<div class="paragraph"><p>В <a href="#introduction">introduction</a> мы использовали термин <em>business logic layer</em> для описания центрального слоя трехслойной архитектуры. Для остальной части книги будем использовать термин <em>domain model</em>. Это термин из методологии Domain Driven Design (DDD), который лучше улавливает наш предполагаемый смысл (подробнее о DDD читайте дальше).</p></div>
<div class="paragraph"><p><em>domain</em>&#8201;&#8212;&#8201;причудливый способ обозначить <em>проблему, которую вы пытаетесь решить.</em>
В настоящее время ваши авторы работают в мебельном интернет-магазине.  В зависимости от того, о какой системе вы говорите, предметной областью может быть совершение разовых покупок и закупка по долгосрочным договорам, дизайн продукта или логистика и доставка. Большинство программистов проводят свои дни в попытках улучшить или автоматизировать бизнес-процессы; домен является набором действий, которые поддерживают эти процессы.</p></div>
<div class="paragraph"><p><em>model</em>&#8201;&#8212;&#8201;карта процесса или явления, которая фиксирует полезное свойство.
Люди исключительно хороши в производстве моделей вещей в их головах. Например, когда кто-то бросает в вас мяч, вы можете предсказать его движение почти бессознательно, потому что у вас есть модель движения объектов в пространстве. Ваша модель ни в коем случае не идеальна. У людей есть ужасные интуитивные представления о том, как объекты ведут себя на околосветовых скоростях или в вакууме, потому что наша модель никогда не предназначалась для этих случаев. Это не означает, что модель неверна, но это означает, что некоторые прогнозы выходят за рамки её области.</p></div>
<div class="paragraph"><p>Модель предметной области&#8201;&#8212;&#8201;это ментальная карта, которую владельцы бизнеса вешают у себя на стене в кабинете и которая отображает их мысли о структуре их бизнеса. У всех деловых людей есть эти ментальные карты&#8201;&#8212;&#8201;это изображене мыслей этих людей о сложных процессах.</p></div>
<div class="paragraph"><p>Вы можете сразу определить, когда они ориентируются по этим картам, потому что они используют деловой язык.
Жаргон возникает естественным образом среди людей, которые сотрудничают в сложных системах.</p></div>
<div class="paragraph"><p>Представьте себе, что вы, наш несчастный читатель, внезапно перенеслись за много световых лет от Земли на борту инопланетного космического корабля со своими друзьями и семьей и должны выяснить, исходя из первых принципов, как вернуться домой.</p></div>
<div class="paragraph"><p>В первые несколько дней вы наверное будете просто нажимать кнопки случайным образом, но вскоре разберётесь, какие кнопки что делают и сможете давать друг другу инструкции. "Нажми красную кнопку возле мигающей штуковины, а затем пребрось этот большой рычаг рядом с радарной хреновиной",&#8201;&#8212;&#8201;скажете вы.</p></div>
<div class="paragraph"><p>Через пару недель вы станете более точными, определив слова для описания функций корабля: "Увеличить уровень кислорода в третьем грузовом отсеке" или "включите дополнительные двигатели." Через несколько месяцев вы бы придумали язык для целых сложных процессов: "Начать программу посадки " или "приготовиться к перегрузке." Этот процесс происходил бы совершенно естественно, без каких-либо формальных усилий по созданию общего глоссария.</p></div>
<div class="sidebarblock nobreakinside less_space">
<div class="content">
<div class="title">Это не книга DDD. Вам следует прочитать книгу DDD.</div>
<div class="paragraph"><p>Domain-driven design, или же DDD, популяризировал концепцию моделирования предметной области,<span class="footnote"><br />[ DDD не был инициатором моделирования предметной области. Эрик Эванс ссылается на книгу 2002 года <em>Object Design</em> за авторством Rebecca Wirfs-Brock и Alan McKean  (Addison-Wesley Professional), который ввел дизайн, основанный на ответственности, из которых DDD является частным случаем, связанным с доменом. Но даже это слишком поздно, и энтузиасты ОО скажут вам, чтобы вы посмотрели дальше назад на Ивара Якобсона и Грейди Буча; этот термин существует с середины 1980-х годов.]<br /></span>
и это было чрезвычайно успешное движение в изменении способа разработки программного обеспечения, сосредоточенного на основной сфере бизнеса. Многие из шаблонов архитектуры, которые мы рассматриваем в этой книге, включая Entity, Aggregate, Value Object (см. <a href="#chapter_07_aggregate">[chapter_07_aggregate]</a>), и Repository (в
<a href="#chapter_02_repository">the next chapter</a>) —- происходят из традиции DDD.</p></div>
<div class="paragraph"><p>Короче говоря, DDD говорит, что самое важное в программном обеспечении&#8201;&#8212;&#8201;это то, как оно предоставляет полезную модель проблемы. Если мы правильно воспользуемся этой моделью, наше программное обеспечение принесет пользу и сделает возможным новые вещи.</p></div>
<div class="paragraph"><p>Если мы ошибаемся в модели, это становится препятствием, над которым нужно работать. В этой книге мы можем показать основы построения модели предметной области и построения на её основе архитектуры, которая максимально освобождает модель от внешних ограничений, чтобы её было легко развить и изменить.</p></div>
<div class="paragraph"><p>Но в DDD и в процессах, инструментах и методах разработки модели предметной области есть гораздо больше. Тем не менее, мы надеемся дать вам почувствовать это на вкус и в достаточной мере побудить вас продолжить и прочитать соответствующую книгу DDD:</p></div>
<div class="ulist"><ul>
<li>
<p>
The original "blue book," <em>Domain-Driven Design</em> by Eric Evans (Addison-Wesley Professional)
</p>
</li>
<li>
<p>
The "red book," <em>Implementing Domain-Driven Design</em>
  by Vaughn Vernon (Addison-Wesley Professional)
</p>
</li>
</ul></div>
</div></div>
<div class="paragraph"><p>Так и в обычном мире бизнеса. Терминология, используемая заинтересованными сторонами бизнеса, представляет собой дистиллированное понимание модели предметной области, где сложные идеи и процессы сводятся к одному слову или фразе.</p></div>
<div class="paragraph"><p>Когда мы слышим, как наши деловые партнеры используют незнакомые слова или используют термины определенным образом, мы должны слушать, чтобы понять более глубокий смысл и закодировать их с трудом завоеванный опыт в наше программное обеспечение.</p></div>
<div class="paragraph"><p>В этой книге мы будем использовать модель предметной области реального мира, в частности модель из нашей текущей работы. MADE.com является успешным мебельным ритейлером. Мы поставляем нашу мебель от производителей по всему миру и продаем её по всей Европе.</p></div>
<div class="paragraph"><p>Когда вы покупаете диван или журнальный столик, мы должны решить, как лучше всего доставить ваш товар из Польши, Китая или Вьетнама в вашу гостиную.</p></div>
<div class="paragraph"><p>На высоком уровне у нас есть отдельные системы, которые отвечают за покупку акций, продажу акций клиентам и доставку товаров клиентам. Система в середине должна координировать процесс, распределяя запасы по заказам клиента; см. <a href="#allocation_context_diagram">[allocation_context_diagram]</a>.</p></div>
<div class="imageblock" id="allocation_context_diagram">
<div class="content">
<img src="images/apwp_0102ru.png" alt="images/apwp_0102ru.png" />
</div>
<div class="title">Figure 5. Контекстная диаграмма для службы распределения</div>
</div>
<div class="listingblock image-source">
<div class="content">
<pre><code>[plantuml, apwp_0102]
@startuml Allocation Context Diagram
!include images/C4_Context.puml
scale 2

System(systema, "Allocation", "Allocates stock to customer orders (Распределяет запасы по заказам клиентов)")

Person(customer, "Customer", "Wants to buy furniture (Хочет купить мебель)")
Person(buyer, "Buying Team", "Needs to purchase furniture from suppliers (Формирует заявку на закупку мебели у поставщиков)")

System(procurement, "Purchasing (Совершение закупок)"
, "Manages workflow for buying stock from suppliers (Управляет рабочим процессом покупки запасов у поставщиков)")
System(ecom, "Ecommerce", "Sells goods online (Продает товары онлайн)")
System(warehouse, "Warehouse", "Manages workflow for shipping goods to customers (Управляет рабочим процессом доставки товаров покупателям)")

Rel(buyer, procurement, "Uses (Заявка)")
Rel(procurement, systema, "Notifies about shipments (Уведомляет о доставке)")
Rel(customer, ecom, "Buys from (Покупает у)")
Rel(ecom, systema, "Asks for stock levels (Запрашивает уровень запасов)")
Rel(ecom, systema, "Notifies about orders (Уведомляет о заказах)")
Rel_R(systema, warehouse, "Sends instructions to (Отправляет инструкции)")
Rel_U(warehouse, customer, "Dispatches goods to (Отправляет товар в)")

@enduml</code></pre>
</div></div>
<div class="paragraph"><p>В рамках этой книги, пофантазируем, что фирма решает внедрить новый способ распределения запасов.  До сих пор компания представляла товар и время выполнения заказа на основе того, что физически доступно на складе.  Если и вдруг склад пустеет, продукт считается "отсутствующим на складе" до тех пор, пока не поступит следующая партия от производителя.</p></div>
<div class="paragraph"><p>Новая идея такова: если у нас есть система, которая может отслеживать все наши поставки и когда они должны прибыть, мы можем рассматривать товары на этих кораблях как реальные запасы и часть нашего инвентаря, просто с немного более длительным временем выполнения заказа. Не смотря на небольшие складские запасы, продавать будем больше, а бизнес сможет сэкономить деньги, уменьшив запасы на внутреннем складе.</p></div>
<div class="paragraph"><p>Но распределение заказов больше не является тривиальным вопросом уменьшения одного количества в складской системе. Нам нужен более сложный механизм распределения. Время для некоторого моделирования предметной области.</p></div>
</div>
<div class="sect2">
<h3 id="_изучение_языка_предметной_области">Изучение языка предметной области</h3>
<div class="paragraph"><p>Понимание модели предметной области требует времени, терпения и заметок. Мы предварительно беседуем с нашими бизнес-экспертами и договариваемся о глоссарии и некоторых правилах для первой минимальной версии модели предметной области. Там, где это возможно, мы просим привести конкретные примеры, иллюстрирующие каждое правило.</p></div>
<div class="paragraph"><p>Мы уверены, чтобы выразить эти правила на бизнес-жаргоне (на <em>ubiquitous language</em> в DDD терминологии) надо выбрать запоминающиеся идентификаторы для наших объектов, чтобы было легче говорить на примерах.</p></div>
<div class="paragraph"><p><a href="#allocation_notes">следующий сайдбар</a> показывает некоторые заметки, которые мы могли бы сделать во время разговора с нашими экспертами по предметной области Распределения.</p></div>
<div class="sidebarblock" id="allocation_notes">
<div class="content">
<div class="title">Некоторые примечания по распределению</div>
<div class="paragraph"><p><em>product</em> идентифицируется с помощью <em>SKU</em>, произносится как "skew", что является сокращением от <em>stock-keeping unit (единицы складского учета )</em>. <em>Customers</em> место <em>orders</em>. Заказ идентифицируется ссылкой <em>order reference</em> и содержит несколько  <em>order lines</em>, где каждая строка имеет <em>SKU</em> и <em>quantity</em>. Например:</p></div>
<div class="ulist"><ul>
<li>
<p>
10 единиц RED-CHAIR
</p>
</li>
<li>
<p>
1 единица TASTELESS-LAMP
</p>
</li>
</ul></div>
<div class="paragraph"><p>Отдел закупок заказывает небольшие партии товара. У <em>batch (партий)</em> заказов есть уникальный идентификатор, называемый <em>reference (ссылка)</em>, <em>SKU</em> и <em>quantity (количество)</em>.</p></div>
<div class="paragraph"><p>Нам нужно <em>allocate (распределить)</em> <em>order lines (позиции заказа)</em> по <em>batches (партиям отгрузки)</em>. Когда мы выделили позицию или строку заказа для партии, мы отправим запас из этой конкретной партии поставки на адрес доставки клиента. Когда мы распределяем <em>x</em> единиц запаса на партию, <em>available quantity (доступное количество)</em> уменьшается на <em>x</em>. Например:</p></div>
<div class="ulist"><ul>
<li>
<p>
У нас есть партия поставки 20 SMALL-TABLE, и мы выделяем строку заказа для 2 SMALL-TABLE.
</p>
</li>
<li>
<p>
В партии поставки должно остаться 18 SMALL-TABLE.
</p>
</li>
</ul></div>
<div class="paragraph"><p>Мы не можем отгрузить партию, если доступное количество меньше количества в строке заказа. Например:</p></div>
<div class="ulist"><ul>
<li>
<p>
У нас есть партия 1 СИНЯЯ ПОДУШКА а строка заказа на 2 СИНЕЙ ПОДУШКИ.
</p>
</li>
<li>
<p>
Мы не должны суметь выделить строку для партии отгрузки.
</p>
</li>
</ul></div>
<div class="paragraph"><p>Мы не можем выделить одну и ту же линию дважды. Например:</p></div>
<div class="ulist"><ul>
<li>
<p>
У нас есть партия поставки из 10 СИНИХ ВАЗ, и мы выделяем строку заказа для 2 СИНИХ ВАЗ.
</p>
</li>
<li>
<p>
Если мы снова выделим строку заказа для той же партии, то партия должна
иметь уже доступное количество 8.
</p>
</li>
</ul></div>
<div class="paragraph"><p>Партии имеют определённый <em>ETA</em>, если они в настоящее время уже отгружаются, или могут находится на <em>warehouse (складе)</em>. Мы распределяем складские запасы в соответствии с партиями отгрузки. Сортируем партии отгрузки начиная с самого раннего ETA <span class="footnote"><br />[ETA (англ. Estimated time of arrival) — ожидаемое время прибытия.]<br /></span>.</p></div>
</div></div>
</div>
<div class="sect2">
<h3 id="_модульное_тестирование_доменных_моделей">Модульное тестирование доменных моделей</h3>
<div class="paragraph"><p>Мы не собираемся показывать вам, как работает TDD в этой книге, но мы хотим показать вам, как мы могли бы построить модель из этого делового разговора.</p></div>
<div class="sidebarblock nobreakinside less_space">
<div class="content">
<div class="title">Упражнение для читателя</div>
<div class="paragraph"><p>Почему бы не попробовать решить эту проблему самостоятельно? Напишите несколько модульных тестов, чтобы увидеть, сможете ли вы уловить суть этих бизнес-правил в красивом, чистом коде.</p></div>
<div class="paragraph"><p>Вы найдете некоторые <a href="https://github.com/cosmicpython/code/tree/chapter_01_domain_model_exercise">placeholder unit tests on GitHub</a>, но вы можете просто начать с
нуля или объединить/переписать их так, как вам нравится.</p></div>
</div></div>
<div class="paragraph"><p>Вот как может выглядеть один из наших первых тестов:</p></div>
<div class="exampleblock" id="first_test">
<div class="title">Example 4. Первый тест на распределение (test_batches.py)</div>
<div class="content">
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">test_allocating_to_a_batch_reduces_the_available_quantity</span><span class="p">():</span>
    <span class="n">batch</span> <span class="o">=</span> <span class="n">Batch</span><span class="p">(</span><span class="s2">&quot;batch-001&quot;</span><span class="p">,</span> <span class="s2">&quot;SMALL-TABLE&quot;</span><span class="p">,</span> <span class="n">qty</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">eta</span><span class="o">=</span><span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">())</span>
    <span class="n">line</span> <span class="o">=</span> <span class="n">OrderLine</span><span class="p">(</span><span class="s1">&#39;order-ref&#39;</span><span class="p">,</span> <span class="s2">&quot;SMALL-TABLE&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

    <span class="n">batch</span><span class="o">.</span><span class="n">allocate</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">batch</span><span class="o">.</span><span class="n">available_quantity</span> <span class="o">==</span> <span class="mi">18</span>
</pre></div></div></div>
</div></div>
<div class="paragraph"><p>Название нашего модульного теста описывает поведение, которое мы хотим получить от системы, а имена классов и переменных, которые мы используем, взяты из делового жаргона. Мы могли бы показать этот код нашим нетехническим коллегам, и они согласились бы, что это правильно описывает поведение системы.</p></div>
<div class="paragraph pagebreak-before"><p>А вот и доменная модель, отвечающая нашим требованиям:</p></div>
<div class="exampleblock" id="domain_model_1">
<div class="title">Example 5. Первый заход доменной модели для партий (model.py)</div>
<div class="content">
<div class="listingblock non-head">
<div class="content"><div class="highlight"><pre><span></span><span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1">#<img src="./images/icons/callouts/1.png" alt="1" /><img src="./images/icons/callouts/2.png" alt="2" /></span>
<span class="k">class</span> <span class="nc">OrderLine</span><span class="p">:</span>
    <span class="n">orderid</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">sku</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">qty</span><span class="p">:</span> <span class="nb">int</span>


<span class="k">class</span> <span class="nc">Batch</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">ref</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">sku</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">qty</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">eta</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">date</span><span class="p">]</span>  <span class="c1">#<img src="./images/icons/callouts/2.png" alt="2" /></span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reference</span> <span class="o">=</span> <span class="n">ref</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sku</span> <span class="o">=</span> <span class="n">sku</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eta</span> <span class="o">=</span> <span class="n">eta</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">available_quantity</span> <span class="o">=</span> <span class="n">qty</span>

    <span class="k">def</span> <span class="nf">allocate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="p">:</span> <span class="n">OrderLine</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">available_quantity</span> <span class="o">-=</span> <span class="n">line</span><span class="o">.</span><span class="n">qty</span>  <span class="c1">#<img src="./images/icons/callouts/3.png" alt="3" /></span>
</pre></div></div></div>
</div></div>
<div class="colist arabic"><table>
<tr><td><img src="./images/icons/callouts/1.png" alt="1" /></td><td>
<code>OrderLine</code> это неизменяемый класс данных без какого-либо поведения.<span class="footnote"><br />[В предыдущих версиях Python мы могли использовать именованный кортеж (namedtuple). Вы также можете ознакомиться с отличными предложениями Hynek Schlawack. <a href="https://pypi.org/project/attrs">attrs</a>.]<br /></span>
</td></tr>
<tr><td><img src="./images/icons/callouts/2.png" alt="2" /></td><td>
Мы не показываем импорт в большинстве листингов кода, чтобы сохранить их в чистоте. Мы надеемся, что вы догадались, что это появилось здесь благодаря <code>from dataclasses import dataclass</code>; аналогично, typing.Optional и datetime.date. Если вы хотите что-то перепроверить, вы можете увидеть полный рабочий код для каждой главы в её ветке (например,
    <a href="https://github.com/python-leap/code/tree/chapter_01_domain_model">chapter_01_domain_model</a>).
</td></tr>
<tr><td><img src="./images/icons/callouts/3.png" alt="3" /></td><td>
Аннотации типов по-прежнему вызывают споры в мире Python. Для моделей предметной области они иногда могут помочь прояснить или задокументировать ожидаемые аргументы, и люди с IDE часто благодарны за них. Вы можете решить, что цена, заплаченная с точки зрения удобочитаемости, слишком высока.     
</td></tr>
</table></div>
<div class="paragraph"><p>Наша реализация здесь тривиальна: <code>Batch</code> просто декоратор! Берёт целое число <code>available_quantity</code>, и уменьшает это значение при резервровании товара в заказе. Мы написали кучу кода только для того, чтобы вычесть одно число из другого, но мы надеемся, что моделирование нашего домена точно окупится off.<span class="footnote"><br />[Или вы думаете, что кода недостаточно?  Как насчет какой-то проверки того, что SKU в <code>OrderLine</code> совпадает с <code>Batch.sku</code>?  Мы сохранили некоторые мысли о валидации для <a href="#appendix_validation">[appendix_validation]</a>.]<br /></span></p></div>
<div class="paragraph"><p>Давайте напишем несколько новых failing tests:</p></div>
<div class="exampleblock" id="test_can_allocate">
<div class="title">Example 6. Логика тестирования того, что мы можем выделить (test_batches.py)</div>
<div class="content">
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">make_batch_and_line</span><span class="p">(</span><span class="n">sku</span><span class="p">,</span> <span class="n">batch_qty</span><span class="p">,</span> <span class="n">line_qty</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">(</span>
        <span class="n">Batch</span><span class="p">(</span><span class="s2">&quot;batch-001&quot;</span><span class="p">,</span> <span class="n">sku</span><span class="p">,</span> <span class="n">batch_qty</span><span class="p">,</span> <span class="n">eta</span><span class="o">=</span><span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">()),</span>
        <span class="n">OrderLine</span><span class="p">(</span><span class="s2">&quot;order-123&quot;</span><span class="p">,</span> <span class="n">sku</span><span class="p">,</span> <span class="n">line_qty</span><span class="p">)</span>
    <span class="p">)</span>


<span class="k">def</span> <span class="nf">test_can_allocate_if_available_greater_than_required</span><span class="p">():</span>
    <span class="n">large_batch</span><span class="p">,</span> <span class="n">small_line</span> <span class="o">=</span> <span class="n">make_batch_and_line</span><span class="p">(</span><span class="s2">&quot;ELEGANT-LAMP&quot;</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">large_batch</span><span class="o">.</span><span class="n">can_allocate</span><span class="p">(</span><span class="n">small_line</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">test_cannot_allocate_if_available_smaller_than_required</span><span class="p">():</span>
    <span class="n">small_batch</span><span class="p">,</span> <span class="n">large_line</span> <span class="o">=</span> <span class="n">make_batch_and_line</span><span class="p">(</span><span class="s2">&quot;ELEGANT-LAMP&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">small_batch</span><span class="o">.</span><span class="n">can_allocate</span><span class="p">(</span><span class="n">large_line</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">False</span>

<span class="k">def</span> <span class="nf">test_can_allocate_if_available_equal_to_required</span><span class="p">():</span>
    <span class="n">batch</span><span class="p">,</span> <span class="n">line</span> <span class="o">=</span> <span class="n">make_batch_and_line</span><span class="p">(</span><span class="s2">&quot;ELEGANT-LAMP&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">batch</span><span class="o">.</span><span class="n">can_allocate</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">test_cannot_allocate_if_skus_do_not_match</span><span class="p">():</span>
    <span class="n">batch</span> <span class="o">=</span> <span class="n">Batch</span><span class="p">(</span><span class="s2">&quot;batch-001&quot;</span><span class="p">,</span> <span class="s2">&quot;UNCOMFORTABLE-CHAIR&quot;</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="n">eta</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">different_sku_line</span> <span class="o">=</span> <span class="n">OrderLine</span><span class="p">(</span><span class="s2">&quot;order-123&quot;</span><span class="p">,</span> <span class="s2">&quot;EXPENSIVE-TOASTER&quot;</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">batch</span><span class="o">.</span><span class="n">can_allocate</span><span class="p">(</span><span class="n">different_sku_line</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">False</span>
</pre></div></div></div>
</div></div>
<div class="paragraph"><p>Здесь нет ничего неожиданного. Мы переработали наш набор тестов, чтобы не повторять одни и те же строки кода для создания партии товара (Batch) и позиции заказа (OrderLine) для одного и того же SKU; и мы написали четыре простых теста для нового метода <code>can_allocate</code>. Again, notice that the names we use mirror the language of our domain experts, and the examples we agreed upon are directly written into code.</p></div>
<div class="paragraph"><p>Мы также можем реализовать это напрямую, написав <code>can_allocate</code>
метод <code>Batch</code>:</p></div>
<div class="exampleblock" id="can_allocate">
<div class="title">Example 7. Новый метод в модели (model.py)</div>
<div class="content">
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span>    <span class="k">def</span> <span class="nf">can_allocate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="p">:</span> <span class="n">OrderLine</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sku</span> <span class="o">==</span> <span class="n">line</span><span class="o">.</span><span class="n">sku</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">available_quantity</span> <span class="o">&gt;=</span> <span class="n">line</span><span class="o">.</span><span class="n">qty</span>
</pre></div></div></div>
</div></div>
<div class="paragraph"><p>Пока что мы можем управлять реализацией, просто увеличивая и уменьшая <code>Batch.available_quantity</code>, но когда мы перейдем к тестам <code>deallocate()</code>, мы будем вынуждены перейти к более интеллектуальному решению:</p></div>
<div class="exampleblock pagebreak-before" id="test_deallocate_unallocated">
<div class="title">Example 8. Этот тест потребует более умной модели (test_batches.py)</div>
<div class="content">
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">test_can_only_deallocate_allocated_lines</span><span class="p">():</span>
    <span class="n">batch</span><span class="p">,</span> <span class="n">unallocated_line</span> <span class="o">=</span> <span class="n">make_batch_and_line</span><span class="p">(</span><span class="s2">&quot;DECORATIVE-TRINKET&quot;</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">batch</span><span class="o">.</span><span class="n">deallocate</span><span class="p">(</span><span class="n">unallocated_line</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">batch</span><span class="o">.</span><span class="n">available_quantity</span> <span class="o">==</span> <span class="mi">20</span>
</pre></div></div></div>
</div></div>
<div class="paragraph"><p>В этом тесте мы assert-им, что deallocating (освобождение) строки из пакета не имеет никакого эффекта, если только пакет ранее не allocated (резервировал) эту позицию . Чтобы это сработало, наша <code>Batch</code> должна понять, какие позиции или строки были зарезервированы. Давайте посмотрим на реализацию:</p></div>
<div class="exampleblock" id="domain_model_complete">
<div class="title">Example 9. Модель предметной области теперь отслеживает распределения (model.py)</div>
<div class="content">
<div class="listingblock non-head">
<div class="content"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Batch</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">ref</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">sku</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">qty</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">eta</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">date</span><span class="p">]</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reference</span> <span class="o">=</span> <span class="n">ref</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sku</span> <span class="o">=</span> <span class="n">sku</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eta</span> <span class="o">=</span> <span class="n">eta</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_purchased_quantity</span> <span class="o">=</span> <span class="n">qty</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_allocations</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>  <span class="c1"># type: Set[OrderLine]</span>

    <span class="k">def</span> <span class="nf">allocate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="p">:</span> <span class="n">OrderLine</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">can_allocate</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_allocations</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">deallocate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="p">:</span> <span class="n">OrderLine</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_allocations</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_allocations</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">allocated_quantity</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">qty</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_allocations</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">available_quantity</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_purchased_quantity</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">allocated_quantity</span>

    <span class="k">def</span> <span class="nf">can_allocate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="p">:</span> <span class="n">OrderLine</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sku</span> <span class="o">==</span> <span class="n">line</span><span class="o">.</span><span class="n">sku</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">available_quantity</span> <span class="o">&gt;=</span> <span class="n">line</span><span class="o">.</span><span class="n">qty</span>
</pre></div></div></div>
</div></div>
<div class="paragraph"><p><a href="#model_diagram">[model_diagram]</a> показывает модель в UML.</p></div>
<div class="imageblock" id="model_diagram">
<div class="content">
<img src="images/apwp_0103.png" alt="images/apwp_0103.png" />
</div>
<div class="title">Figure 6. Our model in UML</div>
</div>
<div class="listingblock image-source">
<div class="content">
<pre><code>[plantuml, apwp_0103, config=plantuml.cfg]
@startuml
scale 4

left to right direction
hide empty members

class Batch {
    reference
    sku
    eta
    _purchased_quantity
    _allocations
}

class OrderLine {
    orderid
    sku
    qty
}

Batch::_allocations o-- OrderLine</code></pre>
</div></div>
<div class="paragraph"><p>Теперь мы кое-чего добились! Партия товара(Batch) теперь отслеживает набор выделенных(allocated) объектов <code>OrderLine</code>. Когда мы распределяем (allocate), если у нас достаточно свободного количества(available quantity), мы просто добавляем к набору. Наше <code>available_quantity</code> теперь является вычисляемым свойством: купленное количество минус выделенное количество.</p></div>
<div class="paragraph"><p>Да, мы могли бы сделать еще много. Немного обескураживает то, что и <code>allocate()</code>, и <code>deallocate()</code> могут потерпеть неудачу без предупреждения, но основа у нас теперь есть.</p></div>
<div class="paragraph"><p>Кстати, использование набора для <code>._allocations</code> упрощает нам обработку последнего теста, потому что элементы в наборе уникальны:</p></div>
<div class="exampleblock" id="last_test">
<div class="title">Example 10. Last batch test!  (test_batches.py)</div>
<div class="content">
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">test_allocation_is_idempotent</span><span class="p">():</span>
    <span class="n">batch</span><span class="p">,</span> <span class="n">line</span> <span class="o">=</span> <span class="n">make_batch_and_line</span><span class="p">(</span><span class="s2">&quot;ANGULAR-DESK&quot;</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">batch</span><span class="o">.</span><span class="n">allocate</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
    <span class="n">batch</span><span class="o">.</span><span class="n">allocate</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">batch</span><span class="o">.</span><span class="n">available_quantity</span> <span class="o">==</span> <span class="mi">18</span>
</pre></div></div></div>
</div></div>
<div class="paragraph"><p>На данный момент, вероятно, будет обоснованной критикой сказать, что модель предметной области слишком тривиальна, чтобы беспокоиться о DDD (или даже об объектной ориентации!). В реальной жизни возникает множество бизнес-правил и крайних случаев: клиенты могут запросить доставку в определенные будущие даты, а это означает, что мы можем не захотеть распределять их на самую раннюю партию. Некоторые SKU (артикулы) не выпускаются партиями, а заказываются по требованию непосредственно у поставщиков, поэтому у них другая логика. В зависимости от местоположения клиента мы можем выделить только подмножество складов и отгрузок, которые находятся в его регионе, за исключением некоторых SKU, которые мы с удовольствием доставляем со склада в другом регионе, если у нас нет запасов в домашнем регионе. And so on.  Настоящий бизнес в реальном мире знает, как нагромождать сложности быстрее, чем мы можем показать на странице!</p></div>
<div class="paragraph"><p>Но взяв эту простую модель предметной области в качестве заменителя чего-то более сложного, мы расширим нашу простую модель предметной области в остальной части книги и подключим её к реальному миру API, баз данных и электронных таблиц. Мы увидим, как строгое следование нашим принципам инкапсуляции и тщательного проанализированного наслоения поможет нам избежать :) "говнокодинга"</p></div>
<div class="sidebarblock nobreakinside">
<div class="content">
<div class="title">Больше типов для большего числа аннотаций</div>
<div class="paragraph"><p>Если вы действительно хотите отправиться погулять в город с подсказками типа, вы можете зайти так далеко, что обернете даже примитивные типы с помощью <code>typing.NewType</code>:</p></div>
<div class="exampleblock" id="too_many_types">
<div class="title">Example 11. Просто зашел слишком далеко, Боб</div>
<div class="content">
<div class="listingblock skip">
<div class="content"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">NewType</span>

<span class="n">Quantity</span> <span class="o">=</span> <span class="n">NewType</span><span class="p">(</span><span class="s2">&quot;Quantity&quot;</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span>
<span class="n">Sku</span> <span class="o">=</span> <span class="n">NewType</span><span class="p">(</span><span class="s2">&quot;Sku&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
<span class="n">Reference</span> <span class="o">=</span> <span class="n">NewType</span><span class="p">(</span><span class="s2">&quot;Reference&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
<span class="o">...</span>

<span class="k">class</span> <span class="nc">Batch</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ref</span><span class="p">:</span> <span class="n">Reference</span><span class="p">,</span> <span class="n">sku</span><span class="p">:</span> <span class="n">Sku</span><span class="p">,</span> <span class="n">qty</span><span class="p">:</span> <span class="n">Quantity</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sku</span> <span class="o">=</span> <span class="n">sku</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reference</span> <span class="o">=</span> <span class="n">ref</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_purchased_quantity</span> <span class="o">=</span> <span class="n">qty</span>
</pre></div></div></div>
</div></div>
<div class="paragraph"><p>Это позволило бы нашей проверке типов убедиться, что мы не передаем <code>Sku (артикул)</code>, где ожидается, например, <code>Reference (Ссылка)</code>.</p></div>
<div class="paragraph"><p>Считаете ли вы это замечательным или ужасным-вопрос спорный.<span class="footnote"><br />[Это ужасно.  Пожалуйста, пожалуйста, не делай этого. —Harry]<br /></span></p></div>
</div></div>
<div class="sect3">
<h4 id="_dataclasses_отлично_подходят_для_value_objects">Dataclasses отлично подходят для Value Objects</h4>
<div class="paragraph"><p>Мы широко использовали <code>line</code> в предыдущих листингах кода, но что такое строка? На нашем деловом языке <em>order</em> состоит из нескольких <em>line</em> товаров, где каждая строка имеет SKU и количество. Представм, что простой файл YAML, содержащий информацию о заказе, может выглядеть так:</p></div>
<div class="exampleblock" id="yaml_order_example">
<div class="title">Example 12. Информация о заказе как YAML</div>
<div class="content">
<div class="listingblock skip">
<div class="content"><div class="highlight"><pre><span></span><span class="nt">Order_reference</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">12345</span>
<span class="nt">Lines</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="nt">sku</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">RED-CHAIR</span>
    <span class="nt">qty</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">25</span>
  <span class="p p-Indicator">-</span> <span class="nt">sku</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">BLU-CHAIR</span>
    <span class="nt">qty</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">25</span>
  <span class="p p-Indicator">-</span> <span class="nt">sku</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">GRN-CHAIR</span>
    <span class="nt">qty</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">25</span>
</pre></div></div></div>
</div></div>
<div class="paragraph"><p>Обратите внимание, что в то время как заказ имеет <em>reference</em>, который однозначно идентифицирует его, <em>line</em> нет. (Даже если мы добавим ссылку на порядок в класс OrderLine, это не то, что однозначно идентифицирует саму строку.)</p></div>
<div class="paragraph"><p>Всякий раз, когда у нас есть бизнес-концепция, имеющая данные, но не имеющая идентичности, мы часто предпочитаем представлять её с помощью шаблона <em>Value Object</em>. <em>value object</em>-это любой объект предметной области, который однозначно идентифицируется содержащимися в нем данными; обычно мы делаем их неизменяемыми:</p></div>
<div class="exampleblock" id="orderline_value_object">
<div class="title">Example 13. OrderLine как value object</div>
<div class="content">
<div class="listingblock skip">
<div class="content"><div class="highlight"><pre><span></span><span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">OrderLine</span><span class="p">:</span>
    <span class="n">orderid</span><span class="p">:</span> <span class="n">OrderReference</span>
    <span class="n">sku</span><span class="p">:</span> <span class="n">ProductReference</span>
    <span class="n">qty</span><span class="p">:</span> <span class="n">Quantity</span>
</pre></div></div></div>
</div></div>
<div class="paragraph"><p>Одна из приятных вещей, которые дают нам dataclasses (или namedtuples),&#8201;&#8212;&#8201;это <em>value equality</em>, что является причудливым способом сказать: "Две строки с одинаковыми <code>orderid</code>, <code>sku</code> и <code>qty</code> равны."</p></div>
<div class="exampleblock" id="more_value_objects">
<div class="title">Example 14. Еще примеры value objects</div>
<div class="content">
<div class="listingblock skip">
<div class="content"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">NamedTuple</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">namedtuple</span>

<span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">Name</span><span class="p">:</span>
    <span class="n">first_name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">surname</span><span class="p">:</span> <span class="nb">str</span>

<span class="k">class</span> <span class="nc">Money</span><span class="p">(</span><span class="n">NamedTuple</span><span class="p">):</span>
    <span class="n">currency</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">value</span><span class="p">:</span> <span class="nb">int</span>

<span class="n">Line</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;Line&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;sku&#39;</span><span class="p">,</span> <span class="s1">&#39;qty&#39;</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">test_equality</span><span class="p">():</span>
    <span class="k">assert</span> <span class="n">Money</span><span class="p">(</span><span class="s1">&#39;gbp&#39;</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span> <span class="o">==</span> <span class="n">Money</span><span class="p">(</span><span class="s1">&#39;gbp&#39;</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">Name</span><span class="p">(</span><span class="s1">&#39;Harry&#39;</span><span class="p">,</span> <span class="s1">&#39;Percival&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="n">Name</span><span class="p">(</span><span class="s1">&#39;Bob&#39;</span><span class="p">,</span> <span class="s1">&#39;Gregory&#39;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">Line</span><span class="p">(</span><span class="s1">&#39;RED-CHAIR&#39;</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span> <span class="o">==</span> <span class="n">Line</span><span class="p">(</span><span class="s1">&#39;RED-CHAIR&#39;</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
</pre></div></div></div>
</div></div>
<div class="paragraph"><p>Эти ценностные объекты соответствуют нашему реальнму передставлению о том, как работают их ценности. Не имеет значения, о какой банкноте в 10 фунтов мы говорим, потому что все они имеют одинаковую ценность. Аналогично, два имени равны, если совпадают имя и фамилия; и две строки эквивалентны, если они имеют один и тот же заказ клиента, код продукта и количество. Однако мы все еще можем иметь сложное поведение на ценностном объекте. На самом деле, обычно поддерживают операции со значениями; например, математические операторы:</p></div>
<div class="exampleblock" id="value_object_maths">
<div class="title">Example 15. Математика с value objects</div>
<div class="content">
<div class="listingblock skip">
<div class="content"><div class="highlight"><pre><span></span><span class="n">fiver</span> <span class="o">=</span> <span class="n">Money</span><span class="p">(</span><span class="s1">&#39;gbp&#39;</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
<span class="n">tenner</span> <span class="o">=</span> <span class="n">Money</span><span class="p">(</span><span class="s1">&#39;gbp&#39;</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">can_add_money_values_for_the_same_currency</span><span class="p">():</span>
    <span class="k">assert</span> <span class="n">fiver</span> <span class="o">+</span> <span class="n">fiver</span> <span class="o">==</span> <span class="n">tenner</span>

<span class="k">def</span> <span class="nf">can_subtract_money_values</span><span class="p">():</span>
    <span class="k">assert</span> <span class="n">tenner</span> <span class="o">-</span> <span class="n">fiver</span> <span class="o">==</span> <span class="n">fiver</span>

<span class="k">def</span> <span class="nf">adding_different_currencies_fails</span><span class="p">():</span>
    <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">):</span>
        <span class="n">Money</span><span class="p">(</span><span class="s1">&#39;usd&#39;</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span> <span class="o">+</span> <span class="n">Money</span><span class="p">(</span><span class="s1">&#39;gbp&#39;</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">can_multiply_money_by_a_number</span><span class="p">():</span>
    <span class="k">assert</span> <span class="n">fiver</span> <span class="o">*</span> <span class="mi">5</span> <span class="o">==</span> <span class="n">Money</span><span class="p">(</span><span class="s1">&#39;gbp&#39;</span><span class="p">,</span> <span class="mi">25</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">multiplying_two_money_values_is_an_error</span><span class="p">():</span>
    <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">):</span>
        <span class="n">tenner</span> <span class="o">*</span> <span class="n">fiver</span>
</pre></div></div></div>
</div></div>
</div>
<div class="sect3">
<h4 id="_value_objects_и_entities">Value Objects и Entities</h4>
<div class="paragraph"><p>Строка заказа однозначно идентифицируется по идентификатору  заказа (ID), артикулу (SKU) и количеству (quantity); если мы изменим одно из этих значений, теперь у нас будет новая строка. Это определение value object: любой объект, который идентифицируется только своими данными и не имеет долгоживущей идентичности. А как насчет партии товара? Это <em>is</em> идентифицировано ссылкой.</p></div>
<div class="paragraph"><p>Мы используем термин <em>entity</em> для описания объекта домена, который имеет долгосрочную идентичность. На предыдущей странице мы представили класс <code>Name</code> как объект значения. Если мы возьмем имя Гарри Персиваль и изменим одну букву, у нас будет новый объект <code>Name</code>, Барри Персиваль.</p></div>
<div class="paragraph"><p>Должно быть ясно, что Гарри Персиваль не равен Барри Персивалю:</p></div>
<div class="exampleblock" id="test_equality">
<div class="title">Example 16. Само имя не может измениться &#8230;</div>
<div class="content">
<div class="listingblock skip">
<div class="content"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">test_name_equality</span><span class="p">():</span>
    <span class="k">assert</span> <span class="n">Name</span><span class="p">(</span><span class="s2">&quot;Harry&quot;</span><span class="p">,</span> <span class="s2">&quot;Percival&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="n">Name</span><span class="p">(</span><span class="s2">&quot;Barry&quot;</span><span class="p">,</span> <span class="s2">&quot;Percival&quot;</span><span class="p">)</span>
</pre></div></div></div>
</div></div>
<div class="paragraph"><p>Но как насчет Гарри как личности? Люди меняют свои имена, семейное положение и даже пол, но мы продолжаем признавать их как одного человека. Это потому, что люди, в отличие от имен, имеют постоянное
<em>identity</em>:</p></div>
<div class="exampleblock" id="person_identity">
<div class="title">Example 17. Но человек может!</div>
<div class="content">
<div class="listingblock skip">
<div class="content"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Person</span><span class="p">:</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="n">Name</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>


<span class="k">def</span> <span class="nf">test_barry_is_harry</span><span class="p">():</span>
    <span class="n">harry</span> <span class="o">=</span> <span class="n">Person</span><span class="p">(</span><span class="n">Name</span><span class="p">(</span><span class="s2">&quot;Harry&quot;</span><span class="p">,</span> <span class="s2">&quot;Percival&quot;</span><span class="p">))</span>
    <span class="n">barry</span> <span class="o">=</span> <span class="n">harry</span>

    <span class="n">barry</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">Name</span><span class="p">(</span><span class="s2">&quot;Barry&quot;</span><span class="p">,</span> <span class="s2">&quot;Percival&quot;</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">harry</span> <span class="ow">is</span> <span class="n">barry</span> <span class="ow">and</span> <span class="n">barry</span> <span class="ow">is</span> <span class="n">harry</span>
</pre></div></div></div>
</div></div>
<div class="paragraph"><p>Сущности, в отличие от значений, обладают <em>identity equality (равенством идентичности)</em>. Мы можем изменить их ценности, и они по-прежнему узнаваемы. Batches (партии), в нашем примере, являются сущностями. Мы можем выделить строки в заказе для партии товара или изменить дату, когда мы ожидаем, что она прибудет, и это будет все та же сущность.</p></div>
<div class="paragraph"><p>Обычно мы делаем это явно в коде, реализуя операторы равенства для сущностей:</p></div>
<div class="exampleblock" id="equality_on_batches">
<div class="title">Example 18. Реализация операторов равенства (model.py)</div>
<div class="content">
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Batch</span><span class="p">:</span>
    <span class="o">...</span>

    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">Batch</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="n">other</span><span class="o">.</span><span class="n">reference</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">reference</span>

    <span class="k">def</span> <span class="fm">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">hash</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reference</span><span class="p">)</span>
</pre></div></div></div>
</div></div>
<div class="paragraph"><p>Магический метод Python  <code> __eq__ </code> 
определяет поведение класса для <code>==</code> operator.<span class="footnote"><br />[ <code> __eq__ </code>  произносится как "dunder-EQ". По крайней мере, некоторыми.]<br /></span></p></div>
<div class="paragraph"><p>И для объектов сущностей, и для объектов значений также стоит подумать о том, как  <code> __hash__ </code>  будет работать.  Это волшебный метод, который Python использует для управления поведением объектов, когда вы добавляете их в наборы или используете их как ключи dict; вы можете найти дополнительную информацию <a href="https://oreil.ly/YUzg5">в документации Python</a>.</p></div>
<div class="paragraph"><p>Для value objects хэш должен основываться на всех атрибутах value, и мы должны гарантировать, что объекты неизменяемы.  Мы получаем это бесплатно, указав <code>@frozen=True</code> в классе данных.</p></div>
<div class="paragraph"><p>Для сущностей самый простой вариант-сказать, что хэш-это <code>None</code>, что означает, что объект не является хэшируемым и не может, например, использоваться в множестве (имеется ввиду set). Если по какой-то причине вы решите, что действительно хотите использовать операции set или dict с сущностями, хэш должен основываться на атрибуте(атрибутах), таком как <code>.reference</code>, который определяет уникальную идентичность сущности с течением времени. Вы должны также попытаться как-то сделать <em>этот</em> атрибут read-only.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/warning.png" alt="Warning" />
</td>
<td class="content">Это сложная территория; вы не должны изменять <code>__hash__</code>     без изменения <code>__eq__</code>.  Если вы не уверены в том, что делаете, рекомендуется продолжить разбор почитав  <a href="https://oreil.ly/vxkgX">"Python Hashes and Equality"</a> от нашего технического обозревателя Хайнека Шлавака - хорошее место для начала.
    
    </td>
</tr></table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_не_все_должно_быть_объектом_a_domain_service_function">Не Все Должно быть Объектом: A Domain Service Function</h3>
<div class="paragraph"><p>Мы создали модель для представления партий, но на самом деле нам нужно распределить строки заказа по определенному набору партий, представляющих все наши запасы.</p></div>
<div class="quoteblock">
<div class="content">
<div class="paragraph"><p>Иногда это просто не так.</p></div>
</div>
<div class="attribution">
<em>Domain-Driven Design</em><br />
&#8212; Eric Evans
</div></div>
<div class="paragraph"><p>Эванс обсуждает идею Domain Service operations, которые не имеют естественного дома в entity или value object.<span class="footnote"><br />[Domain services это не то же самое, что услуги от <a href="#chapter_04_service_layer">service layer</a>, хотя они часто тесно связаны. Доменная служба представляет собой бизнес-концепцию или процесс, в то время как служба уровня сервиса представляет собой вариант использования вашего приложения. Часто уровень сервиса вызывает доменную службу.]<br /></span> То, что выделяет строку заказа для данного набора партий, очень похоже на функцию, и мы можем воспользоваться тем фактом, что Python - это многопарадигмальный язык, и просто сделать его функцией.</p></div>
<div class="paragraph"><p>Давайте посмотрим, как мы можем протестировать такую ​​функцию:</p></div>
<div class="exampleblock" id="test_allocate">
<div class="title">Example 19. Тестирование нашей доменной службы (test_allocate.py)</div>
<div class="content">
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">test_prefers_current_stock_batches_to_shipments</span><span class="p">():</span>
    <span class="n">in_stock_batch</span> <span class="o">=</span> <span class="n">Batch</span><span class="p">(</span><span class="s2">&quot;in-stock-batch&quot;</span><span class="p">,</span> <span class="s2">&quot;RETRO-CLOCK&quot;</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="n">eta</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">shipment_batch</span> <span class="o">=</span> <span class="n">Batch</span><span class="p">(</span><span class="s2">&quot;shipment-batch&quot;</span><span class="p">,</span> <span class="s2">&quot;RETRO-CLOCK&quot;</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="n">eta</span><span class="o">=</span><span class="n">tomorrow</span><span class="p">)</span>
    <span class="n">line</span> <span class="o">=</span> <span class="n">OrderLine</span><span class="p">(</span><span class="s2">&quot;oref&quot;</span><span class="p">,</span> <span class="s2">&quot;RETRO-CLOCK&quot;</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>

    <span class="n">allocate</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="p">[</span><span class="n">in_stock_batch</span><span class="p">,</span> <span class="n">shipment_batch</span><span class="p">])</span>

    <span class="k">assert</span> <span class="n">in_stock_batch</span><span class="o">.</span><span class="n">available_quantity</span> <span class="o">==</span> <span class="mi">90</span>
    <span class="k">assert</span> <span class="n">shipment_batch</span><span class="o">.</span><span class="n">available_quantity</span> <span class="o">==</span> <span class="mi">100</span>


<span class="k">def</span> <span class="nf">test_prefers_earlier_batches</span><span class="p">():</span>
    <span class="n">earliest</span> <span class="o">=</span> <span class="n">Batch</span><span class="p">(</span><span class="s2">&quot;speedy-batch&quot;</span><span class="p">,</span> <span class="s2">&quot;MINIMALIST-SPOON&quot;</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="n">eta</span><span class="o">=</span><span class="n">today</span><span class="p">)</span>
    <span class="n">medium</span> <span class="o">=</span> <span class="n">Batch</span><span class="p">(</span><span class="s2">&quot;normal-batch&quot;</span><span class="p">,</span> <span class="s2">&quot;MINIMALIST-SPOON&quot;</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="n">eta</span><span class="o">=</span><span class="n">tomorrow</span><span class="p">)</span>
    <span class="n">latest</span> <span class="o">=</span> <span class="n">Batch</span><span class="p">(</span><span class="s2">&quot;slow-batch&quot;</span><span class="p">,</span> <span class="s2">&quot;MINIMALIST-SPOON&quot;</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="n">eta</span><span class="o">=</span><span class="n">later</span><span class="p">)</span>
    <span class="n">line</span> <span class="o">=</span> <span class="n">OrderLine</span><span class="p">(</span><span class="s2">&quot;order1&quot;</span><span class="p">,</span> <span class="s2">&quot;MINIMALIST-SPOON&quot;</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>

    <span class="n">allocate</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="p">[</span><span class="n">medium</span><span class="p">,</span> <span class="n">earliest</span><span class="p">,</span> <span class="n">latest</span><span class="p">])</span>

    <span class="k">assert</span> <span class="n">earliest</span><span class="o">.</span><span class="n">available_quantity</span> <span class="o">==</span> <span class="mi">90</span>
    <span class="k">assert</span> <span class="n">medium</span><span class="o">.</span><span class="n">available_quantity</span> <span class="o">==</span> <span class="mi">100</span>
    <span class="k">assert</span> <span class="n">latest</span><span class="o">.</span><span class="n">available_quantity</span> <span class="o">==</span> <span class="mi">100</span>


<span class="k">def</span> <span class="nf">test_returns_allocated_batch_ref</span><span class="p">():</span>
    <span class="n">in_stock_batch</span> <span class="o">=</span> <span class="n">Batch</span><span class="p">(</span><span class="s2">&quot;in-stock-batch-ref&quot;</span><span class="p">,</span> <span class="s2">&quot;HIGHBROW-POSTER&quot;</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="n">eta</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">shipment_batch</span> <span class="o">=</span> <span class="n">Batch</span><span class="p">(</span><span class="s2">&quot;shipment-batch-ref&quot;</span><span class="p">,</span> <span class="s2">&quot;HIGHBROW-POSTER&quot;</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="n">eta</span><span class="o">=</span><span class="n">tomorrow</span><span class="p">)</span>
    <span class="n">line</span> <span class="o">=</span> <span class="n">OrderLine</span><span class="p">(</span><span class="s2">&quot;oref&quot;</span><span class="p">,</span> <span class="s2">&quot;HIGHBROW-POSTER&quot;</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
    <span class="n">allocation</span> <span class="o">=</span> <span class="n">allocate</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="p">[</span><span class="n">in_stock_batch</span><span class="p">,</span> <span class="n">shipment_batch</span><span class="p">])</span>
    <span class="k">assert</span> <span class="n">allocation</span> <span class="o">==</span> <span class="n">in_stock_batch</span><span class="o">.</span><span class="n">reference</span>
</pre></div></div></div>
</div></div>
<div class="paragraph"><p>А наш сервис может выглядеть так:</p></div>
<div class="exampleblock" id="domain_service">
<div class="title">Example 20. Автономная функция для нашего доменного сервиса (model.py)</div>
<div class="content">
<div class="listingblock non-head">
<div class="content"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">allocate</span><span class="p">(</span><span class="n">line</span><span class="p">:</span> <span class="n">OrderLine</span><span class="p">,</span> <span class="n">batches</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Batch</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">batch</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span>
        <span class="n">b</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">batches</span><span class="p">)</span> <span class="k">if</span> <span class="n">b</span><span class="o">.</span><span class="n">can_allocate</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">batch</span><span class="o">.</span><span class="n">allocate</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">batch</span><span class="o">.</span><span class="n">reference</span>
</pre></div></div></div>
</div></div>
<div class="sect3">
<h4 id="_магические_методы_python_позволяют_нам_использовать_наши_модели_с_идиоматическим_python">Магические методы Python позволяют нам использовать наши модели с идиоматическим Python</h4>
<div class="paragraph"><p>Вам может понравиться или не понравиться использование <code>next()</code> в предыдущем коде, но мы почти уверены, что вы согласитесь с тем, что возможность использовать <code>sorted()</code> в нашем списке партий&#8201;&#8212;&#8201;это хороший идиоматический Python.</p></div>
<div class="paragraph"><p>Чтобы заставить его работать, мы реализуем <code>__gt__</code> на нашей доменной модели:</p></div>
<div class="exampleblock" id="dunder_gt">
<div class="title">Example 21. Магические методы могут выражать семантику предметной области (model.py)</div>
<div class="content">
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Batch</span><span class="p">:</span>
    <span class="o">...</span>

    <span class="k">def</span> <span class="fm">__gt__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">eta</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">other</span><span class="o">.</span><span class="n">eta</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">eta</span> <span class="o">&gt;</span> <span class="n">other</span><span class="o">.</span><span class="n">eta</span>
</pre></div></div></div>
</div></div>
<div class="paragraph"><p>Это прекрасно.</p></div>
</div>
<div class="sect3">
<h4 id="_исключения_тоже_могут_выражать_концепции_предметной_области">Исключения тоже могут выражать концепции предметной области</h4>
<div class="paragraph"><p>Имеется еще одна, наверное, последняя концепция, которую нужно охватить: исключения также могут использоваться для выражения концепций предметной области. В наших беседах с экспертами в предметной области мы узнали о возможности того, что заказ не может быть размещен, потому что у нас <em>out of stock (нет запасов)</em>, и мы можем зафиксировать это, используя <em>domain exception</em>:</p></div>
<div class="exampleblock" id="test_out_of_stock">
<div class="title">Example 22. Проверка исключения отсутствия на складе (test_allocate.py)</div>
<div class="content">
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">test_raises_out_of_stock_exception_if_cannot_allocate</span><span class="p">():</span>
    <span class="n">batch</span> <span class="o">=</span> <span class="n">Batch</span><span class="p">(</span><span class="s1">&#39;batch1&#39;</span><span class="p">,</span> <span class="s1">&#39;SMALL-FORK&#39;</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">eta</span><span class="o">=</span><span class="n">today</span><span class="p">)</span>
    <span class="n">allocate</span><span class="p">(</span><span class="n">OrderLine</span><span class="p">(</span><span class="s1">&#39;order1&#39;</span><span class="p">,</span> <span class="s1">&#39;SMALL-FORK&#39;</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> <span class="p">[</span><span class="n">batch</span><span class="p">])</span>

    <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="n">OutOfStock</span><span class="p">,</span> <span class="n">match</span><span class="o">=</span><span class="s1">&#39;SMALL-FORK&#39;</span><span class="p">):</span>
        <span class="n">allocate</span><span class="p">(</span><span class="n">OrderLine</span><span class="p">(</span><span class="s1">&#39;order2&#39;</span><span class="p">,</span> <span class="s1">&#39;SMALL-FORK&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">[</span><span class="n">batch</span><span class="p">])</span>
</pre></div></div></div>
</div></div>
<div class="sidebarblock nobreakinside">
<div class="content">
<div class="title">Краткое описание Моделирования предметной области</div>
<div class="dlist"><dl>
<dt class="hdlist1">
Domain modeling
</dt>
<dd>
<p>
    Это та часть вашего кода, которая наиболее близка к бизнесу, наиболее подвержена изменениям и является местом, где вы приносите наибольшую пользу бизнесу. Сделайте его легким для понимания и модификации.
    
</p>
</dd>
<dt class="hdlist1">
Отличия entities от value objects
</dt>
<dd>
<p>
    value objects определяется его атрибутами. Обычно он лучше всего реализуется как неизменяемый тип. Если вы измените атрибут Value Objects, он будет представлять другой объект. Напротив, у entities есть атрибуты, которые могут меняться с течением времени, и она все равно останется той же сущностью. Важно определить, что <em>делает</em> сущность однозначно идентифицируемой (обычно это какое-то имя или ссылочное поле).
    
    
</p>
</dd>
</dl></div>
<div class="paragraph"><p>Не все должно быть объектом:
    Python - это многопарадигмальный язык, поэтому пусть «глаголы» в вашем коде будут функциями. Для каждого <code>FooManager</code>, <code>BarBuilder</code>, или <code>BazFactory</code>, часто бывает более выразительно и читабельно  использовать <code>manage_foo()</code>, <code>build_bar()</code>,     или <code>get_baz()</code> , ожидающие своей очереди.
    </p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
Сейчас самое время применить свои лучшие принципы проектирования ОО
</dt>
<dd>
<p>
        Вернитесь к принципам SOLID и всем остальным хорошим эвристикам, таким как «has вместо is-a», «предпочитать композицию наследованию» и так далее.
    
</p>
</dd>
<dt class="hdlist1">
Вы также захотите подумать о границах согласованности и агрегатах
</dt>
<dd>
<p>
    Но это тема для <a href="#chapter_07_aggregate">[chapter_07_aggregate]</a>.
</p>
</dd>
</dl></div>
</div></div>
<div class="paragraph"><p>Мы не будем слишком утомлять вас реализацией, но главное, что следует отметить, - это то, что мы тщательно называем наши исключения на ubiquitous language, так же как и наши сущности, объекты ценности и службы:</p></div>
<div class="exampleblock" id="out_of_stock">
<div class="title">Example 23. Вызов исключения домена (model.py)</div>
<div class="content">
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">OutOfStock</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="k">def</span> <span class="nf">allocate</span><span class="p">(</span><span class="n">line</span><span class="p">:</span> <span class="n">OrderLine</span><span class="p">,</span> <span class="n">batches</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Batch</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">batch</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span>
        <span class="o">...</span>
    <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">OutOfStock</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Нет в наличии для артикула </span><span class="si">{</span><span class="n">line</span><span class="o">.</span><span class="n">sku</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div></div></div>
</div></div>
<div class="paragraph"><p><a href="#maps_chapter_01_withtext">[maps_chapter_01_withtext]</a> это визуальное представление того, где мы оказались.</p></div>
<div class="imageblock" id="maps_chapter_01_withtext">
<div class="content">
<img src="images/apwp_0104.png" alt="images/apwp_0104.png" />
</div>
<div class="title">Figure 7. Наша модель предметной области в конце главы</div>
</div>
<div class="paragraph"><p>Пожалуй, на сегодня хватит! У нас есть доменная служба, которую мы можем использовать для нашего первого варианта использования. Но сначала нам понадобится база данных&#8230;</p></div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="chapter_02_repository">Repository Pattern</h2>
<div class="sectionbody">
<div class="paragraph"><p>Пришло время выполнить обещание использовать принцип инверсии зависимостей как способ отделить основную логику от инфраструктурных проблем.</p></div>
<div class="paragraph"><p>Представляем вам шаблон <em>Repository</em>, он упрощает абстракцию над хранилищем данных, позволяющую нам отделить слой модели от слоя данных. Давайте приведем конкретный пример того, как эта упрощающая абстракция делает нашу систему более тестируемой, скрывая сложности базы данных.</p></div>
<div class="paragraph"><p>Картина <a href="#maps_chapter_02">[maps_chapter_02]</a> илюстрирует то, что мы собираемся построить: объект <code>Repository</code>, который находится между нашей моделью предметной области и базой данных.</p></div>
<div class="imageblock" id="maps_chapter_02">
<div class="content">
<img src="images/apwp_0201.png" alt="images/apwp_0201.png" />
</div>
<div class="title">Figure 8. До и после шаблона репозитория</div>
</div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/tip.png" alt="Tip" />
</td>
<td class="content">
<div class="paragraph"><p>Код для этой главы находится в
chapter_02_repository branch <a href="https://oreil.ly/6STDu">on GitHub</a>.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>git clone https://github.com/cosmicpython/code.git
cd code
git checkout chapter_02_repository
# или чтобы писать код вместе с нами, ознакомьтесь с предыдущей главой:
git checkout chapter_01_domain_model</code></pre>
</div></div>
</td>
</tr></table>
</div>
<div class="sect2">
<h3 id="_persisting_our_domain_model">Persisting Our Domain Model</h3>
<div class="paragraph"><p>В <a href="#chapter_01_domain_model">[chapter_01_domain_model]</a> мы построили простую модель домена, которая может распределять заказы по партиям запасов. Мы относительно легко написали тесты для такого кода, потому что нет никаких зависимостей или инфраструктуры для настройки. Если бы нужно было запустить базу данных или API и создать тестовые данные, тесты было бы сложнее писать и поддерживать.</p></div>
<div class="paragraph"><p>К сожалению, в какой-то момент нам придется передать эту идеальную маленькую модель в руки пользователей и бороться с реальным миром электронных таблиц, веб-браузеров и условий гонки. В следующих нескольких главах мы рассмотрим, как связать идеализированную модель предметной области с внешним состоянием.</p></div>
<div class="paragraph"><p>В надежде на то, что мы будем работать гибко, наш основной приоритет&#8201;&#8212;&#8201;как можно быстрее получить минимально жизнеспособный продукт. В нашем случае это будет веб-API. В реальном проекте вы можете сразу погрузиться в несколько сквозных (end-to-end) тестов и начать подключать веб-фреймворк, тестируя функционал извне.</p></div>
<div class="paragraph"><p>Но мы знаем, что, несмотря ни на что, нам понадобится какая-то форма постоянного хранения. Поскольку это учебник, мы можем позволить себе немного больше развития снизу вверх и начать думать о хранении и базах данных.</p></div>
</div>
<div class="sect2">
<h3 id="_псевдокод_что_делать_то_будем">Псевдокод: Что делать то будем?</h3>
<div class="paragraph"><p>Когда мы создаём наш первый endpoint API, подразумеваем, что у нас будет некоторый код, который выглядит более или менее похожим на этот.</p></div>
<div class="exampleblock" id="api_endpoint_pseudocode">
<div class="title">Example 24. Как будет выглядеть наш первый endpoint API</div>
<div class="content">
<div class="listingblock skip">
<div class="content"><div class="highlight"><pre><span></span><span class="nd">@flask</span><span class="o">.</span><span class="n">route</span><span class="o">.</span><span class="n">gubbins</span>
<span class="k">def</span> <span class="nf">allocate_endpoint</span><span class="p">():</span>
    <span class="c1"># извлечь строку заказа из запроса</span>
    <span class="n">line</span> <span class="o">=</span> <span class="n">OrderLine</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>
    <span class="c1"># загрузить все партии из БД</span>
    <span class="n">batches</span> <span class="o">=</span> <span class="o">...</span>
    <span class="c1"># передать в domain service</span>
    <span class="n">allocate</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">batches</span><span class="p">)</span>
    <span class="c1"># затем сохраните выделеные позици обратно в базу данных</span>
    <span class="k">return</span> <span class="mi">201</span>
</pre></div></div></div>
</div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note" />
</td>
<td class="content">Мы использовали Flask, потому что он достаточно простой, но вам не нужно быть с Flask на "ты", чтобы понять эту книгу. На самом деле, наша задача объяснить, как сделать выбор фреймворка незначительной деталью.
    </td>
</tr></table>
</div>
<div class="paragraph"><p>Нам понадобится способ извлечения пакетной информации из базы данных и создания из нее экземпляров объектов модели домена, а также способ сохранения их обратно в базу данных.</p></div>
<div class="paragraph"><p><em>Какого&#8230;? Ух-х-х, «gubbins» - это британское слово, означающее «фигня». Вы можете просто забить на это. Это&#8217;ж псевдокод, понятно?</em></p></div>
</div>
<div class="sect2">
<h3 id="_применение_dip_для_доступа_к_данным">Применение DIP для доступа к данным</h3>
<div class="paragraph"><p>Как уже упоминалось в <a href="#введение">введение</a>, многоуровневая архитектура&#8201;&#8212;&#8201;это общий подход к структурированию системы, которая имеет пользовательский интерфейс, некоторую логику и базу данных (см.
<a href="#layered_architecture2">[layered_architecture2]</a>).</p></div>
<div class="imageblock width-75" id="layered_architecture2">
<div class="content">
<img src="images/apwp_0202.png" alt="images/apwp_0202.png" />
</div>
<div class="title">Figure 9. Многослойная архитектура</div>
</div>
<div class="paragraph"><p>Структура Django Model-View-Template тесно связана, как и Model-View-Controller (MVC). В любом случае цель состоит в том, чтобы слои были разделены (что хорошо), и чтобы каждый слой зависел только от того, который находится под ним.</p></div>
<div class="paragraph"><p>Надо, чтобы в нашей модели предметной области не было <em> никаких зависимостей </em>.<span class="footnote"><br />[ Полагаю, мы имеем в виду «отсутствие зависимостей с отслеживанием состояния». В зависимости от вспомогательной библиотеки это нормально; в зависимости от ORM или веб-фреймворка&#8201;&#8212;&#8201;нет.]<br /></span> Не надо, чтобы проблемы с инфраструктурой проникли в нашу модель предметной области и замедлили наши модульные тесты или нашу способность вносить изменения.</p></div>
<div class="paragraph"><p>Вместо этого, как обсуждалось во введении, мы будем думать, что наша модель находится "inside (внутри)", и зависимости текут внутрь неё; это то, что умные люди иногда называют <em>onion (луковая) architecture</em> (см. <a href="#onion_architecture">[onion_architecture]</a>).</p></div>
<div class="imageblock width-75" id="onion_architecture">
<div class="content">
<img src="images/apwp_0203.png" alt="images/apwp_0203.png" />
</div>
<div class="title">Figure 10. Onion architecture</div>
</div>
<div class="listingblock image-source">
<div class="content">
<pre><code>[ditaa, apwp_0203]
+------------------------+
|   Presentation Layer   |
+------------------------+
           |
           V
+--------------------------------------------------+
|                  Domain Model                    |
+--------------------------------------------------+
                                        ^
                                        |
                             +---------------------+
                             |    Database Layer   |
                             +---------------------+</code></pre>
</div></div>
<div class="sidebarblock nobreakinside less_space">
<div class="content">
<div class="title">Это Порты и Адаптеры?</div>
<div class="paragraph"><p>Если вы читали об архитектурных паттернах, вы можете задавать себе такие вопросы:</p></div>
<div class="quoteblock">
<div class="content">
<div class="paragraph"><p><em>Это порты и адаптеры? Или это гексогональная архитектура? Это то же самое, что и луковая архитектура? А как насчет чистой архитектуры? Что такое порт и что такое адаптер? Почему у вас, "яйцеголовых", так много слов для одного и того же?</em></p></div>
</div>
<div class="attribution">
</div></div>
<div class="paragraph"><p>Хотя некоторые умники любят придираться к различиям, все это в значительной степени названия одного и того же, и все они сводятся к принципу инверсии зависимостей: модули высокого уровня (домен) не должны зависеть от модулей низкого уровня (инфраструктура).<span class="footnote"><br />[Mark Seemann has
<a href="https://oreil.ly/LpFS9">an excellent blog post</a> on the topic.]<br /></span></p></div>
<div class="paragraph"><p>Мы рассмотрим некоторые мелочи, касающиеся «зависимости от абстракций», и того, существует ли Pythonic-эквивалент интерфейсов,
<a href="#depend_on_abstractions">later in the book</a>. Смотрите также <a href="#what_is_a_port_and_what_is_an_adapter">[what_is_a_port_and_what_is_an_adapter]</a>.</p></div>
</div></div>
</div>
<div class="sect2">
<h3 id="_напоминание_наша_модель">Напоминание: Наша модель</h3>
<div class="paragraph"><p>Давайте вспомним нашу модель предметной области (см. <a href="#model_diagram_reminder">[model_diagram_reminder]</a>):
Распределение - это концепция связывания <code>OrderLine</code> с <code>Batch</code>. Мы сохраняем выделенные позиици как коллекцию в нашем объекте <code>Batch</code>.</p></div>
<div class="imageblock" id="model_diagram_reminder">
<div class="content">
<img src="images/apwp_0103.png" alt="images/apwp_0103.png" />
</div>
<div class="title">Figure 11. Наша модель</div>
</div>
<div class="paragraph"><p>Давайте посмотрим, как мы можем перенести это в реляционную базу данных.</p></div>
<div class="sect3">
<h4 id="_нормальный_способ_это_orm_модель_зависит_от_orm">"Нормальный" способ это ORM: Модель зависит от ORM</h4>
<div class="paragraph"><p>В наши дни маловероятно, что члены вашей команды вручную создают свои собственные SQL-запросы. Вместо этого вы почти наверняка используете какой-то фреймворк для генерации строк SQL на основе ваших объектов модели.</p></div>
<div class="paragraph"><p>Эти структуры называются объектно-реляционными картографами <em>object-relational mappers</em> (ОРМ), поскольку они существуют для преодоления концептуального разрыва между миром объектов и моделирования предметной области и миром баз данных и реляционной алгебры.</p></div>
<div class="paragraph"><p>Самая важная вещь, которую дает нам ORM, - это игнорирование сохраняемости <em>persistence ignorance</em>: идея в том, что наша доменная модель не должна ничего знать о том, как данные загружаются или сохраняются. Это помогает сохранить наш домен чистым от прямых зависимостей конкретных технологий баз данных.<span class="footnote"><br />[В этом смысле использование ORM уже является примером DIP. Вместо того чтобы полагаться на жестко запрограммированный SQL, мы зависим от абстракции, ORM. Но нам этого мало&#8201;&#8212;&#8201;не в этой книге!]<br /></span></p></div>
<div class="paragraph"><p>Но если вы будете следовать типичному учебнику SQLAlchemy, то в итоге получите что-то вроде этого:</p></div>
<div class="exampleblock" id="typical_sqlalchemy_example">
<div class="title">Example 25. SQLAlchemy "декларативный" синтаксис, модель зависит от ORM (orm.py)</div>
<div class="content">
<div class="listingblock skip">
<div class="content"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">Column</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">String</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.ext.declarative</span> <span class="kn">import</span> <span class="n">declarative_base</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">relationship</span>

<span class="n">Base</span> <span class="o">=</span> <span class="n">declarative_base</span><span class="p">()</span>

<span class="k">class</span> <span class="nc">Order</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">OrderLine</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">sku</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">250</span><span class="p">))</span>
    <span class="n">qty</span> <span class="o">=</span> <span class="n">Integer</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">250</span><span class="p">))</span>
    <span class="n">order_id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;order.id&#39;</span><span class="p">))</span>
    <span class="n">order</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="n">Order</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">Allocation</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="o">...</span>
</pre></div></div></div>
</div></div>
<div class="paragraph"><p>Вам не нужно разбираться в SQLAlchemy, чтобы увидеть, что наша изначальная модель теперь полна зависимостей от ORM и к тому же начинает выглядеть чертовски уродливо. Можно ли сказать, что эта модель игнорирует базу данных? Как это можно отделить от проблем с хранением, когда свойства нашей модели напрямую связаны со столбцами базы данных?</p></div>
<div class="sidebarblock nobreakinside less_space">
<div class="content">
<div class="title">ORM Django, по сути, тот же, но более строгий</div>
<div class="paragraph"><p>Если вы больше привыкли к Django, предыдущий «декларативный» фрагмент SQLAlchemy можно перевести примерно так:</p></div>
<div class="exampleblock" id="django_orm_example">
<div class="title">Example 26. Django ORM пример</div>
<div class="content">
<div class="listingblock skip">
<div class="content"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Order</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="k">pass</span>

<span class="k">class</span> <span class="nc">OrderLine</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">sku</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">255</span><span class="p">)</span>
    <span class="n">qty</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">IntegerField</span><span class="p">()</span>
    <span class="n">order</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">Order</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">Allocation</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="o">...</span>
</pre></div></div></div>
</div></div>
<div class="paragraph"><p>Дело в том же - наши классы моделей наследуются напрямую от классов ORM, поэтому наша модель зависит от ORM. Мы хотим, чтобы все было наоборот.</p></div>
<div class="paragraph"><p>Django не предоставляет эквивалента классическому мапперу SQLAlchemy, но примеры применения инверсии зависимостей и шаблона репозитория к Django см. в разделе <a href="#appendix_django">[appendix_django]</a>.</p></div>
</div></div>
</div>
<div class="sect3">
<h4 id="_инвертирование_зависимости_orm_зависит_от_модели">Инвертирование зависимости: ORM зависит от модели</h4>
<div class="paragraph"><p>К счастью, это не единственный способ использовать SQLAlchemy. Альтернативой является определение вашей схемы отдельно и определение явного <em>mapper</em>-а для преобразования между схемой и нашей моделью предметной области, что SQLAlchemy называет
<a href="https://oreil.ly/ZucTG">classical mapping</a>:</p></div>
<div class="exampleblock nobreakinside less_space" id="sqlalchemy_classical_mapper">
<div class="title">Example 27. Явное сопоставление ORM с объектами таблицы SQLAlchemy (orm.py)</div>
<div class="content">
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">mapper</span><span class="p">,</span> <span class="n">relationship</span>

<span class="kn">import</span> <span class="nn">model</span>  <span class="c1">#<img src="./images/icons/callouts/1.png" alt="1" /></span>


<span class="n">metadata</span> <span class="o">=</span> <span class="n">MetaData</span><span class="p">()</span>

<span class="n">order_lines</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span>  <span class="c1">#<img src="./images/icons/callouts/2.png" alt="2" /></span>
    <span class="s1">&#39;order_lines&#39;</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span>
    <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">autoincrement</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
    <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;sku&#39;</span><span class="p">,</span> <span class="n">String</span><span class="p">(</span><span class="mi">255</span><span class="p">)),</span>
    <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;qty&#39;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
    <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;orderid&#39;</span><span class="p">,</span> <span class="n">String</span><span class="p">(</span><span class="mi">255</span><span class="p">)),</span>
<span class="p">)</span>

<span class="o">...</span>

<span class="k">def</span> <span class="nf">start_mappers</span><span class="p">():</span>
    <span class="n">lines_mapper</span> <span class="o">=</span> <span class="n">mapper</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">OrderLine</span><span class="p">,</span> <span class="n">order_lines</span><span class="p">)</span>  <span class="c1">#<img src="./images/icons/callouts/3.png" alt="3" /></span>
</pre></div></div></div>
</div></div>
<div class="colist arabic"><table>
<tr><td><img src="./images/icons/callouts/1.png" alt="1" /></td><td>
ORM импортирует (или "зависит от" или "знает о") модель предметной области, а не наоборот.
</td></tr>
<tr><td><img src="./images/icons/callouts/2.png" alt="2" /></td><td>
Мы определяем таблицы и столбцы нашей базы данных с помощью абстракций SQLAlchemy.<span class="footnote"><br />[Даже в проектах, где мы не используем ORM, мы часто используем SQLAlchemy вместе с Alembic для декларативного создания схем в Python и управления миграциями, соединениями и сеансами.]<br /></span>
</td></tr>
<tr><td><img src="./images/icons/callouts/3.png" alt="3" /></td><td>
Когда мы вызываем функцию <code>mapper</code>, SQLAlchemy творит чудеса, связывая классы нашей модели предметной области с различными таблицами, которые мы определили.
</td></tr>
</table></div>
<div class="paragraph"><p>Конечным результатом будет то, что, если мы вызовем <code>start_mappers</code>, мы сможем легко загружать и сохранять экземпляры модели домена из базы данных и в нее. Но если мы никогда не вызываем эту функцию, наши классы доменных моделей остаются в блаженном неведении о базе данных.</p></div>
<div class="paragraph"><p>Это дает нам все преимущества SQLAlchemy, включая возможность использовать <code>alembic</code> для миграций и возможность прозрачного запроса с использованием наших классов домена, как мы увидим.</p></div>
<div class="paragraph"><p>Когда вы впервые пытаетесь создать свою конфигурацию ORM, может быть полезно написать для неё тесты, как в следующем примере:</p></div>
<div class="exampleblock" id="orm_tests">
<div class="title">Example 28. Тестирование ОРМ напрямую (одноразовые тесты) (test_orm.py)</div>
<div class="content">
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">test_orderline_mapper_can_load_lines</span><span class="p">(</span><span class="n">session</span><span class="p">):</span>  <span class="c1">#<img src="./images/icons/callouts/1.png" alt="1" /></span>
    <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="s1">&#39;INSERT INTO order_lines (orderid, sku, qty) VALUES &#39;</span>
        <span class="s1">&#39;(&quot;order1&quot;, &quot;RED-CHAIR&quot;, 12),&#39;</span>
        <span class="s1">&#39;(&quot;order1&quot;, &quot;RED-TABLE&quot;, 13),&#39;</span>
        <span class="s1">&#39;(&quot;order2&quot;, &quot;BLUE-LIPSTICK&quot;, 14)&#39;</span>
    <span class="p">)</span>
    <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">model</span><span class="o">.</span><span class="n">OrderLine</span><span class="p">(</span><span class="s2">&quot;order1&quot;</span><span class="p">,</span> <span class="s2">&quot;RED-CHAIR&quot;</span><span class="p">,</span> <span class="mi">12</span><span class="p">),</span>
        <span class="n">model</span><span class="o">.</span><span class="n">OrderLine</span><span class="p">(</span><span class="s2">&quot;order1&quot;</span><span class="p">,</span> <span class="s2">&quot;RED-TABLE&quot;</span><span class="p">,</span> <span class="mi">13</span><span class="p">),</span>
        <span class="n">model</span><span class="o">.</span><span class="n">OrderLine</span><span class="p">(</span><span class="s2">&quot;order2&quot;</span><span class="p">,</span> <span class="s2">&quot;BLUE-LIPSTICK&quot;</span><span class="p">,</span> <span class="mi">14</span><span class="p">),</span>
    <span class="p">]</span>
    <span class="k">assert</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">OrderLine</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span> <span class="o">==</span> <span class="n">expected</span>


<span class="k">def</span> <span class="nf">test_orderline_mapper_can_save_lines</span><span class="p">(</span><span class="n">session</span><span class="p">):</span>
    <span class="n">new_line</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">OrderLine</span><span class="p">(</span><span class="s2">&quot;order1&quot;</span><span class="p">,</span> <span class="s2">&quot;DECORATIVE-WIDGET&quot;</span><span class="p">,</span> <span class="mi">12</span><span class="p">)</span>
    <span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">new_line</span><span class="p">)</span>
    <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

    <span class="n">rows</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;SELECT orderid, sku, qty FROM &quot;order_lines&quot;&#39;</span><span class="p">))</span>
    <span class="k">assert</span> <span class="n">rows</span> <span class="o">==</span> <span class="p">[(</span><span class="s2">&quot;order1&quot;</span><span class="p">,</span> <span class="s2">&quot;DECORATIVE-WIDGET&quot;</span><span class="p">,</span> <span class="mi">12</span><span class="p">)]</span>
</pre></div></div></div>
</div></div>
<div class="colist arabic"><table>
<tr><td><img src="./images/icons/callouts/1.png" alt="1" /></td><td>
Если вы не использовали pytest, то аргумент <code>session</code> для этого теста нуждается в объяснении. Смысл такой: Вам не нужно беспокоиться о деталях pytest или его фикстурах в целях этой книги, но главная мысль состоит в том, что вы можете определить общие зависимости для ваших тестов в виде "fixtures", и pytest передаст их в тесты, которые нуждаются в них, приняв их в качестве аргументов функций. В данном случае это сеанс <code>session</code> базы данных SQLAlchemy.
    
</td></tr>
</table></div>
<div class="paragraph"><p>Вероятно, вам не стоит хранить эти тесты. Как вы вскоре увидите, после того, как поближе познакомитесь с инверсией зависимости ORM и модели предметной области, это всего лишь небольшой дополнительный шаг для реализации другой абстракции, называемой шаблоном репозитория, для которого будет легче писать тесты, и он предоставит простой интерфейс для, скажем так&#8201;&#8212;&#8201;фейка, позже в тестах.</p></div>
<div class="paragraph"><p>Но мы уже достигли нашей цели инвертировать традиционную зависимость: модель предметной области остается «чистой» и свободной от инфраструктурных проблем. Мы могли бы выбросить SQLAlchemy и использовать другую ORM или совершенно другую систему сохранения, и модель предметной области вообще не нуждалась бы в изменении.</p></div>
<div class="paragraph"><p>В зависимости от того, что вы делаете в своей модели предметной области, и особенно если вы отходите далеко от парадигмы объектно-ориентированного программирования, вам может оказаться все труднее заставить ORM обеспечить точное поведение, которое вам нужно, и вам может потребоваться изменить модель предметной области. <span class="footnote"><br />[Привет чрезвычайно полезным специалистам по сопровождению SQLAlchemy и, в частности, Майку Байеру.]<br /></span> Как это часто бывает с архитектурными решениями, вам нужно будет найти компромисс. Как говорит дзэн Python: «Практичность лучше чистоты!»</p></div>
<div class="paragraph"><p>На данный момент, однако, наш endpoint API может выглядеть примерно так, и мы могли бы заставить её работать просто отлично:</p></div>
<div class="exampleblock" id="api_endpoint_with_session">
<div class="title">Example 29. Использование SQLAlchemy непосредственно в нашем endpoint API</div>
<div class="content">
<div class="listingblock skip">
<div class="content"><div class="highlight"><pre><span></span><span class="nd">@flask</span><span class="o">.</span><span class="n">route</span><span class="o">.</span><span class="n">gubbins</span>
<span class="k">def</span> <span class="nf">allocate_endpoint</span><span class="p">():</span>
    <span class="n">session</span> <span class="o">=</span> <span class="n">start_session</span><span class="p">()</span>

    <span class="c1"># извлечение строки заказа из запроса</span>
    <span class="n">line</span> <span class="o">=</span> <span class="n">OrderLine</span><span class="p">(</span>
        <span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="s1">&#39;orderid&#39;</span><span class="p">],</span>
        <span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="s1">&#39;sku&#39;</span><span class="p">],</span>
        <span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="s1">&#39;qty&#39;</span><span class="p">],</span>
    <span class="p">)</span>

    <span class="c1"># загрузите все пакеты из БД</span>
    <span class="n">batches</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Batch</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

    <span class="c1"># call our domain service</span>
    <span class="n">allocate</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">batches</span><span class="p">)</span>

    <span class="c1"># сохраните распределения обратно в базу данных</span>
    <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

    <span class="k">return</span> <span class="mi">201</span>
</pre></div></div></div>
</div></div>
</div>
</div>
<div class="sect2">
<h3 id="_знакомство_с_шаблоном_репозитория">Знакомство с шаблоном репозитория</h3>
<div class="paragraph"><p>Шаблон <em>Repository</em>&#8201;&#8212;&#8201;это абстракция над постоянным хранилищем. Он скрывает скучные детали доступа к данным, делая вид, что все наши данные находятся в памяти.</p></div>
<div class="paragraph"><p>Если бы у нас была бесконечная память в наших ноутбуках, у нас не было бы необходимости в неуклюжих базах данных. Вместо этого мы могли просто использовать наши объекты, когда нам заблагорассудится. Как это будет выглядеть?</p></div>
<div class="exampleblock" id="all_my_data">
<div class="title">Example 30. Вы должны откуда-то брать данные</div>
<div class="content">
<div class="listingblock skip">
<div class="content"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">all_my_data</span>

<span class="k">def</span> <span class="nf">create_a_batch</span><span class="p">():</span>
    <span class="n">batch</span> <span class="o">=</span> <span class="n">Batch</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
    <span class="n">all_my_data</span><span class="o">.</span><span class="n">batches</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">modify_a_batch</span><span class="p">(</span><span class="n">batch_id</span><span class="p">,</span> <span class="n">new_quantity</span><span class="p">):</span>
    <span class="n">batch</span> <span class="o">=</span> <span class="n">all_my_data</span><span class="o">.</span><span class="n">batches</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">batch_id</span><span class="p">)</span>
    <span class="n">batch</span><span class="o">.</span><span class="n">change_initial_quantity</span><span class="p">(</span><span class="n">new_quantity</span><span class="p">)</span>
</pre></div></div></div>
</div></div>
<div class="paragraph"><p>Несмотря на то, что наши объекты находятся в памяти, нам нужно поместить их где-нибудь, чтобы снова найти их. Наши данные в памяти позволят нам добавлять новые объекты, как список или множество. Поскольку объекты находятся в памяти, нам никогда не нужно вызывать метод <code>.save ()</code>; мы просто получаем объект, который нам нужен, и модифицируем его в памяти.</p></div>
<div class="sect3">
<h4 id="_the_repository_in_the_abstract">The Repository in the Abstract</h4>
<div class="paragraph"><p>В простейшем репозитории всего два метода: add () для добавления нового элемента в репозиторий и get() для возврата ранее добавленного элемента.<span class="footnote"><br />[ Вы можете подумать: «А как насчет <code>list</code>, <code>delete</code> или <code>update</code>?" Однако в идеальном мире мы модифицируем объекты нашей модели по одному, а удаление обычно обрабатывается как мягкое удаление, то есть <code>batch.cancel ()</code>. Наконец, об обновлении позаботится шаблон Unit of Work, как вы увидите в <a href="#chapter_06_uow">[chapter_06_uow]</a>.]<br /></span></p></div>
<div class="paragraph"><p>Мы твердо придерживаемся использования этих методов для доступа к данным в нашем домене и на уровне сервиса. Эта добровольная простота не позволяет нам связать нашу модель предметной области с базой данных.</p></div>
<div class="paragraph"><p>Вот как будет выглядеть абстрактный базовый класс (ABC) для нашего репозитория:</p></div>
<div class="exampleblock" id="abstract_repo">
<div class="title">Example 31. Самый простой из возможных репозиториев (repository.py)</div>
<div class="content">
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">AbstractRepository</span><span class="p">(</span><span class="n">abc</span><span class="o">.</span><span class="n">ABC</span><span class="p">):</span>

    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>  <span class="c1">#<img src="./images/icons/callouts/1.png" alt="1" /></span>
    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">Batch</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>  <span class="c1">#<img src="./images/icons/callouts/2.png" alt="2" /></span>

    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reference</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">model</span><span class="o">.</span><span class="n">Batch</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>
</pre></div></div></div>
</div></div>
<div class="colist arabic"><table>
<tr><td><img src="./images/icons/callouts/1.png" alt="1" /></td><td>
Python tip: <code>@abc.abstractmethod</code>&#8201;&#8212;&#8201;это одна из немногих вещей, которая заставляет ABCs действительно "работать" в Python. Python не позволит вам создать экземпляр класса, который не реализует все "абстрактные методы", определенные в его родительском классе.<span class="footnote"><br />[Чтобы действительно воспользоваться преимуществами ABC (какими бы они ни были), запустите помощники, такие как <code>pylint</code> и <code>mypy</code>.]<br /></span>
    
    
</td></tr>
<tr><td><img src="./images/icons/callouts/2.png" alt="2" /></td><td>
<code>raise NotImplementedError</code>&#8201;&#8212;&#8201;это хорошо, но это не обязательно и не достаточно. На самом деле, ваши абстрактные методы могут иметь реальное поведение, которое подклассы могут вызвать, если вы действительно хотите.
</td></tr>
</table></div>
<div class="sidebarblock pagebreak-before less_space">
<div class="content">
<div class="title">Абстрактные базовые классы, утиная типизация и протоколы</div>
<div class="paragraph"><p>Мы используем абстрактные базовые классы в этой книге по дидактическим соображениям: мы надеемся, что они помогут объяснить, что такое интерфейс абстракции репозитория.</p></div>
<div class="paragraph"><p>В реальной жизни мы иногда обнаруживаем, что удаляем ABC из нашего продакшен кода, потому что Python слишком упрощает их игнорирование, и они в конечном итоге не обслуживаются и, в худшем случае, вводят в заблуждение. На практике мы часто просто полагаемся на утиную типизацию Python для включения абстракций. Для Pythonista репозиторий&#8201;&#8212;&#8201;это <em>любой</em> объект, имеющий <code>add(<em>thing</em>)</code> and <code>get(<em>id</em>)</code> methods.</p></div>
<div class="paragraph"><p>Альтернативой для изучения является <a href="https://oreil.ly/q9EPC">PEP 544 protocols</a>. Это дает вам возможность писать классы без возможного использования наследования, что особенно понравится фанатам "предпочитать композицию наследованию".</p></div>
</div></div>
</div>
<div class="sect3">
<h4 id="_что_такое_компромисс">Что такое компромисс?</h4>
<div class="quoteblock">
<div class="content">
<div class="paragraph"><p>Знаете, говорят, что экономисты знают всё о цене и ничего о ценности? Программисты же, знают всё о преимуществе и ничего о компромисе.</p></div>
</div>
<div class="attribution">
&#8212; Рич Хикки
</div></div>
<div class="paragraph"><p>Всякий раз, когда мы представляем архитектурный паттерн в этой книге, мы всегда задаёмся вопроосом: «Что нам ЭТО даст? И во что нам ЭТО обойдётся?»</p></div>
<div class="paragraph"><p>Обычно, вводя дополнительный уровень абстракции, мы по крайней мере надеемся, что это уменьшит сложность в целом, а в действительности всё это добавляет сложности локальной и имеет свою стоимость с точки зрения необработанного количества перемещений и текущего обслуживания.</p></div>
<div class="paragraph"><p>Шаблон репозитория, вероятно, является одним из самых простых вариантов в книге, если вы уже идёте по пути DDD и инверсии зависимостей.  Что касается нашего кода, на самом деле мы просто меняем абстракцию SQLAlchemy (<code>session.query (Batch)</code>) на другую (<code>batches_repo.get</code>), которую мы разработали.</p></div>
<div class="paragraph"><p>Нам придется добавлять несколько строк кода в нашем классе репозитория каждый раз, когда мы добавляем новый объект домена, который мы хотим получить, но взамен мы получаем простую абстракцию над нашим уровнем хранения, который мы контролируем. Шаблон репозитория позволит легко вносить фундаментальные изменения в то, как мы храним объекты (см. <a href="#appendix_csvs">[appendix_csvs]</a>), и, как мы увидим, его легко подменить для модульных тестов.</p></div>
<div class="paragraph"><p>Кроме того, шаблон репозитория настолько распространен в мире DDD, что, если вы сотрудничаете с программистами, пришедшими в Python из мира Java и C#, они, скорее всего, узнают его. <a href="#repository_pattern_diagram">[repository_pattern_diagram]</a> иллюстрирует этот паттерн.</p></div>
<div class="imageblock width-60" id="repository_pattern_diagram">
<div class="content">
<img src="images/apwp_0205.png" alt="images/apwp_0205.png" />
</div>
<div class="title">Figure 12. Repository pattern</div>
</div>
<div class="listingblock image-source">
<div class="content">
<pre><code>[ditaa, apwp_0205]
  +-----------------------------+
  |      Application Layer      |
  +-----------------------------+
                 |^
                 ||          /------------------\
                 ||----------|   Domain Model   |
                 ||          |      Objects     |
                 ||          \------------------/
                 V|
  +------------------------------+
  |          Repository          |
  +------------------------------+
                 |
                 V
  +------------------------------+
  |        Database Layer        |
  +------------------------------+</code></pre>
</div></div>
<div class="paragraph"><p>Как всегда, мы начинаем с теста. Это, вероятно, было бы классифицировано как интеграционный тест, поскольку мы проверяем, что наш код (репозиторий) правильно интегрирован с базой данных; следовательно, тесты, как правило, смешивают необработанный SQL с вызовами и ассертами в нашем собственном коде.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/tip.png" alt="Tip" />
</td>
<td class="content">В отличие от предыдущих тестов ORM, эти тесты являются хорошими кандидатами на то, чтобы оставаться частью вашей кодовой базы в долгосрочной перспективе, особенно если какие-либо части вашей модели предметной области означают, что объектно-реляционная карта нетривиальна.</td>
</tr></table>
</div>
<div class="exampleblock" id="repo_test_save">
<div class="title">Example 32. Тест репозитория для сохранения объекта (test_repository.py)</div>
<div class="content">
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">test_repository_can_save_a_batch</span><span class="p">(</span><span class="n">session</span><span class="p">):</span>
    <span class="n">batch</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">Batch</span><span class="p">(</span><span class="s2">&quot;batch1&quot;</span><span class="p">,</span> <span class="s2">&quot;RUSTY-SOAPDISH&quot;</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="n">eta</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

    <span class="n">repo</span> <span class="o">=</span> <span class="n">repository</span><span class="o">.</span><span class="n">SqlAlchemyRepository</span><span class="p">(</span><span class="n">session</span><span class="p">)</span>
    <span class="n">repo</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>  <span class="c1">#<img src="./images/icons/callouts/1.png" alt="1" /></span>
    <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>  <span class="c1">#<img src="./images/icons/callouts/2.png" alt="2" /></span>

    <span class="n">rows</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="s1">&#39;SELECT reference, sku, _purchased_quantity, eta FROM &quot;batches&quot;&#39;</span>  <span class="c1">#<img src="./images/icons/callouts/3.png" alt="3" /></span>
    <span class="p">))</span>
    <span class="k">assert</span> <span class="n">rows</span> <span class="o">==</span> <span class="p">[(</span><span class="s2">&quot;batch1&quot;</span><span class="p">,</span> <span class="s2">&quot;RUSTY-SOAPDISH&quot;</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="kc">None</span><span class="p">)]</span>
</pre></div></div></div>
</div></div>
<div class="colist arabic"><table>
<tr><td><img src="./images/icons/callouts/1.png" alt="1" /></td><td>
<code>repo.add()</code> это тестируемый здесь метод.
</td></tr>
<tr><td><img src="./images/icons/callouts/2.png" alt="2" /></td><td>
Мы храним <code>.commit()</code> вне репозитория и возлагаем ответственность на вызывающего. В этом есть свои плюсы и минусы; некоторые из причин станут яснее, когда мы доберемся до <a href="#chapter_06_uow">[chapter_06_uow]</a>.
</td></tr>
<tr><td><img src="./images/icons/callouts/3.png" alt="3" /></td><td>
Используем необработанный SQL, чтобы убедиться, что были сохраненыправильные данные .
</td></tr>
</table></div>
<div class="paragraph"><p>Следующий тест включает в себя извлечение пакетов и распределений, поэтому он более сложный:</p></div>
<div class="exampleblock" id="repo_test_retrieve">
<div class="title">Example 33. Тест репозитория для извлечения сложного объекта (test_repository.py)</div>
<div class="content">
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">insert_order_line</span><span class="p">(</span><span class="n">session</span><span class="p">):</span>
    <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>  <span class="c1">#<img src="./images/icons/callouts/1.png" alt="1" /></span>
        <span class="s1">&#39;INSERT INTO order_lines (orderid, sku, qty)&#39;</span>
        <span class="s1">&#39; VALUES (&quot;order1&quot;, &quot;GENERIC-SOFA&quot;, 12)&#39;</span>
    <span class="p">)</span>
    <span class="p">[[</span><span class="n">orderline_id</span><span class="p">]]</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="s1">&#39;SELECT id FROM order_lines WHERE orderid=:orderid AND sku=:sku&#39;</span><span class="p">,</span>
        <span class="nb">dict</span><span class="p">(</span><span class="n">orderid</span><span class="o">=</span><span class="s2">&quot;order1&quot;</span><span class="p">,</span> <span class="n">sku</span><span class="o">=</span><span class="s2">&quot;GENERIC-SOFA&quot;</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">orderline_id</span>

<span class="k">def</span> <span class="nf">insert_batch</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">batch_id</span><span class="p">):</span>  <span class="c1">#<img src="./images/icons/callouts/2.png" alt="2" /></span>
    <span class="o">...</span>

<span class="k">def</span> <span class="nf">test_repository_can_retrieve_a_batch_with_allocations</span><span class="p">(</span><span class="n">session</span><span class="p">):</span>
    <span class="n">orderline_id</span> <span class="o">=</span> <span class="n">insert_order_line</span><span class="p">(</span><span class="n">session</span><span class="p">)</span>
    <span class="n">batch1_id</span> <span class="o">=</span> <span class="n">insert_batch</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="s2">&quot;batch1&quot;</span><span class="p">)</span>
    <span class="n">insert_batch</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="s2">&quot;batch2&quot;</span><span class="p">)</span>
    <span class="n">insert_allocation</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">orderline_id</span><span class="p">,</span> <span class="n">batch1_id</span><span class="p">)</span>  <span class="c1">#<img src="./images/icons/callouts/2.png" alt="2" /></span>

    <span class="n">repo</span> <span class="o">=</span> <span class="n">repository</span><span class="o">.</span><span class="n">SqlAlchemyRepository</span><span class="p">(</span><span class="n">session</span><span class="p">)</span>
    <span class="n">retrieved</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;batch1&quot;</span><span class="p">)</span>

    <span class="n">expected</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">Batch</span><span class="p">(</span><span class="s2">&quot;batch1&quot;</span><span class="p">,</span> <span class="s2">&quot;GENERIC-SOFA&quot;</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="n">eta</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">retrieved</span> <span class="o">==</span> <span class="n">expected</span>  <span class="c1"># Batch.__eq__ only compares reference  #<img src="./images/icons/callouts/3.png" alt="3" /></span>
    <span class="k">assert</span> <span class="n">retrieved</span><span class="o">.</span><span class="n">sku</span> <span class="o">==</span> <span class="n">expected</span><span class="o">.</span><span class="n">sku</span>  <span class="c1">#<img src="./images/icons/callouts/4.png" alt="4" /></span>
    <span class="k">assert</span> <span class="n">retrieved</span><span class="o">.</span><span class="n">_purchased_quantity</span> <span class="o">==</span> <span class="n">expected</span><span class="o">.</span><span class="n">_purchased_quantity</span>
    <span class="k">assert</span> <span class="n">retrieved</span><span class="o">.</span><span class="n">_allocations</span> <span class="o">==</span> <span class="p">{</span>  <span class="c1">#<img src="./images/icons/callouts/4.png" alt="4" /></span>
        <span class="n">model</span><span class="o">.</span><span class="n">OrderLine</span><span class="p">(</span><span class="s2">&quot;order1&quot;</span><span class="p">,</span> <span class="s2">&quot;GENERIC-SOFA&quot;</span><span class="p">,</span> <span class="mi">12</span><span class="p">),</span>
    <span class="p">}</span>
</pre></div></div></div>
</div></div>
<div class="colist arabic"><table>
<tr><td><img src="./images/icons/callouts/1.png" alt="1" /></td><td>
Проверяет сторону чтения, поэтому необработанный SQL готовит данные для чтения <code>repo.get()</code>.
</td></tr>
<tr><td><img src="./images/icons/callouts/2.png" alt="2" /></td><td>
Избавляем вас от деталей <code>insert_batch</code> и <code>insert_allocation</code>; Зыдача в том, чтобы создать пару партий, а для интересующей нас партии выделить одну существующую строку заказа.
</td></tr>
<tr><td><img src="./images/icons/callouts/3.png" alt="3" /></td><td>
Вот что мы здесь проверяем. Первый <code>assert ==</code> проверяет соответствие типов и совпадение ссылок (потому что, как вы помните, <code>Batch</code>&#8201;&#8212;&#8201;это сущность, и для нее у нас есть собственный <code> <em> eq </em> </code>).
</td></tr>
<tr><td><img src="./images/icons/callouts/4.png" alt="4" /></td><td>
Поэтому мы также явно проверяем его основные атрибуты, в том числе
    <code>._allocations</code>, который представляет собой набор Python-объектов значений <code>OrderLine</code>.
</td></tr>
</table></div>
<div class="paragraph"><p>Независимо от того, насколько вы кропотливо написали тесты для каждой модели. После того, как у вас будет протестирован один класс на создание/изменение/сохранение, вы можете продолжить и протестировать другие с минимальным тестом на обратную связь или вообще ничего, если все они следуют схожему шаблону. В нашем случае конфигурация ORM, которая устанавливает набор <code>._allocations</code>, немного сложна, поэтому заслуживает особого тестирования.</p></div>
<div class="paragraph"><p>Вы получите что-то вроде этого:</p></div>
<div class="exampleblock" id="batch_repository">
<div class="title">Example 34. Типичный репозиторий (repository.py)</div>
<div class="content">
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">SqlAlchemyRepository</span><span class="p">(</span><span class="n">AbstractRepository</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session</span> <span class="o">=</span> <span class="n">session</span>

    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reference</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">Batch</span><span class="p">)</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">reference</span><span class="o">=</span><span class="n">reference</span><span class="p">)</span><span class="o">.</span><span class="n">one</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">list</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">Batch</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
</pre></div></div></div>
</div></div>
<div class="paragraph"><p>И теперь наша конечная точка Flask может выглядеть примерно так:</p></div>
<div class="exampleblock" id="api_endpoint_with_repo">
<div class="title">Example 35. Использование нашего репозитория непосредственно в нашей конечной точке API</div>
<div class="content">
<div class="listingblock skip">
<div class="content"><div class="highlight"><pre><span></span><span class="nd">@flask</span><span class="o">.</span><span class="n">route</span><span class="o">.</span><span class="n">gubbins</span>
<span class="k">def</span> <span class="nf">allocate_endpoint</span><span class="p">():</span>
    <span class="n">batches</span> <span class="o">=</span> <span class="n">SqlAlchemyRepository</span><span class="o">.</span><span class="n">list</span><span class="p">()</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">OrderLine</span><span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="s1">&#39;orderid&#39;</span><span class="p">],</span> <span class="n">l</span><span class="p">[</span><span class="s1">&#39;sku&#39;</span><span class="p">],</span> <span class="n">l</span><span class="p">[</span><span class="s1">&#39;qty&#39;</span><span class="p">])</span>
         <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">params</span><span class="o">...</span>
    <span class="p">]</span>
    <span class="n">allocate</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span> <span class="n">batches</span><span class="p">)</span>
    <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="k">return</span> <span class="mi">201</span>
</pre></div></div></div>
</div></div>
<div class="sidebarblock nobreakinside less_space">
<div class="content">
<div class="title">Упражнение для читателя</div>
<div class="paragraph"><p>На днях мы столкнулись с другом на конференции DDD, который сказал: "Я не использовал ORM в течение 10 лет." Шаблон репозитория и ORM действуют как абстракции перед необработанным SQL, поэтому использование одного за другим на самом деле не является необходимым.  Почему бы не попробовать реализовать наш репозиторий без использования ORM? Вы найдете код <a href="https://github.com/cosmicpython/code/tree/chapter_02_repository_exercise">на GitHub</a>.</p></div>
<div class="paragraph"><p>Мы оставили тесты репозитория, но решать, какой SQL писать, решать вам. Возможно, это будет труднее, чем вы думаете; возможно будет легче. Но хорошо то, что остальной части вашего приложения это до лампочки.</p></div>
</div></div>
</div>
</div>
<div class="sect2">
<h3 id="_создание_поддельного_репозитория_для_тестов_теперь_тривиально">Создание поддельного репозитория для тестов теперь тривиально!</h3>
<div class="paragraph"><p>Вот одно из самых больших преимуществ шаблона репозиторий:</p></div>
<div class="exampleblock" id="fake_repository">
<div class="title">Example 36. Простой фейковый репозиторий с использованием набора (repository.py)</div>
<div class="content">
<div class="listingblock skip">
<div class="content"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">FakeRepository</span><span class="p">(</span><span class="n">AbstractRepository</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batches</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_batches</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">batches</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_batches</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reference</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">next</span><span class="p">(</span><span class="n">b</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_batches</span> <span class="k">if</span> <span class="n">b</span><span class="o">.</span><span class="n">reference</span> <span class="o">==</span> <span class="n">reference</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">list</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_batches</span><span class="p">)</span>
</pre></div></div></div>
</div></div>
<div class="paragraph"><p>Поскольку это простая оболочка для <code>set</code>, все методы являются однострочными.</p></div>
<div class="paragraph"><p>Использовать фальшивое репо в тестах действительно просто, и у нас есть простая абстракция, которую легко использовать и рассуждать:</p></div>
<div class="exampleblock" id="fake_repository_example">
<div class="title">Example 37. Пример использования поддельного репозитория (test_api.py)</div>
<div class="content">
<div class="listingblock skip">
<div class="content"><div class="highlight"><pre><span></span><span class="n">fake_repo</span> <span class="o">=</span> <span class="n">FakeRepository</span><span class="p">([</span><span class="n">batch1</span><span class="p">,</span> <span class="n">batch2</span><span class="p">,</span> <span class="n">batch3</span><span class="p">])</span>
</pre></div></div></div>
</div></div>
<div class="paragraph"><p>Вы увидите эту подделку в действии в следующей главе.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/tip.png" alt="Tip" />
</td>
<td class="content">Создание подделок для ваших абстракций - отличный способ получить обратную связь от дизайна: если подделать сложно, значит, абстракция слишком сложна.</td>
</tr></table>
</div>
</div>
<div class="sect2">
<h3 id="what_is_a_port_and_what_is_an_adapter">Что такое порт и что такое адаптер в Python?</h3>
<div class="paragraph"><p>Мы не хотим слишком подробно останавливаться здесь на терминологии, потому что главное, на чем мы хотим сосредоточиться, - это инверсия зависимостей, а специфика используемой вами техники не имеет большого значения. Кроме того, мы знаем, что разные люди используют несколько разные определения.</p></div>
<div class="paragraph"><p>Порты и адаптеры вышли из мира OO, и определение, которое мы придерживаемся, состоит в том, что <em>port</em>&#8201;&#8212;&#8201;это <em>interface</em> между нашим приложением и тем, что мы хотим абстрагировать, а <em>adapter</em>&#8201;&#8212;&#8201;это <em>implementation (реализация)</em> за этим интерфейсом или абстракцией.</p></div>
<div class="paragraph"><p>Python не имеет интерфейсов как таковых, поэтому, хотя обычно легко идентифицировать адаптер, определение порта может быть сложнее. Если вы используете абстрактный базовый класс, это порт. Если нет, то порт—это просто duck type, которому соответствуют ваши адаптеры и который ожидает ваше основное приложение&#8201;&#8212;&#8201;имена используемых функций и методов, а также имена и типы их аргументов.</p></div>
<div class="paragraph"><p>Конкретно, в этой главе, <code>AbstractRepository</code> это порт, a
<code>SqlAlchemyRepository</code> и <code>FakeRepository</code> - это адаптеры.</p></div>
</div>
<div class="sect2">
<h3 id="_заключение">Заключение</h3>
<div class="paragraph"><p>Помня цитату Рича Хики, в каждой главе мы суммируем затраты и преимущества каждого представленного архитектурного шаблона.  Мы хотим, чтобы было ясно, что мы не говорим, что каждое отдельное приложение должно быть построено именно таким образом; только иногда сложность приложения и домена заставляет тратить время и усилия на добавление этих дополнительных слоев косвенности.</p></div>
<div class="paragraph"><p>Имея это в виду, <a href="#chapter_02_repository_tradeoffs">[chapter_02_repository_tradeoffs]</a> показывает некоторые плюсы и минусы шаблона репозитория и нашей модели с игнорированием персистентности.</p></div>
<div class="tableblock" id="chapter_02_repository_tradeoffs">
<table rules="all"
width="100%"
frame="border"
cellspacing="0" cellpadding="4">
<caption class="title">Table 1. Шаблон репозитория и persistence ignorance: компромиссы</caption>
<col width="50%" />
<col width="50%" />
<thead>
<tr>
<th align="left" valign="top">Плюсы</th>
<th align="left" valign="top">Минусы</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left" valign="top"><div><div class="ulist"><ul>
<li>
<p>
У нас есть простой интерфейс между persistent (постоянным) хранилищем и нашей доменной моделью.
</p>
</li>
<li>
<p>
Легко создать фейковую версию репозитория для модульного тестирования или заменить другие решения для хранения, потому что мы полностью отделили модель от проблем инфраструктуры.
</p>
</li>
<li>
<p>
Написание модели предметной области, прежде чем думать о персистентности, помогает нам сосредоточиться на текущей бизнес-проблеме. Если мы когда-нибудь захотим радикально изменить наш подход, мы можем сделать это в нашей модели, не беспокоясь о внешних ключах или миграциях до более позднего времени.
</p>
</li>
<li>
<p>
Наша схема базы данных очень проста, потому что у нас есть полный контроль над тем, как мы сопоставляем наши объекты с таблицами.
</p>
</li>
</ul></div></div></td>
<td align="left" valign="top"><div><div class="ulist"><ul>
<li>
<p>
ORM уже окупает вам затраты. Смена внешних ключей может создать сложности, но при необходимости будет довольно легко переключаться между MySQL и Postgres.
</p>
</li>
</ul></div>
<div class="ulist"><ul>
<li>
<p>
Ведение сопоставлений ORM вручную требует дополнительной работы и дополнительного кода.
</p>
</li>
<li>
<p>
Любой дополнительный уровень косвенности всегда увеличивает затраты на обслуживание и добавляет "фактор WTF" для программистов Python, которые никогда раньше не видели шаблон репозитория.
</p>
</li>
</ul></div></div></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p><a href="#domain_model_tradeoffs_diagram">[domain_model_tradeoffs_diagram]</a> демонстрирует основной тезис: да, для простых случаев развязанная модель предметной области является более сложной работой, чем простой шаблон ORM/ActiveRecord.<span class="footnote"><br />[Диаграмма вдохновлена ​​публикацией под названием
<a href="https://oreil.ly/fQXkP"> «Глобальная сложность, локальная простота»</a> Роба Венса.]<br /></span></p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/tip.png" alt="Tip" />
</td>
<td class="content">Если ваше приложение представляет собой простую оболочку CRUD (создание-чтение-обновление-удаление) вокруг базы данных, вам не нужна модель предметной области или репозиторий.</td>
</tr></table>
</div>
<div class="paragraph"><p>Но чем сложнее домен, тем больше окупаются инвестиции в избавление от проблем с инфраструктурой с точки зрения простоты внесения изменений.</p></div>
<div class="imageblock" id="domain_model_tradeoffs_diagram">
<div class="content">
<img src="images/apwp_0206.png" alt="images/apwp_0206.png" />
</div>
<div class="title">Figure 13. Компромиссы модели предметной области в виде диаграммы</div>
</div>
<div class="paragraph"><p>Наш пример кода не настолько сложен, чтобы дать больше, чем намек на то, как выглядит правая часть графика, но намеки есть. Представьте себе, например, что однажды мы решим, что хотим изменить распределение, чтобы жить на "OrderLine", а не на "Batch" объекте: если бы мы использовали, скажем, Django, нам пришлось бы определить и продумать миграцию базы данных, прежде чем мы могли бы запустить какие-либо тесты. Как бы то ни было, поскольку наша модель-это просто старые объекты Python, мы можем изменить <code>set()</code> на новый атрибут, не думая о базе данных до более подходящего момента.</p></div>
<div class="sidebarblock nobreakinside">
<div class="content">
<div class="title">Резюме шаблона репозитория</div>
<div class="dlist"><dl>
<dt class="hdlist1">
Применение инверсии зависимости в ORM
</dt>
<dd>
<p>
    Наша модель предметной области должна быть свободна от проблем с инфраструктурой, поэтому ваш ORM должен импортировать вашу модель, а не наоборот.
    
</p>
</dd>
<dt class="hdlist1">
Шаблон репозитория&#8201;&#8212;&#8201;это простая абстракция вокруг постоянного хранилища
</dt>
<dd>
<p>
    Репозиторий дает вам иллюзию коллекции объектов в памяти. Это позволяет легко создать "FakeRepository" для тестирования и поменять местами основные детали вашей инфраструктуры, не нарушая работу вашего основного приложения. Смотрите
    <a href="#appendix_csvs">[appendix_csvs]</a> для примера.
</p>
</dd>
</dl></div>
</div></div>
<div class="paragraph"><p>Вам будет интересно, как мы создаем экземпляры этих хранилищ, поддельные или настоящие? Как на самом деле будет выглядеть наше приложение Flask? Вы узнаете об этом в следующей захватывающей части, <a href="#chapter_04_service_layer">the Service Layer pattern</a>.</p></div>
<div class="paragraph"><p>Но сначала небольшое отступление.</p></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="chapter_03_abstractions">Краткая интерлюдия: О Связях <span class=".keep-together">и Абстракции</span></h2>
<div class="sectionbody">
<div class="paragraph"><p>Позвольте нам, дорогой читатель, сделать небольшое отступление от темы абстракций. Мы довольно много говорили об <em>абстракциях</em>. Например, шаблон репозитория-это абстракция над складом. Но что делает хорошую абстракцию?  Чего мы хотим от абстракций?  И как они связаны с тестированием?</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/tip.png" alt="Tip" />
</td>
<td class="content">
<div class="paragraph"><p>Код для этой главы находится в
ветке chapter_03_abstractions <a href="https://oreil.ly/k6MmV">on GitHub</a>:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>git clone https://github.com/cosmicpython/code.git
git checkout chapter_03_abstractions</code></pre>
</div></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>Ключевая тема этой книги, скрытая среди причудливых хитроплетений, заключается в том, что мы можем использовать простые абстракции, чтобы скрыть беспорядочные детали. Когда мы пишем код для удовольствия или в ката,<span class="footnote"><br />[code kata - это концепция, предлагающая оттачивать навыки программиста делая небольшие проблемы много раз, пытаясь улучшить код на каждой итерации. Название происходит от аналогии с Ката боевых искусств , где формы (aka kata) - это практика, выполняемая над и в результате улучшений. code kata - это небольшая, содержательная задача программирования, часто используемая для практики TDD. См. <a href="https://oreil.ly/vhjju">"Kata—The Only Way to Learn TDD"</a> автор: Питер Провост.]<br /></span> мы можем свободно упражняться с идеями, вычленяя сущности и агрессивно рефакторингуя. Однако, в крупномасштабной системе, наши решения становимся ограниченными, другими решениями, принятыми в других частях системы.</p></div>
<div class="paragraph"><p>Когда мы не можем изменить компонент A из опасения сломать компонент B, мы говорим, что компоненты стали <em>связанными</em> или <em>сцепленными</em>   (<em>coupled</em>). Локальное сцепление&#8201;&#8212;&#8201;это хорошо: это признак того, что наш код работает дружно "всем коллективом", каждый компонент поддерживает другие, все они подходят друг к другу, как колёсики в часах. Говоря на жаргоне будет сказано как то так: это работает, когда существуют жесткие <em>связи</em> между связанными элементами.</p></div>
<div class="paragraph"><p>Вот в глобальном масштабе жёстка связанность (сцепление)&#8201;&#8212;&#8201;это неприятность: Увеличивается риск и стоимость внесения изменений нашего кода, иногда до такой степени, что мы чувствуем себя неспособными внести какие-либо изменения вообще. Это проблема на рисунке Шара грязи может быть описана так: по мере роста приложения, в случае если мы не можем предотвратить жесткую связанность между элементами, которые не связаны друг с другом, эта взаимосвязь будет прогрессировать сверхлинейно, до тех пор пока мы больше не сможем эффективно вносить изменения в наши системы.</p></div>
<div class="paragraph"><p>Мы можем уменьшить степень сцепления внутри системы
(<a href="#coupling_illustration1">[coupling_illustration1]</a>) абстрагируясь от деталей
(<a href="#coupling_illustration2">[coupling_illustration2]</a>).</p></div>
<div class="imageblock width-50" id="coupling_illustration1">
<div class="content">
<img src="images/apwp_0301.png" alt="images/apwp_0301.png" />
</div>
<div class="title">Figure 14. Много жёстких связей</div>
</div>
<div class="listingblock image-source">
<div class="content">
<pre><code>[ditaa, apwp_0301]
+--------+      +--------+
| System | ---&gt; | System |
|   A    | ---&gt; |   B    |
|        | ---&gt; |        |
|        | ---&gt; |        |
|        | ---&gt; |        |
+--------+      +--------+</code></pre>
</div></div>
<div class="imageblock width-90" id="coupling_illustration2">
<div class="content">
<img src="images/apwp_0302.png" alt="images/apwp_0302.png" />
</div>
<div class="title">Figure 15. Меньше жёстких связей</div>
</div>
<div class="listingblock image-source">
<div class="content">
<pre><code>[ditaa, apwp_0302]
+--------+                           +--------+
| System |      /-------------\      | System |
|   A    | ---&gt; |             | ---&gt; |   B    |
|        | ---&gt; | Abstraction | ---&gt; |        |
|        |      |             | ---&gt; |        |
|        |      \-------------/      |        |
+--------+                           +--------+</code></pre>
</div></div>
<div class="paragraph"><p>На обеих диаграммах у нас есть пара подсистем, одна из которых зависит от другой.В <a href="#coupling_illustration1">[coupling_illustration1]</a> между ними существует высокая степень связаности; количество стрелок указывает на множество видов зависимостей между ними. Если нам нужно изменить систему B, есть большая вероятность, что это изменение отразится на системе A.</p></div>
<div class="paragraph"><p>Однако в <a href="#coupling_illustration2">[coupling_illustration2]</a> мы уменьшили степень связаности, вставив новую, более простую абстракцию. Поскольку она проще, система А имеет меньше видов зависимостей от абстракции. Абстракция служит для защиты нас от изменений, скрывая сложные детали того, что делает система B - мы можем изменить стрелки справа, не меняя стрелки слева.</p></div>
<div class="sect2 pagebreak-before less_space">
<h3 id="_абстрагирование_от_состояния_улучшает_тестируемость">Абстрагирование от Состояния Улучшает Тестируемость</h3>
<div class="paragraph"><p>Давайте рассмотрим пример. Представьте, что мы хотим написать код для синхронизации двух файловых каталогов, которые назовем <em>source</em> и <em>destination</em>:</p></div>
<div class="ulist"><ul>
<li>
<p>
Если файл существует в источнике, но не в месте назначения, скопируйте его.
</p>
</li>
<li>
<p>
Если файл существует в источнике, но имеет другое имя, отличное от имеющегося в папке назначения, переименуйте его в соответствующее.
</p>
</li>
<li>
<p>
Если файл существует в папке назначения, но отсутствует в источнике, удалите его.
</p>
</li>
</ul></div>
<div class="paragraph"><p>Первое и третье требования достаточно просты: мы можем просто сравнить два списка путей. Но, вот, со вторым сложнее. Чтобы выявить необходимость переименования, нам придется проверить содержимое файлов. Для этого мы можем использовать функцию хеширования, такую ​​как MD5 или SHA-1. Код для генерации хэша SHA-1 из файла достаточно прост:</p></div>
<div class="exampleblock" id="hash_file">
<div class="title">Example 38. Хеширование файла (sync.py)</div>
<div class="content">
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span><span class="n">BLOCKSIZE</span> <span class="o">=</span> <span class="mi">65536</span>

<span class="k">def</span> <span class="nf">hash_file</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="n">hasher</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha1</span><span class="p">()</span>
    <span class="k">with</span> <span class="n">path</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
        <span class="n">buf</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">BLOCKSIZE</span><span class="p">)</span>
        <span class="k">while</span> <span class="n">buf</span><span class="p">:</span>
            <span class="n">hasher</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span>
            <span class="n">buf</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">BLOCKSIZE</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">hasher</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
</pre></div></div></div>
</div></div>
<div class="paragraph"><p>Теперь нам нужно чуть дописать, часть принятия решения "что делать"&#8201;&#8212;&#8201;Бизнес-логику, если хотите.</p></div>
<div class="paragraph"><p>Когда нам нужно решить проблему основываясь на первичных принципах, мы обычно пытаемся написать простую реализацию, а затем заняться рефакторингом в сторону лучшего дизайна. Мы будем использовать этот подход на протяжении всей книги, потому что именно так мы пишем код в реальном мире: начните с решения самой маленькой части проблемы, а затем итеративно делайте решение более продвинутым и лучше разработанным.</p></div>
<div class="paragraph"><p>Наш первый подход выглядит примерно так:</p></div>
<div class="exampleblock" id="sync_first_cut">
<div class="title">Example 39. Базовый алгоритм синхронизации (sync.py)</div>
<div class="content">
<div class="listingblock non-head">
<div class="content"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">hashlib</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="k">def</span> <span class="nf">sync</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">dest</span><span class="p">):</span>
    <span class="c1"># Пройдите по исходной папке и создайте список имен файлов и их хэшей</span>
    <span class="n">source_hashes</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">folder</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">files</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">source</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">fn</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
            <span class="n">source_hashes</span><span class="p">[</span><span class="n">hash_file</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span> <span class="o">/</span> <span class="n">fn</span><span class="p">)]</span> <span class="o">=</span> <span class="n">fn</span>

    <span class="n">seen</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>  <span class="c1"># Следите за файлами, которые мы нашли в целевой папке</span>

    <span class="c1"># Пройдитесь по целевой папке и получите имена файлов и их хэши</span>
    <span class="k">for</span> <span class="n">folder</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">files</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">dest</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">fn</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
            <span class="n">dest_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span> <span class="o">/</span> <span class="n">fn</span>
            <span class="n">dest_hash</span> <span class="o">=</span> <span class="n">hash_file</span><span class="p">(</span><span class="n">dest_path</span><span class="p">)</span>
            <span class="n">seen</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">dest_hash</span><span class="p">)</span>

            <span class="c1"># если в целевой папке есть файл, которого нет в исходной,</span>
                        <span class="c1">#  удалите его</span>
                        <span class="k">if</span> <span class="n">dest_hash</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">source_hashes</span><span class="p">:</span>
                <span class="n">dest_path</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>

            <span class="c1"># если в target есть файл, который имеет другой путь в source,</span>
            <span class="c1"># переместите его на правильный путь</span>
            <span class="k">elif</span> <span class="n">dest_hash</span> <span class="ow">in</span> <span class="n">source_hashes</span> <span class="ow">and</span> <span class="n">fn</span> <span class="o">!=</span> <span class="n">source_hashes</span><span class="p">[</span><span class="n">dest_hash</span><span class="p">]:</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">dest_path</span><span class="p">,</span> <span class="n">Path</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span> <span class="o">/</span> <span class="n">source_hashes</span><span class="p">[</span><span class="n">dest_hash</span><span class="p">])</span>

    <span class="c1"># для каждого файла, который появляется в исходной папке,</span>
        <span class="c1"># но не в целевой, скопируйте его в целевую</span>
    <span class="k">for</span> <span class="n">src_hash</span><span class="p">,</span> <span class="n">fn</span> <span class="ow">in</span> <span class="n">source_hashes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">src_hash</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">seen</span><span class="p">:</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">source</span><span class="p">)</span> <span class="o">/</span> <span class="n">fn</span><span class="p">,</span> <span class="n">Path</span><span class="p">(</span><span class="n">dest</span><span class="p">)</span> <span class="o">/</span> <span class="n">fn</span><span class="p">)</span>
</pre></div></div></div>
</div></div>
<div class="paragraph"><p>Фантастика! У нас есть какой-то код, и он <em>выглядит</em> нормально, но прежде чем мы запустим его на жестком диске, может быть, нам стоит его протестировать. Как мы будем тестировать такие штуковины?</p></div>
<div class="exampleblock" id="ugly_sync_tests">
<div class="title">Example 40. Парочка сквозных тестов (test_sync.py)</div>
<div class="content">
<div class="listingblock non-head">
<div class="content"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">test_when_a_file_exists_in_the_source_but_not_the_destination</span><span class="p">():</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">source</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">()</span>
        <span class="n">dest</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">()</span>

        <span class="n">content</span> <span class="o">=</span> <span class="s2">&quot;Я очень полезный файл&quot;</span>
        <span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">source</span><span class="p">)</span> <span class="o">/</span> <span class="s1">&#39;my-file&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">write_text</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>

        <span class="n">sync</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">dest</span><span class="p">)</span>

        <span class="n">expected_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">dest</span><span class="p">)</span> <span class="o">/</span>  <span class="s1">&#39;my-file&#39;</span>
        <span class="k">assert</span> <span class="n">expected_path</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span>
        <span class="k">assert</span> <span class="n">expected_path</span><span class="o">.</span><span class="n">read_text</span><span class="p">()</span> <span class="o">==</span> <span class="n">content</span>

    <span class="k">finally</span><span class="p">:</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">dest</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">test_when_a_file_has_been_renamed_in_the_source</span><span class="p">():</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">source</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">()</span>
        <span class="n">dest</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">()</span>

        <span class="n">content</span> <span class="o">=</span> <span class="s2">&quot;Я файл, который был переименован&quot;</span>
        <span class="n">source_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">source</span><span class="p">)</span> <span class="o">/</span> <span class="s1">&#39;source-filename&#39;</span>
        <span class="n">old_dest_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">dest</span><span class="p">)</span> <span class="o">/</span> <span class="s1">&#39;dest-filename&#39;</span>
        <span class="n">expected_dest_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">dest</span><span class="p">)</span> <span class="o">/</span> <span class="s1">&#39;source-filename&#39;</span>
        <span class="n">source_path</span><span class="o">.</span><span class="n">write_text</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
        <span class="n">old_dest_path</span><span class="o">.</span><span class="n">write_text</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>

        <span class="n">sync</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">dest</span><span class="p">)</span>

        <span class="k">assert</span> <span class="n">old_dest_path</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span> <span class="ow">is</span> <span class="kc">False</span>
        <span class="k">assert</span> <span class="n">expected_dest_path</span><span class="o">.</span><span class="n">read_text</span><span class="p">()</span> <span class="o">==</span> <span class="n">content</span>


    <span class="k">finally</span><span class="p">:</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">dest</span><span class="p">)</span>
</pre></div></div></div>
</div></div>
<div class="paragraph"><p>Строго говоря, тут многовато установок для двух простых случаев! Проблема в том, что логика нашей предметной области «выяснение разницы между двумя каталогами» тесно связана с I/O кодом. Мы не можем запустить наш алгоритм поиска различий без вызова модулей <code>pathlib</code>, <code>shutil</code> и <code>hashlib</code>.</p></div>
<div class="paragraph"><p>Только вот беда в том, что даже с нашими текущими требованиями мы не написали достаточно тестов: текущая реализация имеет несколько ошибок (например, <code>shutil.move()</code> неверен).  Чтобы получить достойное покрытие и выявить эти ошибки, нужно написать больше тестов, но если все они будут такими же громоздкими, как предыдущие, это быстро станет очень геморно.</p></div>
<div class="paragraph"><p>Вдобавок наш код не очень расширяемый. Представьте, что вы пытаетесь реализовать флаг <code>--dry-run</code>, который заставляет наш код просто распечатать то, что он собирается делать, а не выполнять это на самом деле.  А что, если мы хотим синхронизироваться с удаленным сервером или с облачным хранилищем?</p></div>
<div class="paragraph"><p>Наш высокоуровневый код связан с низкоуровневыми деталями, и это усложняет жизнь. По мере усложнения рассматриваемых сценариев наши тесты будут становиться все более громоздкими. Мы определенно можем провести рефакторинг этих тестов (например, некоторая очистка может быть перенесена в фикстуры pytest), но пока мы выполняем операции с файловой системой, они будут медленными, их будет трудно читать и писать.</p></div>
</div>
<div class="sect2 pagebreak-before less_space">
<h3 id="_выбор_правильной_абстракции_й">Выбор правильной Абстракции(-й)</h3>
<div class="paragraph"><p>Что мы можем сделать, чтобы переписать наш код и сделать его более тестируемым?</p></div>
<div class="paragraph"><p>Во-первых, нам нужно подумать о том, что нужно нашему коду от файловой системы. Разбирая код, мы видим три различных момента. Воспримем их как три различных <em>обязанности</em>, которые выполняет код:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
Мы опрашиваем файловую систему с помощью <code>os.walk</code> и определяем хэши для ряда путей. Это похоже как для  исходного, так и конечного случая.
</p>
</li>
<li>
<p>
Мы решаем, является ли файл новым, переименованным или лишним.
</p>
</li>
<li>
<p>
Мы копируем, перемещаем или удаляем файлы в соответствии с источником.
</p>
</li>
</ol></div>
<div class="paragraph"><p>Помните, что мы хотим найти <em>упрощающие абстракции</em> для каждой из этих обязанностей. Это позволит нам скрыть беспорядочные детали, чтобы мы могли сосредоточиться на интересующей нас логике.<span class="footnote"><br />[Если вы привыкли мыслить терминами интерфейсов, то мы пытаемся дать определение именно этому. Прим переводчика: <a href="https://habr.com/ru/post/30444/">https://habr.com/ru/post/30444/</a>]<br /></span></p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note" />
</td>
<td class="content">В этой главе мы отрефакторим слегка корявый код в более проверяемую структуру,
      определяя отдельные задачи, которые необходимо выполнить, и предоставляя каждую задачу четко
          определенному субъекту, аналогично <a href="#ddg_example">пример <code>duckduckgo</code></a>.</td>
</tr></table>
</div>
<div class="paragraph"><p>Для шагов 1 и 2 мы уже интуитивно начали использовать абстракцию, словарь хэшей для путей. Возможно, вы уже думали: «Почему бы не создать словарь для целевой папки, а также для источника, а затем мы просто сравним два словаря?» Это похоже на хороший способ абстрагироваться от текущего состояния файловой системы:</p></div>
<div class="literalblock">
<div class="content">
<pre><code>source_files = {'hash1': 'path1', 'hash2': 'path2'}
dest_files = {'hash1': 'path1', 'hash2': 'pathX'}</code></pre>
</div></div>
<div class="paragraph"><p>А как насчет перехода от пункта 2 к пункту 3? Как мы можем абстрагироваться от фактического взаимодействия файловой системы перемещения/копирования/удаления?</p></div>
<div class="paragraph"><p>Мы применим здесь трюк, который будем применять позже в этой книге достаточно широко. Мы собираемся отделить то, <em>что</em> мы хотим сделать, от того, <em>как</em> это сделать. Мы собираемся сделать так, чтобы наша программа выводила список команд, которые выглядят следующим образом:</p></div>
<div class="literalblock">
<div class="content">
<pre><code>("COPY", "sourcepath", "destpath"),
("MOVE", "old", "new"),</code></pre>
</div></div>
<div class="paragraph"><p>Теперь мы могли бы написать тесты, которые просто используют два дикта файловой системы в качестве входных данных, и мы ожидали бы списки кортежей строк, представляющих действия в качестве выходных данных.</p></div>
<div class="paragraph"><p>Вместо того чтобы сказать: "Учитывая фактическую файловую систему при запуске своей функции, проверить, какие действия произошли", мы говорим: "Учитывая <em>абстрацию</em> файловой системы, какое <em>абстрактное</em> действие файловой системы произойдет?"</p></div>
<div class="exampleblock" id="better_tests">
<div class="title">Example 41. Упрощенные входы и выходы в наших тестах (test_sync.py)</div>
<div class="content">
<div class="listingblock skip">
<div class="content"><div class="highlight"><pre><span></span>    <span class="k">def</span> <span class="nf">test_when_a_file_exists_in_the_source_but_not_the_destination</span><span class="p">():</span>
        <span class="n">src_hashes</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;hash1&#39;</span><span class="p">:</span> <span class="s1">&#39;fn1&#39;</span><span class="p">}</span>
        <span class="n">dst_hashes</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">expected_actions</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;COPY&#39;</span><span class="p">,</span> <span class="s1">&#39;/src/fn1&#39;</span><span class="p">,</span> <span class="s1">&#39;/dst/fn1&#39;</span><span class="p">)]</span>
        <span class="o">...</span>

    <span class="k">def</span> <span class="nf">test_when_a_file_has_been_renamed_in_the_source</span><span class="p">():</span>
        <span class="n">src_hashes</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;hash1&#39;</span><span class="p">:</span> <span class="s1">&#39;fn1&#39;</span><span class="p">}</span>
        <span class="n">dst_hashes</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;hash1&#39;</span><span class="p">:</span> <span class="s1">&#39;fn2&#39;</span><span class="p">}</span>
        <span class="n">expected_actions</span> <span class="o">==</span> <span class="p">[(</span><span class="s1">&#39;MOVE&#39;</span><span class="p">,</span> <span class="s1">&#39;/dst/fn2&#39;</span><span class="p">,</span> <span class="s1">&#39;/dst/fn1&#39;</span><span class="p">)]</span>
        <span class="o">...</span>
</pre></div></div></div>
</div></div>
</div>
<div class="sect2">
<h3 id="_реализация_выбранных_нами_абстракций">Реализация Выбранных Нами Абстракций</h3>
<div class="paragraph"><p>Это все очень хорошо, но как нам <em>на самом деле</em> написать эти новые тесты и как изменить нашу реализацию, чтобы все это работало?</p></div>
<div class="paragraph"><p>Наша цель состоит в том, чтобы изолировать умную часть нашей системы и иметь возможность тщательно протестировать её без необходимости создавать реальную файловую систему. Мы создадим "ядро" кода, которое не имеет зависимостей от внешнего состояния, а затем посмотрим, как оно реагирует, когда мы даем ему входные данные из внешнего мира (такой подход был охарактеризован Гэри Бернхардтом как
<a href="https://oreil.ly/wnad4">Functional
Core, Imperative Shell</a>, или FCIS).</p></div>
<div class="paragraph"><p>Давайте начнем с разделения кода, чтобы отделить части с состоянием от логики.</p></div>
<div class="paragraph"><p>И наша функция верхнего уровня не будет содержать почти никакой логики вообще; это просто обязательная серия шагов: собрать входные данные, вызвать нашу логику, применить результаты:</p></div>
<div class="exampleblock" id="three_parts">
<div class="title">Example 42. Разделим наш код на три  (sync.py)</div>
<div class="content">
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">sync</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">dest</span><span class="p">):</span>
    <span class="c1"># imperative shell Шаг 1, собрать входные данные</span>
    <span class="n">source_hashes</span> <span class="o">=</span> <span class="n">read_paths_and_hashes</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>  <span class="c1">#<img src="./images/icons/callouts/1.png" alt="1" /></span>
    <span class="n">dest_hashes</span> <span class="o">=</span> <span class="n">read_paths_and_hashes</span><span class="p">(</span><span class="n">dest</span><span class="p">)</span>  <span class="c1">#<img src="./images/icons/callouts/1.png" alt="1" /></span>

    <span class="c1"># Шаг 2: вызов функционального ядра</span>
    <span class="n">actions</span> <span class="o">=</span> <span class="n">determine_actions</span><span class="p">(</span><span class="n">source_hashes</span><span class="p">,</span> <span class="n">dest_hashes</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">dest</span><span class="p">)</span>  <span class="c1">#<img src="./images/icons/callouts/2.png" alt="2" /></span>

    <span class="c1"># imperative shell Шаг 3, применить результаты</span>
    <span class="k">for</span> <span class="n">action</span><span class="p">,</span> <span class="o">*</span><span class="n">paths</span> <span class="ow">in</span> <span class="n">actions</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">action</span> <span class="o">==</span> <span class="s1">&#39;copy&#39;</span><span class="p">:</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="o">*</span><span class="n">paths</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">action</span> <span class="o">==</span> <span class="s1">&#39;move&#39;</span><span class="p">:</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="o">*</span><span class="n">paths</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">action</span> <span class="o">==</span> <span class="s1">&#39;delete&#39;</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">paths</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</pre></div></div></div>
</div></div>
<div class="colist arabic"><table>
<tr><td><img src="./images/icons/callouts/1.png" alt="1" /></td><td>
Первая функция, которую мы учитываем, <code>read_paths_and_hashes()</code>, которая изолирует часть ввода-вывода нашего приложения.
</td></tr>
<tr><td><img src="./images/icons/callouts/2.png" alt="2" /></td><td>
Именно здесь мы вырежем функциональное ядро, бизнес-логику.
</td></tr>
</table></div>
<div class="paragraph"><p>Код для создания словаря путей и хешей теперь написать тривиально просто:</p></div>
<div class="exampleblock" id="read_paths_and_hashes">
<div class="title">Example 43. Функция, которая просто выполняет ввод/вывод (sync.py)</div>
<div class="content">
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">read_paths_and_hashes</span><span class="p">(</span><span class="n">root</span><span class="p">):</span>
    <span class="n">hashes</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">folder</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">files</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">root</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">fn</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
            <span class="n">hashes</span><span class="p">[</span><span class="n">hash_file</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span> <span class="o">/</span> <span class="n">fn</span><span class="p">)]</span> <span class="o">=</span> <span class="n">fn</span>
    <span class="k">return</span> <span class="n">hashes</span>
</pre></div></div></div>
</div></div>
<div class="paragraph"><p>Функция <code>define_actions()</code> будет ядром нашей бизнес-логики, которая выясняет: «Учитывая эти два набора хэшей и имен файлов, что мы должны копировать/перемещать/удалять?». Она принимает простые структуры данных и возвращает простые структуры данных:</p></div>
<div class="exampleblock" id="determine_actions">
<div class="title">Example 44. Функция, которая просто выполняет бизнес-логику (sync.py)</div>
<div class="content">
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">determine_actions</span><span class="p">(</span><span class="n">src_hashes</span><span class="p">,</span> <span class="n">dst_hashes</span><span class="p">,</span> <span class="n">src_folder</span><span class="p">,</span> <span class="n">dst_folder</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">sha</span><span class="p">,</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">src_hashes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">sha</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dst_hashes</span><span class="p">:</span>
            <span class="n">sourcepath</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">src_folder</span><span class="p">)</span> <span class="o">/</span> <span class="n">filename</span>
            <span class="n">destpath</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">dst_folder</span><span class="p">)</span> <span class="o">/</span> <span class="n">filename</span>
            <span class="k">yield</span> <span class="s1">&#39;copy&#39;</span><span class="p">,</span> <span class="n">sourcepath</span><span class="p">,</span> <span class="n">destpath</span>

        <span class="k">elif</span> <span class="n">dst_hashes</span><span class="p">[</span><span class="n">sha</span><span class="p">]</span> <span class="o">!=</span> <span class="n">filename</span><span class="p">:</span>
            <span class="n">olddestpath</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">dst_folder</span><span class="p">)</span> <span class="o">/</span> <span class="n">dst_hashes</span><span class="p">[</span><span class="n">sha</span><span class="p">]</span>
            <span class="n">newdestpath</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">dst_folder</span><span class="p">)</span> <span class="o">/</span> <span class="n">filename</span>
            <span class="k">yield</span> <span class="s1">&#39;move&#39;</span><span class="p">,</span> <span class="n">olddestpath</span><span class="p">,</span> <span class="n">newdestpath</span>

    <span class="k">for</span> <span class="n">sha</span><span class="p">,</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">dst_hashes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">sha</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">src_hashes</span><span class="p">:</span>
            <span class="k">yield</span> <span class="s1">&#39;delete&#39;</span><span class="p">,</span> <span class="n">dst_folder</span> <span class="o">/</span> <span class="n">filename</span>
</pre></div></div></div>
</div></div>
<div class="paragraph"><p>Теперь наши тесты действуют непосредственно на функцию <code>determine_actions()</code>:</p></div>
<div class="exampleblock" id="harry_tests">
<div class="title">Example 45. Более приятные на вид тесты (test_sync.py)</div>
<div class="content">
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">test_when_a_file_exists_in_the_source_but_not_the_destination</span><span class="p">():</span>
    <span class="n">src_hashes</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;hash1&#39;</span><span class="p">:</span> <span class="s1">&#39;fn1&#39;</span><span class="p">}</span>
    <span class="n">dst_hashes</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">actions</span> <span class="o">=</span> <span class="n">determine_actions</span><span class="p">(</span><span class="n">src_hashes</span><span class="p">,</span> <span class="n">dst_hashes</span><span class="p">,</span> <span class="n">Path</span><span class="p">(</span><span class="s1">&#39;/src&#39;</span><span class="p">),</span> <span class="n">Path</span><span class="p">(</span><span class="s1">&#39;/dst&#39;</span><span class="p">))</span>
    <span class="k">assert</span> <span class="nb">list</span><span class="p">(</span><span class="n">actions</span><span class="p">)</span> <span class="o">==</span> <span class="p">[(</span><span class="s1">&#39;copy&#39;</span><span class="p">,</span> <span class="n">Path</span><span class="p">(</span><span class="s1">&#39;/src/fn1&#39;</span><span class="p">),</span> <span class="n">Path</span><span class="p">(</span><span class="s1">&#39;/dst/fn1&#39;</span><span class="p">))]</span>

<span class="k">def</span> <span class="nf">test_when_a_file_has_been_renamed_in_the_source</span><span class="p">():</span>
    <span class="n">src_hashes</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;hash1&#39;</span><span class="p">:</span> <span class="s1">&#39;fn1&#39;</span><span class="p">}</span>
    <span class="n">dst_hashes</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;hash1&#39;</span><span class="p">:</span> <span class="s1">&#39;fn2&#39;</span><span class="p">}</span>
    <span class="n">actions</span> <span class="o">=</span> <span class="n">determine_actions</span><span class="p">(</span><span class="n">src_hashes</span><span class="p">,</span> <span class="n">dst_hashes</span><span class="p">,</span> <span class="n">Path</span><span class="p">(</span><span class="s1">&#39;/src&#39;</span><span class="p">),</span> <span class="n">Path</span><span class="p">(</span><span class="s1">&#39;/dst&#39;</span><span class="p">))</span>
    <span class="k">assert</span> <span class="nb">list</span><span class="p">(</span><span class="n">actions</span><span class="p">)</span> <span class="o">==</span> <span class="p">[(</span><span class="s1">&#39;move&#39;</span><span class="p">,</span> <span class="n">Path</span><span class="p">(</span><span class="s1">&#39;/dst/fn2&#39;</span><span class="p">),</span> <span class="n">Path</span><span class="p">(</span><span class="s1">&#39;/dst/fn1&#39;</span><span class="p">))]</span>
</pre></div></div></div>
</div></div>
<div class="paragraph"><p>Поскольку мы отделили логику нашей программы&#8201;&#8212;&#8201;код для идентификации изменений&#8201;&#8212;&#8201;от низкоуровневых деталей ввода-вывода, мы можем легко протестировать ядро нашего кода.</p></div>
<div class="paragraph"><p>При таком подходе мы перешли от тестирования нашей основной функции точки входа <code>sync()</code> к тестированию функции более низкого уровня  <code>determine_actions()</code>. Вы можете решить, что это нормально, потому что <code>sync()</code> теперь выполняется так просто. Или вы можете решить провести несколько интеграционных/приемочных тестов, чтобы проверить эту <code>sync()</code>. Но есть еще один вариант, который заключается в изменении функции <code>sync()</code>, чтобы её можно было тестировать модульно и тестировать от начала до конца; это подход, который Боб называет <em>edge-to-edge testing</em>.</p></div>
<div class="sect3">
<h4 id="_тестирование_edge_to_edge_с_fakes_и_dependency_injection">Тестирование Edge to Edge с Fakes и Dependency Injection</h4>
<div class="paragraph"><p>Когда мы начинаем писать новую систему, мы часто сначала фокусируемся на основной логике, управляя ею с помощью прямых модульных тестов. Однако в какой-то момент мы хотим протестировать совместное использование большой части системы.</p></div>
<div class="paragraph"><p>Мы бы <em>могли</em> вернуться к нашим сквозным тестам, но они все еще так же сложны в написании и обслуживании, как и раньше. Вместо этого мы часто пишем тесты, которые вызывают целую систему вместе, но подделывают ввод-вывод, своего рода <em>edge to edge</em>:</p></div>
<div class="exampleblock" id="di_version">
<div class="title">Example 46. Явные зависимости (sync.py)</div>
<div class="content">
<div class="listingblock skip">
<div class="content"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">sync</span><span class="p">(</span><span class="n">reader</span><span class="p">,</span> <span class="n">filesystem</span><span class="p">,</span> <span class="n">source_root</span><span class="p">,</span> <span class="n">dest_root</span><span class="p">):</span> <span class="c1">#<img src="./images/icons/callouts/1.png" alt="1" /></span>

    <span class="n">source_hashes</span> <span class="o">=</span> <span class="n">reader</span><span class="p">(</span><span class="n">source_root</span><span class="p">)</span> <span class="c1">#<img src="./images/icons/callouts/2.png" alt="2" /></span>
    <span class="n">dest_hashes</span> <span class="o">=</span> <span class="n">reader</span><span class="p">(</span><span class="n">dest_root</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">sha</span><span class="p">,</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">src_hashes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">sha</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dest_hashes</span><span class="p">:</span>
            <span class="n">sourcepath</span> <span class="o">=</span> <span class="n">source_root</span> <span class="o">/</span> <span class="n">filename</span>
            <span class="n">destpath</span> <span class="o">=</span> <span class="n">dest_root</span> <span class="o">/</span> <span class="n">filename</span>
            <span class="n">filesystem</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">destpath</span><span class="p">,</span> <span class="n">sourcepath</span><span class="p">)</span> <span class="c1">#<img src="./images/icons/callouts/3.png" alt="3" /></span>

        <span class="k">elif</span> <span class="n">dest_hashes</span><span class="p">[</span><span class="n">sha</span><span class="p">]</span> <span class="o">!=</span> <span class="n">filename</span><span class="p">:</span>
            <span class="n">olddestpath</span> <span class="o">=</span> <span class="n">dest_root</span> <span class="o">/</span> <span class="n">dest_hashes</span><span class="p">[</span><span class="n">sha</span><span class="p">]</span>
            <span class="n">newdestpath</span> <span class="o">=</span> <span class="n">dest_root</span> <span class="o">/</span> <span class="n">filename</span>
            <span class="n">filesystem</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">olddestpath</span><span class="p">,</span> <span class="n">newdestpath</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">sha</span><span class="p">,</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">dst_hashes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">sha</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">source_hashes</span><span class="p">:</span>
            <span class="n">filesystem</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">dest_root</span><span class="o">/</span><span class="n">filename</span><span class="p">)</span>
</pre></div></div></div>
</div></div>
<div class="colist arabic"><table>
<tr><td><img src="./images/icons/callouts/1.png" alt="1" /></td><td>
Наша функция верхнего уровня теперь предоставляет две новые зависимости: <code>reader</code> и <code>filesystem</code>.
</td></tr>
<tr><td><img src="./images/icons/callouts/2.png" alt="2" /></td><td>
Мы вызываем <code>reader</code> для создания наших файлов dict.
</td></tr>
<tr><td><img src="./images/icons/callouts/3.png" alt="3" /></td><td>
Мы вызываем <code>filesystem</code>, чтобы применить обнаруженные нами изменения.
</td></tr>
</table></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/tip.png" alt="Tip" />
</td>
<td class="content">Хотя мы используем инъекцию зависимостей, нет необходимости
        определять абстрактный базовый класс или какой-либо явный интерфейс.
        В этой книге мы часто показываем ABC, потому что надеемся, что этот модуль поможет вам понять, что такое абстракция, но в этом нет
        необходимости. Динамический характер Python означает, что мы всегда можем положиться на утиную типизацию<span class="footnote"><br />[PEP 544&#8201;&#8212;&#8201;Protocols: Structural subtyping (static duck typing) <a href="https://www.python.org/dev/peps/pep-0544/">https://www.python.org/dev/peps/pep-0544/</a>]<br /></span>.</td>
</tr></table>
</div>
<div class="exampleblock" id="bob_tests">
<div class="title">Example 47. Тесты с использованием DI</div>
<div class="content">
<div class="listingblock skip">
<div class="content"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">FakeFileSystem</span><span class="p">(</span><span class="nb">list</span><span class="p">):</span> <span class="c1">#<img src="./images/icons/callouts/1.png" alt="1" /></span>

    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">dest</span><span class="p">):</span> <span class="c1">#<img src="./images/icons/callouts/2.png" alt="2" /></span>
        <span class="bp">self</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;COPY&#39;</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">dest</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">move</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">dest</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;MOVE&#39;</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">dest</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dest</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;DELETE&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">test_when_a_file_exists_in_the_source_but_not_the_destination</span><span class="p">():</span>
    <span class="n">source</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;sha1&quot;</span><span class="p">:</span> <span class="s2">&quot;my-file&quot;</span> <span class="p">}</span>
    <span class="n">dest</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">filesystem</span> <span class="o">=</span> <span class="n">FakeFileSystem</span><span class="p">()</span>

    <span class="n">reader</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;/source&quot;</span><span class="p">:</span> <span class="n">source</span><span class="p">,</span> <span class="s2">&quot;/dest&quot;</span><span class="p">:</span> <span class="n">dest</span><span class="p">}</span>
    <span class="n">sync</span><span class="p">(</span><span class="n">reader</span><span class="o">.</span><span class="n">pop</span><span class="p">,</span> <span class="n">filesystem</span><span class="p">,</span> <span class="s2">&quot;/source&quot;</span><span class="p">,</span> <span class="s2">&quot;/dest&quot;</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">filesystem</span> <span class="o">==</span> <span class="p">[(</span><span class="s2">&quot;COPY&quot;</span><span class="p">,</span> <span class="s2">&quot;/source/my-file&quot;</span><span class="p">,</span> <span class="s2">&quot;/dest/my-file&quot;</span><span class="p">)]</span>


<span class="k">def</span> <span class="nf">test_when_a_file_has_been_renamed_in_the_source</span><span class="p">():</span>
    <span class="n">source</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;sha1&quot;</span><span class="p">:</span> <span class="s2">&quot;renamed-file&quot;</span> <span class="p">}</span>
    <span class="n">dest</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;sha1&quot;</span><span class="p">:</span> <span class="s2">&quot;original-file&quot;</span> <span class="p">}</span>
    <span class="n">filesystem</span> <span class="o">=</span> <span class="n">FakeFileSystem</span><span class="p">()</span>

    <span class="n">reader</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;/source&quot;</span><span class="p">:</span> <span class="n">source</span><span class="p">,</span> <span class="s2">&quot;/dest&quot;</span><span class="p">:</span> <span class="n">dest</span><span class="p">}</span>
    <span class="n">sync</span><span class="p">(</span><span class="n">reader</span><span class="o">.</span><span class="n">pop</span><span class="p">,</span> <span class="n">filesystem</span><span class="p">,</span> <span class="s2">&quot;/source&quot;</span><span class="p">,</span> <span class="s2">&quot;/dest&quot;</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">filesystem</span> <span class="o">==</span> <span class="p">[(</span><span class="s2">&quot;MOVE&quot;</span><span class="p">,</span> <span class="s2">&quot;/dest/original-file&quot;</span><span class="p">,</span> <span class="s2">&quot;/dest/renamed-file&quot;</span><span class="p">)]</span>
</pre></div></div></div>
</div></div>
<div class="colist arabic"><table>
<tr><td><img src="./images/icons/callouts/1.png" alt="1" /></td><td>
Боб <em>обожает</em> использовать списки для создания простых тестовых двойников, даже если это бесит его коллег. Это означает, что мы можем писать тесты вроде <code>assert <em>foo</em> not in database</code>.
    
</td></tr>
<tr><td><img src="./images/icons/callouts/2.png" alt="2" /></td><td>
Каждый метод в нашей <code>FakeFileSystem</code> просто добавляет что-то в список, чтобы мы могли проверить это позже. Это пример spy object.
    
</td></tr>
</table></div>
<div class="paragraph"><p>Преимущество этого подхода заключается в том, что наши тесты работают с той же функцией, которая используется нашим production кодом. Недостатком является то, что мы должны сделать наши компоненты с отслеживанием состояния явными и передавать их по кругу. Дэвид Хайнемайер Ханссон, создатель Ruby on Rails, как известно, описал это как "вызванное тестом повреждение конструкции."</p></div>
<div class="paragraph"><p>В любом случае, теперь мы можем работать над исправлением всех ошибок в нашей реализации;
Перечисление тестов для всех крайних случаев стало намного проще.</p></div>
</div>
<div class="sect3">
<h4 id="_почему_бы_просто_не_запатчить_это">Почему бы просто не запатчить это?</h4>
<div class="paragraph"><p>В этот момент вы можете почесать затылок и подумать: "Почему бы просто не использовать <em>mock.patch</em> и не сэкономить свои усилия?"</p></div>
<div class="paragraph"><p>Мы избегаем использования моков в этой книге и в нашем production коде. Мы не собираемся устраивать ХолиВар по этому поводу, но инстинкт подсказывает, что mocking frameworks, особенно monkeypatching, - это дурнопахнущий код.</p></div>
<div class="paragraph"><p>Вместо этого мы предпочитаем четко определять обязанности в нашей кодовой базе и разделять эти обязанности на небольшие, сфокусированные объекты, которые легко заменить тестовым дублёром.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note" />
</td>
<td class="content">Вы можете увидеть пример в <a href="#chapter_08_events_and_message_bus">[chapter_08_events_and_message_bus]</a>, где мы <code>mock.patch()</code>-ем выводим модуль отправки электронной почты, но в конечном итоге заменяем его явным небольшим кодом внедрения зависимостей в
    <a href="#chapter_13_dependency_injection">[chapter_13_dependency_injection]</a>.</td>
</tr></table>
</div>
<div class="paragraph"><p>У нас есть три тесно связанных причины нашего предпочтения:</p></div>
<div class="ulist"><ul>
<li>
<p>
Исправление зависимости, которую вы используете, позволяет модульно протестировать код, но это никак не улучшает дизайн. Использование <code>mock.patch</code> не позволит вашему коду работать с флагом <code>--dry-run</code> и не поможет вам работать с FTP-сервером. Для этого вам нужно будет ввести абстракции.
</p>
</li>
<li>
<p>
Тесты, которые используют mocks <em>стремятся</em>  быть более связанными с деталями реализации кодовой базы. Это потому, что имитационные тесты проверяют взаимодействие между объектами: вызывали ли мы <code>shutil.copy</code> с правильными аргументами? По нашему опыту, эта связь между кодом и тестом <em>стремится</em> сделать тесты более хрупкими.
  
</p>
</li>
<li>
<p>
Чрезмерное использование моков приводит к созданию сложных наборов тестов, которые не могут объяснить код.
</p>
</li>
</ul></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note" />
</td>
<td class="content">Проектирование для тестируемости на самом деле означает проектирование для расширяемости. Мы обмениваем немного большую сложность на более чистый дизайн, который допускает новые варианты использования.</td>
</tr></table>
</div>
<div class="sidebarblock nobreakinside less_space">
<div class="content">
<div class="title">Моки против фейков; Классический стиль  в сравнении с TDD Лондонской школы<span class="footnote"><br />["Лондонская школа", которая больше ориентирована на тестирование взаимодействия, mocking и end-to-end TDD, с особым упором на дизайн, основанный на ответственности, и подход «Говори, не спрашивай» к объектно-ориентированному дизайну, недавно повторно популяризированному Стивом Фриманом и Нэтом Прайсом, в потрясающей книге Growing Object Oriented Software Guided By Tests.  <a href="http://codemanship.co.uk/parlezuml/blog/?postid=987">http://codemanship.co.uk/parlezuml/blog/?postid=987</a>]<br /></span></div>
<div class="paragraph"><p>Вот краткое и несколько упрощенное определение разницы между моком и фейком:</p></div>
<div class="ulist"><ul>
<li>
<p>
Моки используются для проверки <em>как</em> что-то используется; у них есть такие методы, как <code>assert_called_once_with()</code>. Они связаны с TDD лондонской школы.
</p>
</li>
<li>
<p>
Фейки-это рабочие реализации того, что они заменяют, но они предназначены для использования только в тестах. Они не будут работать "в реальной жизни"; наш репозиторий in-memory&#8201;&#8212;&#8201;хороший пример. Но вы можете использовать их, чтобы выполнить assert о конечном состоянии системы, а не о поведении на пути к этому состоянию, поэтому они связаны с классическим стилем TDD.
</p>
</li>
</ul></div>
<div class="paragraph"><p>Здесь мы слегка смешиваем насмешки (mocks) со шпионами(spies) и фальшивки(fakes) с заглушками(stubs), однако вы можете прочитать длинный, правильный опус в классическом эссе Мартина Фаулера на эту тему под названием  <a href="https://oreil.ly/yYjBN">"Mocks Aren&#8217;t Stubs"</a>.</p></div>
<div class="paragraph"><p>Также, вероятно, не помогает то, что объекты <code>MagicMock</code>, предоставляемые <code>unittest.mock</code>, строго говоря, не являются mocks; они шпионы(spies), если уж на то пошло. Но их также часто используют как заглушки(stubs) или пустышки(dummies). Ну вот, мы обещаем, что теперь покончим с  придирками двойной терминологии тестирования.</p></div>
<div class="paragraph"><p>А как насчет лондонской школы по сравнению с TDD в классическом стиле? Вы можете прочитать больше об этих двух подходах в статье Мартина Фаулера, которую мы только что процитировали, а также на <a href="https://oreil.ly/H2im_">Software Engineering Stack Exchange site</a>, но в этой книге мы довольно твердо придерживаемся классицизма.  Нам нравится строить наши тесты вокруг состояния как в сетапах, так и в ассертах, и нам нравится работать на самом высоком уровне абстракции, а не проверять поведение промежуточных участников.<span class="footnote"><br />[Это не значит, что мы считаем, что люди из лондонской школы ошибаются. Некоторые безумно умные люди работают именно так. Просто это не то, к чему мы привыкли.]<br /></span></p></div>
<div class="paragraph"><p>Подробнее об этом читайте в <a href="#kinds_of_tests">[kinds_of_tests]</a>.</p></div>
</div></div>
<div class="paragraph"><p>Мы рассматриваем TDD в первую очередь как практику проектирования, а затем как практику тестирования. Тесты выполняют функцию хранения наших вариантов проектирования и служат для объяснения системы, когда мы возвращаемся к коду после долгого отсутствия.</p></div>
<div class="paragraph"><p>Тесты, использующие слишком много mocks, перегружаются установочным кодом, который скрывает интересующую нас историю.</p></div>
<div class="paragraph"><p>В своем выступлении Стив Фриман приводит отличный пример чрезмерно замкнутых тестов. <a href="https://oreil.ly/jAmtr">"Test-Driven Development"</a>. Вам также следует ознакомиться с этим выступлением PyCon, <a href="https://oreil.ly/s3e05">"Mocking and Patching Pitfalls"</a>, от нашего уважаемого технического обозревателя Эда Юнга, который также рассматривает mocking и их альтернативы.
И в то время как мы рекомендуем доклады, не пропустите Брэндона Родса, говорящего о <a href="https://oreil.ly/oiXJM">"Hoisting Your I/O"</a>, который действительно хорошо охватывает проблемы, о которых мы говорим, используя еще один простой пример.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/tip.png" alt="Tip" />
</td>
<td class="content">В этой главе мы потратили много времени, заменяя сквозные тесты модульными. Это не значит, что мы считаем, что вы никогда не должны использовать тесты E2E!     В этой книге мы показываем методы, которые помогут вам составить достойную пирамиду тестов с максимально возможным количеством модульных тестов и с минимальным количеством тестов E2E, необходимых для уверенности. Прочтите <a href="#types_of_test_rules_of_thumb">[types_of_test_rules_of_thumb]</a> для получения более подробной информации.
    
    </td>
</tr></table>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Так Что Же Мы Используем В Этой Книге? Функциональную или Объектно-ориентированную композицию?</div>
<div class="paragraph"><p>Оба. Наша доменная модель полностью свободна от зависимостей и побочных эффектов, так что это наше функциональное ядро. Уровень сервиса, который мы строим вокруг него (в <a href="#chapter_04_service_layer">[chapter_04_service_layer]</a>) позволяет нам управлять системой на перефирии, и мы используя инъекцию зависимостей, можем предоставить этим службам компоненты с отслеживанием состояния, так что мы все еще можем их модульно тестировать.</p></div>
<div class="paragraph"><p>См. <a href="#chapter_13_dependency_injection">[chapter_13_dependency_injection]</a> для более подробного изучения того, как сделать нашу инъекцию зависимостей более явной и централизованной.</p></div>
</div></div>
</div>
</div>
<div class="sect2">
<h3 id="_подведение_итогов">Подведение итогов</h3>
<div class="paragraph"><p>Мы будем видеть эту идею в книге снова и снова: мы можем упростить тестирование и обслуживание наших систем, упростив интерфейс между нашей бизнес-логикой и беспорядочным вводом-выводом. Найти правильную абстракцию сложно, но вот несколько эвристик и вопросов, которые нужно задать себе:</p></div>
<div class="ulist"><ul>
<li>
<p>
Могу ли я выбрать знакомую структуру данных Python для представления состояния беспорядочной системы, а затем попытаться представить себе единственную функцию, которая может вернуть это состояние?
</p>
</li>
<li>
<p>
Где я могу провести границу между моими системами, где я смогу использовать <a href="https://oreil.ly/zNUGG">шов</a> чтобы вставить эту абстракцию?
  
</p>
</li>
<li>
<p>
Что такое разумный способ разделения объектов на компоненты с различными обязанностями?  Какие неявные понятия я могу сделать явными?
</p>
</li>
<li>
<p>
Что же такое зависимость, и каковы основные бизнес-логики?
</p>
</li>
</ul></div>
<div class="paragraph"><p>Практика делает его менее несовершенным! А теперь вернемся к <span class=".line-through">нашим баранам</span> нашему обычному  программированию&#8230;</p></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="chapter_04_service_layer">Наш первый Use Case или пример использования: <span class=".keep-together">Flask API и Service Layer</span></h2>
<div class="sectionbody">
<div class="paragraph"><p>Вернемся к нашему исходному проекту! Схема <a href="#maps_service_layer_before">[maps_service_layer_before]</a> показывает точку, которую мы достигли в конце <a href="#chapter_02_repository">[chapter_02_repository]</a>, которая включает в себя шаблон репозитория.</p></div>
<div class="imageblock width-75" id="maps_service_layer_before">
<div class="content">
<img src="images/apwp_0401.png" alt="images/apwp_0401.png" />
</div>
<div class="title">Figure 16. Управляем приложением, общаясь с репозиторием и моделью домена</div>
</div>
<div class="paragraph"><p>В этой главе мы обсудим различие между Orchestration logic, business logic и interfacing code, а также введем модель  <em>Service Layer</em> для координации наших бизнес - процессов и определения вариантов использования системы.</p></div>
<div class="paragraph"><p>Мы также обсудим тестирование: объединив уровень сервиса с нашей абстракцией репозитория над базой данных, мы можем писать быстрые тесты не только нашей модели предметной области, но и всего рабочего процесса для конкретного случая использования.</p></div>
<div class="paragraph"><p>Схема <a href="#maps_service_layer_after">[maps_service_layer_after]</a> показывает, то к чему мы стремимся: Собираемся добавить API Flask, который будет общаться с уровнем сервиса, который будет служить точкой входа в нашу доменную модель. Поскольку наш уровень обслуживания зависит от <code>AbstractRepository</code>, мы можем модульно протестировать его с помощью <code>FakeRepository</code>, но запустить наш production код с помощью <code>SqlAlchemyRepository</code>.</p></div>
<div class="imageblock" id="maps_service_layer_after">
<div class="content">
<img src="images/apwp_0402.png" alt="images/apwp_0402.png" />
</div>
<div class="title">Figure 17. Сервис будет основным способом доступа к нашим приложениям</div>
</div>
<div class="paragraph"><p>В наших диаграммах мы используем соглашение о том, что новые компоненты выделяются жирным шрифтом/линиями (и желтым/оранжевым цветом, если вы читаете цифровую версию).</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/tip.png" alt="Tip" />
</td>
<td class="content">
<div class="paragraph"><p>Код этой главы находится в ветке chapter_04_service_layer <a href="https://oreil.ly/TBRuy">on GitHub</a>:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>git clone https://github.com/cosmicpython/code.git
cd code
git checkout chapter_04_service_layer
# or to code along, checkout Chapter 2:
git checkout chapter_02_repository</code></pre>
</div></div>
</td>
</tr></table>
</div>
<div class="sect2">
<h3 id="_подключение_нашего_приложения_к_реальному_миру">Подключение нашего приложения к реальному миру</h3>
<div class="paragraph"><p>Как и любая другая команда, быстрая и проворная, мы пытаемся получить MVP (минимально жизнеспособный продукт) и собрать обратную связь на глазах у пользователей. У нас есть ядро нашей доменной модели и доменная служба, необходимая для распределения заказов, а также интерфейс репозитория для постоянного хранилища.</p></div>
<div class="paragraph"><p>Давайте как можно скорее соединим все мобильные компоненты и перестроим их в более чистую архитектуру. Наш план таков:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
Используем Flask, чтобы поместить endpoint API перед сервисом <code>allocate</code>.
    Подключаем сеанс базы данных и наш репозиторий. Тестируем его с помощью сквозного теста и некоторого quick-and-dirty SQL для подготовки тестовых данных.    Проводим сеанс работы с базой данных и нашим репозиторием. Протестируем его с помощью сквозного теста и небольшого количества quick-and-dirty SQL запросов для подготовки тестовых данных.
   
</p>
</li>
<li>
<p>
Отрефакторим сервисный уровень, который будет служить абстракцией для захвата сценария использования и который будет находиться между Flask и нашей моделью домена.    Построим несколько тестов сервисного уровня и покажем, как они могут использовать <code>FakeRepository</code>.
</p>
</li>
<li>
<p>
Поэкспериментируем с различными типами параметров для наших функций сервисного уровня; продемонстрируем, что использование примитивных типов данных позволяет отделить клиентов сервисного уровня (наши тесты и наш API Flask) от уровня модели.
</p>
</li>
</ol></div>
</div>
<div class="sect2">
<h3 id="_первый_сквозной_тест">Первый сквозной тест</h3>
<div class="paragraph"><p>Никто не заинтересован в долгих терминологических дебатах о том, что считается сквозным тестом (E2E) по сравнению с функциональным тестом по сравнению с приемочным тестом по сравнению с интеграционным тестом по сравнению с модульным тестом. Различные проекты нуждаются в различных комбинациях тестов, и мы видели, как совершенно успешные проекты просто делят вещи на "быстрые тесты" и "медленные тесты"."</p></div>
<div class="paragraph"><p>На данный момент мы хотим написать один или, может быть, два теста, которые будут использовать "реальную" конечную точку API (используя HTTP) и общаться с реальной базой данных. Давайте назовем их <em>сквозные тесты</em>, потому что это одно из самых понятных названий.</p></div>
<div class="paragraph"><p>Ниже показан первый разрез:</p></div>
<div class="exampleblock" id="first_api_test">
<div class="title">Example 48. Первый тест API (test_api.py)</div>
<div class="content">
<div class="listingblock non-head">
<div class="content"><div class="highlight"><pre><span></span><span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">usefixtures</span><span class="p">(</span><span class="s1">&#39;restart_api&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">test_api_returns_allocation</span><span class="p">(</span><span class="n">add_stock</span><span class="p">):</span>
    <span class="n">sku</span><span class="p">,</span> <span class="n">othersku</span> <span class="o">=</span> <span class="n">random_sku</span><span class="p">(),</span> <span class="n">random_sku</span><span class="p">(</span><span class="s1">&#39;other&#39;</span><span class="p">)</span>  <span class="c1">#<img src="./images/icons/callouts/1.png" alt="1" /></span>
    <span class="n">earlybatch</span> <span class="o">=</span> <span class="n">random_batchref</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">laterbatch</span> <span class="o">=</span> <span class="n">random_batchref</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">otherbatch</span> <span class="o">=</span> <span class="n">random_batchref</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">add_stock</span><span class="p">([</span>  <span class="c1">#<img src="./images/icons/callouts/2.png" alt="2" /></span>
        <span class="p">(</span><span class="n">laterbatch</span><span class="p">,</span> <span class="n">sku</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="s1">&#39;2011-01-02&#39;</span><span class="p">),</span>
        <span class="p">(</span><span class="n">earlybatch</span><span class="p">,</span> <span class="n">sku</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="s1">&#39;2011-01-01&#39;</span><span class="p">),</span>
        <span class="p">(</span><span class="n">otherbatch</span><span class="p">,</span> <span class="n">othersku</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
    <span class="p">])</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;orderid&#39;</span><span class="p">:</span> <span class="n">random_orderid</span><span class="p">(),</span> <span class="s1">&#39;sku&#39;</span><span class="p">:</span> <span class="n">sku</span><span class="p">,</span> <span class="s1">&#39;qty&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">}</span>
    <span class="n">url</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get_api_url</span><span class="p">()</span>  <span class="c1">#<img src="./images/icons/callouts/3.png" alt="3" /></span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s1">/allocate&#39;</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">r</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">201</span>
    <span class="k">assert</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;batchref&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">earlybatch</span>
</pre></div></div></div>
</div></div>
<div class="colist arabic"><table>
<tr><td><img src="./images/icons/callouts/1.png" alt="1" /></td><td>
<code>random_sku()</code>, <code>random_batchref ()</code> и так далее&#8201;&#8212;&#8201;это небольшие вспомогательные функции, которые генерируют случайные символы с помощью модуля <code>uuid</code>. Поскольку сейчас мы работаем с реальной базой данных, это один из способов предотвратить взаимное влияние различных тестов друг на друга.
</td></tr>
<tr><td><img src="./images/icons/callouts/2.png" alt="2" /></td><td>
<code>add_stock</code>&#8201;&#8212;&#8201;это вспомогательная фикстура, инструмент, который просто скрывает детали ручной вставки строк в базу данных с помощью SQL. В конце этой главы мы покажем способ получше.
</td></tr>
<tr><td><img src="./images/icons/callouts/3.png" alt="3" /></td><td>
<em>config.py</em> это модуль, в котором мы храним информацию о конфигурации.
</td></tr>
</table></div>
<div class="paragraph"><p>Все решают эти проблемы по-разному, но вам понадобится какой-то способ развернуть Flask, возможно, в контейнере, и пообщаться с базой данных Postgres. Если вы хотите увидеть, как мы это сделали, ознакомьтесь
<a href="#appendix_project_structure">[appendix_project_structure]</a>.</p></div>
</div>
<div class="sect2">
<h3 id="_простая_реализация">Простая Реализация</h3>
<div class="paragraph"><p>Реализуя вещи самым очевидным образом, вы можете получить что-то вроде этого:</p></div>
<div class="exampleblock" id="first_cut_flask_app">
<div class="title">Example 49. First cut of Flask app (flask_app.py)</div>
<div class="content">
<div class="listingblock non-head">
<div class="content"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">jsonify</span><span class="p">,</span> <span class="n">request</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">create_engine</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">sessionmaker</span>

<span class="kn">import</span> <span class="nn">config</span>
<span class="kn">import</span> <span class="nn">model</span>
<span class="kn">import</span> <span class="nn">orm</span>
<span class="kn">import</span> <span class="nn">repository</span>


<span class="n">orm</span><span class="o">.</span><span class="n">start_mappers</span><span class="p">()</span>
<span class="n">get_session</span> <span class="o">=</span> <span class="n">sessionmaker</span><span class="p">(</span><span class="n">bind</span><span class="o">=</span><span class="n">create_engine</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">get_postgres_uri</span><span class="p">()))</span>
<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/allocate&quot;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">allocate_endpoint</span><span class="p">():</span>
    <span class="n">session</span> <span class="o">=</span> <span class="n">get_session</span><span class="p">()</span>
    <span class="n">batches</span> <span class="o">=</span> <span class="n">repository</span><span class="o">.</span><span class="n">SqlAlchemyRepository</span><span class="p">(</span><span class="n">session</span><span class="p">)</span><span class="o">.</span><span class="n">list</span><span class="p">()</span>
    <span class="n">line</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">OrderLine</span><span class="p">(</span>
        <span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="s1">&#39;orderid&#39;</span><span class="p">],</span>
        <span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="s1">&#39;sku&#39;</span><span class="p">],</span>
        <span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="s1">&#39;qty&#39;</span><span class="p">],</span>
    <span class="p">)</span>

    <span class="n">batchref</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">allocate</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">batches</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;batchref&#39;</span><span class="p">:</span> <span class="n">batchref</span><span class="p">}),</span> <span class="mi">201</span>
</pre></div></div></div>
</div></div>
<div class="paragraph"><p>Пока всё слишком хорошо. Боб и Гарри, вы наверное думаете, что вам больше не нужно говорить про "архитектурных астронавтов".</p></div>
<div class="paragraph"><p>Но подождите минутку&#8201;&#8212;&#8201;никаких обязательств. На самом деле мы не сохраняем наше распределение в базе данных. Теперь нам нужен второй тест, либо тот, который проверит состояние базы данных после (не очень black-boxy <em>чёрного ящика</em>), или, может быть, тот, который проверяет, что мы не можем выделить вторую строку, если первая уже должна была исчерпать пакет:</p></div>
<div class="exampleblock" id="second_api_test">
<div class="title">Example 50. Тест распределения с сохранением (test_api.py)</div>
<div class="content">
<div class="listingblock non-head">
<div class="content"><div class="highlight"><pre><span></span><span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">usefixtures</span><span class="p">(</span><span class="s1">&#39;restart_api&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">test_allocations_are_persisted</span><span class="p">(</span><span class="n">add_stock</span><span class="p">):</span>
    <span class="n">sku</span> <span class="o">=</span> <span class="n">random_sku</span><span class="p">()</span>
    <span class="n">batch1</span><span class="p">,</span> <span class="n">batch2</span> <span class="o">=</span> <span class="n">random_batchref</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">random_batchref</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">order1</span><span class="p">,</span> <span class="n">order2</span> <span class="o">=</span> <span class="n">random_orderid</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">random_orderid</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">add_stock</span><span class="p">([</span>
        <span class="p">(</span><span class="n">batch1</span><span class="p">,</span> <span class="n">sku</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="s1">&#39;2011-01-01&#39;</span><span class="p">),</span>
        <span class="p">(</span><span class="n">batch2</span><span class="p">,</span> <span class="n">sku</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="s1">&#39;2011-01-02&#39;</span><span class="p">),</span>
    <span class="p">])</span>
    <span class="n">line1</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;orderid&#39;</span><span class="p">:</span> <span class="n">order1</span><span class="p">,</span> <span class="s1">&#39;sku&#39;</span><span class="p">:</span> <span class="n">sku</span><span class="p">,</span> <span class="s1">&#39;qty&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">}</span>
    <span class="n">line2</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;orderid&#39;</span><span class="p">:</span> <span class="n">order2</span><span class="p">,</span> <span class="s1">&#39;sku&#39;</span><span class="p">:</span> <span class="n">sku</span><span class="p">,</span> <span class="s1">&#39;qty&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">}</span>
    <span class="n">url</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get_api_url</span><span class="p">()</span>

    <span class="c1"># первый заказ использует все запасы в партии 1</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s1">/allocate&#39;</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="n">line1</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">r</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">201</span>
    <span class="k">assert</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;batchref&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">batch1</span>

    <span class="c1"># второй заказ должен перейти в партию 2</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s1">/allocate&#39;</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="n">line2</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">r</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">201</span>
    <span class="k">assert</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;batchref&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">batch2</span>
</pre></div></div></div>
</div></div>
<div class="paragraph"><p>Не совсем так красиво, но это заставит нас добавить коммит.</p></div>
</div>
<div class="sect2">
<h3 id="_ошибочные_условия_требуют_проверки_базы_данных">Ошибочные условия требуют проверки базы данных</h3>
<div class="paragraph"><p>Если мы будем продолжать в том же духе, все станет ещё хуже и хуже.</p></div>
<div class="paragraph"><p>Предположим, что мы добавим несколько обработок ошибок. Что делать, если домен вызывает ошибку для SKU, которого нет в наличии?  Или как насчет SKU, которого даже не существует? Об этом домен даже не знает, да и не должен знать. Это скорее проверка на вменяемость, которую мы должны применить на уровне базы данных, прежде чем мы даже вызовем службу домена.</p></div>
<div class="paragraph"><p>Теперь мы рассмотрим еще пару сквозных теста:</p></div>
<div class="exampleblock" id="test_error_cases">
<div class="title">Example 51. Еще больше тестов на уровне E2E (test_api.py)</div>
<div class="content">
<div class="listingblock non-head">
<div class="content"><div class="highlight"><pre><span></span><span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">usefixtures</span><span class="p">(</span><span class="s1">&#39;restart_api&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">test_400_message_for_out_of_stock</span><span class="p">(</span><span class="n">add_stock</span><span class="p">):</span>  <span class="c1">#<img src="./images/icons/callouts/1.png" alt="1" /></span>
    <span class="n">sku</span><span class="p">,</span> <span class="n">smalL_batch</span><span class="p">,</span> <span class="n">large_order</span> <span class="o">=</span> <span class="n">random_sku</span><span class="p">(),</span> <span class="n">random_batchref</span><span class="p">(),</span> <span class="n">random_orderid</span><span class="p">()</span>
    <span class="n">add_stock</span><span class="p">([</span>
        <span class="p">(</span><span class="n">smalL_batch</span><span class="p">,</span> <span class="n">sku</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="s1">&#39;2011-01-01&#39;</span><span class="p">),</span>
    <span class="p">])</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;orderid&#39;</span><span class="p">:</span> <span class="n">large_order</span><span class="p">,</span> <span class="s1">&#39;sku&#39;</span><span class="p">:</span> <span class="n">sku</span><span class="p">,</span> <span class="s1">&#39;qty&#39;</span><span class="p">:</span> <span class="mi">20</span><span class="p">}</span>
    <span class="n">url</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get_api_url</span><span class="p">()</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s1">/allocate&#39;</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">r</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">400</span>
    <span class="k">assert</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;message&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="sa">f</span><span class="s1">&#39;Out of stock for sku </span><span class="si">{</span><span class="n">sku</span><span class="si">}</span><span class="s1">&#39;</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">usefixtures</span><span class="p">(</span><span class="s1">&#39;restart_api&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">test_400_message_for_invalid_sku</span><span class="p">():</span>  <span class="c1">#<img src="./images/icons/callouts/2.png" alt="2" /></span>
    <span class="n">unknown_sku</span><span class="p">,</span> <span class="n">orderid</span> <span class="o">=</span> <span class="n">random_sku</span><span class="p">(),</span> <span class="n">random_orderid</span><span class="p">()</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;orderid&#39;</span><span class="p">:</span> <span class="n">orderid</span><span class="p">,</span> <span class="s1">&#39;sku&#39;</span><span class="p">:</span> <span class="n">unknown_sku</span><span class="p">,</span> <span class="s1">&#39;qty&#39;</span><span class="p">:</span> <span class="mi">20</span><span class="p">}</span>
    <span class="n">url</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get_api_url</span><span class="p">()</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s1">/allocate&#39;</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">r</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">400</span>
    <span class="k">assert</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;message&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="sa">f</span><span class="s1">&#39;Invalid sku </span><span class="si">{</span><span class="n">unknown_sku</span><span class="si">}</span><span class="s1">&#39;</span>
</pre></div></div></div>
</div></div>
<div class="colist arabic"><table>
<tr><td><img src="./images/icons/callouts/1.png" alt="1" /></td><td>
В первом тесте мы пытаемся выделить больше единиц, чем есть на складе.
</td></tr>
<tr><td><img src="./images/icons/callouts/2.png" alt="2" /></td><td>
Во втором случае SKU просто не существует (потому что мы никогда не вызывали <code>add_stock</code>), поэтому он недействителен для нашего приложения.
</td></tr>
</table></div>
<div class="paragraph"><p>И конечно, мы могли бы реализовать его и в приложении Flask:</p></div>
<div class="exampleblock" id="flask_error_handling">
<div class="title">Example 52. Приложение Flask начинает становиться крутым (flask_app.py)</div>
<div class="content">
<div class="listingblock non-head">
<div class="content"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">is_valid_sku</span><span class="p">(</span><span class="n">sku</span><span class="p">,</span> <span class="n">batches</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">sku</span> <span class="ow">in</span> <span class="p">{</span><span class="n">b</span><span class="o">.</span><span class="n">sku</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">batches</span><span class="p">}</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/allocate&quot;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">allocate_endpoint</span><span class="p">():</span>
    <span class="n">session</span> <span class="o">=</span> <span class="n">get_session</span><span class="p">()</span>
    <span class="n">batches</span> <span class="o">=</span> <span class="n">repository</span><span class="o">.</span><span class="n">SqlAlchemyRepository</span><span class="p">(</span><span class="n">session</span><span class="p">)</span><span class="o">.</span><span class="n">list</span><span class="p">()</span>
    <span class="n">line</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">OrderLine</span><span class="p">(</span>
        <span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="s1">&#39;orderid&#39;</span><span class="p">],</span>
        <span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="s1">&#39;sku&#39;</span><span class="p">],</span>
        <span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="s1">&#39;qty&#39;</span><span class="p">],</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">is_valid_sku</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">sku</span><span class="p">,</span> <span class="n">batches</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Invalid sku </span><span class="si">{</span><span class="n">line</span><span class="o">.</span><span class="n">sku</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">}),</span> <span class="mi">400</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">batchref</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">allocate</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">batches</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">model</span><span class="o">.</span><span class="n">OutOfStock</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}),</span> <span class="mi">400</span>

    <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;batchref&#39;</span><span class="p">:</span> <span class="n">batchref</span><span class="p">}),</span> <span class="mi">201</span>
</pre></div></div></div>
</div></div>
<div class="paragraph"><p>Но наше приложение Flask начинает выглядеть слегка громоздким.  И наше количество тестов E2E начинает выходить из-под контроля, и вскоре мы получим перевернутую тестовую пирамиду (или "модель рожка мороженого", как любит называть ее Боб).</p></div>
</div>
<div class="sect2">
<h3 id="_представляем_сервисный_слой_и_используем_fakerepository_для_его_модульного_тестирования">Представляем сервисный слой и используем FakeRepository для его модульного тестирования</h3>
<div class="paragraph"><p>Если мы посмотрим на то, что делает наше приложение Flask, то увидим довольно много того, что мы могли бы назвать <em>orchestration</em> —- извлечение материала из нашего репозитория, проверка наших входных данных на соответствие состоянию базы данных, обработка ошибок и фиксация в happy path. Большинство из этих вещей не имеют ничего общего с наличием web API endpoint (они понадобились бы вам, если бы вы создавали, например CLI; см. <a href="#appendix_csvs">[appendix_csvs]</a>), и на самом деле это не те вещи, которые нужно тестировать сквозными тестами.</p></div>
<div class="paragraph"><p>Часто имеет смысл разделить service layer, иногда называемый <em>orchestration layer</em>  слоем оркестровки  или <em>use-case</em> слоем прецедентов .</p></div>
<div class="paragraph"><p>Вы помните "FakeRepository", который мы подготовили в <a href="#chapter_03_abstractions">[chapter_03_abstractions]</a>?</p></div>
<div class="exampleblock" id="fake_repo">
<div class="title">Example 53. Our fake repository, an in-memory collection of batches (test_services.py)</div>
<div class="content">
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">FakeRepository</span><span class="p">(</span><span class="n">repository</span><span class="o">.</span><span class="n">AbstractRepository</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batches</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_batches</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">batches</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_batches</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reference</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">next</span><span class="p">(</span><span class="n">b</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_batches</span> <span class="k">if</span> <span class="n">b</span><span class="o">.</span><span class="n">reference</span> <span class="o">==</span> <span class="n">reference</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">list</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_batches</span><span class="p">)</span>
</pre></div></div></div>
</div></div>
<div class="paragraph"><p>Вот где он будет полезен; он позволяет нам тестировать наш уровень обслуживания с помощью хороших, быстрых модульных тестов:</p></div>
<div class="exampleblock" id="first_services_tests">
<div class="title">Example 54. Модульное тестирование с фейками на уровне сервиса (test_services.py)</div>
<div class="content">
<div class="listingblock non-head">
<div class="content"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">test_returns_allocation</span><span class="p">():</span>
    <span class="n">line</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">OrderLine</span><span class="p">(</span><span class="s2">&quot;o1&quot;</span><span class="p">,</span> <span class="s2">&quot;COMPLICATED-LAMP&quot;</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
    <span class="n">batch</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">Batch</span><span class="p">(</span><span class="s2">&quot;b1&quot;</span><span class="p">,</span> <span class="s2">&quot;COMPLICATED-LAMP&quot;</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="n">eta</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">repo</span> <span class="o">=</span> <span class="n">FakeRepository</span><span class="p">([</span><span class="n">batch</span><span class="p">])</span>  <span class="c1">#<img src="./images/icons/callouts/1.png" alt="1" /></span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">services</span><span class="o">.</span><span class="n">allocate</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">repo</span><span class="p">,</span> <span class="n">FakeSession</span><span class="p">())</span>  <span class="c1">#<img src="./images/icons/callouts/2.png" alt="2" /><img src="./images/icons/callouts/3.png" alt="3" /></span>
    <span class="k">assert</span> <span class="n">result</span> <span class="o">==</span> <span class="s2">&quot;b1&quot;</span>


<span class="k">def</span> <span class="nf">test_error_for_invalid_sku</span><span class="p">():</span>
    <span class="n">line</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">OrderLine</span><span class="p">(</span><span class="s2">&quot;o1&quot;</span><span class="p">,</span> <span class="s2">&quot;NONEXISTENTSKU&quot;</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
    <span class="n">batch</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">Batch</span><span class="p">(</span><span class="s2">&quot;b1&quot;</span><span class="p">,</span> <span class="s2">&quot;AREALSKU&quot;</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="n">eta</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">repo</span> <span class="o">=</span> <span class="n">FakeRepository</span><span class="p">([</span><span class="n">batch</span><span class="p">])</span>  <span class="c1">#<img src="./images/icons/callouts/1.png" alt="1" /></span>

    <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="n">services</span><span class="o">.</span><span class="n">InvalidSku</span><span class="p">,</span> <span class="n">match</span><span class="o">=</span><span class="s2">&quot;Invalid sku NONEXISTENTSKU&quot;</span><span class="p">):</span>
        <span class="n">services</span><span class="o">.</span><span class="n">allocate</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">repo</span><span class="p">,</span> <span class="n">FakeSession</span><span class="p">())</span>  <span class="c1">#<img src="./images/icons/callouts/2.png" alt="2" /><img src="./images/icons/callouts/3.png" alt="3" /></span>
</pre></div></div></div>
</div></div>
<div class="colist arabic"><table>
<tr><td><img src="./images/icons/callouts/1.png" alt="1" /></td><td>
<code>FakeRepository</code> содержит объекты <code>Batch</code>, которые будут использоваться в нашем тесте.
</td></tr>
<tr><td><img src="./images/icons/callouts/2.png" alt="2" /></td><td>
Наш сервисный модуль (<em>services.py</em>) определит функцию сервисного уровня <code>allocate()</code>. Он будет находиться между нашей функцией <code>allocate_endpoint()</code> на уровне API и функцией доменной службы <code>allocate()</code> из нашей модели домена.<span class="footnote"><br />[Службы сервисного уровня и доменные службы имеют до смешного похожие имена. Мы обсудим эту тему позже.
    <a href="#why_is_everything_a_service">[why_is_everything_a_service]</a>.]<br /></span>
</td></tr>
<tr><td><img src="./images/icons/callouts/3.png" alt="3" /></td><td>
Нам также нужен "FakeSession", чтобы подделать сеанс базы данных, как показано в следующем фрагменте кода.
    
    
</td></tr>
</table></div>
<div class="exampleblock" id="fake_session">
<div class="title">Example 55. A fake database session (test_services.py)</div>
<div class="content">
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">FakeSession</span><span class="p">():</span>
    <span class="n">committed</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">commit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">committed</span> <span class="o">=</span> <span class="kc">True</span>
</pre></div></div></div>
</div></div>
<div class="paragraph"><p>Эта фальшивая сессия - лишь временное решение.  Мы скоро избавимся от него и сделаем все лучше. <a href="#chapter_06_uow">[chapter_06_uow]</a>. Но в то же время фейковый <code>.commit()</code> позволяет нам перенести третий тест со слоя E2E:</p></div>
<div class="exampleblock" id="second_services_test">
<div class="title">Example 56. Второй тест на сервисном уровне (test_services.py)</div>
<div class="content">
<div class="listingblock non-head">
<div class="content"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">test_commits</span><span class="p">():</span>
    <span class="n">line</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">OrderLine</span><span class="p">(</span><span class="s1">&#39;o1&#39;</span><span class="p">,</span> <span class="s1">&#39;OMINOUS-MIRROR&#39;</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
    <span class="n">batch</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">Batch</span><span class="p">(</span><span class="s1">&#39;b1&#39;</span><span class="p">,</span> <span class="s1">&#39;OMINOUS-MIRROR&#39;</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="n">eta</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">repo</span> <span class="o">=</span> <span class="n">FakeRepository</span><span class="p">([</span><span class="n">batch</span><span class="p">])</span>
    <span class="n">session</span> <span class="o">=</span> <span class="n">FakeSession</span><span class="p">()</span>

    <span class="n">services</span><span class="o">.</span><span class="n">allocate</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">repo</span><span class="p">,</span> <span class="n">session</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">session</span><span class="o">.</span><span class="n">committed</span> <span class="ow">is</span> <span class="kc">True</span>
</pre></div></div></div>
</div></div>
<div class="sect3">
<h4 id="_типичная_service_function">Типичная Service Function</h4>
<div class="paragraph"><p>Мы напишем служебную функцию, которая выглядит примерно так:</p></div>
<div class="exampleblock" id="service_function">
<div class="title">Example 57. Базовая служба распределения (services.py)</div>
<div class="content">
<div class="listingblock non-head">
<div class="content"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">InvalidSku</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="k">def</span> <span class="nf">is_valid_sku</span><span class="p">(</span><span class="n">sku</span><span class="p">,</span> <span class="n">batches</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">sku</span> <span class="ow">in</span> <span class="p">{</span><span class="n">b</span><span class="o">.</span><span class="n">sku</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">batches</span><span class="p">}</span>

<span class="k">def</span> <span class="nf">allocate</span><span class="p">(</span><span class="n">line</span><span class="p">:</span> <span class="n">OrderLine</span><span class="p">,</span> <span class="n">repo</span><span class="p">:</span> <span class="n">AbstractRepository</span><span class="p">,</span> <span class="n">session</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">batches</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">list</span><span class="p">()</span>  <span class="c1">#<img src="./images/icons/callouts/1.png" alt="1" /></span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">is_valid_sku</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">sku</span><span class="p">,</span> <span class="n">batches</span><span class="p">):</span>  <span class="c1">#<img src="./images/icons/callouts/2.png" alt="2" /></span>
        <span class="k">raise</span> <span class="n">InvalidSku</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Invalid sku </span><span class="si">{</span><span class="n">line</span><span class="o">.</span><span class="n">sku</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">batchref</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">allocate</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">batches</span><span class="p">)</span>  <span class="c1">#<img src="./images/icons/callouts/3.png" alt="3" /></span>
    <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>  <span class="c1">#<img src="./images/icons/callouts/4.png" alt="4" /></span>
    <span class="k">return</span> <span class="n">batchref</span>
</pre></div></div></div>
</div></div>
<div class="paragraph"><p>Типичные функции сервисного уровня имеют сходные этапы:</p></div>
<div class="colist arabic"><table>
<tr><td><img src="./images/icons/callouts/1.png" alt="1" /></td><td>
Извлекаем  некоторые объекты из репозитория.
</td></tr>
<tr><td><img src="./images/icons/callouts/2.png" alt="2" /></td><td>
Мы делаем несколько подтверждений или опровергаем требования о текущем состоянии мира.
</td></tr>
<tr><td><img src="./images/icons/callouts/3.png" alt="3" /></td><td>
Мы вызываем доменную службу.
</td></tr>
<tr><td><img src="./images/icons/callouts/4.png" alt="4" /></td><td>
Если все хорошо, то мы сохраняем/обновляем любое состояние, которое мы изменили.
</td></tr>
</table></div>
<div class="paragraph"><p>Этот последний шаг на данный момент несовсем удовлетворителен, поскольку наш сервисный уровень тесно связан с нашим уровнем базы данных. Мы улучшим это в <a href="#chapter_06_uow">[chapter_06_uow]</a> с помощью шаблона Unit of Work.</p></div>
<div class="sidebarblock nobreakinside less_space" id="depend_on_abstractions">
<div class="content">
<div class="title">Зависеть от абстракций</div>
<div class="paragraph"><p>Обратите внимание на еще одну особенность нашей функции уровня сервиса:</p></div>
<div class="listingblock skip">
<div class="content"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">allocate</span><span class="p">(</span><span class="n">line</span><span class="p">:</span> <span class="n">OrderLine</span><span class="p">,</span> <span class="n">repo</span><span class="p">:</span> <span class="n">AbstractRepository</span><span class="p">,</span> <span class="n">session</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</pre></div></div></div>
<div class="paragraph"><p>Она зависит от репозитория.  Мы решили сделать зависимость явной и использовали аннотацию типа, чтобы показать, что мы зависим от <code>AbstractRepository</code>. Это означает, что функция будет работать даже тогда, когда тесты предоставят ему <code>FakeRepository</code>, или когда приложение Flask предоставит ему <code>SqlAlchemyRepository</code>.</p></div>
<div class="paragraph"><p>Если вы помните <a href="#dip">[dip]</a>,
это то, что мы имеем в виду, когда говорим, что должны «зависеть от абстракций». Наш  <em>high-level module</em>,  уровень обслуживания, зависит от абстракции репозитория. И <em>детали</em> реализации для нашего конкретного выбора постоянного хранилища также зависят от той же абстракции. См.
<a href="#service_layer_diagram_abstract_dependencies">[service_layer_diagram_abstract_dependencies]</a> и
<a href="#service_layer_diagram_test_dependencies">[service_layer_diagram_test_dependencies]</a>.</p></div>
<div class="paragraph"><p>См. также в <a href="#appendix_csvs">[appendix_csvs]</a> отработаемый пример замены <em>деталей</em>, которые постоянно используется системой хранения данных, оставляя абстракции нетронутыми.</p></div>
</div></div>
<div class="paragraph"><p>Но самое необходимое для уровня сервиса уже есть, и наше приложение Flask теперь выглядит намного чище:</p></div>
<div class="exampleblock" id="flask_app_using_service_layer">
<div class="title">Example 58. Делегирование приложения Flask на уровень сервиса (flask_app.py)</div>
<div class="content">
<div class="listingblock non-head">
<div class="content"><div class="highlight"><pre><span></span><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/allocate&quot;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">allocate_endpoint</span><span class="p">():</span>
    <span class="n">session</span> <span class="o">=</span> <span class="n">get_session</span><span class="p">()</span>  <span class="c1">#<img src="./images/icons/callouts/1.png" alt="1" /></span>
    <span class="n">repo</span> <span class="o">=</span> <span class="n">repository</span><span class="o">.</span><span class="n">SqlAlchemyRepository</span><span class="p">(</span><span class="n">session</span><span class="p">)</span>  <span class="c1">#<img src="./images/icons/callouts/1.png" alt="1" /></span>
    <span class="n">line</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">OrderLine</span><span class="p">(</span>
        <span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="s1">&#39;orderid&#39;</span><span class="p">],</span>  <span class="c1">#<img src="./images/icons/callouts/2.png" alt="2" /></span>
        <span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="s1">&#39;sku&#39;</span><span class="p">],</span>  <span class="c1">#<img src="./images/icons/callouts/2.png" alt="2" /></span>
        <span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="s1">&#39;qty&#39;</span><span class="p">],</span>  <span class="c1">#<img src="./images/icons/callouts/2.png" alt="2" /></span>
    <span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">batchref</span> <span class="o">=</span> <span class="n">services</span><span class="o">.</span><span class="n">allocate</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">repo</span><span class="p">,</span> <span class="n">session</span><span class="p">)</span>  <span class="c1">#<img src="./images/icons/callouts/2.png" alt="2" /></span>
    <span class="k">except</span> <span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">OutOfStock</span><span class="p">,</span> <span class="n">services</span><span class="o">.</span><span class="n">InvalidSku</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}),</span> <span class="mi">400</span>  <span class="o">&lt;</span><span class="mi">3</span><span class="o">&gt;</span>

    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;batchref&#39;</span><span class="p">:</span> <span class="n">batchref</span><span class="p">}),</span> <span class="mi">201</span>  <span class="o">&lt;</span><span class="mi">3</span><span class="o">&gt;</span>
</pre></div></div></div>
</div></div>
<div class="colist arabic"><table>
<tr><td><img src="./images/icons/callouts/1.png" alt="1" /></td><td>
Инстанцируем сеанс работы с базой данных и некоторые объекты репозитория.
</td></tr>
<tr><td><img src="./images/icons/callouts/2.png" alt="2" /></td><td>
Извлекаем команды пользователя из веб-запроса и передаем их службе домена.
</td></tr>
<tr><td><img src="./images/icons/callouts/3.png" alt="3" /></td><td>
Возвращаем несколько ответов JSON с соответствующими кодами состояния.
</td></tr>
</table></div>
<div class="paragraph"><p>Обязанности приложения Flask - это обычные веб-вещи: управление сеансами по каждому запросу, анализ информации из параметров POST, коды состояния ответа и JSON. Вся логика оркестрации находится на уровне использования case/service, а логика домена остается в домене.</p></div>
<div class="paragraph"><p>Наконец, мы можем уверенно разделить наши тесты E2E всего на два: один для пути удачных решений и один для неверного выбора:</p></div>
<div class="exampleblock" id="fewer_e2e_tests">
<div class="title">Example 59. E2E тесты только для happy и unhappy paths (test_api.py)</div>
<div class="content">
<div class="listingblock non-head">
<div class="content"><div class="highlight"><pre><span></span><span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">usefixtures</span><span class="p">(</span><span class="s1">&#39;restart_api&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">test_happy_path_returns_201_and_allocated_batch</span><span class="p">(</span><span class="n">add_stock</span><span class="p">):</span>
    <span class="n">sku</span><span class="p">,</span> <span class="n">othersku</span> <span class="o">=</span> <span class="n">random_sku</span><span class="p">(),</span> <span class="n">random_sku</span><span class="p">(</span><span class="s1">&#39;other&#39;</span><span class="p">)</span>
    <span class="n">earlybatch</span> <span class="o">=</span> <span class="n">random_batchref</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">laterbatch</span> <span class="o">=</span> <span class="n">random_batchref</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">otherbatch</span> <span class="o">=</span> <span class="n">random_batchref</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">add_stock</span><span class="p">([</span>
        <span class="p">(</span><span class="n">laterbatch</span><span class="p">,</span> <span class="n">sku</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="s1">&#39;2011-01-02&#39;</span><span class="p">),</span>
        <span class="p">(</span><span class="n">earlybatch</span><span class="p">,</span> <span class="n">sku</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="s1">&#39;2011-01-01&#39;</span><span class="p">),</span>
        <span class="p">(</span><span class="n">otherbatch</span><span class="p">,</span> <span class="n">othersku</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
    <span class="p">])</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;orderid&#39;</span><span class="p">:</span> <span class="n">random_orderid</span><span class="p">(),</span> <span class="s1">&#39;sku&#39;</span><span class="p">:</span> <span class="n">sku</span><span class="p">,</span> <span class="s1">&#39;qty&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">}</span>
    <span class="n">url</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get_api_url</span><span class="p">()</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s1">/allocate&#39;</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">r</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">201</span>
    <span class="k">assert</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;batchref&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">earlybatch</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">usefixtures</span><span class="p">(</span><span class="s1">&#39;restart_api&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">test_unhappy_path_returns_400_and_error_message</span><span class="p">():</span>
    <span class="n">unknown_sku</span><span class="p">,</span> <span class="n">orderid</span> <span class="o">=</span> <span class="n">random_sku</span><span class="p">(),</span> <span class="n">random_orderid</span><span class="p">()</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;orderid&#39;</span><span class="p">:</span> <span class="n">orderid</span><span class="p">,</span> <span class="s1">&#39;sku&#39;</span><span class="p">:</span> <span class="n">unknown_sku</span><span class="p">,</span> <span class="s1">&#39;qty&#39;</span><span class="p">:</span> <span class="mi">20</span><span class="p">}</span>
    <span class="n">url</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get_api_url</span><span class="p">()</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s1">/allocate&#39;</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">r</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">400</span>
    <span class="k">assert</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;message&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="sa">f</span><span class="s1">&#39;Invalid sku </span><span class="si">{</span><span class="n">unknown_sku</span><span class="si">}</span><span class="s1">&#39;</span>
</pre></div></div></div>
</div></div>
<div class="paragraph"><p>Мы успешно разделили наши тесты на две большие категории: тесты на веб-материалы, которые мы реализуем от начала до конца; и тесты, связанные с оркестровкой, которые мы можем протестировать на уровне сервиса в памяти.</p></div>
<div class="sidebarblock nobreakinside less_space">
<div class="content">
<div class="title">Упражнение для читателя</div>
<div class="paragraph"><p>Теперь, когда у нас есть служба распределения, почему бы не создать службу для <code>освобождения</code>? Мы добавили <a href="https://github.com/cosmicpython/code/tree/chapter_04_service_layer_exercise">тест E2E и несколько тестов stub для уровня сервиса</a> для вас, чтобы начать работу на GitHub.</p></div>
<div class="paragraph"><p>Если этого недостаточно, переходите к тестам E2E и <em>flask_app.py</em> и отрефакторите адаптер Flask, чтобы он был более RESTful. Обратите внимание, что это не требует каких-либо изменений в нашем сервисном или доменном слое!</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/tip.png" alt="Tip" />
</td>
<td class="content">Если вы решили, что хотите создать конечную точку read-only для получения информации о выделении, просто сделайте «простейшую вещь, которая может сработать», а именно <code>repo.get()</code> прямо в обработчике Flask. Мы поговорим больше о чтении и записи в <a href="#chapter_12_cqrs">[chapter_12_cqrs]</a>.</td>
</tr></table>
</div>
</div></div>
</div>
</div>
<div class="sect2">
<h3 id="why_is_everything_a_service">Почему всё называется сервисом?</h3>
<div class="paragraph"><p>Некоторые из вас, вероятно, сейчас ломают голову, пытаясь точно понять, в чем разница между доменным сервисом и уровнем сервиса.</p></div>
<div class="paragraph"><p>К сожалению, не мы выбрали имена, иначе у нас были бы более разумные и дружелюбные способы поговорить об этом.</p></div>
<div class="paragraph"><p>В этой главе мы используем две вещи, называемые <em>service</em>. Первый-это <em>application service</em> (наш service layer). Его работа заключается в обработке запросов из внешнего мира и в <em>orchestrate</em> операции. Мы имеем в виду, что уровень сервиса управляет приложением, следуя нескольким простым шагам:</p></div>
<div class="ulist"><ul>
<li>
<p>
Получить некоторые данные из базы данных
</p>
</li>
<li>
<p>
Обновить модели домена
</p>
</li>
<li>
<p>
Сохранить любые изменения
</p>
</li>
</ul></div>
<div class="paragraph"><p>Это рутина, которая должна выполняться для каждой операции в вашей системе, и отделение её от бизнес-логики помогает поддерживать порядок.</p></div>
<div class="paragraph"><p>Второй тип сервиса-это <em>domain service</em>. Это имя для части логики, которая принадлежит модели предметной области, но не находится естественным образом внутри состояния сущности или value object. Например, если вы создаете приложение для корзины покупок, вы можете выбрать создание правил налогообложения в качестве доменной службы. Расчет налога-это отдельная работа от обновления корзины, и это важная часть модели, но не кажется правильным иметь постоянную сущность для этой работы. Вместо этого эту работу может выполнять класс TaxCalculator или функция <code>calculate_tax</code>.</p></div>
</div>
<div class="sect2">
<h3 id="_разложим_всё_по_папкам_чтобы_увидеть_чему_всё_это_принадлежит">Разложим всё по папкам, чтобы увидеть, чему всё это принадлежит</h3>
<div class="paragraph"><p>По мере того, как приложения становятся все больше и больше, нам необходимо постоянно обновлять структуру каталогов. Компоновка проекта предоставляет полезные советы о том, что в каком файле находится.</p></div>
<div class="paragraph"><p>Мы можем организовать все так:</p></div>
<div class="exampleblock" id="nested_folder_tree">
<div class="title">Example 60. Some subfolders</div>
<div class="content">
<div class="listingblock skip">
<div class="content"><div class="highlight"><pre><span></span>.
├── config.py
├── domain  #<img src="./images/icons/callouts/1.png" alt="1" />
│   ├── __init__.py
│   └── model.py
├── service_layer  #<img src="./images/icons/callouts/2.png" alt="2" />
│   ├── __init__.py
│   └── services.py
├── adapters  #<img src="./images/icons/callouts/3.png" alt="3" />
│   ├── __init__.py
│   ├── orm.py
│   └── repository.py
├── entrypoints  <img src="./images/icons/callouts/4.png" alt="4" />
│   ├── __init__.py
│   └── flask_app.py
└── tests
    ├── __init__.py
    ├── conftest.py
    ├── unit
    │   ├── test_allocate.py
    │   ├── test_batches.py
    │   └── test_services.py
    ├── integration
    │   ├── test_orm.py
    │   └── test_repository.py
    └── e2e
        └── test_api.py
</pre></div></div></div>
</div></div>
<div class="colist arabic"><table>
<tr><td><img src="./images/icons/callouts/1.png" alt="1" /></td><td>
Давайте создадим папку для нашей доменной модели.
        В настоящее время это всего лишь один файл, но для более сложного приложения у
        вас может быть один файл на класс; у вас могут быть вспомогательные родительские классы для <code>Entity</code>, <code>ValueObject</code>, и <code>Aggregate</code>, и вы могли бы добавить
        <em>exceptions.py</em> для исключений доменного уровня и, как вы увидите в  <a href="#part2">[part2]</a>, <span class=".keep-together"><em>commands.py</em></span> и <em>events.py</em>.
    
</td></tr>
<tr><td><img src="./images/icons/callouts/2.png" alt="2" /></td><td>
Мы будем различать уровень обслуживания. В настоящее время это всего лишь один файл с именем <em>services.py</em> для наших функций сервисного уровня.  Здесь вы можете добавить исключения сервисного уровня, и, как вы увидите в <a href="#chapter_05_high_gear_low_gear">[chapter_05_high_gear_low_gear]</a>, мы добавим <em>unit_of_work.py</em>.
</td></tr>
<tr><td><img src="./images/icons/callouts/3.png" alt="3" /></td><td>
<em>Adapters</em> - это дань терминологии портов и адаптеров. Это заполнит любые другие абстракции вокруг внешнего I/O (напр., a <em>redis_client.py</em>).     Строго говоря, вы бы назвали эти адаптеры <em>secondary</em> или <em>driven</em> адаптерами, или иногда <em>inward-facing</em> адаптерами.
    
    
    
    
</td></tr>
<tr><td><img src="./images/icons/callouts/4.png" alt="4" /></td><td>
Точки входа <em>entrypoints</em>&#8201;&#8212;&#8201;это места, откуда мы управляем нашим приложением. В официальной терминологии портов и адаптеров они тоже являются адаптерами и называются адаптерами <em>primary</em> первичными, <em>driving</em> управляющими или <em>outward-facing</em> обращенными наружу.
    
</td></tr>
</table></div>
<div class="paragraph"><p>А как насчет портов?  Как вы помните, это абстрактные интерфейсы, которые
реализуют адаптеры. Мы склонны хранить их в том же файле, что и адаптеры, которые
их реализуют.</p></div>
</div>
<div class="sect2">
<h3 id="_резюме">Резюме</h3>
<div class="paragraph"><p>Добавление <em>service layer</em> уровня сервиса даёт немало преимуществ.</p></div>
<div class="ulist"><ul>
<li>
<p>
Наши entrypoints Flask API становятся очень тонкими и легкими в написании: их единственная обязанность-делать "web stuff", такие как разбор JSON и создание правильных HTTP-кодов для удачных или неудачных случаев.
</p>
</li>
<li>
<p>
Мы определили четкий API для нашего домена, набор вариантов использования или точек входа, которые могут быть использованы любым адаптером без необходимости знать что-либо о наших классах моделей домена-будь то API, CLI (см. <a href="#appendix_csvs">[appendix_csvs]</a>) или тесты! Они также являются адаптером для нашего домена.
</p>
</li>
<li>
<p>
Мы можем писать тесты на «высокой скорости», используя уровень сервиса, что дает нам возможность рефакторинга модели предметной области любым способом, который мы сочтем нужным. Пока мы можем предоставлять те же сценарии использования, мы можем экспериментировать с новыми проектами без необходимости переписывать множество тестов.
</p>
</li>
<li>
<p>
И наша пирамида тестирования выглядит неплохо&#8201;&#8212;&#8201;большая часть наших тестов&#8201;&#8212;&#8201;это быстрые модульные тесты, с минимальным количеством E2E и интеграционных тестов.
</p>
</li>
</ul></div>
<div class="sect3">
<h4 id="_dip_в_действии">DIP в действии</h4>
<div class="paragraph"><p><a href="#service_layer_diagram_abstract_dependencies">[service_layer_diagram_abstract_dependencies]</a> показывает зависимости нашего уровня сервиса: модель предметной области и <code>AbstractRepository</code> (порт в терминологии портов и адаптеров).</p></div>
<div class="paragraph"><p>Когда мы запускаем тесты, <a href="#service_layer_diagram_test_dependencies">[service_layer_diagram_test_dependencies]</a> показывает, как мы реализуем абстрактные зависимости с помощью <code>FakeRepository</code> (адаптера).</p></div>
<div class="paragraph"><p>И когда мы на самом деле запускаем наше приложение, мы меняем "реальную" зависимость, показанную в
<a href="#service_layer_diagram_runtime_dependencies">[service_layer_diagram_runtime_dependencies]</a>.</p></div>
<div class="imageblock width-75" id="service_layer_diagram_abstract_dependencies">
<div class="content">
<img src="images/apwp_0403.png" alt="images/apwp_0403.png" />
</div>
<div class="title">Figure 18. Abstract dependencies of the service layer</div>
</div>
<div class="listingblock image-source">
<div class="content">
<pre><code>[ditaa, apwp_0403]
        +-----------------------------+
        |         Service Layer       |
        +-----------------------------+
           |                   |
           |                   | depends on abstraction
           V                   V
+------------------+     +--------------------+
|   Domain Model   |     | AbstractRepository |
|                  |     |       (Port)       |
+------------------+     +--------------------+</code></pre>
</div></div>
<div class="imageblock width-75" id="service_layer_diagram_test_dependencies">
<div class="content">
<img src="images/apwp_0404.png" alt="images/apwp_0404.png" />
</div>
<div class="title">Figure 19. Tests provide an implementation of the abstract dependency</div>
</div>
<div class="listingblock image-source">
<div class="content">
<pre><code>[ditaa, apwp_0404]
        +-----------------------------+
        |           Tests             |-------------\
        +-----------------------------+             |
                       |                            |
                       V                            |
        +-----------------------------+             |
        |         Service Layer       |    provides |
        +-----------------------------+             |
           |                     |                  |
           V                     V                  |
+------------------+     +--------------------+     |
|   Domain Model   |     | AbstractRepository |     |
+------------------+     +--------------------+     |
                                    ^               |
                         implements |               |
                                    |               |
                         +----------------------+   |
                         |    FakeRepository    |&lt;--/
                         |     (in–memory)      |
                         +----------------------+</code></pre>
</div></div>
<div class="imageblock width-75" id="service_layer_diagram_runtime_dependencies">
<div class="content">
<img src="images/apwp_0405.png" alt="images/apwp_0405.png" />
</div>
<div class="title">Figure 20. Dependencies at runtime</div>
</div>
<div class="listingblock image-source">
<div class="content">
<pre><code>[ditaa, apwp_0405]
       +--------------------------------+
       | Flask API (Presentation Layer) |-----------\
       +--------------------------------+           |
                       |                            |
                       V                            |
        +-----------------------------+             |
        |         Service Layer       |             |
        +-----------------------------+             |
           |                     |                  |
           V                     V                  |
+------------------+     +--------------------+     |
|   Domain Model   |     | AbstractRepository |     |
+------------------+     +--------------------+     |
              ^                     ^               |
              |                     |               |
       gets   |          +----------------------+   |
       model  |          | SqlAlchemyRepository |&lt;--/
   definitions|          +----------------------+
       from   |                | uses
              |                V
           +-----------------------+
           |          ORM          |
           | (another abstraction) |
           +-----------------------+
                       |
                       | talks to
                       V
           +------------------------+
           |       Database         |
           +------------------------+</code></pre>
</div></div>
<div class="paragraph"><p>Чудесно.</p></div>
<div class="paragraph"><p>Давайте сделаем паузу для <a href="#chapter_04_service_layer_tradeoffs">[chapter_04_service_layer_tradeoffs]</a>, в которой мы рассмотрим плюсы и минусы наличия service layer вообще.</p></div>
<div class="tableblock" id="chapter_04_service_layer_tradeoffs">
<table rules="all"
width="100%"
frame="border"
cellspacing="0" cellpadding="4">
<caption class="title">Table 2. Service layer: Компромиссы</caption>
<col width="50%" />
<col width="50%" />
<thead>
<tr>
<th align="left" valign="top">Плюсы</th>
<th align="left" valign="top">Минусы</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left" valign="top"><div><div class="ulist"><ul>
<li>
<p>
У нас есть единое место, где можно запечатлеть все случаи использования нашего приложения.
</p>
</li>
<li>
<p>
Мы поместили нашу умную доменную логику за API, что оставляет нам свободу для рефакторинга.
</p>
</li>
<li>
<p>
Мы четко отделили "stuff that talks HTTP" от "stuff that talks   allocation."
</p>
</li>
<li>
<p>
В сочетании с шаблоном Repository и <code>FakeRepository</code> у нас есть хороший способ написания тестов на более высоком уровне, чем уровень домена; мы можем протестировать большую часть нашего рабочего процесса без необходимости использования интеграционных тестов (подробнее см. в <a href="#chapter_05_high_gear_low_gear">[chapter_05_high_gear_low_gear]</a>).
</p>
</li>
</ul></div></div></td>
<td align="left" valign="top"><div><div class="ulist"><ul>
<li>
<p>
Если ваше приложение является <em>purely</em> чистым веб-приложением, ваши контроллеры/функции просмотра могут быть единственным местом для захвата всех вариантов использования.
</p>
</li>
<li>
<p>
Это еще один слой абстракции.
</p>
</li>
<li>
<p>
Внесение слишком большого количества логики в уровень сервиса может привести к антипаттерну <em>Anemic Domain</em>. Этот уровень лучше вводить после того, как вы заметите, как логика оркестровки проникает в ваши контроллеры.


</p>
</li>
<li>
<p>
Вы можете получить много преимуществ, связанных с наличием богатых моделей предметной области, просто вытолкнув логику из ваших контроллеров на уровень модели, без необходимости добавлять дополнительный слой между ними (также известный как «толстые модели, тонкие контроллеры») .


</p>
</li>
</ul></div></div></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p>Но есть еще несколько неловких моментов, которые нужно убрать:</p></div>
<div class="ulist"><ul>
<li>
<p>
Уровень сервиса по-прежнему тесно связан с доменом, поскольку его API выражается в терминах объектов <code>OrderLine</code>. В <a href="#chapter_05_high_gear_low_gear">[chapter_05_high_gear_low_gear]</a> мы исправим это и поговорим о том, как уровень сервиса обеспечивает более производительный TDD.
</p>
</li>
<li>
<p>
Уровень сервиса тесно связан с объектом <code>session</code>. В <a href="#chapter_06_uow">[chapter_06_uow]</a> мы введем еще один паттерн, который тесно работает с паттернами Уровня Репозитория и Сервиса, паттерн Unit of Work, и все будет абсолютно прекрасно.
Вот увидите!
</p>
</li>
</ul></div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="chapter_05_high_gear_low_gear">TDD на Высокой и Низкой передаче</h2>
<div class="sectionbody">
<div class="paragraph"><p>Мы ввели уровень сервиса, чтобы захватить некоторые дополнительные обязанности по оркестровке, которые нам нужны от рабочего приложения. Уровень сервиса помогает нам четко определить наши варианты использования и рабочий процесс для каждого из них: что нам нужно получить из наших репозиториев, какие предварительные проверки и проверку текущего состояния мы должны сделать, и что мы сохраняем в конце.</p></div>
<div class="paragraph"><p>Но в настоящее время многие из наших модульных тестов работают на более низком уровне, воздействуя непосредственно на модель. В этой главе мы обсудим компромиссы, связанные с переносом этих тестов на уровень сервисного уровня, и некоторые более общие рекомендации по тестированию.</p></div>
<div class="sidebarblock">
<div class="content">
<div class="title">Harry Says: Seeing a Test Pyramid in Action Was a Light-Bulb Moment</div>
<div class="paragraph"><p>Вот несколько слов непосредственно от Гарри:</p></div>
<div class="paragraph"><p><em>Я изначально скептически относился ко всем архитектурным паттернам Боба, но
настоящая тестовая пирамида сделала меня новообращенным.</em></p></div>
<div class="paragraph"><p><em>Как только вы реализуете моделирование предметной области и уровень сервиса, вы действительно можете перейти к этапу, когда модульные тесты на порядок превосходят интеграционные и сквозные тесты.  Работая в местах, где тестовая сборка E2E заняла бы несколько часов (по сути, "подождите до завтра"), я не могу сказать вам, какая разница, если вы сможете запустить все свои тесты за считанные минуты или секунды.</em></p></div>
<div class="paragraph"><p><em>Прочтите несколько рекомендаций о том, как решить, какие тесты писать и на каком уровне. Мышление с высокой передачей High Gear и низкой передачей Low Gear  действительно изменило мою тестовую жизнь.</em></p></div>
</div></div>
<div class="sect2">
<h3 id="_как_выглядит_наша_тестовая_пирамида">Как выглядит наша тестовая пирамида?</h3>
<div class="paragraph"><p>Давайте посмотрим, что этот переход к использованию сервисного уровня с его собственными тестами сервисного уровня делает с нашей тестовой пирамидой:</p></div>
<div class="exampleblock" id="test_pyramid">
<div class="title">Example 61. Подсчет типов тестов</div>
<div class="content">
<div class="listingblock skip">
<div class="content"><div class="highlight"><pre><span></span>$ grep -c test_ **/test_*.py
tests/unit/test_allocate.py:4
tests/unit/test_batches.py:8
tests/unit/test_services.py:3

tests/integration/test_orm.py:6
tests/integration/test_repository.py:2

tests/e2e/test_api.py:2
</pre></div></div></div>
</div></div>
<div class="paragraph"><p>Неплохо! У нас есть 15 модульных тестов, 8 интеграционных тестов и всего 2 сквозных теста.  Это уже здоровая на вид тестовая пирамида.</p></div>
</div>
<div class="sect2">
<h3 id="_должны_ли_тесты_доменного_уровня_перейти_на_уровень_сервиса">Должны ли тесты доменного уровня перейти на уровень сервиса?</h3>
<div class="paragraph"><p>Посмотрим, что произойдет, если мы сделаем еще один шаг. Поскольку мы можем тестировать наше программное обеспечение на уровне сервисов, нам больше не нужны тесты для модели предметной области. Вместо этого мы могли бы переписать все тесты уровня домена из
<a href="#chapter_01_domain_model">[chapter_01_domain_model]</a> с точки зрения уровня обслуживания:</p></div>
<div class="exampleblock">
<div class="title">Example 62. Переписывание теста домена на уровне сервиса (tests/unit/test_services.py)</div>
<div class="content">
<div class="listingblock skip">
<div class="content"><div class="highlight"><pre><span></span><span class="c1"># domain-layer test:</span>
<span class="k">def</span> <span class="nf">test_prefers_current_stock_batches_to_shipments</span><span class="p">():</span>
    <span class="n">in_stock_batch</span> <span class="o">=</span> <span class="n">Batch</span><span class="p">(</span><span class="s2">&quot;in-stock-batch&quot;</span><span class="p">,</span> <span class="s2">&quot;RETRO-CLOCK&quot;</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="n">eta</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">shipment_batch</span> <span class="o">=</span> <span class="n">Batch</span><span class="p">(</span><span class="s2">&quot;shipment-batch&quot;</span><span class="p">,</span> <span class="s2">&quot;RETRO-CLOCK&quot;</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="n">eta</span><span class="o">=</span><span class="n">tomorrow</span><span class="p">)</span>
    <span class="n">line</span> <span class="o">=</span> <span class="n">OrderLine</span><span class="p">(</span><span class="s2">&quot;oref&quot;</span><span class="p">,</span> <span class="s2">&quot;RETRO-CLOCK&quot;</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>

    <span class="n">allocate</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="p">[</span><span class="n">in_stock_batch</span><span class="p">,</span> <span class="n">shipment_batch</span><span class="p">])</span>

    <span class="k">assert</span> <span class="n">in_stock_batch</span><span class="o">.</span><span class="n">available_quantity</span> <span class="o">==</span> <span class="mi">90</span>
    <span class="k">assert</span> <span class="n">shipment_batch</span><span class="o">.</span><span class="n">available_quantity</span> <span class="o">==</span> <span class="mi">100</span>


<span class="c1"># service-layer test:</span>
<span class="k">def</span> <span class="nf">test_prefers_warehouse_batches_to_shipments</span><span class="p">():</span>
    <span class="n">in_stock_batch</span> <span class="o">=</span> <span class="n">Batch</span><span class="p">(</span><span class="s2">&quot;in-stock-batch&quot;</span><span class="p">,</span> <span class="s2">&quot;RETRO-CLOCK&quot;</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="n">eta</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">shipment_batch</span> <span class="o">=</span> <span class="n">Batch</span><span class="p">(</span><span class="s2">&quot;shipment-batch&quot;</span><span class="p">,</span> <span class="s2">&quot;RETRO-CLOCK&quot;</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="n">eta</span><span class="o">=</span><span class="n">tomorrow</span><span class="p">)</span>
    <span class="n">repo</span> <span class="o">=</span> <span class="n">FakeRepository</span><span class="p">([</span><span class="n">in_stock_batch</span><span class="p">,</span> <span class="n">shipment_batch</span><span class="p">])</span>
    <span class="n">session</span> <span class="o">=</span> <span class="n">FakeSession</span><span class="p">()</span>

    <span class="n">line</span> <span class="o">=</span> <span class="n">OrderLine</span><span class="p">(</span><span class="s1">&#39;oref&#39;</span><span class="p">,</span> <span class="s2">&quot;RETRO-CLOCK&quot;</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>

    <span class="n">services</span><span class="o">.</span><span class="n">allocate</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">repo</span><span class="p">,</span> <span class="n">session</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">in_stock_batch</span><span class="o">.</span><span class="n">available_quantity</span> <span class="o">==</span> <span class="mi">90</span>
    <span class="k">assert</span> <span class="n">shipment_batch</span><span class="o">.</span><span class="n">available_quantity</span> <span class="o">==</span> <span class="mi">100</span>
</pre></div></div></div>
</div></div>
<div class="paragraph"><p>Зачем нам это нужно?</p></div>
<div class="paragraph"><p>Предполагается, что тесты помогают нам безбоязненно изменять нашу систему, но часто мы видим, как команды пишут слишком много тестов для своей модели предметной области. Это вызывает проблемы, когда они приходят изменить свою кодовую базу и обнаруживают, что им необходимо обновить десятки или даже сотни модульных тестов.</p></div>
<div class="paragraph"><p>В этом есть смысл, если вы перестанете задумываться о назначении автоматических тестов. Мы используем тесты, чтобы убедиться, что свойство системы не меняется во время работы. Мы используем тесты, чтобы проверить, что API продолжает возвращать 200, что сеанс базы данных продолжает фиксироваться и что заказы все еще распределяются.</p></div>
<div class="paragraph"><p>Если мы случайно изменим одно из этих поведений, наши тесты сломаются. Однако оборотная сторона состоит в том, что если мы захотим изменить дизайн нашего кода, любые тесты, напрямую полагающиеся на этот код, также потерпят неудачу.</p></div>
<div class="paragraph"><p>По мере того, как мы углубимся в книгу, вы увидите, как уровень сервиса формирует API для нашей системы, которым мы можем управлять разными способами. Тестирование этого API сокращает объем кода, который нам нужно изменить при рефакторинге нашей модели предметной области. Если мы ограничимся тестированием только на уровне сервиса, у нас не будет никаких тестов, которые напрямую взаимодействуют с «частными» методами или атрибутами объектов нашей модели, что дает нам больше свободы для их рефакторинга.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/tip.png" alt="Tip" />
</td>
<td class="content">Каждая строка кода, которую мы помещаем в тест, подобна капле клея, удерживающему систему в определенной форме. Чем больше у нас будет тестов низкого уровня, тем труднее будет что-то изменить.</td>
</tr></table>
</div>
</div>
<div class="sect2">
<h3 id="kinds_of_tests">О принятии решения О том, Какие Тесты писать</h3>
<div class="paragraph"><p>Вы можете спросить себя: «А стоит ли мне тогда переписать все свои модульные тесты? Разве неправильно писать тесты для модели предметной области?» Чтобы ответить на эти вопросы, важно понимать компромисс между связью и обратной связью по проекту (см. <a href="#test_spectrum_diagram">[test_spectrum_diagram]</a>).</p></div>
<div class="imageblock" id="test_spectrum_diagram">
<div class="content">
<img src="images/apwp_0501.png" alt="images/apwp_0501.png" />
</div>
<div class="title">Figure 21. Тестовый спектр</div>
</div>
<div class="listingblock image-source">
<div class="content">
<pre><code>[ditaa, apwp_0501]
| Низкая обратная связь                                    Высокая обратная связь |
| Низкий барьер для изменений                           Высокий барьер для перемен |
| Высокий охват системы                                  Сфокусированное покрытие |
|                                                                              |
| &lt;---------                                                       ----------&gt; |
|                                                                              |
| API Tests                  Service–Layer Tests                  Domain Tests |</code></pre>
</div></div>
<div class="paragraph"><p>Экстремальное программирование (XP) призывает нас «слушать код». Когда мы пишем тесты, мы можем обнаружить, что код трудно использовать, или заметим запах кода. Это повод для рефакторинга и пересмотра нашего дизайна.</p></div>
<div class="paragraph"><p>Однако мы получаем эту обратную связь только тогда, когда тесно работаем с целевым кодом. Тест HTTP API ничего не говорит нам о детальном дизайне наших объектов, потому что он находится на гораздо более высоком уровне абстракции.</p></div>
<div class="paragraph"><p>С другой стороны, мы можем переписать все наше приложение, и, пока мы не меняем URL-адреса или форматы запросов, наши HTTP-тесты будут продолжать проходить. Это дает нам уверенность в том, что крупномасштабные изменения, такие как изменение схемы базы данных, не нарушили наш код.</p></div>
<div class="paragraph"><p>На другом конце спектра тесты, которые мы написали в <a href="#chapter_01_domain_model">[chapter_01_domain_model]</a>, помогли нам конкретизировать наше понимание необходимых нам объектов. Тесты привели нас к разработке, которая имеет смысл и читается на языке предметной области. Когда наши тесты читаются на языке предметной области, мы чувствуем себя комфортно, потому что наш код соответствует нашей интуиции относительно проблемы, которую мы пытаемся решить.</p></div>
<div class="paragraph"><p>Поскольку тесты написаны на языке предметной области, они служат живой документацией для нашей модели. Новый член команды может прочитать эти тесты, чтобы быстро понять, как работает система и как взаимосвязаны основные концепции.</p></div>
<div class="paragraph"><p>Мы часто «зарисовываем» новое поведение, написав тесты на этом уровне, чтобы увидеть, как может выглядеть код. Однако, когда мы хотим улучшить дизайн кода, нам нужно будет заменить или удалить эти тесты, потому что они тесно связаны с конкретной
<span class=".keep-together">implementation реализацей</span>.</p></div>
</div>
<div class="sect2">
<h3 id="_высокая_и_низкая_передача">Высокая и низкая передача</h3>
<div class="paragraph"><p>В большинстве случаев, когда мы добавляем новую функцию или исправляем ошибку, нам не нужно вносить значительные изменения в модель домена. В этих случаях мы предпочитаем писать тесты против сервисов из-за более низкой связи и более высокого покрытия.</p></div>
<div class="paragraph"><p>Например, при написании функции <code>add_stock</code> или функции <code>cancel_order</code> мы можем работать быстрее и с меньшей связью, написав тесты на уровне сервиса.</p></div>
<div class="paragraph"><p>Когда мы начинаем новый проект или сталкиваемся с особенно сложной проблемой, мы возвращаемся к написанию тестов против модели предметной области, чтобы получить лучшую обратную связь и исполняемую документацию о наших намерениях.</p></div>
<div class="paragraph"><p>Мы используем в качестве метафоры термины переключения передач. В начале поездки велосипед должен быть на пониженной передаче, чтобы он мог преодолеть инерцию. Когда мы тронемся и бежим, мы можем двигаться быстрее и эффективнее, переключившись на повышенную передачу; но если мы внезапно наталкиваемся на крутой холм или вынуждены замедляться из-за опасности, мы снова переключаемся на низкую передачу, пока не сможем снова набрать скорость.</p></div>
</div>
<div class="sect2">
<h3 id="primitive_obsession">Полное отделение тестов уровня сервиса от домена</h3>
<div class="paragraph"><p>У нас все еще есть прямые зависимости от домена в наших тестах уровня обслуживания, потому что мы используем объекты домена для настройки наших тестовых данных и вызова наших функций уровня обслуживания.</p></div>
<div class="paragraph"><p>Чтобы иметь уровень сервиса, который полностью отделен от домена, нам нужно переписать его API, чтобы работать в терминах примитивов.</p></div>
<div class="paragraph"><p>Наш уровень обслуживания в настоящее время принимает доменный объект <code>OrderLine</code>:</p></div>
<div class="exampleblock" id="service_domain">
<div class="title">Example 63. До: allocate принимает объект домена (service_layer/services.py)</div>
<div class="content">
<div class="listingblock skip">
<div class="content"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">allocate</span><span class="p">(</span><span class="n">line</span><span class="p">:</span> <span class="n">OrderLine</span><span class="p">,</span> <span class="n">repo</span><span class="p">:</span> <span class="n">AbstractRepository</span><span class="p">,</span> <span class="n">session</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</pre></div></div></div>
</div></div>
<div class="paragraph"><p>Как бы это выглядело, если бы все его параметры были примитивными типами?</p></div>
<div class="exampleblock" id="service_takes_primitives">
<div class="title">Example 64. После: allocate принимает строки и целые числа (service_layer/services.py)</div>
<div class="content">
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">allocate</span><span class="p">(</span>
        <span class="n">orderid</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">sku</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">qty</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">repo</span><span class="p">:</span> <span class="n">AbstractRepository</span><span class="p">,</span> <span class="n">session</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</pre></div></div></div>
</div></div>
<div class="paragraph"><p>Мы также переписываем тесты в этих терминах:</p></div>
<div class="exampleblock" id="tests_call_with_primitives">
<div class="title">Example 65. Tests now use primitives in function call (tests/unit/test_services.py)</div>
<div class="content">
<div class="listingblock non-head">
<div class="content"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">test_returns_allocation</span><span class="p">():</span>
    <span class="n">batch</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">Batch</span><span class="p">(</span><span class="s2">&quot;batch1&quot;</span><span class="p">,</span> <span class="s2">&quot;COMPLICATED-LAMP&quot;</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="n">eta</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">repo</span> <span class="o">=</span> <span class="n">FakeRepository</span><span class="p">([</span><span class="n">batch</span><span class="p">])</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">services</span><span class="o">.</span><span class="n">allocate</span><span class="p">(</span><span class="s2">&quot;o1&quot;</span><span class="p">,</span> <span class="s2">&quot;COMPLICATED-LAMP&quot;</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">repo</span><span class="p">,</span> <span class="n">FakeSession</span><span class="p">())</span>
    <span class="k">assert</span> <span class="n">result</span> <span class="o">==</span> <span class="s2">&quot;batch1&quot;</span>
</pre></div></div></div>
</div></div>
<div class="paragraph"><p>Но наши тесты все еще зависят от домена, потому что мы все еще вручную создаем экземпляры <code>Batch</code> объектов.  Поэтому, если в один прекрасный день мы решим провести массовый рефакторинг того, как работает наша <code>Batch</code> модель, нам придется изменить кучу тестов.</p></div>
<div class="sect3">
<h4 id="_смягчение_последствий_храните_все_доменные_зависимости_в_функциях_fixture">Смягчение последствий: Храните Все доменные зависимости в функциях Fixture</h4>
<div class="paragraph"><p>Мы могли бы, по крайней мере, абстрагировать это до вспомогательной функции или фикстуры в наших тестах.  Вот один из способов, которым вы могли бы это сделать, добавив фабричную функцию в <code>FakeRepository</code>:</p></div>
<div class="exampleblock" id="services_factory_function">
<div class="title">Example 66. Фабричные функции для фикстур&#8201;&#8212;&#8201;это одна из возможностей (tests/unit/test_services.py)</div>
<div class="content">
<div class="listingblock skip">
<div class="content"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">FakeRepository</span><span class="p">(</span><span class="nb">set</span><span class="p">):</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">for_batch</span><span class="p">(</span><span class="n">ref</span><span class="p">,</span> <span class="n">sku</span><span class="p">,</span> <span class="n">qty</span><span class="p">,</span> <span class="n">eta</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">FakeRepository</span><span class="p">([</span>
            <span class="n">model</span><span class="o">.</span><span class="n">Batch</span><span class="p">(</span><span class="n">ref</span><span class="p">,</span> <span class="n">sku</span><span class="p">,</span> <span class="n">qty</span><span class="p">,</span> <span class="n">eta</span><span class="p">),</span>
        <span class="p">])</span>

    <span class="o">...</span>


<span class="k">def</span> <span class="nf">test_returns_allocation</span><span class="p">():</span>
    <span class="n">repo</span> <span class="o">=</span> <span class="n">FakeRepository</span><span class="o">.</span><span class="n">for_batch</span><span class="p">(</span><span class="s2">&quot;batch1&quot;</span><span class="p">,</span> <span class="s2">&quot;COMPLICATED-LAMP&quot;</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="n">eta</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">services</span><span class="o">.</span><span class="n">allocate</span><span class="p">(</span><span class="s2">&quot;o1&quot;</span><span class="p">,</span> <span class="s2">&quot;COMPLICATED-LAMP&quot;</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">repo</span><span class="p">,</span> <span class="n">FakeSession</span><span class="p">())</span>
    <span class="k">assert</span> <span class="n">result</span> <span class="o">==</span> <span class="s2">&quot;batch1&quot;</span>
</pre></div></div></div>
</div></div>
<div class="paragraph"><p>По крайней мере, это переместило бы все зависимости наших тестов из домена в одно место.</p></div>
</div>
<div class="sect3">
<h4 id="_добавление_отсутствующей_службы">Добавление отсутствующей службы</h4>
<div class="paragraph"><p>Но мы могли бы сделать еще один шаг. Если бы у нас был сервис для добавления запасов, мы могли бы использовать его и сделать наши тесты уровня сервиса полностью выраженными в терминах официальных вариантов использования уровня сервиса, удалив все зависимости от домена:</p></div>
<div class="exampleblock" id="test_add_batch">
<div class="title">Example 67. Тест для нового сервиса add_batch (tests/unit/test_services.py)</div>
<div class="content">
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">test_add_batch</span><span class="p">():</span>
    <span class="n">repo</span><span class="p">,</span> <span class="n">session</span> <span class="o">=</span> <span class="n">FakeRepository</span><span class="p">([]),</span> <span class="n">FakeSession</span><span class="p">()</span>
    <span class="n">services</span><span class="o">.</span><span class="n">add_batch</span><span class="p">(</span><span class="s2">&quot;b1&quot;</span><span class="p">,</span> <span class="s2">&quot;CRUNCHY-ARMCHAIR&quot;</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">repo</span><span class="p">,</span> <span class="n">session</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">repo</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;b1&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
    <span class="k">assert</span> <span class="n">session</span><span class="o">.</span><span class="n">committed</span>
</pre></div></div></div>
</div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/tip.png" alt="Tip" />
</td>
<td class="content">В общем, если вам нужно делать что-то на уровне домена непосредственно в тестах уровня сервиса, это может быть признаком того, что ваш уровень сервиса не завершен.</td>
</tr></table>
</div>
<div class="paragraph pagebreak-before"><p>А реализация&#8201;&#8212;&#8201;это всего две строчки:</p></div>
<div class="exampleblock" id="add_batch_service">
<div class="title">Example 68. Новый сервис для add_batch (service_layer/services.py)</div>
<div class="content">
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">add_batch</span><span class="p">(</span>
        <span class="n">ref</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">sku</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">qty</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">eta</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">date</span><span class="p">],</span>
        <span class="n">repo</span><span class="p">:</span> <span class="n">AbstractRepository</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span>
<span class="p">):</span>
    <span class="n">repo</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">Batch</span><span class="p">(</span><span class="n">ref</span><span class="p">,</span> <span class="n">sku</span><span class="p">,</span> <span class="n">qty</span><span class="p">,</span> <span class="n">eta</span><span class="p">))</span>
    <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">allocate</span><span class="p">(</span>
        <span class="n">orderid</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">sku</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">qty</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">repo</span><span class="p">:</span> <span class="n">AbstractRepository</span><span class="p">,</span> <span class="n">session</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="o">...</span>
</pre></div></div></div>
</div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note" />
</td>
<td class="content">Стоит ли писать новую службу только потому, что она поможет устранить зависимости из ваших тестов? Возможно нет. Но в этом случае нам почти наверняка однажды понадобится сервис <code>add_batch</code>.
<span class=".keep-together">так или иначе</span>.</td>
</tr></table>
</div>
<div class="paragraph"><p>Теперь это позволяет нам переписать <em>все</em> наши тесты сервисного уровня исключительно с точки зрения самих сервисов, используя только примитивы и без каких-либо зависимостей от модели:</p></div>
<div class="exampleblock" id="services_tests_all_services">
<div class="title">Example 69. Тесты сервисов теперь используют только сервисы (tests/unit/test_services.py)</div>
<div class="content">
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">test_allocate_returns_allocation</span><span class="p">():</span>
    <span class="n">repo</span><span class="p">,</span> <span class="n">session</span> <span class="o">=</span> <span class="n">FakeRepository</span><span class="p">([]),</span> <span class="n">FakeSession</span><span class="p">()</span>
    <span class="n">services</span><span class="o">.</span><span class="n">add_batch</span><span class="p">(</span><span class="s2">&quot;batch1&quot;</span><span class="p">,</span> <span class="s2">&quot;COMPLICATED-LAMP&quot;</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">repo</span><span class="p">,</span> <span class="n">session</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">services</span><span class="o">.</span><span class="n">allocate</span><span class="p">(</span><span class="s2">&quot;o1&quot;</span><span class="p">,</span> <span class="s2">&quot;COMPLICATED-LAMP&quot;</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">repo</span><span class="p">,</span> <span class="n">session</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">result</span> <span class="o">==</span> <span class="s2">&quot;batch1&quot;</span>


<span class="k">def</span> <span class="nf">test_allocate_errors_for_invalid_sku</span><span class="p">():</span>
    <span class="n">repo</span><span class="p">,</span> <span class="n">session</span> <span class="o">=</span> <span class="n">FakeRepository</span><span class="p">([]),</span> <span class="n">FakeSession</span><span class="p">()</span>
    <span class="n">services</span><span class="o">.</span><span class="n">add_batch</span><span class="p">(</span><span class="s2">&quot;b1&quot;</span><span class="p">,</span> <span class="s2">&quot;AREALSKU&quot;</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">repo</span><span class="p">,</span> <span class="n">session</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="n">services</span><span class="o">.</span><span class="n">InvalidSku</span><span class="p">,</span> <span class="n">match</span><span class="o">=</span><span class="s2">&quot;Invalid sku NONEXISTENTSKU&quot;</span><span class="p">):</span>
        <span class="n">services</span><span class="o">.</span><span class="n">allocate</span><span class="p">(</span><span class="s2">&quot;o1&quot;</span><span class="p">,</span> <span class="s2">&quot;NONEXISTENTSKU&quot;</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">repo</span><span class="p">,</span> <span class="n">FakeSession</span><span class="p">())</span>
</pre></div></div></div>
</div></div>
<div class="paragraph"><p>Это действительно хорошее место.  Наши тесты уровня сервиса зависят только от самого уровня сервиса, что дает нам полную свободу для рефакторинга модели по своему усмотрению.</p></div>
</div>
</div>
<div class="sect2 pagebreak-before less_space">
<h3 id="_внесение_улучшений_в_тесты_e2e">Внесение улучшений в тесты E2E</h3>
<div class="paragraph"><p>Точно так же, как добавление <code>add_batch</code> помогло отделить наши тесты сервисного уровня от модели, добавление конечной точки API для добавления пакета устранило бы необходимость в уродливом приспособлении <code>add_stock</code>, и наши тесты E2E могли бы быть свободны от этих жестко закодированных SQL-запросов и прямой зависимости от базы данных.</p></div>
<div class="paragraph"><p>Благодаря нашей сервисной функции добавить endpoint очень просто, требуется всего лишь немного порботать с JSON и один раз вызвать функцию:</p></div>
<div class="exampleblock" id="api_for_add_batch">
<div class="title">Example 70. API для добавления batch (entrypoints/flask_app.py)</div>
<div class="content">
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/add_batch&quot;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">add_batch</span><span class="p">():</span>
    <span class="n">session</span> <span class="o">=</span> <span class="n">get_session</span><span class="p">()</span>
    <span class="n">repo</span> <span class="o">=</span> <span class="n">repository</span><span class="o">.</span><span class="n">SqlAlchemyRepository</span><span class="p">(</span><span class="n">session</span><span class="p">)</span>
    <span class="n">eta</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="s1">&#39;eta&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">eta</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">eta</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromisoformat</span><span class="p">(</span><span class="n">eta</span><span class="p">)</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>
    <span class="n">services</span><span class="o">.</span><span class="n">add_batch</span><span class="p">(</span>
        <span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="s1">&#39;ref&#39;</span><span class="p">],</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="s1">&#39;sku&#39;</span><span class="p">],</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="s1">&#39;qty&#39;</span><span class="p">],</span> <span class="n">eta</span><span class="p">,</span>
        <span class="n">repo</span><span class="p">,</span> <span class="n">session</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="s1">&#39;OK&#39;</span><span class="p">,</span> <span class="mi">201</span>
</pre></div></div></div>
</div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note" />
</td>
<td class="content">Вы думаете про себя, POST to _ /add_batch_? Это не очень RESTful!  Вы совершенно правы.  Мы, к счастью, небрежны, но если вы хотите сделать все более RESTy, возможно, POST to <em>/batches</em>,тогда сам щёлкни себя по носу! Поскольку Flask - тонкий адаптер, это будет несложно. See <a href="#types_of_test_rules_of_thumb">the next sidebar</a>.</td>
</tr></table>
</div>
<div class="paragraph"><p>И наши жестко закодированные SQL-запросы из <em>conftest.py</em> заменяются некоторыми вызовами API, что означает, что тесты API не имеют никаких зависимостей, кроме API, что тоже неплохо:</p></div>
<div class="exampleblock" id="api_tests_with_no_sql">
<div class="title">Example 71. Тесты API теперь могут добавлять свои собственные пакеты (tests/e2e/test_api.py)</div>
<div class="content">
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">post_to_add_batch</span><span class="p">(</span><span class="n">ref</span><span class="p">,</span> <span class="n">sku</span><span class="p">,</span> <span class="n">qty</span><span class="p">,</span> <span class="n">eta</span><span class="p">):</span>
    <span class="n">url</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get_api_url</span><span class="p">()</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
        <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s1">/add_batch&#39;</span><span class="p">,</span>
        <span class="n">json</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;ref&#39;</span><span class="p">:</span> <span class="n">ref</span><span class="p">,</span> <span class="s1">&#39;sku&#39;</span><span class="p">:</span> <span class="n">sku</span><span class="p">,</span> <span class="s1">&#39;qty&#39;</span><span class="p">:</span> <span class="n">qty</span><span class="p">,</span> <span class="s1">&#39;eta&#39;</span><span class="p">:</span> <span class="n">eta</span><span class="p">}</span>
    <span class="p">)</span>
    <span class="k">assert</span> <span class="n">r</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">201</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">usefixtures</span><span class="p">(</span><span class="s1">&#39;postgres_db&#39;</span><span class="p">)</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">usefixtures</span><span class="p">(</span><span class="s1">&#39;restart_api&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">test_happy_path_returns_201_and_allocated_batch</span><span class="p">():</span>
    <span class="n">sku</span><span class="p">,</span> <span class="n">othersku</span> <span class="o">=</span> <span class="n">random_sku</span><span class="p">(),</span> <span class="n">random_sku</span><span class="p">(</span><span class="s1">&#39;other&#39;</span><span class="p">)</span>
    <span class="n">earlybatch</span> <span class="o">=</span> <span class="n">random_batchref</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">laterbatch</span> <span class="o">=</span> <span class="n">random_batchref</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">otherbatch</span> <span class="o">=</span> <span class="n">random_batchref</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">post_to_add_batch</span><span class="p">(</span><span class="n">laterbatch</span><span class="p">,</span> <span class="n">sku</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="s1">&#39;2011-01-02&#39;</span><span class="p">)</span>
    <span class="n">post_to_add_batch</span><span class="p">(</span><span class="n">earlybatch</span><span class="p">,</span> <span class="n">sku</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="s1">&#39;2011-01-01&#39;</span><span class="p">)</span>
    <span class="n">post_to_add_batch</span><span class="p">(</span><span class="n">otherbatch</span><span class="p">,</span> <span class="n">othersku</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;orderid&#39;</span><span class="p">:</span> <span class="n">random_orderid</span><span class="p">(),</span> <span class="s1">&#39;sku&#39;</span><span class="p">:</span> <span class="n">sku</span><span class="p">,</span> <span class="s1">&#39;qty&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">}</span>
    <span class="n">url</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get_api_url</span><span class="p">()</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s1">/allocate&#39;</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">r</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">201</span>
    <span class="k">assert</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;batchref&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">earlybatch</span>
</pre></div></div></div>
</div></div>
</div>
<div class="sect2">
<h3 id="_заключение_2">Заключение</h3>
<div class="paragraph"><p>Как только у вас появится уровень сервиса, вы действительно можете переместить большую часть тестового покрытия в модульные тесты и разработать здоровую пирамиду тестов.</p></div>
<div class="sidebarblock nobreakinside less_space" id="types_of_test_rules_of_thumb">
<div class="content">
<div class="title">Резюме: Эмпирические правила для различных типов тестов</div>
<div class="dlist"><dl>
<dt class="hdlist1">
Стремитесь к одному сквозному тесту для каждой функции. 
</dt>
<dd>
<p>
Это может быть написано,
        например, для HTTP API. Цель состоит в том, чтобы продемонстрировать, что функция работает, и что все движущиеся части правильно склеены.
    
</p>
</dd>
<dt class="hdlist1">
Пишите основную часть ваших тестов на уровне сервиса. 
</dt>
<dd>
<p>
Эти сквозные тесты
        предлагают хороший компромисс между охватом, временем выполнения и эффективностью. Каждый тест обычно охватывает один путь кода функции и использует подделки для ввода-вывода. Это место, где можно полностью охватить все крайние случаи и тонкости вашей бизнес-логики.<span class="footnote"><br />[Обоснованное беспокойство по поводу написания тестов на более высоком уровне заключается в том, что это может привести к комбинаторному взрыву для более сложных случаев использования. В этих случаях может быть полезно перейти к модульным тестам более низкого уровня различных сотрудничающих объектов домена. Смотрите также <a href="#chapter_08_events_and_message_bus">[chapter_08_events_and_message_bus]</a> и <a href="#fake_message_bus">[fake_message_bus]</a>.]<br /></span>
    
</p>
</dd>
<dt class="hdlist1">
Поддерживайте небольшое ядро ​​тестов, написанных для вашей модели предметной области. 
</dt>
<dd>
<p>
Эти тесты имеют
        узконаправленный охват и более хрупкие, но они имеют самую высокую обратную связь. Не бойтесь удалить эти тесты, если их функциональность позже будет покрыта тестами на уровне сервиса.
    
</p>
</dd>
<dt class="hdlist1">
Обработку ошибок считайте функцией. 
</dt>
<dd>
<p>
        В идеале ваше приложение должно быть структурировано таким образом, чтобы все ошибки, возникающие в ваших точках входа (например, Flask), обрабатывались одинаково. Это означает, что вам нужно протестировать только удачный путь для каждой функции и зарезервировать один сквозной тест для всех неудачных путей (и, конечно, многих модульных тестов неудачных путей).
    
    
</p>
</dd>
</dl></div>
</div></div>
<div class="paragraph"><p>В этом вам помогут несколько вещей:</p></div>
<div class="ulist"><ul>
<li>
<p>
Выражайте уровень обслуживания в терминах примитивов, а не объектов предметной области.
</p>
</li>
<li>
<p>
В идеальном мире у вас будут все сервисы, которые вам нужны, чтобы иметь возможность полностью протестировать уровень сервиса, а не взламывать состояние через репозитории или базу данных. Это также окупается в ваших сквозных тестах.
  
</p>
</li>
</ul></div>
<div class="paragraph"><p>Переходим к следующей главе!</p></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="chapter_06_uow">Паттерн Unit of Work(Единица работы)</h2>
<div class="sectionbody">
<div class="paragraph"><p>В этой главе мы познакомимся с заключительной частью головоломки, которая связывает воедино паттерны уровня Репозитория и Уровня Сервиса: паттерн <em>Unit of Work</em>.</p></div>
<div class="paragraph"><p>Если шаблон хранилища-это наша абстракция по отношению к идее постоянного хранения, то шаблон "Единицы Работы" (UoW) - это наша абстракция по отношению к идее <em>атомарных операций</em>. Это позволит нам окончательно и полностью отделить наш уровень обслуживания от уровня данных.</p></div>
<div class="paragraph"><p><a href="#before_uow_diagram">[before_uow_diagram]</a> показывает, что в настоящее время много взаимодействий происходит между уровнями нашей инфраструктуры: API обращается напрямую к уровню базы данных, чтобы начать сеанс, он обращается к уровню репозитория для инициализации <code>SQLAlchemyRepository</code>, и он связывается с уровнем сервиса, чтобы  выделить позиции.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/tip.png" alt="Tip" />
</td>
<td class="content">
<div class="paragraph"><p>Код для этой главы находится в ветке chapter_06_uow <a href="https://oreil.ly/MoWdZ">on
<span class=".keep-together">GitHub</span></a>:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>git clone https://github.com/cosmicpython/code.git
cd code
git checkout chapter_06_uow
# or to code along, checkout Chapter 4:
git checkout chapter_04_service_layer</code></pre>
</div></div>
</td>
</tr></table>
</div>
<div class="imageblock width-75" id="before_uow_diagram">
<div class="content">
<img src="images/apwp_0601.png" alt="images/apwp_0601.png" />
</div>
<div class="title">Figure 22. Без UoW: API напрямую общается с тремя уровнями</div>
</div>
<div class="paragraph"><p><a href="#after_uow_diagram">[after_uow_diagram]</a> показывает наше целевое состояние. API Flask теперь делает только две вещи: он инициализирует единицу работы и вызывает службу. Сервис сотрудничает с UoW (нам нравится думать о UoW как о части сервисного уровня), но ни сама сервисная функция, ни Flask теперь не нуждаются в непосредственном общении с базой данных.</p></div>
<div class="paragraph"><p>И мы сделаем все это с помощью прекрасного синтаксиса Python - диспетчера контекста.</p></div>
<div class="imageblock width-75" id="after_uow_diagram">
<div class="content">
<img src="images/apwp_0602.png" alt="images/apwp_0602.png" />
</div>
<div class="title">Figure 23. С помощью UoW: UoW теперь управляет состоянием базы данных</div>
</div>
<div class="sect2">
<h3 id="_unit_of_work_взаимодействует_с_репозиторием">Unit of Work взаимодействует с репозиторием</h3>
<div class="paragraph"><p>Давайте посмотрим, как работает единица работы (или UoW, что мы произносим как «you-wow»). Вот как будет выглядеть сервисный слой, когда мы закончим:</p></div>
<div class="exampleblock" id="uow_preview">
<div class="title">Example 72. Предварительный просмотр Unit of Work в действии (src/allocation/service_layer/services.py)</div>
<div class="content">
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">allocate</span><span class="p">(</span>
        <span class="n">orderid</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">sku</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">qty</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">uow</span><span class="p">:</span> <span class="n">unit_of_work</span><span class="o">.</span><span class="n">AbstractUnitOfWork</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">line</span> <span class="o">=</span> <span class="n">OrderLine</span><span class="p">(</span><span class="n">orderid</span><span class="p">,</span> <span class="n">sku</span><span class="p">,</span> <span class="n">qty</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">uow</span><span class="p">:</span>  <span class="c1">#<img src="./images/icons/callouts/1.png" alt="1" /></span>
        <span class="n">batches</span> <span class="o">=</span> <span class="n">uow</span><span class="o">.</span><span class="n">batches</span><span class="o">.</span><span class="n">list</span><span class="p">()</span>  <span class="c1">#<img src="./images/icons/callouts/2.png" alt="2" /></span>
        <span class="o">...</span>
        <span class="n">batchref</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">allocate</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">batches</span><span class="p">)</span>
        <span class="n">uow</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>  <span class="c1">#<img src="./images/icons/callouts/3.png" alt="3" /></span>
</pre></div></div></div>
</div></div>
<div class="colist arabic"><table>
<tr><td><img src="./images/icons/callouts/1.png" alt="1" /></td><td>
Мы запустим UoW в качестве менеджера контекста.
    
</td></tr>
<tr><td><img src="./images/icons/callouts/2.png" alt="2" /></td><td>
<code>uow.batches</code> это пакетный репо, поэтому UoW предоставляет нам доступ к нашему постоянному хранилищу.
    
</td></tr>
<tr><td><img src="./images/icons/callouts/3.png" alt="3" /></td><td>
Когда мы закончили, мы фиксируем или откатываем нашу работу, используя UoW.
</td></tr>
</table></div>
<div class="paragraph"><p>UoW действует как единственная точка входа в наше постоянное хранилище и отслеживает, какие объекты были загружены, и последнее состояние.<span class="footnote"><br />[
Возможно, вы встречали слово <em>collaborators</em> для описания объектов, которые работают вместе для достижения цели. Единица работы и репозиторий - отличный пример сотрудничества в объектном моделировании. В дизайне, ориентированном на ответственность, кластеры объектов, взаимодействующих в своих ролях, называются <em>object neighborhoods</em> ближайшими соседями, что, по нашему профессиональному мнению, совершенно восхитительно.]<br /></span></p></div>
<div class="paragraph"><p>Это дает нам три полезных преимущества:</p></div>
<div class="ulist"><ul>
<li>
<p>
Стабильный моментальный снимок базы данных для работы, поэтому объекты, которые мы используем, не меняются на полпути операции.
</p>
</li>
<li>
<p>
Способ сохранить все наши изменения сразу, чтобы, если что-то пойдет не так, мы не оказались в непоследовательном состоянии.
</p>
</li>
<li>
<p>
Простой API для наших проблем персистентности и удобное место для получения репозитория
</p>
</li>
</ul></div>
</div>
<div class="sect2">
<h3 id="_тест_драйв_uow_с_интеграционными_тестами">Тест-драйв UoW с интеграционными тестами</h3>
<div class="paragraph"><p>Here are our integration tests for the UOW:</p></div>
<div class="exampleblock" id="test_unit_of_work">
<div class="title">Example 73. A basic "round-trip" test for a UoW (tests/integration/test_uow.py)</div>
<div class="content">
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">test_uow_can_retrieve_a_batch_and_allocate_to_it</span><span class="p">(</span><span class="n">session_factory</span><span class="p">):</span>
    <span class="n">session</span> <span class="o">=</span> <span class="n">session_factory</span><span class="p">()</span>
    <span class="n">insert_batch</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="s1">&#39;batch1&#39;</span><span class="p">,</span> <span class="s1">&#39;HIPSTER-WORKBENCH&#39;</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

    <span class="n">uow</span> <span class="o">=</span> <span class="n">unit_of_work</span><span class="o">.</span><span class="n">SqlAlchemyUnitOfWork</span><span class="p">(</span><span class="n">session_factory</span><span class="p">)</span>  <span class="c1">#<img src="./images/icons/callouts/1.png" alt="1" /></span>
    <span class="k">with</span> <span class="n">uow</span><span class="p">:</span>
        <span class="n">batch</span> <span class="o">=</span> <span class="n">uow</span><span class="o">.</span><span class="n">batches</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">reference</span><span class="o">=</span><span class="s1">&#39;batch1&#39;</span><span class="p">)</span>  <span class="c1">#<img src="./images/icons/callouts/2.png" alt="2" /></span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">OrderLine</span><span class="p">(</span><span class="s1">&#39;o1&#39;</span><span class="p">,</span> <span class="s1">&#39;HIPSTER-WORKBENCH&#39;</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
        <span class="n">batch</span><span class="o">.</span><span class="n">allocate</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="n">uow</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>  <span class="c1">#<img src="./images/icons/callouts/3.png" alt="3" /></span>

    <span class="n">batchref</span> <span class="o">=</span> <span class="n">get_allocated_batch_ref</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="s1">&#39;o1&#39;</span><span class="p">,</span> <span class="s1">&#39;HIPSTER-WORKBENCH&#39;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">batchref</span> <span class="o">==</span> <span class="s1">&#39;batch1&#39;</span>
</pre></div></div></div>
</div></div>
<div class="colist arabic"><table>
<tr><td><img src="./images/icons/callouts/1.png" alt="1" /></td><td>
Мы инициализируем UoW, используя нашу настраиваемую фабрику сеансов, и возвращаем объект <code>uow</code> для использования его в нашем блоке <code>with</code>.
</td></tr>
<tr><td><img src="./images/icons/callouts/2.png" alt="2" /></td><td>
UoW дает нам доступ к репозиторию batch через <code>uow.batches</code>.
</td></tr>
<tr><td><img src="./images/icons/callouts/3.png" alt="3" /></td><td>
Мы вызываем для него <code>commit()</code>, когда закончим.
</td></tr>
</table></div>
<div class="paragraph"><p>Для любопытных хелперы <code>insert_batch</code> и <code>get_allocated_batch_ref</code> выглядят так:</p></div>
<div class="exampleblock" id="sql_helpers">
<div class="title">Example 74. Помощники для работы с SQL (tests/integration/test_uow.py)</div>
<div class="content">
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">insert_batch</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">ref</span><span class="p">,</span> <span class="n">sku</span><span class="p">,</span> <span class="n">qty</span><span class="p">,</span> <span class="n">eta</span><span class="p">):</span>
    <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="s1">&#39;INSERT INTO batches (reference, sku, _purchased_quantity, eta)&#39;</span>
        <span class="s1">&#39; VALUES (:ref, :sku, :qty, :eta)&#39;</span><span class="p">,</span>
        <span class="nb">dict</span><span class="p">(</span><span class="n">ref</span><span class="o">=</span><span class="n">ref</span><span class="p">,</span> <span class="n">sku</span><span class="o">=</span><span class="n">sku</span><span class="p">,</span> <span class="n">qty</span><span class="o">=</span><span class="n">qty</span><span class="p">,</span> <span class="n">eta</span><span class="o">=</span><span class="n">eta</span><span class="p">)</span>
    <span class="p">)</span>


<span class="k">def</span> <span class="nf">get_allocated_batch_ref</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">orderid</span><span class="p">,</span> <span class="n">sku</span><span class="p">):</span>
    <span class="p">[[</span><span class="n">orderlineid</span><span class="p">]]</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="s1">&#39;SELECT id FROM order_lines WHERE orderid=:orderid AND sku=:sku&#39;</span><span class="p">,</span>
        <span class="nb">dict</span><span class="p">(</span><span class="n">orderid</span><span class="o">=</span><span class="n">orderid</span><span class="p">,</span> <span class="n">sku</span><span class="o">=</span><span class="n">sku</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="p">[[</span><span class="n">batchref</span><span class="p">]]</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="s1">&#39;SELECT b.reference FROM allocations JOIN batches AS b ON batch_id = b.id&#39;</span>
        <span class="s1">&#39; WHERE orderline_id=:orderlineid&#39;</span><span class="p">,</span>
        <span class="nb">dict</span><span class="p">(</span><span class="n">orderlineid</span><span class="o">=</span><span class="n">orderlineid</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">batchref</span>
</pre></div></div></div>
</div></div>
</div>
<div class="sect2">
<h3 id="_unit_of_work_и_её_менеджер_контекста">Unit of Work и её менеджер контекста</h3>
<div class="paragraph"><p>В наших тестах мы неявно определили интерфейс для того, что должен делать UoW. Давайте сделаем это явным с помощью абстрактного базового класса:</p></div>
<div class="exampleblock" id="abstract_unit_of_work">
<div class="title">Example 75. Абстрактный менеджер контекста UoW (src/allocation/service_layer/unit_of_work.py)</div>
<div class="content">
<div class="listingblock skip">
<div class="content"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">AbstractUnitOfWork</span><span class="p">(</span><span class="n">abc</span><span class="o">.</span><span class="n">ABC</span><span class="p">):</span>
    <span class="n">batches</span><span class="p">:</span> <span class="n">repository</span><span class="o">.</span><span class="n">AbstractRepository</span>  <span class="c1">#<img src="./images/icons/callouts/1.png" alt="1" /></span>

    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>  <span class="c1">#<img src="./images/icons/callouts/2.png" alt="2" /></span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>  <span class="c1">#<img src="./images/icons/callouts/4.png" alt="4" /></span>

    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">commit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>  <span class="c1">#<img src="./images/icons/callouts/3.png" alt="3" /></span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">rollback</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>  <span class="c1">#<img src="./images/icons/callouts/4.png" alt="4" /></span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>
</pre></div></div></div>
</div></div>
<div class="colist arabic"><table>
<tr><td><img src="./images/icons/callouts/1.png" alt="1" /></td><td>
UoW предоставляет атрибут под названием <code>.batches</code>, который дает нам доступ к репозиторию пакетов.
</td></tr>
<tr><td><img src="./images/icons/callouts/2.png" alt="2" /></td><td>
Если вы никогда не видели контекстного менеджера, <code>__enter__</code> и <code>__exit__</code> это два волшебных метода, которые выполняются, когда мы входим в блок <code>with</code> и когда выходим из него, соответственно. Это наши фазы setup и teardown.
    
    
</td></tr>
<tr><td><img src="./images/icons/callouts/3.png" alt="3" /></td><td>
Мы вызовем этот метод, чтобы явно зафиксировать нашу работу, когда будем готовы.
</td></tr>
<tr><td><img src="./images/icons/callouts/4.png" alt="4" /></td><td>
Если мы не фиксируем, или если мы выходим из диспетчера контекста, вызывая ошибку, мы выполняем
        «откат» <code>rollback</code>. (Откат не возымеет никакого эффекта, если была вызвана функция <code>commit()</code>. Читайте дальше для более подробного обсуждения этого вопроса.)
    
</td></tr>
</table></div>
<div class="sect3">
<h4 id="_реальная_unit_of_work_использует_сеансы_sqlalchemy">Реальная Unit of Work Использует Сеансы SQLAlchemy</h4>
<div class="paragraph"><p>Главное, что добавляет наша конкретная реализация, - это сеанс базы данных:</p></div>
<div class="exampleblock" id="unit_of_work">
<div class="title">Example 76. The real SQLAlchemy UoW (src/allocation/service_layer/unit_of_work.py)</div>
<div class="content">
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span><span class="n">DEFAULT_SESSION_FACTORY</span> <span class="o">=</span> <span class="n">sessionmaker</span><span class="p">(</span><span class="n">bind</span><span class="o">=</span><span class="n">create_engine</span><span class="p">(</span>  <span class="c1">#<img src="./images/icons/callouts/1.png" alt="1" /></span>
    <span class="n">config</span><span class="o">.</span><span class="n">get_postgres_uri</span><span class="p">(),</span>
<span class="p">))</span>

<span class="k">class</span> <span class="nc">SqlAlchemyUnitOfWork</span><span class="p">(</span><span class="n">AbstractUnitOfWork</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session_factory</span><span class="o">=</span><span class="n">DEFAULT_SESSION_FACTORY</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session_factory</span> <span class="o">=</span> <span class="n">session_factory</span>  <span class="c1">#<img src="./images/icons/callouts/1.png" alt="1" /></span>

    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_factory</span><span class="p">()</span>  <span class="c1"># type: Session  #<img src="./images/icons/callouts/2.png" alt="2" /></span>
        <span class="bp">self</span><span class="o">.</span><span class="n">batches</span> <span class="o">=</span> <span class="n">repository</span><span class="o">.</span><span class="n">SqlAlchemyRepository</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">)</span>  <span class="c1">#<img src="./images/icons/callouts/2.png" alt="2" /></span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__enter__</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__exit__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>  <span class="c1">#<img src="./images/icons/callouts/3.png" alt="3" /></span>

    <span class="k">def</span> <span class="nf">commit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>  <span class="c1">#<img src="./images/icons/callouts/4.png" alt="4" /></span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">rollback</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>  <span class="c1">#<img src="./images/icons/callouts/4.png" alt="4" /></span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
</pre></div></div></div>
</div></div>
<div class="colist arabic"><table>
<tr><td><img src="./images/icons/callouts/1.png" alt="1" /></td><td>
Модуль определяет фабрику сеансов по умолчанию, которая будет подключаться к Postgres, но мы позволяем переопределить это в наших интеграционных тестах, чтобы вместо этого мы могли использовать SQLite.
</td></tr>
<tr><td><img src="./images/icons/callouts/2.png" alt="2" /></td><td>
Метод <code>__enter__</code> отвечает за запуск сеанса базы данных и создание экземпляра реального репозитория, который может использовать этот сеанс.
    
</td></tr>
<tr><td><img src="./images/icons/callouts/3.png" alt="3" /></td><td>
Закрываем сессию при выходе.
</td></tr>
<tr><td><img src="./images/icons/callouts/4.png" alt="4" /></td><td>
Наконец, мы предоставляем конкретные методы <code>commit()</code> и <code>rollback()</code>, которые используют наш сеанс базы данных.
    
    
</td></tr>
</table></div>
</div>
<div class="sect3">
<h4 id="_иммитация_unit_of_work_для_теста">Иммитация Unit of Work для теста</h4>
<div class="paragraph"><p>Вот как мы используем фиктивный UoW в наших тестах уровня сервиса:</p></div>
<div class="exampleblock" id="fake_unit_of_work">
<div class="title">Example 77. Fake UoW (tests/unit/test_services.py)</div>
<div class="content">
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">FakeUnitOfWork</span><span class="p">(</span><span class="n">unit_of_work</span><span class="o">.</span><span class="n">AbstractUnitOfWork</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">batches</span> <span class="o">=</span> <span class="n">FakeRepository</span><span class="p">([])</span>  <span class="c1">#<img src="./images/icons/callouts/1.png" alt="1" /></span>
        <span class="bp">self</span><span class="o">.</span><span class="n">committed</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1">#<img src="./images/icons/callouts/2.png" alt="2" /></span>

    <span class="k">def</span> <span class="nf">commit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">committed</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1">#<img src="./images/icons/callouts/2.png" alt="2" /></span>

    <span class="k">def</span> <span class="nf">rollback</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>



<span class="k">def</span> <span class="nf">test_add_batch</span><span class="p">():</span>
    <span class="n">uow</span> <span class="o">=</span> <span class="n">FakeUnitOfWork</span><span class="p">()</span>  <span class="c1">#<img src="./images/icons/callouts/3.png" alt="3" /></span>
    <span class="n">services</span><span class="o">.</span><span class="n">add_batch</span><span class="p">(</span><span class="s2">&quot;b1&quot;</span><span class="p">,</span> <span class="s2">&quot;CRUNCHY-ARMCHAIR&quot;</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">uow</span><span class="p">)</span>  <span class="c1">#<img src="./images/icons/callouts/3.png" alt="3" /></span>
    <span class="k">assert</span> <span class="n">uow</span><span class="o">.</span><span class="n">batches</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;b1&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
    <span class="k">assert</span> <span class="n">uow</span><span class="o">.</span><span class="n">committed</span>


<span class="k">def</span> <span class="nf">test_allocate_returns_allocation</span><span class="p">():</span>
    <span class="n">uow</span> <span class="o">=</span> <span class="n">FakeUnitOfWork</span><span class="p">()</span>  <span class="c1">#<img src="./images/icons/callouts/3.png" alt="3" /></span>
    <span class="n">services</span><span class="o">.</span><span class="n">add_batch</span><span class="p">(</span><span class="s2">&quot;batch1&quot;</span><span class="p">,</span> <span class="s2">&quot;COMPLICATED-LAMP&quot;</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">uow</span><span class="p">)</span>  <span class="c1">#<img src="./images/icons/callouts/3.png" alt="3" /></span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">services</span><span class="o">.</span><span class="n">allocate</span><span class="p">(</span><span class="s2">&quot;o1&quot;</span><span class="p">,</span> <span class="s2">&quot;COMPLICATED-LAMP&quot;</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">uow</span><span class="p">)</span>  <span class="c1">#<img src="./images/icons/callouts/3.png" alt="3" /></span>
    <span class="k">assert</span> <span class="n">result</span> <span class="o">==</span> <span class="s2">&quot;batch1&quot;</span>
<span class="o">...</span>
</pre></div></div></div>
</div></div>
<div class="colist arabic"><table>
<tr><td><img src="./images/icons/callouts/1.png" alt="1" /></td><td>
<code>FakeUnitOfWork</code> и <code>FakeRepository</code> тесно связаны, так же как  реальные классы <code>UnitofWork</code>  и <code>Repository</code>.     Это прекрасно, потому что мы признаем, что объекты являются соавторами.
</td></tr>
<tr><td><img src="./images/icons/callouts/2.png" alt="2" /></td><td>
Обратите внимание на сходство с фальшивой функцией <code>commit()</code> из <code>FakeSession</code> (от которой теперь мы можем избавиться). Но это существенное улучшение, потому что мы сейчас <span class=".keep-together">подделываем</span> код, который мы написали, а не сторонний код. Как гласит народная мудрость, <a href="https://oreil.ly/0LVj3">"Не твоё&#8201;&#8212;&#8201;не трогай"</a>.
</td></tr>
<tr><td><img src="./images/icons/callouts/3.png" alt="3" /></td><td>
В наших тестах мы можем создать экземпляр UoW и передать его на наш уровень обслуживания, а не передавать репозиторий и сеанс. Это значительно изящнее.
</td></tr>
</table></div>
<div class="sidebarblock nobreakinside less_space">
<div class="content">
<div class="title">Не твоё&#8201;&#8212;&#8201;не мОкай</div>
<div class="paragraph"><p>Почему мы чувствуем себя более комфортно, мокая UoW, а не сессию? Обе наши имитации преднназначены для одного и того же: дать нам возможность изменить уровень персистентности, чтобы мы могли запускать тесты в памяти вместо того, чтобы связываться с реальной базой данных. Разница заключается в полученном дизайне.</p></div>
<div class="paragraph"><p>Если бы мы заботились только о написании тестов, которые выполняются быстро, мы могли бы создавать макеты, заменяющие SQLAlchemy, и использовать их во всей нашей кодовой базе. Проблема в том, что Session - это сложный объект, который предоставляет множество функций, связанных с постоянством. <code>Session</code> легко использовать для выполнения произвольных запросов к базе данных, но это быстро приводит к тому, что код доступа к данным разбрызгивается по всей кодовой базе. Чтобы этого избежать, мы хотим ограничить доступ к нашему уровню сохранения, чтобы каждый компонент имел именно то, что ему нужно, и ничего более.</p></div>
<div class="paragraph"><p>Связываясь с интерфейсом <code>Session</code>, вы решаете объединить всю сложность SQLAlchemy. Вместо этого мы хотим выбрать более простую абстракцию и использовать ее для четкого разделения обязанностей. Наш UoW намного проще, чем сеанс, и мы чувствуем себя комфортно, когда уровень сервиса может запускать и останавливать единицы работы.</p></div>
<div class="paragraph"><p>«Не смейтесь над тем, что вам не принадлежит» - это эмпирическое правило, которое заставляет нас строить эти простые абстракции над беспорядочными подсистемами. Это дает тот же выигрыш в производительности, что и имитация сеанса SQLAlchemy, но побуждает нас тщательно обдумать наши проекты.</p></div>
</div></div>
</div>
</div>
<div class="sect2">
<h3 id="_использование_uow_в_сервисном_слое">Использование UoW в сервисном слое</h3>
<div class="paragraph"><p>Вот как выглядит наш новый уровень обслуживания:</p></div>
<div class="exampleblock" id="service_layer_with_uow">
<div class="title">Example 78. Уровень обслуживания с использованием UoW (src/allocation/service_layer/services.py)</div>
<div class="content">
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">add_batch</span><span class="p">(</span>
        <span class="n">ref</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">sku</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">qty</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">eta</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">date</span><span class="p">],</span>
        <span class="n">uow</span><span class="p">:</span> <span class="n">unit_of_work</span><span class="o">.</span><span class="n">AbstractUnitOfWork</span>  <span class="c1">#<img src="./images/icons/callouts/1.png" alt="1" /></span>
<span class="p">):</span>
    <span class="k">with</span> <span class="n">uow</span><span class="p">:</span>
        <span class="n">uow</span><span class="o">.</span><span class="n">batches</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">Batch</span><span class="p">(</span><span class="n">ref</span><span class="p">,</span> <span class="n">sku</span><span class="p">,</span> <span class="n">qty</span><span class="p">,</span> <span class="n">eta</span><span class="p">))</span>
        <span class="n">uow</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">allocate</span><span class="p">(</span>
        <span class="n">orderid</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">sku</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">qty</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">uow</span><span class="p">:</span> <span class="n">unit_of_work</span><span class="o">.</span><span class="n">AbstractUnitOfWork</span>  <span class="c1">#<img src="./images/icons/callouts/1.png" alt="1" /></span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">line</span> <span class="o">=</span> <span class="n">OrderLine</span><span class="p">(</span><span class="n">orderid</span><span class="p">,</span> <span class="n">sku</span><span class="p">,</span> <span class="n">qty</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">uow</span><span class="p">:</span>
        <span class="n">batches</span> <span class="o">=</span> <span class="n">uow</span><span class="o">.</span><span class="n">batches</span><span class="o">.</span><span class="n">list</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_valid_sku</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">sku</span><span class="p">,</span> <span class="n">batches</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">InvalidSku</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Invalid sku </span><span class="si">{</span><span class="n">line</span><span class="o">.</span><span class="n">sku</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">batchref</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">allocate</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">batches</span><span class="p">)</span>
        <span class="n">uow</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">batchref</span>
</pre></div></div></div>
</div></div>
<div class="colist arabic"><table>
<tr><td><img src="./images/icons/callouts/1.png" alt="1" /></td><td>
Наш уровень обслуживания теперь имеет только одну зависимость, опять же от <em>abstract</em> UoW.
    
</td></tr>
</table></div>
</div>
<div class="sect2">
<h3 id="_явные_тесты_для_режима_commit_rollback">Явные тесты для режима Commit/Rollback</h3>
<div class="paragraph"><p>Чтобы убедиться, что поведение <em>commit/rollback</em> фиксации/отката работает, мы написали несколько тестов:</p></div>
<div class="exampleblock" id="testing_rollback">
<div class="title">Example 79. Интеграционные тесты на поведение отката (tests/integration/test_uow.py)</div>
<div class="content">
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">test_rolls_back_uncommitted_work_by_default</span><span class="p">(</span><span class="n">session_factory</span><span class="p">):</span>
    <span class="n">uow</span> <span class="o">=</span> <span class="n">unit_of_work</span><span class="o">.</span><span class="n">SqlAlchemyUnitOfWork</span><span class="p">(</span><span class="n">session_factory</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">uow</span><span class="p">:</span>
        <span class="n">insert_batch</span><span class="p">(</span><span class="n">uow</span><span class="o">.</span><span class="n">session</span><span class="p">,</span> <span class="s1">&#39;batch1&#39;</span><span class="p">,</span> <span class="s1">&#39;MEDIUM-PLINTH&#39;</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="n">new_session</span> <span class="o">=</span> <span class="n">session_factory</span><span class="p">()</span>
    <span class="n">rows</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">new_session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;SELECT * FROM &quot;batches&quot;&#39;</span><span class="p">))</span>
    <span class="k">assert</span> <span class="n">rows</span> <span class="o">==</span> <span class="p">[]</span>


<span class="k">def</span> <span class="nf">test_rolls_back_on_error</span><span class="p">(</span><span class="n">session_factory</span><span class="p">):</span>
    <span class="k">class</span> <span class="nc">MyException</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="n">uow</span> <span class="o">=</span> <span class="n">unit_of_work</span><span class="o">.</span><span class="n">SqlAlchemyUnitOfWork</span><span class="p">(</span><span class="n">session_factory</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="n">MyException</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">uow</span><span class="p">:</span>
            <span class="n">insert_batch</span><span class="p">(</span><span class="n">uow</span><span class="o">.</span><span class="n">session</span><span class="p">,</span> <span class="s1">&#39;batch1&#39;</span><span class="p">,</span> <span class="s1">&#39;LARGE-FORK&#39;</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">MyException</span><span class="p">()</span>

    <span class="n">new_session</span> <span class="o">=</span> <span class="n">session_factory</span><span class="p">()</span>
    <span class="n">rows</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">new_session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;SELECT * FROM &quot;batches&quot;&#39;</span><span class="p">))</span>
    <span class="k">assert</span> <span class="n">rows</span> <span class="o">==</span> <span class="p">[]</span>
</pre></div></div></div>
</div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/tip.png" alt="Tip" />
</td>
<td class="content">Мы не показывали его здесь, но, возможно, стоит протестировать некоторые из более "неясных" действий базы данных, таких как транзакции, против "реальной" базы данных—то есть того же самого движка. На данный момент нам сходит с рук использование SQLite вместо Postgres, но в <a href="#chapter_07_aggregate">[chapter_07_aggregate]</a> мы переключим некоторые тесты на использование реальной базы данных. Очень удобно, что наш класс UoW делает это легко!
    </td>
</tr></table>
</div>
</div>
<div class="sect2">
<h3 id="_явные_и_неявные_коммиты">Явные и неявные коммиты</h3>
<div class="paragraph"><p>Теперь мы вкратце остановимся на различных способах реализации паттерна UoW.</p></div>
<div class="paragraph"><p>Мы могли бы представить себе несколько иную версию UoW, которая фиксируется по умолчанию и откатывается только в том случае, если замечает исключение:</p></div>
<div class="exampleblock" id="uow_implicit_commit">
<div class="title">Example 80. UoW с неявной фиксацией &#8230; (src/allocation/unit_of_work.py)</div>
<div class="content">
<div class="listingblock skip">
<div class="content"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">AbstractUnitOfWork</span><span class="p">(</span><span class="n">abc</span><span class="o">.</span><span class="n">ABC</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exn_type</span><span class="p">,</span> <span class="n">exn_value</span><span class="p">,</span> <span class="n">traceback</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">exn_type</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>  <span class="c1">#<img src="./images/icons/callouts/1.png" alt="1" /></span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>  <span class="c1">#<img src="./images/icons/callouts/2.png" alt="2" /></span>
</pre></div></div></div>
</div></div>
<div class="colist arabic"><table>
<tr><td><img src="./images/icons/callouts/1.png" alt="1" /></td><td>
Должны ли мы иметь на счастливом пути неявную фиксацию?
</td></tr>
<tr><td><img src="./images/icons/callouts/2.png" alt="2" /></td><td>
И откатиться только при исключении?
</td></tr>
</table></div>
<div class="paragraph"><p>Это позволило бы нам сохранить строку кода и удалить явную фиксацию из нашего клиентского кода:</p></div>
<div class="exampleblock" id="add_batch_nocommit">
<div class="title">Example 81. ...это сэкономило бы нам строку кода (src/allocation/service_layer/services.py)</div>
<div class="content">
<div class="listingblock skip">
<div class="content"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">add_batch</span><span class="p">(</span><span class="n">ref</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">sku</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">qty</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">eta</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">date</span><span class="p">],</span> <span class="n">uow</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">uow</span><span class="p">:</span>
        <span class="n">uow</span><span class="o">.</span><span class="n">batches</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">Batch</span><span class="p">(</span><span class="n">ref</span><span class="p">,</span> <span class="n">sku</span><span class="p">,</span> <span class="n">qty</span><span class="p">,</span> <span class="n">eta</span><span class="p">))</span>
        <span class="c1"># uow.commit()</span>
</pre></div></div></div>
</div></div>
<div class="paragraph"><p>Это субъективное мнение, но мы, как правило, предпочитаем требовать явной фиксации, так что нам приходится выбирать, когда сбросить состояние.</p></div>
<div class="paragraph"><p>Хотя мы используем дополнительную строку кода, это делает программное обеспечение безопасным по умолчанию. Поведение по умолчанию - "ничего не менять". В свою очередь, это делает наш код более простым для рассуждения, потому что есть только один путь кода, который ведет к изменениям в системе: полный успех и явная фиксация. Любой другой путь кода, любое исключение, любой ранний выход из области действия UoW приводит к безопасному состоянию.</p></div>
<div class="paragraph"><p>Точно так же мы предпочитаем откат по умолчанию, потому что это легче понять; это откат к последней фиксации, поэтому пользователь либо выполнил задание, или мы сдуем их изменения. Сурово, но просто.</p></div>
</div>
<div class="sect2">
<h3 id="_примеры_использование_uow_для_группировки_нескольких_операций_в_атомарную_единицу">Примеры: Использование UoW для группировки нескольких операций в атомарную единицу</h3>
<div class="paragraph"><p>Ниже приведены некоторые примеры используемых схем работы. Это может привести к более простому рассуждению о том, как блоки кода работают совместно.</p></div>
<div class="sect3">
<h4 id="_пример_1_перераспределение">Пример 1: Перераспределение</h4>
<div class="paragraph"><p>Предположим, что мы хотим отменить распределение, а затем передислоцировать заказ:</p></div>
<div class="exampleblock" id="reallocate">
<div class="title">Example 82. Перераспределить сервисную функцию</div>
<div class="content">
<div class="listingblock skip">
<div class="content"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">reallocate</span><span class="p">(</span><span class="n">line</span><span class="p">:</span> <span class="n">OrderLine</span><span class="p">,</span> <span class="n">uow</span><span class="p">:</span> <span class="n">AbstractUnitOfWork</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">with</span> <span class="n">uow</span><span class="p">:</span>
        <span class="n">batch</span> <span class="o">=</span> <span class="n">uow</span><span class="o">.</span><span class="n">batches</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">sku</span><span class="o">=</span><span class="n">line</span><span class="o">.</span><span class="n">sku</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">batch</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">InvalidSku</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Invalid sku </span><span class="si">{</span><span class="n">line</span><span class="o">.</span><span class="n">sku</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">batch</span><span class="o">.</span><span class="n">deallocate</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>  <span class="c1">#<img src="./images/icons/callouts/1.png" alt="1" /></span>
        <span class="n">allocate</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>  <span class="c1">#<img src="./images/icons/callouts/2.png" alt="2" /></span>
        <span class="n">uow</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</pre></div></div></div>
</div></div>
<div class="colist arabic"><table>
<tr><td><img src="./images/icons/callouts/1.png" alt="1" /></td><td>
Если <code>deallocate()</code> не работает, очевидно мы не хотим вызывать <code>allocate()</code>.
</td></tr>
<tr><td><img src="./images/icons/callouts/2.png" alt="2" /></td><td>
Если <code>allocate()</code> терпит неудачу, вероятно мы, так же не хотим фиксить <code>deallocate()</code>
</td></tr>
</table></div>
</div>
<div class="sect3">
<h4 id="_пример_2_изменить_размер_партии">Пример 2: Изменить размер партии</h4>
<div class="paragraph"><p>Наша судоходная компания звонит нам, чтобы сообщить, что одна из дверей контейнера открылась, и половина наших диванов упала в Индийский океан. Ой!</p></div>
<div class="exampleblock" id="change_batch_quantity">
<div class="title">Example 83. Изменение количества</div>
<div class="content">
<div class="listingblock skip">
<div class="content"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">change_batch_quantity</span><span class="p">(</span><span class="n">batchref</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">new_qty</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">uow</span><span class="p">:</span> <span class="n">AbstractUnitOfWork</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">uow</span><span class="p">:</span>
        <span class="n">batch</span> <span class="o">=</span> <span class="n">uow</span><span class="o">.</span><span class="n">batches</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">reference</span><span class="o">=</span><span class="n">batchref</span><span class="p">)</span>
        <span class="n">batch</span><span class="o">.</span><span class="n">change_purchased_quantity</span><span class="p">(</span><span class="n">new_qty</span><span class="p">)</span>
        <span class="k">while</span> <span class="n">batch</span><span class="o">.</span><span class="n">available_quantity</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">batch</span><span class="o">.</span><span class="n">deallocate_one</span><span class="p">()</span>  <span class="c1">#<img src="./images/icons/callouts/1.png" alt="1" /></span>
        <span class="n">uow</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</pre></div></div></div>
</div></div>
<div class="colist arabic"><table>
<tr><td><img src="./images/icons/callouts/1.png" alt="1" /></td><td>
Здесь нам может понадобиться разобраться с любым количеством строк. Если мы получим неудачу на каком-то этапе, мы, вероятно, не захотим вносить никаких изменений.
    
    
</td></tr>
</table></div>
</div>
</div>
<div class="sect2">
<h3 id="_уборка_интеграционных_тестов">Уборка интеграционных тестов</h3>
<div class="paragraph"><p>Теперь у нас есть три набора тестов, все из которых, по сути, направлены на базу данных: <em>test_orm.py</em>, <em>test_repository.py</em>, и <em>test_uow.py</em>. Может, выкинем что-нибудь?</p></div>
<div class="exampleblock">
<div class="content">
<div class="listingblock tree">
<div class="content"><div class="highlight"><pre><span></span>└── tests
    ├── conftest.py
    ├── e2e
    │   └── test_api.py
    ├── integration
    │   ├── test_orm.py
    │   ├── test_repository.py
    │   └── test_uow.py
    ├── pytest.ini
    └── unit
        ├── test_allocate.py
        ├── test_batches.py
        └── test_services.py
</pre></div></div></div>
</div></div>
<div class="paragraph"><p>Вы всегда можете отказаться от тестов, если считаете, что они не принесут пользы в долгосрочной перспективе. Мы бы сказали, что <em>test_orm.py</em> был в первую очередь инструментом для изучения SQLAlchemy, поэтому в дальнейшем он не понадобится, особенно если основные вещи, которые он делает, описаны в <em>test_repository.py</em>. Этот последний тест вы можете оставить, но мы, безусловно, видим аргумент в пользу того, чтобы просто держать все на максимально возможном уровне абстракции (так же, как мы делали это в юнит-тестах).</p></div>
<div class="sidebarblock nobreakinside less_space">
<div class="content">
<div class="title">Упражнение для читателя</div>
<div class="paragraph"><p>Для этой главы, пожалуй, лучшее, что можно попробовать, это реализовать UoW с нуля. Код, как всегда, здесь <a href="https://github.com/cosmicpython/code/tree/chapter_06_uow_exercise">на GitHub</a>. Вы можете либо достаточно внимательно следовать нашей модели, либо, возможно, поэкспериментировать с отделением UoW (в обязанности которого входит <code>commit()</code>, <code>rollback()</code> и предоставление репозитория <code>.batches</code>) от контекстного менеджера, чья работа заключается в инициализации объектов, а затем выполнить коммит или откат при выходе. Если вы чувствуете, что хотите работать полностью функционально, а не возиться со всеми этими классами, вы можете использовать <code>@contextmanager</code> из <code>contextlib</code>.</p></div>
<div class="paragraph"><p>Мы удалили как фактический UoW, так и подделки, а также сократили абстрактный UoW. Почему бы не прислать нам ссылку на ваше репо, если вы придумали что-то, чем особенно гордитесь?</p></div>
</div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/tip.png" alt="Tip" />
</td>
<td class="content">Это еще один пример урока из <a href="#chapter_05_high_gear_low_gear">[chapter_05_high_gear_low_gear]</a>: по мере того как мы строим лучшие абстракции, мы можем перемещать наши тесты, чтобы работать с ними, что оставляет нам свободу изменять лежащие в их основе детали.</td>
</tr></table>
</div>
</div>
<div class="sect2">
<h3 id="_заключение_3">Заключение</h3>
<div class="paragraph"><p>Надеюсь, мы убедили вас, что шаблон «Единица работы» полезен и что диспетчер контекста - действительно хороший питонический способ визуальной группировки кода в блоки, которые мы хотим реализовать атомарно.</p></div>
<div class="paragraph"><p>Этот шаблон настолько полезен, что SQLAlchemy уже использует UoW в форме объекта <code>Session</code>. Объект <code>Session</code> в SQLAlchemy - это способ, которым ваше приложение загружает данные из базы данных.</p></div>
<div class="paragraph"><p>Каждый раз, когда вы загружаете новую <em>сущность</em> из базы данных, сеанс начинает <em>отслеживать</em> изменения в сущности, и когда сеанс сбрасывается, все ваши изменения сохраняются вместе. Зачем нам пытаться абстрагировать сеанс SQLAlchemy, если он уже реализует нужный нам паттерн?</p></div>
<div class="paragraph"><p><a href="#chapter_06_uow_tradeoffs">[chapter_06_uow_tradeoffs]</a> обсуждает некоторые компромиссы.</p></div>
<div class="tableblock" id="chapter_06_uow_tradeoffs">
<table rules="all"
width="100%"
frame="border"
cellspacing="0" cellpadding="4">
<caption class="title">Table 3. Паттерн Единица Работы: компромиссы</caption>
<col width="50%" />
<col width="50%" />
<thead>
<tr>
<th align="left" valign="top">Плюсы</th>
<th align="left" valign="top">Минусы</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left" valign="top"><div><div class="ulist"><ul>
<li>
<p>
У нас есть хорошая абстракция над концепцией атомарных операций, и контекстный менеджер позволяет легко увидеть, визуально, какие блоки кода сгруппированы вместе атомарно.


</p>
</li>
<li>
<p>
У нас есть явный контроль над тем, когда транзакция начинается и заканчивается, и наше приложение выходит в случае сбоя таким образом, который безопасен по умолчанию. Нам никогда не приходётсяся беспокоиться о том, что операция завершена лишь частично.
</p>
</li>
<li>
<p>
Это хорошее место для размещения всех репозиториев, доступных для клиентского кода.
</p>
</li>
<li>
<p>
Как вы увидите в последующих главах, атомарность&#8201;&#8212;&#8201;это не только транзакции; она может помочь нам работать с событиями и шиной сообщений.
</p>
</li>
</ul></div></div></td>
<td align="left" valign="top"><div><div class="ulist"><ul>
<li>
<p>
В вашем ORM, вероятно, уже есть отличные абстракции вокруг атомарности. В SQLAlchemy даже есть диспетчеры контекста. Вы можете пройти долгий путь, просто пропуская сеанс.
</p>
</li>
<li>
<p>
Мы сделали так, чтобы это выглядело легко, но вы должны очень тщательно подумать о таких вещах, как откаты, многопоточность и вложенные транзакции. Возможно, просто придерживаясь того, что дает вам Django или Flask-SQLAlchemy, вы упростите свою жизнь.

</p>
</li>
</ul></div></div></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p>Во-первых, Session API богат и поддерживает операции, которые нам не нужны или не нужны в нашем домене. Наш <code>UnitOfWork</code> упрощает сеанс до его основного ядра: его можно запустить, зафиксировать или выбросить.</p></div>
<div class="paragraph"><p>Во-вторых, мы используем <code>UnitOfWork</code> для доступа к нашим объектам <code>Repository</code>. Это добавит удобства в использовании разработчиками, и это то, то мы не смогли бы сделать с помощью простого SQLAlchemy <code>Session</code>.</p></div>
<div class="sidebarblock nobreakinside less_space">
<div class="content">
<div class="title">Краткий обзор шаблона Unit of Work</div>
<div class="paragraph"><p></p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
Шаблон Unit of Work - это абстракция вокруг целостности данных
</dt>
<dd>
<p>
        Он помогает обеспечить согласованность нашей модели предметной области и повышает производительность, позволяя нам выполнять одну _flush_операцию  в конце операции.
</p>
</dd>
<dt class="hdlist1">
Он тесно работает с шаблонами Уровня репозитория и сервиса
</dt>
<dd>
<p>
        Шаблон Unit of Work завершает наши абстракции над доступом к данным, представляя атомарные обновления. Каждый из наших вариантов использования сервисного уровня выполняется в одной единице работы, которая успешно или неудачно выполняется как блок.
</p>
</dd>
<dt class="hdlist1">
Это прекрасный случай для контекстного менеджера
</dt>
<dd>
<p>
        Менеджеры контекста - это идиоматический способ определения области видимости в Python. Мы можем использовать диспетчер контекста для автоматического отката нашей работы в конце запроса, что означает, что система по умолчанию безопасна.
</p>
</dd>
</dl></div>
<div class="paragraph"><p>SQLAlchemy уже реализует этот шаблон:
    Мы вводим еще более простую абстракцию над объектом SQLAlchemy <code>Session</code>, чтобы "сузить" интерфейс между ORM и нашим кодом. Это помогает нам сохранять слабую связь.</p></div>
</div></div>
<div class="paragraph"><p>Наконец, мы снова мотивированы принципом инверсии зависимостей: наш уровень сервиса зависит от тонкой абстракции, и мы прикрепляем конкретную реализацию к внешнему краю системы. Это хорошо согласуется с собственной <a href="https://oreil.ly/tS0E0">рекомендацией</a> SQLAlchemy:</p></div>
<div class="quoteblock">
<div class="content">
<div class="paragraph"><p>Держите жизненный цикл сеанса (и, как правило, транзакции) отдельным и внешним. Наиболее комплексный подход, рекомендуемый для более существенных приложений, будет стараться держать детали сеанса, транзакции и управления исключениями как можно дальше от деталей программы, выполняющей свою работу.</p></div>
</div>
<div class="attribution">
&#8212; SQLALchemy "Session Basics" Documentation
</div></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="chapter_07_aggregate">Агрегаты и границы консистентности</h2>
<div class="sectionbody">
<div class="paragraph"><p>В этой главе мы бы хотели вернуться к нашей доменной модели, чтобы поговорить об инвариантах и ограничениях, а также посмотреть, как наши доменные объекты могут поддерживать свою собственную внутреннюю согласованность, как концептуально, так и в постоянном хранении.  Мы обсудим концепцию <em>границ консистентности</em> и покажем, как ее постановка может помочь нам построить высокопроизводительное программное обеспечение без ущерба для удобства обслуживания.</p></div>
<div class="paragraph"><p><a href="#maps_chapter_06">[maps_chapter_06]</a> показывает предварительный образ того, куда мы движемся: мы введем новый объект модели под названием <code>Product</code> для упаковки нескольких пакетов <em>batches</em>, и вместо этого сделаем старую доменную службу <code>allocate()</code> доступной в качестве метода в <code>Product</code>.</p></div>
<div class="imageblock" id="maps_chapter_06">
<div class="content">
<img src="images/apwp_0701.png" alt="images/apwp_0701.png" />
</div>
<div class="title">Figure 24. Добавление Product aggregate</div>
</div>
<div class="paragraph"><p>Почему? Давай выясним.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/tip.png" alt="Tip" />
</td>
<td class="content">
<div class="paragraph"><p>Код этой главы находится в ветке chapter_07_aggregate
<a href="https://github.com/cosmicpython/code/tree/chapter_07_aggregate">on <span class=".keep-together">GitHub</span></a>:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>git clone https://github.com/cosmicpython/code.git
cd code
git checkout chapter_07_aggregate
# или, чтобы кодировать вместе, проверьте предыдущую главу:
git checkout chapter_06_uow</code></pre>
</div></div>
</td>
</tr></table>
</div>
<div class="sect2">
<h3 id="_почему_бы_просто_не_запустить_все_в_электронной_таблице">Почему бы просто не запустить все в электронной таблице?</h3>
<div class="paragraph"><p>В любом случае, в чем смысл доменной модели? Какую фундаментальную проблему мы пытаемся решить?</p></div>
<div class="paragraph"><p>Не могли бы мы просто запустить все в электронную таблицу? Многие из наших пользователей были бы <span class=".keep-together">в восторге</span> от этого. Бизнес-пользователи <em>любят</em> электронные таблицы, потому что они простые, привычные и в то же время невероятно мощные.</p></div>
<div class="paragraph"><p>На самом деле, огромное количество бизнес-процессов работают путем ручной отправки электронных таблиц туда и обратно по электронной почте. Эта архитектура «CSV поверх SMTP» имеет низкую начальную сложность, но имеет тенденцию не очень хорошо масштабироваться, потому что трудно применять логику и поддерживать согласованность.</p></div>
<div class="paragraph"><p>Кому разрешено просматривать это конкретное поле? Кому разрешено обновлять? Что происходит, когда мы пытаемся заказать -350 стульев, или 10 000 000 столов? Может ли работник иметь отрицательную зарплату?</p></div>
<div class="paragraph"><p>Это ограничения системы. Большая часть логики предметной области, которую мы пишем, существует для обеспечения соблюдения этих ограничений, чтобы поддерживать инварианты системы. Инварианты&#8201;&#8212;&#8201;это то, что должно быть истинным всякий раз, когда мы заканчиваем операцию.</p></div>
</div>
<div class="sect2">
<h3 id="_инварианты_ограничения_и_консистентность">Инварианты, Ограничения и Консистентность</h3>
<div class="paragraph"><p>Эти два слова в некоторой степени взаимозаменяемы, но <em>constraint</em> Ограничения&#8201;&#8212;&#8201;это правило, ограничивающее возможные состояния, в которые может попасть наша модель, в то время как <em>invariant</em> определяется немного более точно как условие, которое всегда истинно.</p></div>
<div class="paragraph"><p>Если бы мы писали систему бронирования отелей, у нас могло бы возникнуть ограничение, что двойное бронирование не допускается. Это подтверждает инвариант, что номер не может быть забронирован более чем на одну ночь.</p></div>
<div class="paragraph"><p>Конечно, иногда нам может понадобиться временно нарушить правила. Возможно, нам нужно перетасовать номера из-за VIP-бронирования. Пока мы перемещаем заказы в памяти, мы можем быть дважды забронированы, но наша модель предметной области должна гарантировать, что, когда мы закончим, мы окажемся в конечном согласованном состоянии, где инварианты будут выполнены. Если мы не можем найти способ разместить всех наших гостей, мы должны поднять ошибку и отказаться от завершения операции.</p></div>
<div class="paragraph"><p>Давайте рассмотрим несколько конкретных примеров из наших бизнес-требований; мы начнем с этого:</p></div>
<div class="quoteblock">
<div class="content">
<div class="paragraph"><p>Строка заказа может быть выделена только для одной партии одновременно.</p></div>
</div>
<div class="attribution">
&#8212; The business
</div></div>
<div class="paragraph"><p>Это бизнес - правило, которое накладывает инвариант. Инвариант заключается в том, что строка заказа распределяется либо на ноль, либо на одну партию, но никогда не более чем на одну. Нам нужно убедиться, что наш код никогда случайно не вызывает <code>Batch.allocate()</code> в двух разных пакетах для одной и той же строки, и в настоящее время ничто явно не мешает нам это сделать.</p></div>
<div class="sect3">
<h4 id="_инварианты_параллельность_и_блокировки_em_locks_em">Инварианты, Параллельность, и Блокировки <em>locks</em></h4>
<div class="paragraph"><p>Давайте рассмотрим еще одно из наших бизнес-правил:</p></div>
<div class="quoteblock">
<div class="content">
<div class="paragraph"><p>Мы не можем выделить партию, если доступное количество меньше количества строки заказа.</p></div>
</div>
<div class="attribution">
&#8212; The business
</div></div>
<div class="paragraph"><p>Ограничением здесь является то, что мы не можем выделить больше запасов, чем имеется в наличии для партии, поэтому мы никогда не перепродаем запасы, например, выделяя двух клиентов на одну и ту же физическую подушку. Каждый раз, когда мы обновляем состояние системы, наш код должен гарантировать, что мы не сломаем инвариант, а именно, что доступное количество должно быть больше или равно нулю.</p></div>
<div class="paragraph"><p>В однопоточном, однопользовательском приложении нам относительно легко поддерживать этот инвариант. Мы можем просто выделить запас по одной строке за раз и вызвать ошибку, если запаса нет.</p></div>
<div class="paragraph"><p>Это становится намного сложнее, когда мы вводим идею <em>concurrency</em>. Внезапно мы можем распределять запасы для нескольких строк заказа одновременно. Мы могли бы даже выделять строки заказа одновременно с обработкой изменений в пакетах <span class=".keep-together">сами для себя</span>.</p></div>
<div class="paragraph"><p>Обычно мы решаем эту проблему, применяя блокировку <em>locks</em> к нашим таблицам базы данных. Это предотвращает одновременное выполнение двух операций в одной строке или одной таблице.</p></div>
<div class="paragraph"><p>Когда мы начинаем думать о масштабировании нашего приложения, мы понимаем, что наша модель распределения строк по всем доступным пакетам может не масштабироваться. Если мы обрабатываем десятки тысяч заказов в час и сотни тысяч строк заказов, мы не можем держать блокировку над всей таблицей <code>batches</code> партии для каждого из них&#8201;&#8212;&#8201;мы получим тупики или проблемы с производительностью, по крайней мере.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_что_такое_агрегат">Что такое Агрегат?</h3>
<div class="paragraph"><p>Итак, если мы не можем блокировать всю базу данных каждый раз, когда хотим выделить строку заказа, что мы должны делать вместо этого? Мы хотим защитить инварианты нашей системы, но при этом обеспечить максимальную степень параллелизма. Сохранение наших инвариантов неизбежно означает предотвращение одновременной записи; если несколько пользователей могут выделить "DEADLY-SPOON" одновременно, мы рискуем перераспределить ее.</p></div>
<div class="paragraph"><p>С другой стороны, нет причин, по которым мы не можем выделить <code>DEADLY-SPOON</code> одновременно с <code>FLIMSY-DESK</code>. Безопасно выделять два продукта одновременно, потому что нет инварианта, покрывающего оба. Нам не нужно, чтобы они были консистентны друг другу.</p></div>
<div class="paragraph"><p>Шаблон <em>Aggregate</em> является шаблоном дизайна от сообщества DDD, который помогает нам решить эту проблему. <em>aggregate</em> - это просто объект домена, который содержит другие объекты домена и позволяет нам рассматривать всю коллекцию как единое целое.</p></div>
<div class="paragraph"><p>Единственный способ модифицировать объекты внутри агрегата - это загрузить его целиком, а также вызвать методы внутри самомого агрегата.</p></div>
<div class="paragraph"><p>По мере усложнения модели и увеличения числа объектов сущностей и значений, ссылающихся друг на друга в запутанном графе, становится трудно отслеживать, кто и что может изменять. Особенно когда у нас есть <em>collections</em> в модели, как у нас это принято (наши пакеты-это коллекция), это хорошая идея назначить некоторые сущности в качестве единственной точки входа для изменения связанных с ними объектов. Это делает систему концептуально проще и легче обоснуемой, если вы назначаете некоторые объекты ответственными за консистентность над другими.</p></div>
<div class="paragraph"><p>Например, если мы создаем Интернет-магазин, Корзина может стать хорошим Агрегатом: это коллекция предметов, которые мы можем рассматривать как единое целое. Важно отметить, что мы хотим загрузить всю корзину как одну большую каплю из нашего хранилища данных. Мы не хотим, чтобы два запроса изменяли корзину одновременно, иначе мы рискуем получить странные ошибки параллелизма. Вместо этого мы хотим, чтобы каждое изменение корзины выполнялось в одной транзакции базы данных.</p></div>
<div class="paragraph"><p>Мы не хотим изменять несколько корзин в транзакции, потому что нет смысла менять корзины нескольких клиентов одновременно. Каждая корзина представляет собой единственную <em>границу соответствия</em>, отвечающую за поддержание своих собственных инвариантов.</p></div>
<div class="quoteblock">
<div class="content">
<div class="paragraph"><p>АГРЕГАТ - это кластер связанных объектов, который мы рассматриваем как единое целое с целью изменения данных.</p></div>
</div>
<div class="attribution">
<em>Domain-Driven Design blue book</em><br />
&#8212; Eric Evans
</div></div>
<div class="paragraph"><p>Согласно Эвансу, наш агрегат имеет корневую сущность (корзину), которая инкапсулирует доступ к элементам. Каждый товар имеет свою индивидуальность, но другие части системы всегда будут относиться к Корзине только как к неделимому целому.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/tip.png" alt="Tip" />
</td>
<td class="content">Точно так же, как мы иногда используем <code><em>_leading_underscores</em></code> для обозначения методов или функций как "частных", вы можете думать о агрегатах как о "публичных" классах нашей модели, а об остальных сущностях и объектах значений как о "частных"."</td>
</tr></table>
</div>
</div>
<div class="sect2">
<h3 id="_выбор_агрегата">Выбор агрегата</h3>
<div class="paragraph"><p>Какой агрегат мы должны использовать для нашей системы? Выбор несколько произвольный, но он важен. Агрегат будет границей, где мы будем следить за тем, чтобы каждая операция заканчивалась в последовательном состоянии. Это помогает нам рассуждать о нашем программном обеспечении и предотвращать тайные расовые проблемы. Мы хотим нарисовать границу вокруг небольшого количества объектов - чем меньше, тем лучше, для производительности - которые должны быть совместимы друг с другом, и мы должны дать этой границе хорошее имя.</p></div>
<div class="paragraph"><p>Объект, которым мы манипулируем под капотом, - это <code>Batch</code>.. Что мы называем коллекцией партий? Как нам разделить все партии в системе на дискретные острова консистентности?</p></div>
<div class="paragraph"><p>Мы <em>можем</em> использовать <code>Shipment</code> отгрузку в качестве границы. Каждая отгрузка содержит несколько партий, и все они отправляются на наш склад одновременно. Или, возможно, мы могли бы использовать <code>Warehouse</code> "Склад" в качестве нашей границы: каждый склад содержит много партий, и подсчет всех запасов одновременно может иметь смысл.</p></div>
<div class="paragraph"><p>Но ни одна из этих концепций нас не удовлетворяет. Мы должны быть в состоянии выделить <code>DEADLLY-SPOONs</code> и <code>FLIMSY-DESK</code> одновременно, даже если они находятся на одном и том же складе или в одной и той же отгрузке. Эти понятия имеют неправильную гранулярность.</p></div>
<div class="paragraph"><p>Когда мы выделяем линию заказа, нас интересуют только те партии, которые имеют тот же SKU, что и линия заказа. Может сработать какая-нибудь концепция вроде <code>GlobalSkuStock</code>: сбор всех партий для данного SKU.</p></div>
<div class="paragraph"><p>Однако, это громоздкое имя, поэтому после некоторого пролива велосипедов через <code>SkuStock</code>, <code>Stock</code>, <code>ProductStock</code> и так далее, мы решили просто назвать его <code>Product</code>&#8201;&#8212;&#8201;в конце концов, это была первая концепция, с которой мы столкнулись при изучении языка домена еще в <a href="#chapter_01_domain_model">[chapter_01_domain_model]</a>.</p></div>
<div class="paragraph"><p>Итак, план таков: когда мы хотим выделить строку заказа вместо <a href="#before_aggregates_diagram">[before_aggregates_diagram]</a>, где мы ищем все объекты <code>Batch</code> в мире и передаем их службе домена <code>allocate()</code>.. .</p></div>
<div class="imageblock width-60" id="before_aggregates_diagram">
<div class="content">
<img src="images/apwp_0702.png" alt="images/apwp_0702.png" />
</div>
<div class="title">Figure 25. Раньше: распределение по всем пакетам, использующим доменную службу</div>
</div>
<div class="listingblock image-source">
<div class="content">
<pre><code>[plantuml, apwp_0702, config=plantuml.cfg]
@startuml
scale 4

hide empty members

package "Service Layer" as services {
    class "allocate()" as allocate {
    }
    hide allocate circle
    hide allocate members
}



package "Domain Model" as domain_model {

  class Batch {
  }

  class "allocate()" as allocate_domain_service {
  }
    hide allocate_domain_service circle
    hide allocate_domain_service members
}


package Repositories {

  class BatchRepository {
    list()
  }

}

allocate -&gt; BatchRepository: list all batches
allocate --&gt; allocate_domain_service: allocate(orderline, batches)

@enduml</code></pre>
</div></div>
<div class="paragraph"><p>&#8230; мы переместимся в мир <a href="#after_aggregates_diagram">[after_aggregates_diagram]</a>, в котором есть новый объект <code>Product</code> для конкретного SKU нашей строки заказа который теперь будет отвечать за все партии <em>для этого SKU</em>, и вместо этого мы можем вызвать метод <code>.allocate()</code>.</p></div>
<div class="imageblock width-75" id="after_aggregates_diagram">
<div class="content">
<img src="images/apwp_0703.png" alt="images/apwp_0703.png" />
</div>
<div class="title">Figure 26. После: просим  Product распределить продукт по его партиям</div>
</div>
<div class="listingblock image-source">
<div class="content">
<pre><code>[plantuml, apwp_0703, config=plantuml.cfg]
@startuml
scale 4

hide empty members

package "Service Layer" as services {
    class "allocate()" as allocate {
    }
}

hide allocate circle
hide allocate members


package "Domain Model" as domain_model {

  class Product {
    allocate()
  }

  class Batch {
  }
}


package Repositories {

  class ProductRepository {
    get()
  }

}

allocate -&gt; ProductRepository: get me the product for this SKU
allocate --&gt; Product: product.allocate(orderline)
Product o- Batch: has

@enduml</code></pre>
</div></div>
<div class="paragraph"><p>Посмотрим, как это выглядит в виде кода:</p></div>
<div class="exampleblock pagebreak-before" id="product_aggregate">
<div class="title">Example 84. Наш выбранный агрегат, Продукт (src/allocation/domain/model.py)</div>
<div class="content">
<div class="listingblock non-head">
<div class="content"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Product</span><span class="p">:</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sku</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">batches</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Batch</span><span class="p">]):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sku</span> <span class="o">=</span> <span class="n">sku</span>  <span class="c1">#<img src="./images/icons/callouts/1.png" alt="1" /></span>
        <span class="bp">self</span><span class="o">.</span><span class="n">batches</span> <span class="o">=</span> <span class="n">batches</span>  <span class="c1">#<img src="./images/icons/callouts/2.png" alt="2" /></span>

    <span class="k">def</span> <span class="nf">allocate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="p">:</span> <span class="n">OrderLine</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>  <span class="c1">#<img src="./images/icons/callouts/3.png" alt="3" /></span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">batch</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span>
                <span class="n">b</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">batches</span><span class="p">)</span> <span class="k">if</span> <span class="n">b</span><span class="o">.</span><span class="n">can_allocate</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">batch</span><span class="o">.</span><span class="n">allocate</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">batch</span><span class="o">.</span><span class="n">reference</span>
        <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">OutOfStock</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Out of stock for sku </span><span class="si">{</span><span class="n">line</span><span class="o">.</span><span class="n">sku</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div></div></div>
</div></div>
<div class="colist arabic"><table>
<tr><td><img src="./images/icons/callouts/1.png" alt="1" /></td><td>
Основной идентификатор <code>Product</code> - это <code>sku</code>.
</td></tr>
<tr><td><img src="./images/icons/callouts/2.png" alt="2" /></td><td>
Наш класс <code>Product</code> содержит ссылку на коллекцию <code>batches</code> для этого SKU.
    
</td></tr>
<tr><td><img src="./images/icons/callouts/3.png" alt="3" /></td><td>
Наконец, мы можем переместить доменную службу <code>allocate()</code> в метод агрегата <span class=".keep-together">'Product`</span>.
</td></tr>
</table></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note" />
</td>
<td class="content">Этот <code>Product</code> может выглядеть не так, как вы ожидаете от модели <code>Product</code>. Ни цены, ни описания, ни габаритов. Нашу службу размещения не волнует ни одна из этих вещей. В этом сила ограниченных контекстов; концепция продукта в одном приложении может сильно отличаться от другого. См. Дополнительную информацию на следующей боковой панели.
    </td>
</tr></table>
</div>
<div class="sidebarblock nobreakinside less_space" id="bounded_contexts_sidebar">
<div class="content">
<div class="title">Агрегаты, Ограниченные контексты и микросервисы</div>
<div class="paragraph"><p>Одним из наиболее важных вкладов Эванса и сообщества DDD является концепция
<a href="https://martinfowler.com/bliki/BoundedContext.html"><em>ограниченные контексты</em></a>.</p></div>
<div class="paragraph"><p>По сути, это была реакция на попытки объединить весь бизнес в единую модель. Слово "клиент" означает разные вещи для людей в сфере продаж, обслуживания клиентов, логистики, поддержки и так далее. Атрибуты, необходимые в одном контексте, не имеют значения в другом; более пагубно то, что понятия с одним и тем же именем могут иметь совершенно разные значения в разных контекстах. Вместо того чтобы пытаться построить единую модель (или класс, или базу данных), чтобы охватить все варианты использования, лучше иметь несколько моделей, рисовать границы вокруг каждого контекста и явно обрабатывать перевод между различными контекстами.</p></div>
<div class="paragraph"><p>Эта концепция очень хорошо переносится в мир микросервисов, где каждая микросервисная служба свободна иметь свою собственную концепцию "клиента" и свои собственные правила перевода этого понятия в другие микросервисы, с которыми она интегрируется.</p></div>
<div class="paragraph"><p>В нашем примере сервис распределения имеет <code>Product(sku, batches)</code>, в то время как электронная коммерция будет иметь <code>Product(sku, description, price, image_url,dimensions, etc...)</code>. Как правило, ваши доменные модели должны включать только те данные, которые необходимы для выполнения вычислений.</p></div>
<div class="paragraph"><p>Независимо от того, имеете ли вы архитектуру микроуслуг или нет, ключевым моментом при выборе ваших агрегатов также является выбор ограниченного контекста, в котором они будут работать. Ограничив контекст, вы можете держать ваше количество агрегатов низким, а их размер управляемым.</p></div>
<div class="paragraph"><p>Еще раз, мы вынуждены сказать, что мы не можем уделить этому вопросу должное внимание здесь, и мы можем только посоветовать вам прочитать об этом в другом месте. Ссылка Фаулера в начале этой боковой панели является хорошей отправной точкой, и в любой (или даже в любой другой) книге DDD будет глава или больше об ограниченных контекстах.</p></div>
</div></div>
</div>
<div class="sect2">
<h3 id="_один_агрегат_один_репозиторий">Один Агрегат = Один Репозиторий</h3>
<div class="paragraph"><p>Как только вы определяете определенные сущности как агрегаты, мы должны применить правило, что они являются единственными сущностями, которые являются общедоступными для внешнего мира.  Другими словами, единственными репозиториями, которые нам разрешены, должны быть репозитории, возвращающие агрегаты.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note" />
</td>
<td class="content">The rule that repositories should only return aggregates is the main place
    where we enforce the convention that aggregates are the only way into our
    domain model.  Be wary of breaking it!</td>
</tr></table>
</div>
<div class="paragraph"><p>In our case, we&#8217;ll switch from <code>BatchRepository</code> to <code>ProductRepository</code>:</p></div>
<div class="exampleblock" id="new_uow_and_repository">
<div class="title">Example 85. Our new UoW and repository (unit_of_work.py and repository.py)</div>
<div class="content">
<div class="listingblock skip">
<div class="content"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">AbstractUnitOfWork</span><span class="p">(</span><span class="n">abc</span><span class="o">.</span><span class="n">ABC</span><span class="p">):</span>
    <span class="n">products</span><span class="p">:</span> <span class="n">repository</span><span class="o">.</span><span class="n">AbstractProductRepository</span>

<span class="o">...</span>

<span class="k">class</span> <span class="nc">AbstractProductRepository</span><span class="p">(</span><span class="n">abc</span><span class="o">.</span><span class="n">ABC</span><span class="p">):</span>

    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">product</span><span class="p">):</span>
        <span class="o">...</span>

    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sku</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">model</span><span class="o">.</span><span class="n">Product</span><span class="p">:</span>
        <span class="o">...</span>
</pre></div></div></div>
</div></div>
<div class="paragraph"><p>The ORM layer will need some tweaks so that the right batches automatically get
loaded and associated with <code>Product</code> objects. The nice thing is, the Repository
pattern means we don&#8217;t have to worry about that yet. We can just use
our <code>FakeRepository</code> and then feed through the new model into our service
layer to see how it looks with <code>Product</code> as its main entrypoint:</p></div>
<div class="exampleblock" id="service_layer_uses_products">
<div class="title">Example 86. Service layer (src/allocation/service_layer/services.py)</div>
<div class="content">
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">add_batch</span><span class="p">(</span>
        <span class="n">ref</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">sku</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">qty</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">eta</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">date</span><span class="p">],</span>
        <span class="n">uow</span><span class="p">:</span> <span class="n">unit_of_work</span><span class="o">.</span><span class="n">AbstractUnitOfWork</span>
<span class="p">):</span>
    <span class="k">with</span> <span class="n">uow</span><span class="p">:</span>
        <span class="n">product</span> <span class="o">=</span> <span class="n">uow</span><span class="o">.</span><span class="n">products</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">sku</span><span class="o">=</span><span class="n">sku</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">product</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">product</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">Product</span><span class="p">(</span><span class="n">sku</span><span class="p">,</span> <span class="n">batches</span><span class="o">=</span><span class="p">[])</span>
            <span class="n">uow</span><span class="o">.</span><span class="n">products</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">product</span><span class="p">)</span>
        <span class="n">product</span><span class="o">.</span><span class="n">batches</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">Batch</span><span class="p">(</span><span class="n">ref</span><span class="p">,</span> <span class="n">sku</span><span class="p">,</span> <span class="n">qty</span><span class="p">,</span> <span class="n">eta</span><span class="p">))</span>
        <span class="n">uow</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">allocate</span><span class="p">(</span>
        <span class="n">orderid</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">sku</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">qty</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">uow</span><span class="p">:</span> <span class="n">unit_of_work</span><span class="o">.</span><span class="n">AbstractUnitOfWork</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">line</span> <span class="o">=</span> <span class="n">OrderLine</span><span class="p">(</span><span class="n">orderid</span><span class="p">,</span> <span class="n">sku</span><span class="p">,</span> <span class="n">qty</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">uow</span><span class="p">:</span>
        <span class="n">product</span> <span class="o">=</span> <span class="n">uow</span><span class="o">.</span><span class="n">products</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">sku</span><span class="o">=</span><span class="n">line</span><span class="o">.</span><span class="n">sku</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">product</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">InvalidSku</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Invalid sku </span><span class="si">{</span><span class="n">line</span><span class="o">.</span><span class="n">sku</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">batchref</span> <span class="o">=</span> <span class="n">product</span><span class="o">.</span><span class="n">allocate</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="n">uow</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">batchref</span>
</pre></div></div></div>
</div></div>
</div>
<div class="sect2">
<h3 id="_what_about_performance">What About Performance?</h3>
<div class="paragraph"><p>We&#8217;ve mentioned a few times that we&#8217;re modeling with aggregates because we want
to have high-performance software, but here we are loading <em>all</em> the batches when
we only need one. You might expect that to be inefficient, but there are a few
reasons why we&#8217;re comfortable here.</p></div>
<div class="paragraph"><p>First, we&#8217;re purposefully modeling our data so that we can make a single
query to the database to read, and a single update to persist our changes. This
tends to perform much better than systems that issue lots of ad hoc queries. In
systems that don&#8217;t model this way, we often find that transactions slowly
get longer and more complex as the software evolves.</p></div>
<div class="paragraph"><p>Second, our data structures are minimal and comprise a few strings and
integers per row. We can easily load tens or even hundreds of batches in a few
milliseconds.</p></div>
<div class="paragraph"><p>Third, we expect to have only 20 or so batches of each product at a time.
Once a batch is used up, we can discount it from our calculations. This means
that the amount of data we&#8217;re fetching shouldn&#8217;t get out of control over time.</p></div>
<div class="paragraph"><p>If we <em>did</em> expect to have thousands of active batches for a product, we&#8217;d have
a couple of options. For one, we could use lazy-loading for the batches in a
product. From the perspective of our code, nothing would change, but in the
background, SQLAlchemy would page through data for us. This would lead to more
requests, each fetching a smaller number of rows. Because we need to find only a
single batch with enough capacity for our order, this might work pretty well.</p></div>
<div class="sidebarblock nobreakinside less_space">
<div class="content">
<div class="title">Exercise for the Reader</div>
<div class="paragraph"><p>You&#8217;ve just seen the main top layers of the code, so this shouldn&#8217;t be too hard,
but we&#8217;d like you to implement the <code>Product</code> aggregate starting from <code>Batch</code>,
just as we did.</p></div>
<div class="paragraph"><p>Of course, you could cheat and copy/paste from the previous listings, but even
if you do that, you&#8217;ll still have to solve a few challenges on your own,
like adding the model to the ORM and making sure all the moving parts can
talk to each other, which we hope will be instructive.</p></div>
<div class="paragraph"><p>You&#8217;ll find the code <a href="https://github.com/cosmicpython/code/tree/chapter_07_aggregate_exercise">on GitHub</a>.
We&#8217;ve put in a "cheating" implementation in the delegates to the existing
<code>allocate()</code> function, so you should be able to evolve that toward the real
thing.</p></div>
<div class="paragraph"><p>We&#8217;ve marked a couple of tests with <code>@pytest.skip()</code>. After you&#8217;ve read the
rest of this chapter, come back to these tests to have a go at implementing
version numbers. Bonus points if you can get SQLAlchemy to do them for you by
magic!</p></div>
</div></div>
<div class="paragraph"><p>If all else failed, we&#8217;d just look for a different aggregate. Maybe we could
split up batches by region or by warehouse. Maybe we could redesign our data
access strategy around the shipment concept. The Aggregate pattern is designed
to help manage some technical constraints around consistency and performance.
There isn&#8217;t <em>one</em> correct aggregate, and we should feel comfortable changing our
minds if we find our boundaries are causing performance woes.</p></div>
</div>
<div class="sect2">
<h3 id="_optimistic_concurrency_with_version_numbers">Optimistic Concurrency with Version Numbers</h3>
<div class="paragraph"><p>We have our new aggregate, so we&#8217;ve solved the conceptual problem of choosing
an object to be in charge of consistency boundaries.  Let&#8217;s now spend a little
time talking about how to enforce data integrity at the database level.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note" />
</td>
<td class="content">This section has a lot of implementation details; for example, some of it
    is Postgres-specific. But more generally, we&#8217;re showing one way of managing
    concurrency issues, but it is just one approach. Real requirements in this
    area vary a lot from project to project. You shouldn&#8217;t expect to be able to
    copy and paste code from here into production.
    </td>
</tr></table>
</div>
<div class="paragraph"><p>We don&#8217;t want to hold a lock over the entire <code>batches</code> table, but how will we
implement holding a lock over just the rows for a particular SKU?</p></div>
<div class="paragraph"><p>One answer is to have a single attribute on the <code>Product</code> model that acts as a marker for
the whole state change being complete and to use it as the single resource
that concurrent workers can fight over. If two transactions read the
state of the world for <code>batches</code> at the same time, and both want to update
the <code>allocations</code> tables, we force both to also try to update the
<code>version_number</code> in the <code>products</code> table, in such a way that only one of them
can win and the world stays consistent.</p></div>
<div class="paragraph"><p><a href="#version_numbers_sequence_diagram">[version_numbers_sequence_diagram]</a> illustrates two concurrent
transactions doing their read operations at the same time, so they see
a <code>Product</code> with, for example, <code>version=3</code>.  They both call <code>Product.allocate()</code>
in order to modify a state. But we set up our database integrity
rules such that only one of them is allowed to <code>commit</code> the new <code>Product</code>
with <code>version=4</code>, and the other update is rejected.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/tip.png" alt="Tip" />
</td>
<td class="content">Version numbers are just one way to implement optimistic locking. You
    could achieve the same thing by setting the Postgres transaction isolation
    level to <code>SERIALIZABLE</code>, but that often comes at a severe performance cost.
    Version numbers also make implicit concepts explicit.
    </td>
</tr></table>
</div>
<div class="imageblock" id="version_numbers_sequence_diagram">
<div class="content">
<img src="images/apwp_0704.png" alt="images/apwp_0704.png" />
</div>
<div class="title">Figure 27. Sequence diagram: two transactions attempting a concurrent update on <span class=".keep-together"><code>Product</code></span></div>
</div>
<div class="listingblock image-source">
<div class="content">
<pre><code>[plantuml, apwp_0704, config=plantuml.cfg]
@startuml
scale 4

entity Model
collections Transaction1
collections Transaction2
database Database


Transaction1 -&gt; Database: get product
Database -&gt; Transaction1: Product(version=3)
Transaction2 -&gt; Database: get product
Database -&gt; Transaction2: Product(version=3)
Transaction1 -&gt; Model: Product.allocate()
Model -&gt; Transaction1: Product(version=4)
Transaction2 -&gt; Model: Product.allocate()
Model -&gt; Transaction2: Product(version=4)
Transaction1 -&gt; Database: commit Product(version=4)
Database -[#green]&gt; Transaction1: OK
Transaction2 -&gt; Database: commit Product(version=4)
Database -[#red]&gt;x Transaction2: Error! version is already 4

@enduml</code></pre>
</div></div>
<div class="sidebarblock nobreakinside less_space">
<div class="content">
<div class="title">Optimistic Concurrency Control and Retries</div>
<div class="paragraph"><p>What we&#8217;ve implemented here is called <em>optimistic</em> concurrency control because
our default assumption is that everything will be fine when two users want to
make changes to the database. We think it&#8217;s unlikely that they will conflict
with each other, so we let them go ahead and just make sure we have a way to
notice if there is a <span class=".keep-together">problem</span>.</p></div>
<div class="paragraph"><p><em>Pessimistic</em> concurrency control works under the assumption that two users
are going to cause conflicts, and we want to prevent conflicts in all cases, so
we lock everything just to be safe. In our example, that would mean locking
the whole <code>batches</code> table, or using <code>SELECT FOR UPDATE</code>—we&#8217;re pretending
that we&#8217;ve ruled those out for performance reasons, but in real life you&#8217;d
want to do some evaluations and measurements of your own.</p></div>
<div class="paragraph"><p>With pessimistic locking, you don&#8217;t need to think about handling failures
because the database will prevent them for you (although you do need to think
about deadlocks). With optimistic locking, you need to explicitly handle
the possibility of failures in the (hopefully unlikely) case of a clash.</p></div>
<div class="paragraph"><p>The usual way to handle a failure is to retry the failed operation from the
beginning. Imagine we have two customers, Harry and Bob, and each submits an order
for <code>SHINY-TABLE</code>. Both threads load the product at version 1 and allocate
stock. The database prevents the concurrent update, and Bob&#8217;s order fails with
an error. When we <em>retry</em> the operation, Bob&#8217;s order loads the product at
version 2 and tries to allocate again. If there is enough stock left, all is
well; otherwise, he&#8217;ll receive <code>OutOfStock</code>. Most operations can be retried this
way in the case of a concurrency problem.</p></div>
<div class="paragraph"><p>Read more on retries in <a href="#recovering_from_errors">[recovering_from_errors]</a> and <a href="#footguns">[footguns]</a>.</p></div>
</div></div>
<div class="sect3">
<h4 id="_implementation_options_for_version_numbers">Implementation Options for Version Numbers</h4>
<div class="paragraph"><p>There are essentially three options for implementing version numbers:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
<code>version_number</code> lives in the domain; we add it to the <code>Product</code> constructor,
   and <code>Product.allocate()</code> is responsible for incrementing it.
</p>
</li>
<li>
<p>
The service layer could do it!  The version number isn&#8217;t <em>strictly</em> a domain
   concern, so instead our service layer could assume that the current version number
   is attached to <code>Product</code> by the repository, and the service layer will increment it
   before it does the <code>commit()</code>.
</p>
</li>
<li>
<p>
Since it&#8217;s arguably an infrastructure concern, the UoW and repository
   could do it by magic.  The repository has access to version numbers for any
   products it retrieves, and when the UoW does a commit, it can increment the
   version number for any products it knows about, assuming them to have changed.
</p>
</li>
</ol></div>
<div class="paragraph"><p>Option 3 isn&#8217;t ideal, because there&#8217;s no real way of doing it without having to
assume that <em>all</em> products have changed, so we&#8217;ll be incrementing version numbers
when we don&#8217;t have to.<span class="footnote"><br />[Perhaps we could get some ORM/SQLAlchemy magic to tell
us when an object is dirty, but how would that work in the generic case—for example, for a
<code>CsvRepository</code>?]<br /></span></p></div>
<div class="paragraph"><p>Option 2 involves mixing the responsibility for mutating state between the service
layer and the domain layer, so it&#8217;s a little messy as well.</p></div>
<div class="paragraph"><p>So in the end, even though version numbers don&#8217;t <em>have</em> to be a domain concern,
you might decide the cleanest trade-off is to put them in the domain:</p></div>
<div class="exampleblock" id="product_aggregate_with_version_number">
<div class="title">Example 87. Our chosen aggregate, Product (src/allocation/domain/model.py)</div>
<div class="content">
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Product</span><span class="p">:</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sku</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">batches</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Batch</span><span class="p">],</span> <span class="n">version_number</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">):</span>  <span class="c1">#<img src="./images/icons/callouts/1.png" alt="1" /></span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sku</span> <span class="o">=</span> <span class="n">sku</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">batches</span> <span class="o">=</span> <span class="n">batches</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">version_number</span> <span class="o">=</span> <span class="n">version_number</span>  <span class="c1">#<img src="./images/icons/callouts/1.png" alt="1" /></span>

    <span class="k">def</span> <span class="nf">allocate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="p">:</span> <span class="n">OrderLine</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">batch</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span>
                <span class="n">b</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">batches</span><span class="p">)</span> <span class="k">if</span> <span class="n">b</span><span class="o">.</span><span class="n">can_allocate</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">batch</span><span class="o">.</span><span class="n">allocate</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">version_number</span> <span class="o">+=</span> <span class="mi">1</span>  <span class="c1">#<img src="./images/icons/callouts/1.png" alt="1" /></span>
            <span class="k">return</span> <span class="n">batch</span><span class="o">.</span><span class="n">reference</span>
        <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">OutOfStock</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Out of stock for sku </span><span class="si">{</span><span class="n">line</span><span class="o">.</span><span class="n">sku</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div></div></div>
</div></div>
<div class="colist arabic"><table>
<tr><td><img src="./images/icons/callouts/1.png" alt="1" /></td><td>
There it is!
</td></tr>
</table></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/tip.png" alt="Tip" />
</td>
<td class="content">If you&#8217;re scratching your head at this version number business, it might
    help to remember that the <em>number</em> isn&#8217;t important. What&#8217;s important is
    that the <code>Product</code> database row is modified whenever we make a change to the
    <code>Product</code> aggregate. The version number is a simple, human-comprehensible way
    to model a thing that changes on every write, but it could equally be a
    random UUID every time.
    
    
    </td>
</tr></table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_testing_for_our_data_integrity_rules">Testing for Our Data Integrity Rules</h3>
<div class="paragraph"><p>Now to make sure we can get the behavior we want: if we have two
concurrent attempts to do allocation against the same <code>Product</code>, one of them
should fail, because they can&#8217;t both update the version number.</p></div>
<div class="paragraph"><p>First, let&#8217;s simulate a "slow" transaction using a function that does
allocation and then does an explicit sleep:<span class="footnote"><br />[<code>time.sleep()</code> works well
in our use case, but it&#8217;s not the most reliable or efficient way to reproduce
concurrency bugs.  Consider using semaphores or similar synchronization primitives
shared between your threads to get better guarantees of behavior.]<br /></span></p></div>
<div class="exampleblock" id="time_sleep_thread">
<div class="title">Example 88. time.sleep can reproduce concurrency behavior (tests/integration/test_uow.py)</div>
<div class="content">
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">try_to_allocate</span><span class="p">(</span><span class="n">orderid</span><span class="p">,</span> <span class="n">sku</span><span class="p">,</span> <span class="n">exceptions</span><span class="p">):</span>
    <span class="n">line</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">OrderLine</span><span class="p">(</span><span class="n">orderid</span><span class="p">,</span> <span class="n">sku</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">unit_of_work</span><span class="o">.</span><span class="n">SqlAlchemyUnitOfWork</span><span class="p">()</span> <span class="k">as</span> <span class="n">uow</span><span class="p">:</span>
            <span class="n">product</span> <span class="o">=</span> <span class="n">uow</span><span class="o">.</span><span class="n">products</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">sku</span><span class="o">=</span><span class="n">sku</span><span class="p">)</span>
            <span class="n">product</span><span class="o">.</span><span class="n">allocate</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.2</span><span class="p">)</span>
            <span class="n">uow</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
        <span class="n">exceptions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</pre></div></div></div>
</div></div>
<div class="paragraph"><p>Then we have our test invoke this slow allocation twice, concurrently, using
threads:</p></div>
<div class="exampleblock" id="data_integrity_test">
<div class="title">Example 89. An integration test for concurrency behavior (tests/integration/test_uow.py)</div>
<div class="content">
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">test_concurrent_updates_to_version_are_not_allowed</span><span class="p">(</span><span class="n">postgres_session_factory</span><span class="p">):</span>
    <span class="n">sku</span><span class="p">,</span> <span class="n">batch</span> <span class="o">=</span> <span class="n">random_sku</span><span class="p">(),</span> <span class="n">random_batchref</span><span class="p">()</span>
    <span class="n">session</span> <span class="o">=</span> <span class="n">postgres_session_factory</span><span class="p">()</span>
    <span class="n">insert_batch</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">batch</span><span class="p">,</span> <span class="n">sku</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="n">eta</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">product_version</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

    <span class="n">order1</span><span class="p">,</span> <span class="n">order2</span> <span class="o">=</span> <span class="n">random_orderid</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">random_orderid</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">exceptions</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># type: List[Exception]</span>
    <span class="n">try_to_allocate_order1</span> <span class="o">=</span> <span class="k">lambda</span><span class="p">:</span> <span class="n">try_to_allocate</span><span class="p">(</span><span class="n">order1</span><span class="p">,</span> <span class="n">sku</span><span class="p">,</span> <span class="n">exceptions</span><span class="p">)</span>
    <span class="n">try_to_allocate_order2</span> <span class="o">=</span> <span class="k">lambda</span><span class="p">:</span> <span class="n">try_to_allocate</span><span class="p">(</span><span class="n">order2</span><span class="p">,</span> <span class="n">sku</span><span class="p">,</span> <span class="n">exceptions</span><span class="p">)</span>
    <span class="n">thread1</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">try_to_allocate_order1</span><span class="p">)</span>  <span class="c1">#<img src="./images/icons/callouts/1.png" alt="1" /></span>
    <span class="n">thread2</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">try_to_allocate_order2</span><span class="p">)</span>  <span class="c1">#<img src="./images/icons/callouts/1.png" alt="1" /></span>
    <span class="n">thread1</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="n">thread2</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="n">thread1</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
    <span class="n">thread2</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>

    <span class="p">[[</span><span class="n">version</span><span class="p">]]</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="s2">&quot;SELECT version_number FROM products WHERE sku=:sku&quot;</span><span class="p">,</span>
        <span class="nb">dict</span><span class="p">(</span><span class="n">sku</span><span class="o">=</span><span class="n">sku</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="k">assert</span> <span class="n">version</span> <span class="o">==</span> <span class="mi">2</span>  <span class="c1">#<img src="./images/icons/callouts/2.png" alt="2" /></span>
    <span class="p">[</span><span class="n">exception</span><span class="p">]</span> <span class="o">=</span> <span class="n">exceptions</span>
    <span class="k">assert</span> <span class="s1">&#39;could not serialize access due to concurrent update&#39;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">exception</span><span class="p">)</span>  <span class="c1">#<img src="./images/icons/callouts/3.png" alt="3" /></span>

    <span class="n">orders</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="s2">&quot;SELECT orderid FROM allocations&quot;</span>
        <span class="s2">&quot; JOIN batches ON allocations.batch_id = batches.id&quot;</span>
        <span class="s2">&quot; JOIN order_lines ON allocations.orderline_id = order_lines.id&quot;</span>
        <span class="s2">&quot; WHERE order_lines.sku=:sku&quot;</span><span class="p">,</span>
        <span class="nb">dict</span><span class="p">(</span><span class="n">sku</span><span class="o">=</span><span class="n">sku</span><span class="p">),</span>
    <span class="p">))</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">orders</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>  <span class="c1">#<img src="./images/icons/callouts/4.png" alt="4" /></span>
    <span class="k">with</span> <span class="n">unit_of_work</span><span class="o">.</span><span class="n">SqlAlchemyUnitOfWork</span><span class="p">()</span> <span class="k">as</span> <span class="n">uow</span><span class="p">:</span>
        <span class="n">uow</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;select 1&#39;</span><span class="p">)</span>
</pre></div></div></div>
</div></div>
<div class="colist arabic"><table>
<tr><td><img src="./images/icons/callouts/1.png" alt="1" /></td><td>
We start two threads that will reliably produce the concurrency behavior we
    want: <code>read1, read2, write1, write2</code>.
</td></tr>
<tr><td><img src="./images/icons/callouts/2.png" alt="2" /></td><td>
We assert that the version number has been incremented only once.
</td></tr>
<tr><td><img src="./images/icons/callouts/3.png" alt="3" /></td><td>
We can also check on the specific exception if we like.
</td></tr>
<tr><td><img src="./images/icons/callouts/4.png" alt="4" /></td><td>
And we double-check that only one allocation has gotten through.
</td></tr>
</table></div>
<div class="sect3">
<h4 id="_enforcing_concurrency_rules_by_using_database_transaction_span_class_keep_together_isolation_levels_span">Enforcing Concurrency Rules by Using Database Transaction <span class=".keep-together">Isolation Levels</span></h4>
<div class="paragraph"><p>To get the test to pass as it is, we can set the transaction isolation level
on our session:</p></div>
<div class="exampleblock" id="isolation_repeatable_read">
<div class="title">Example 90. Set isolation level for session (src/allocation/service_layer/unit_of_work.py)</div>
<div class="content">
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span><span class="n">DEFAULT_SESSION_FACTORY</span> <span class="o">=</span> <span class="n">sessionmaker</span><span class="p">(</span><span class="n">bind</span><span class="o">=</span><span class="n">create_engine</span><span class="p">(</span>
    <span class="n">config</span><span class="o">.</span><span class="n">get_postgres_uri</span><span class="p">(),</span>
    <span class="n">isolation_level</span><span class="o">=</span><span class="s2">&quot;REPEATABLE READ&quot;</span><span class="p">,</span>
<span class="p">))</span>
</pre></div></div></div>
</div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/tip.png" alt="Tip" />
</td>
<td class="content">Transaction isolation levels are tricky stuff, so it&#8217;s worth spending time
    understanding <a href="https://oreil.ly/5vxJA">the Postgres documentation</a>.<span class="footnote"><br />[If
    you&#8217;re not using Postgres, you&#8217;ll need to read different documentation.
    Annoyingly, different databases all have quite different definitions.
    Oracle&#8217;s <code>SERIALIZABLE</code> is equivalent to Postgres&#8217;s <code>REPEATABLE READ</code>, for
    <span class=".keep-together">example</span>.]<br /></span>
    
    </td>
</tr></table>
</div>
</div>
<div class="sect3">
<h4 id="_pessimistic_concurrency_control_example_select_for_update">Pessimistic Concurrency Control Example: SELECT FOR UPDATE</h4>
<div class="paragraph"><p>There are multiple ways to approach this, but we&#8217;ll show one. <a href="https://oreil.ly/i8wKL"><code>SELECT FOR UPDATE</code></a>
produces different behavior; two concurrent transactions will not be allowed to
do a read on the same rows at the same time:</p></div>
<div class="paragraph"><p><code>SELECT FOR UPDATE</code> is a way of picking a row or rows to use as a lock
(although those rows don&#8217;t have to be the ones you update).  If two
transactions both try to <code>SELECT FOR UPDATE</code> a row at the same time, one will
win, and the other will wait until the lock is released. So this is an example
of pessimistic concurrency control.</p></div>
<div class="paragraph"><p>Here&#8217;s how you can use the SQLAlchemy DSL to specify <code>FOR UPDATE</code> at
query time:</p></div>
<div class="exampleblock" id="with_for_update">
<div class="title">Example 91. SQLAlchemy with_for_update (src/allocation/adapters/repository.py)</div>
<div class="content">
<div class="listingblock non-head">
<div class="content"><div class="highlight"><pre><span></span>    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sku</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">Product</span><span class="p">)</span> \
                           <span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">sku</span><span class="o">=</span><span class="n">sku</span><span class="p">)</span> \
                           <span class="o">.</span><span class="n">with_for_update</span><span class="p">()</span> \
                           <span class="o">.</span><span class="n">first</span><span class="p">()</span>
</pre></div></div></div>
</div></div>
<div class="paragraph"><p>This will have the effect of changing the concurrency pattern from</p></div>
<div class="listingblock skip">
<div class="content">
<pre><code>read1, read2, write1, write2(fail)</code></pre>
</div></div>
<div class="paragraph"><p>to</p></div>
<div class="listingblock skip">
<div class="content">
<pre><code>read1, write1, read2, write2(succeed)</code></pre>
</div></div>
<div class="paragraph"><p>Some people refer to this as the "read-modify-write" failure mode.
Read <a href="https://oreil.ly/uXeZI">"PostgreSQL Anti-Patterns: Read-Modify-Write Cycles"</a> for a good <span class=".keep-together">overview</span>.</p></div>
<div class="paragraph"><p>We don&#8217;t really have time to discuss all the trade-offs between <code>REPEATABLE READ</code>
and <code>SELECT FOR UPDATE</code>, or optimistic versus pessimistic locking in general.
But if you have a test like the one we&#8217;ve shown, you can specify the behavior
you want and see how it changes. You can also use the test as a basis for
performing some performance experiments.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_wrap_up">Wrap-Up</h3>
<div class="paragraph"><p>Specific choices around concurrency control vary a lot based on business
circumstances and storage technology choices, but we&#8217;d like to bring this
chapter back to the conceptual idea of an aggregate: we explicitly model an
object as being the main entrypoint to some subset of our model, and as being in
charge of enforcing the invariants and business rules that apply across all of
those objects.</p></div>
<div class="paragraph"><p>Choosing the right aggregate is key, and it&#8217;s a decision you may revisit
over time. You can read more about it in multiple DDD books.
We also recommend these three online papers on
<a href="https://dddcommunity.org/library/vernon_2011">effective aggregate design</a>
by Vaughn Vernon (the "red book" author).</p></div>
<div class="paragraph"><p><a href="#chapter_07_aggregate_tradoffs">[chapter_07_aggregate_tradoffs]</a> has some thoughts on the trade-offs of implementing the Aggregate pattern.</p></div>
<div class="tableblock" id="chapter_07_aggregate_tradoffs">
<table rules="all"
width="100%"
frame="border"
cellspacing="0" cellpadding="4">
<caption class="title">Table 4. Aggregates: the trade-offs</caption>
<col width="50%" />
<col width="50%" />
<thead>
<tr>
<th align="left" valign="top">Pros</th>
<th align="left" valign="top">Cons</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left" valign="top"><div><div class="ulist"><ul>
<li>
<p>
Python might not have "official" public and private methods, but we do have
  the underscores convention, because it&#8217;s often useful to try to indicate what&#8217;s for
  "internal" use and what&#8217;s for "outside code" to use. Choosing aggregates is
  just the next level up: it lets you decide which of your domain model classes
  are the public ones, and which aren&#8217;t.
</p>
</li>
<li>
<p>
Modeling our operations around explicit consistency boundaries helps us avoid
  performance problems with our ORM.

</p>
</li>
<li>
<p>
Putting the aggregate in sole charge of state changes to its subsidiary models
  makes the system easier to reason about, and makes it easier to control invariants.
</p>
</li>
</ul></div></div></td>
<td align="left" valign="top"><div><div class="ulist"><ul>
<li>
<p>
Yet another new concept for new developers to take on. Explaining entities versus
  value objects was already a mental load; now there&#8217;s a third type of domain
  model object?
</p>
</li>
<li>
<p>
Sticking rigidly to the rule that we modify only one aggregate at a time is a
  big mental shift.
</p>
</li>
<li>
<p>
Dealing with eventual consistency between aggregates can be complex.
</p>
</li>
</ul></div></div></td>
</tr>
</tbody>
</table>
</div>
<div class="sidebarblock nobreakinside less_space">
<div class="content">
<div class="title">Aggregates and Consistency Boundaries Recap</div>
<div class="paragraph"><p></p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
Aggregates are your entrypoints into the domain model
</dt>
<dd>
<p>
    By restricting the number of ways that things can be changed,
    we make the system easier to reason about.
</p>
</dd>
<dt class="hdlist1">
Aggregates are in charge of a consistency boundary
</dt>
<dd>
<p>
    An aggregate&#8217;s job is to be able to manage our business rules
    about invariants as they apply to a group of related objects.
    It&#8217;s the aggregate&#8217;s job to check that the objects within its
    remit are consistent with each other and with our rules, and
    to reject changes that would break the rules.
</p>
</dd>
<dt class="hdlist1">
Aggregates and concurrency issues go together
</dt>
<dd>
<p>
    When thinking about implementing these consistency checks, we
    end up thinking about transactions and locks.  Choosing the
    right aggregate is about performance as well as conceptual
    organization of your domain.
    
</p>
</dd>
</dl></div>
</div></div>
</div>
<div class="sect2 pagebreak-before less_space">
<h3 id="_part_i_recap">Part I Recap</h3>
<div class="paragraph"><p>Do you remember <a href="#recap_components_diagram">[recap_components_diagram]</a>, the diagram we showed at the
beginning of <a href="#part1">[part1]</a> to preview where we were heading?</p></div>
<div class="imageblock width-75" id="recap_components_diagram">
<div class="content">
<img src="images/apwp_0705.png" alt="images/apwp_0705.png" />
</div>
<div class="title">Figure 28. A component diagram for our app at the end of Part I</div>
</div>
<div class="paragraph"><p>So that&#8217;s where we are at the end of Part I. What have we achieved? We&#8217;ve
seen how to build a domain model that&#8217;s exercised by a set of
high-level unit tests. Our tests are living documentation: they describe the
behavior of our system&#8212;the rules upon which we agreed with our business
stakeholders&#8212;in nice readable code. When our business requirements change, we
have confidence that our tests will help us to prove the new functionality, and
when new developers join the project, they can read our tests to understand how
things work.</p></div>
<div class="paragraph"><p>We&#8217;ve decoupled the infrastructural parts of our system, like the database and
API handlers, so that we can plug them into the outside of our application.
This helps us to keep our codebase well organized and stops us from building a
big ball of mud.</p></div>
<div class="paragraph"><p>By applying the dependency inversion principle, and by using
ports-and-adapters-inspired patterns like Repository and Unit of Work, we&#8217;ve
made it possible to do TDD in both high gear and low gear and to maintain a
healthy test pyramid. We can test our system edge to edge, and the need for
integration and end-to-end tests is kept to a minimum.</p></div>
<div class="paragraph"><p>Lastly, we&#8217;ve talked about the idea of consistency boundaries. We don&#8217;t want to
lock our entire system whenever we make a change, so we have to choose which
parts are consistent with one another.</p></div>
<div class="paragraph"><p>For a small system, this is everything you need to go and play with the ideas of
domain-driven design. You now have the tools to build database-agnostic domain
models that represent the shared language of your business experts. Hurrah!</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note" />
</td>
<td class="content">At the risk of laboring the point&#8212;we&#8217;ve been at pains to point out that
    each pattern comes at a cost. Each layer of indirection has a price in terms
    of complexity and duplication in our code and will be confusing to programmers
    who&#8217;ve never seen these patterns before. If your app is essentially a simple CRUD
    wrapper around a database and isn&#8217;t likely to be anything more than that
    in the foreseeable future, <em>you don&#8217;t need these patterns</em>. Go ahead and
    use Django, and save yourself a lot of bother.
    
    </td>
</tr></table>
</div>
<div class="paragraph"><p>In Part II, we&#8217;ll zoom out and talk about a bigger topic: if aggregates are our
boundary, and we can update only one at a time, how do we model processes that
cross consistency boundaries?</p></div>
</div>
</div>
</div>
<div class="quoteblock">
<div class="content">
<div class="paragraph"><p>Мне жаль, что я давным-давно придумал термин "объекты" для этой темы, потому что он заставляет многих людей сосредоточиться на менее значимой идее.</p></div>
<div class="paragraph"><p>Главная идея-это "<em>messaging</em> обмен сообщениями"&#8230;.Ключ к созданию больших и растущих систем гораздо больше заключается в том, чтобы спроектировать, как его модули взаимодействуют, а не в том, какими должны быть их внутренние свойства и поведение.</p></div>
</div>
<div class="attribution">
&#8212; Alan Kay
</div></div>
<div class="paragraph"><p>Все это очень хорошо, когда мы можем написать <em>одну</em> доменную модель для управления одним участком бизнес-процесса, но что происходит, когда нам нужно написать <em>несколько</em> моделей? В реальном мире наши приложения находятся внутри организации и должны обмениваться информацией с другими частями системы. Возможно, вы помните нашу контекстную диаграмму, показанную в <a href="#allocation_context_diagram_again">[allocation_context_diagram_again]</a>.</p></div>
<div class="paragraph"><p>Столкнувшись с этим требованием, многие команды обращаются к микросервисам, интегрированным через HTTP API. Но если они не будут осторожны, то в конечном итоге создадут самый хаотичный беспорядок из всех: распределенный БОЛЬШОЙ ШАР ГРЯЗИ.</p></div>
<div class="paragraph"><p>В части II мы покажем, как методы из <a href="#части 1">[части 1]</a> могут быть распространены на распределенные системы. Мы уменьшим масштаб, чтобы посмотреть, как мы можем составить систему из множества небольших компонентов, которые взаимодействуют посредством асинхронной передачи сообщений.</p></div>
<div class="paragraph"><p>Мы увидим, как наш Уровень обслуживания и шаблоны единиц работы позволяют нам перенастроить наше приложение для работы в качестве асинхронного процессора сообщений и как системы, управляемые событиями, помогают нам отделить агрегаты и приложения друг от друга.</p></div>
<div class="imageblock" id="allocation_context_diagram_again">
<div class="content">
<img src="images/apwp_0102ru.png" alt="images/apwp_0102ru.png" />
</div>
<div class="title">Figure 29. Но как именно все эти системы будут общаться друг с другом?</div>
</div>
<div class="paragraph"><p>Мы рассмотрим следующие шаблоны и техники:</p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
События домена 
</dt>
<dd>
<p>
  Триггерные рабочие процессы, которые пересекают границы консистенции.
</p>
</dd>
<dt class="hdlist1">
Шина сообщений 
</dt>
<dd>
<p>
  Обеспечивает унифицированный способ вызова случаев использования из любой конечной точки.
</p>
</dd>
<dt class="hdlist1">
CQRS
</dt>
<dd>
<p>
  Разделяет операций чтения и записи позволяет избежать неудобных компромиссов в событийно-управляемой архитектуре и повысить производительность и масштабируемость.
</p>
</dd>
</dl></div>
<div class="paragraph"><p>Плюс, мы добавим каркас для инъекций зависимостей. Это не имеет ничего общего с архитектурой, основанной на событиях как таковой, но она убирает очень много свободных концовок.</p></div>
<div class="sect1">
<h2 id="chapter_08_events_and_message_bus">События и шина сообщений</h2>
<div class="sectionbody">
<div class="paragraph"><p>Итак, мы потратили кучу времени и энергии на простую проблему, которую мы могли бы легко решить с помощью Django. Возможно, вы задаётесь вопросом, <em>действительно</em> ли повышенная тестируемость и выразительность стоят всех усилий?!</p></div>
<div class="paragraph"><p>Однако на практике мы обнаруживаем, что не очевидные функции создают беспорядок в наших кодовых базах: это нечто липкое и тупое скопившееся по краю. Это отчеты, разрешения и рабочие процессы, которые затрагивают миллион объектов.</p></div>
<div class="paragraph"><p>Нашим примером будет типичное требование к уведомлению: когда мы не можем разместить заказ, потому что его нет в наличии, мы должны предупредить отдел сбыта. Они пойдут и решат проблему, закупив побольше запасов, и все будет хорошо.</p></div>
<div class="paragraph"><p>В случае первой версии, наш владелец только должен отправить предупреждение по электронной почте.</p></div>
<div class="paragraph"><p>Давайте посмотрим, как выдержит наша архитектура, когда нам нужно подключить некоторые прозаичные вещи, которые составляют так много наших систем.</p></div>
<div class="paragraph"><p>Мы начнём с самого простого, самого быстрого решения и дальше поговорим о том, почему именно такое решение приводит нас к Большому Комку грязи.</p></div>
<div class="paragraph"><p>Затем мы покажем, как использовать шаблон <em>Domain Events</em> для отделения побочных эффектов от наших вариантов использования, и как использовать простой шаблон <em>Message Bus</em> для запуска поведения на основе этих событий. Мы покажем несколько вариантов для создания этих событий и того, как передать их в шину сообщений, и, наконец, мы покажем, как можно изменить шаблон Unit of Work, чтобы элегантно соединить их вместе, как показано в &lt;&lt;message_bus_diagram&gt; &gt;.</p></div>
<div class="imageblock" id="message_bus_diagram">
<div class="content">
<img src="images/apwp_0801.png" alt="images/apwp_0801.png" />
</div>
<div class="title">Figure 30. События, протекающие через систему</div>
</div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/tip.png" alt="Tip" />
</td>
<td class="content">
<div class="paragraph"><p>Код этой главы находится в ветке chapter_08_events_and_message_bus <a href="https://oreil.ly/M-JuL">на GitHub</a>:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>git clone https://github.com/cosmicpython/code.git
cd code
git checkout chapter_08_events_and_message_bus
# или, чтобы дальше кодировать вместе, проверьте предыдущую главу:
git checkout chapter_07_aggregate</code></pre>
</div></div>
</td>
</tr></table>
</div>
<div class="sect2">
<h3 id="_как_избежать_беспорядка">Как избежать беспорядка</h3>
<div class="paragraph"><p>Так. Уведомления по электронной почте, когда у нас заканчивается товар. Когда у нас появляются новые требования, вроде тех, которые <em>в действительности</em> не имеют ничего общего с основным доменом, очень легко начать сбрасывать эти вещи в наши веб-контроллеры.</p></div>
<div class="sect3">
<h4 id="_во_первых_давайте_не_будем_путать_наши_веб_контроллеры">Во-первых, давайте не будем путать наши веб-контроллеры</h4>
<div class="paragraph"><p>В качестве одноразового взлома, это <em>может</em> быть допустимо:</p></div>
<div class="exampleblock" id="email_in_flask">
<div class="title">Example 92. Просто сунь его в endpoint—что может пойти не так? (src/allocation/entrypoints/flask_app.py)</div>
<div class="content">
<div class="listingblock skip">
<div class="content"><div class="highlight"><pre><span></span><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/allocate&quot;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">allocate_endpoint</span><span class="p">():</span>
    <span class="n">line</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">OrderLine</span><span class="p">(</span>
        <span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="s1">&#39;orderid&#39;</span><span class="p">],</span>
        <span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="s1">&#39;sku&#39;</span><span class="p">],</span>
        <span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="s1">&#39;qty&#39;</span><span class="p">],</span>
    <span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">uow</span> <span class="o">=</span> <span class="n">unit_of_work</span><span class="o">.</span><span class="n">SqlAlchemyUnitOfWork</span><span class="p">()</span>
        <span class="n">batchref</span> <span class="o">=</span> <span class="n">services</span><span class="o">.</span><span class="n">allocate</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">uow</span><span class="p">)</span>
    <span class="k">except</span> <span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">OutOfStock</span><span class="p">,</span> <span class="n">services</span><span class="o">.</span><span class="n">InvalidSku</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">send_mail</span><span class="p">(</span>
            <span class="s1">&#39;out of stock&#39;</span><span class="p">,</span>
            <span class="s1">&#39;stock_admin@made.com&#39;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">line</span><span class="o">.</span><span class="n">orderid</span><span class="si">}</span><span class="s1"> - </span><span class="si">{</span><span class="n">line</span><span class="o">.</span><span class="n">sku</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}),</span> <span class="mi">400</span>

    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;batchref&#39;</span><span class="p">:</span> <span class="n">batchref</span><span class="p">}),</span> <span class="mi">201</span>
</pre></div></div></div>
</div></div>
<div class="paragraph"><p>&#8230;но легко понять, как мы можем быстро попасть в переделку, если так всё сделать. Отправка электронной почты не является задачей нашего HTTP-уровня, и мы хотели бы иметь возможность протестировать эту новую функцию.</p></div>
</div>
<div class="sect3">
<h4 id="_и_давайте_не_будем_портить_нашу_модель">И давайте не будем портить нашу модель</h4>
<div class="paragraph"><p>Предполагая, что мы не хотим помещать этот код в наши веб-контроллеры, потому что мы хотим, чтобы они были как можно более тонкими, мы можем посмотреть на то, чтобы поместить его прямо в источник, в модель:</p></div>
<div class="exampleblock" id="email_in_model">
<div class="title">Example 93. Код отправки электронной почты в нашей модели тоже не очень хорош (src/allocation/domain/model.py)</div>
<div class="content">
<div class="listingblock non-head">
<div class="content"><div class="highlight"><pre><span></span>    <span class="k">def</span> <span class="nf">allocate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="p">:</span> <span class="n">OrderLine</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">batch</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span>
                <span class="n">b</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">batches</span><span class="p">)</span> <span class="k">if</span> <span class="n">b</span><span class="o">.</span><span class="n">can_allocate</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="c1">#...</span>
        <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
            <span class="n">email</span><span class="o">.</span><span class="n">send_mail</span><span class="p">(</span><span class="s1">&#39;stock@made.com&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;Out of stock for </span><span class="si">{</span><span class="n">line</span><span class="o">.</span><span class="n">sku</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">OutOfStock</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Out of stock for sku </span><span class="si">{</span><span class="n">line</span><span class="o">.</span><span class="n">sku</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div></div></div>
</div></div>
<div class="paragraph"><p>Но это еще хуже! Мы не хотим, чтобы наша модель имела какие-либо зависимости от инфраструктурных проблем, таких как <code>email.send_mail</code>.</p></div>
<div class="paragraph"><p>Эта штука с отправкой электронной почты нежелательна <em>сгусток</em>, испортивший приятный чистый поток нашей системы. Мы хотели бы, чтобы наша модель предметной области была ориентирована на правило "Вы не можете выделить больше материала, чем на самом деле доступно."</p></div>
</div>
<div class="sect3">
<h4 id="_или_уровень_обслуживания">Или уровень обслуживания!</h4>
<div class="paragraph"><p>Требование "Попробуйте распределить некоторый запас и отправить электронное письмо, если это не удастся" является примером оркестровки рабочего процесса: это набор шагов, которые система должна выполнить, чтобы <span class=".keep-together">достичь</span> цели.</p></div>
<div class="paragraph"><p>Мы написали сервисный уровень для управления оркестровкой для нас, но даже здесь эта функция кажется неуместной:</p></div>
<div class="exampleblock" id="email_in_services">
<div class="title">Example 94. И на сервисном уровне, это неуместно (src/allocation/service_layer/services.py)</div>
<div class="content">
<div class="listingblock non-head">
<div class="content"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">allocate</span><span class="p">(</span>
        <span class="n">orderid</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">sku</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">qty</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">uow</span><span class="p">:</span> <span class="n">unit_of_work</span><span class="o">.</span><span class="n">AbstractUnitOfWork</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">line</span> <span class="o">=</span> <span class="n">OrderLine</span><span class="p">(</span><span class="n">orderid</span><span class="p">,</span> <span class="n">sku</span><span class="p">,</span> <span class="n">qty</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">uow</span><span class="p">:</span>
        <span class="n">product</span> <span class="o">=</span> <span class="n">uow</span><span class="o">.</span><span class="n">products</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">sku</span><span class="o">=</span><span class="n">line</span><span class="o">.</span><span class="n">sku</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">product</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">InvalidSku</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Invalid sku </span><span class="si">{</span><span class="n">line</span><span class="o">.</span><span class="n">sku</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">batchref</span> <span class="o">=</span> <span class="n">product</span><span class="o">.</span><span class="n">allocate</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="n">uow</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">batchref</span>
        <span class="k">except</span> <span class="n">model</span><span class="o">.</span><span class="n">OutOfStock</span><span class="p">:</span>
            <span class="n">email</span><span class="o">.</span><span class="n">send_mail</span><span class="p">(</span><span class="s1">&#39;stock@made.com&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;Out of stock for </span><span class="si">{</span><span class="n">line</span><span class="o">.</span><span class="n">sku</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">raise</span>
</pre></div></div></div>
</div></div>
<div class="paragraph"><p>Поймать исключение и сделать ререйз? Могло быть и хуже, но это определенно нас огорчает. Почему так сложно найти подходящий дом для этого кода?</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_single_responsibility_principle">Single Responsibility Principle</h3>
<div class="paragraph"><p>На самом деле, это нарушение <em>принципа единственной ответственности</em> (SRP) .footnote: [Этот принцип&#8201;&#8212;&#8201;<em>S</em> в <a href="https://oreil.ly/AIdSD">SOLID</a>.] Наш пример использования&#8201;&#8212;&#8201;распределение. Наша конечная точка, служебная функция и методы домена называются [.keep-together] <code>allocate</code>, а не <code>allocate_and_send_mail_if_out_of_stock</code>.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/tip.png" alt="Tip" />
</td>
<td class="content">Эмпирическое правило: если вы не можете описать, что делает ваша функция, не используя такие слова, как "тогда" или "и", вы можете нарушить SRP.</td>
</tr></table>
</div>
<div class="paragraph"><p>Согласно одной из формулировок SRP, у каждого класса должна быть только одна причина для изменения. Когда мы переключаемся с электронной почты на SMS, нам не нужно обновлять нашу функцию <code>allocate()</code>, потому что это явно отдельная ответственность.</p></div>
<div class="paragraph"><p>Чтобы решить эту проблему, мы разделим оркестровку на отдельные этапы, чтобы различные проблемы не перепутались.<span class="footnote"><br />[ Наш технический обозреватель Эд Юнг любит говорить, что когда вы переходите от императивного управления потоком к управлению потоком на основе событий, вы меняете <em>orchestration</em> на <em>choreography</em>.]<br /></span> Задача модели домена состоит в том, чтобы знать, что у нас нет запасов, но ответственность за отправку предупреждения лежит на другом месте. Мы должны иметь возможность включать или выключать эту функцию или переключаться на SMS-уведомления вместо этого, не меняя правила нашей доменной модели.</p></div>
<div class="paragraph"><p>Мы также хотели бы сохранить уровень сервиса свободным от деталей реализации. Мы хотим применить принцип инверсии зависимостей к уведомлениям, чтобы наш уровень обслуживания зависел от абстракции, точно так же, как мы избегаем зависимости от базы данных, используя единицу работы.</p></div>
</div>
<div class="sect2">
<h3 id="_все_на_борт_автобуса_сообщений">Все на борт автобуса Сообщений!</h3>
<div class="paragraph"><p>Шаблоны, которые мы собираемся здесь представить, - это <em>Domain Events</em> События домена и <em>Message Bus</em> Шина сообщений. Мы можем реализовать их несколькими способами, поэтому мы покажем пару, прежде чем остановимся на том, который нам больше всего нравится.</p></div>
<div class="sect3">
<h4 id="_модель_записывает_события">Модель Записывает События</h4>
<div class="paragraph"><p>Во-первых, вместо того, чтобы беспокоиться об электронных письмах, наша модель будет отвечать за регистрацию <em>events</em> (событий) - факты о том, что произошло. Мы будем использовать шину сообщений, чтобы отвечать на события и вызывать новую операцию.</p></div>
</div>
<div class="sect3">
<h4 id="_события_events_это_простые_классы_данных">События (events) - это простые классы данных</h4>
<div class="paragraph"><p><em>event</em>-это своего рода <em>value object</em>. События не имеют никакого поведения, потому что они являются чистыми структурами данных. Мы всегда называем события на языке домена и думаем о них как о части нашей модели домена.</p></div>
<div class="paragraph"><p>Мы могли бы хранить их в <em>model.py</em>, но мы также можем хранить их в отдельном файле.
 (возможно, сейчас самое подходящее время подумать о рефакторинге каталога с именем <em>domain</em>, чтобы у нас был <em>domain/model.py</em> и <em>domain/events.py</em>):</p></div>
<div class="exampleblock nobreakinside less_space" id="events_dot_py">
<div class="title">Example 95. Классы событий (src/allocation/domain/events.py)</div>
<div class="content">
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>

<span class="k">class</span> <span class="nc">Event</span><span class="p">:</span>  <span class="c1">#<img src="./images/icons/callouts/1.png" alt="1" /></span>
    <span class="k">pass</span>

<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">OutOfStock</span><span class="p">(</span><span class="n">Event</span><span class="p">):</span>  <span class="c1">#<img src="./images/icons/callouts/2.png" alt="2" /></span>
    <span class="n">sku</span><span class="p">:</span> <span class="nb">str</span>
</pre></div></div></div>
</div></div>
<div class="colist arabic"><table>
<tr><td><img src="./images/icons/callouts/1.png" alt="1" /></td><td>
Как только у нас будет несколько событий, нам будет полезно иметь родительский класс, который может хранить общие атрибуты. Это также полезно для подсказок типа в нашей шине сообщений, как вы вскоре увидите.
</td></tr>
<tr><td><img src="./images/icons/callouts/2.png" alt="2" /></td><td>
<code>dataclasses</code> отлично подходят и для доменных событий.
</td></tr>
</table></div>
</div>
<div class="sect3">
<h4 id="_модель_вызывает_события">Модель вызывает события</h4>
<div class="paragraph"><p>Когда наша модель домена фиксирует факт, который произошел, мы говорим, что это <em>raises (поднимает)</em> событие.</p></div>
<div class="paragraph"><p>Вот как это будет выглядеть со стороны; если мы попросим "Product" распределить  ( <em>allocate</em> ), но он не сможет, он должен <em>raise (поднять)</em> событие:</p></div>
<div class="exampleblock" id="test_raising_event">
<div class="title">Example 96. Протестируйте наш агрегат, чтобы поднять события (tests/unit/test_product.py)</div>
<div class="content">
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">test_records_out_of_stock_event_if_cannot_allocate</span><span class="p">():</span>
    <span class="n">batch</span> <span class="o">=</span> <span class="n">Batch</span><span class="p">(</span><span class="s1">&#39;batch1&#39;</span><span class="p">,</span> <span class="s1">&#39;SMALL-FORK&#39;</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">eta</span><span class="o">=</span><span class="n">today</span><span class="p">)</span>
    <span class="n">product</span> <span class="o">=</span> <span class="n">Product</span><span class="p">(</span><span class="n">sku</span><span class="o">=</span><span class="s2">&quot;SMALL-FORK&quot;</span><span class="p">,</span> <span class="n">batches</span><span class="o">=</span><span class="p">[</span><span class="n">batch</span><span class="p">])</span>
    <span class="n">product</span><span class="o">.</span><span class="n">allocate</span><span class="p">(</span><span class="n">OrderLine</span><span class="p">(</span><span class="s1">&#39;order1&#39;</span><span class="p">,</span> <span class="s1">&#39;SMALL-FORK&#39;</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>

    <span class="n">allocation</span> <span class="o">=</span> <span class="n">product</span><span class="o">.</span><span class="n">allocate</span><span class="p">(</span><span class="n">OrderLine</span><span class="p">(</span><span class="s1">&#39;order2&#39;</span><span class="p">,</span> <span class="s1">&#39;SMALL-FORK&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="k">assert</span> <span class="n">product</span><span class="o">.</span><span class="n">events</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">events</span><span class="o">.</span><span class="n">OutOfStock</span><span class="p">(</span><span class="n">sku</span><span class="o">=</span><span class="s2">&quot;SMALL-FORK&quot;</span><span class="p">)</span>  <span class="c1">#<img src="./images/icons/callouts/1.png" alt="1" /></span>
    <span class="k">assert</span> <span class="n">allocation</span> <span class="ow">is</span> <span class="kc">None</span>
</pre></div></div></div>
</div></div>
<div class="colist arabic"><table>
<tr><td><img src="./images/icons/callouts/1.png" alt="1" /></td><td>
Наш агрегат предоставит новый атрибут под названием <code>.events</code>, который будет содержать список фактов о том, что произошло, в форме объектов <code>Event</code>.
</td></tr>
</table></div>
<div class="paragraph"><p>Вот как выглядит модель изнутри:</p></div>
<div class="exampleblock" id="domain_event">
<div class="title">Example 97. Модель вызывает событие предметной области (src/allocation/domain/model.py)</div>
<div class="content">
<div class="listingblock non-head">
<div class="content"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Product</span><span class="p">:</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sku</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">batches</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Batch</span><span class="p">],</span> <span class="n">version_number</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sku</span> <span class="o">=</span> <span class="n">sku</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">batches</span> <span class="o">=</span> <span class="n">batches</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">version_number</span> <span class="o">=</span> <span class="n">version_number</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">events</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># type: List[events.Event]  #<img src="./images/icons/callouts/1.png" alt="1" /></span>

    <span class="k">def</span> <span class="nf">allocate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="p">:</span> <span class="n">OrderLine</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1">#...</span>
        <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">events</span><span class="o">.</span><span class="n">OutOfStock</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">sku</span><span class="p">))</span>  <span class="c1">#<img src="./images/icons/callouts/2.png" alt="2" /></span>
            <span class="c1"># raise OutOfStock(f&#39;Out of stock for sku {line.sku}&#39;)  #<img src="./images/icons/callouts/3.png" alt="3" /></span>
            <span class="k">return</span> <span class="kc">None</span>
</pre></div></div></div>
</div></div>
<div class="colist arabic"><table>
<tr><td><img src="./images/icons/callouts/1.png" alt="1" /></td><td>
Вот наш новый атрибут <code>.events</code>.
</td></tr>
<tr><td><img src="./images/icons/callouts/2.png" alt="2" /></td><td>
Вместо того, чтобы напрямую вызывать какой-либо код отправки электронной почты, мы записываем эти события в том месте, где они происходят, используя только язык домена.
</td></tr>
<tr><td><img src="./images/icons/callouts/3.png" alt="3" /></td><td>
Мы также собираемся прекратить создавать исключение для случая отсутствия на складе. Событие выполнит ту работу, которую выполняло исключение.
</td></tr>
</table></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note" />
</td>
<td class="content">На самом деле мы "принюхиваемся" к коду, который мы рассматривали до сих пор, а именно к тому, что обсуждается в <a href="https://oreil.ly/IQB51">использование исключений для потока управления</a>. В общем случае, если вы реализуете доменные события, не создавайте исключений для описания одной и той же концепции домена.     Как вы увидите позже, когда мы будем обрабатывать события в шаблоне Unit of Work, это сбивает с толку, когда приходится рассуждать о совместном использовании событий и исключений.
    
    </td>
</tr></table>
</div>
</div>
<div class="sect3">
<h4 id="_шина_сообщений_сопоставляет_события_events_с_обработчиками_handlers">Шина сообщений сопоставляет События(Events) с Обработчиками(Handlers)</h4>
<div class="paragraph"><p>Шина сообщений в основном говорит: "Когда я вижу это событие, я должен вызвать следующую функцию обработчика". Другими словами, это простая система подписки на публикации. Обработчики <em>подписаны (subscribed)</em> на получение событий, которые мы размещаем в шине. Это звучит сложнее, чем есть на самом деле, и мы обычно реализуем это с помощью dict:</p></div>
<div class="exampleblock" id="messagebus">
<div class="title">Example 98. Simple message bus (src/allocation/service_layer/messagebus.py)</div>
<div class="content">
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">handle</span><span class="p">(</span><span class="n">event</span><span class="p">:</span> <span class="n">events</span><span class="o">.</span><span class="n">Event</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">handler</span> <span class="ow">in</span> <span class="n">HANDLERS</span><span class="p">[</span><span class="nb">type</span><span class="p">(</span><span class="n">event</span><span class="p">)]:</span>
        <span class="n">handler</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">send_out_of_stock_notification</span><span class="p">(</span><span class="n">event</span><span class="p">:</span> <span class="n">events</span><span class="o">.</span><span class="n">OutOfStock</span><span class="p">):</span>
    <span class="n">email</span><span class="o">.</span><span class="n">send_mail</span><span class="p">(</span>
        <span class="s1">&#39;stock@made.com&#39;</span><span class="p">,</span>
        <span class="sa">f</span><span class="s1">&#39;Out of stock for </span><span class="si">{</span><span class="n">event</span><span class="o">.</span><span class="n">sku</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
    <span class="p">)</span>


<span class="n">HANDLERS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">events</span><span class="o">.</span><span class="n">OutOfStock</span><span class="p">:</span> <span class="p">[</span><span class="n">send_out_of_stock_notification</span><span class="p">],</span>

<span class="p">}</span>  <span class="c1"># type: Dict[Type[events.Event], List[Callable]]</span>
</pre></div></div></div>
</div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note" />
</td>
<td class="content">Обратите внимание, что реализованная шина сообщений не дает нам параллелизма, потому что одновременно будет работать только один обработчик. Наша цель состоит не в том, чтобы поддерживать параллельные потоки, а в том, чтобы концептуально разделить задачи и сделать каждый UoW как можно меньше. Это помогает нам понять кодовую базу, потому что "рецепт" для запуска каждого варианта использования написан в одном месте. См. следующую боковую панель.
    </td>
</tr></table>
</div>
<div class="sidebarblock nobreakinside less_space" id="celery_sidebar">
<div class="content">
<div class="title">Это как Celery?</div>
<div class="paragraph"><p><em>Celery</em>&#8201;&#8212;&#8201;это популярный в мире Python инструмент для переноса автономных фрагментов работы в асинхронную очередь задач. Шина сообщений, которую мы представляем здесь, очень отличается, поэтому короткий ответ на вышеприведенный вопрос-нет; наша шина сообщений имеет больше общего с Express.js приложение, цикл событий пользовательского интерфейса или структура актера.</p></div>
<div class="paragraph"><p>Если у вас есть необходимость перенести работу из основного потока, вы все еще можете использовать наши event-based metaphors (метафоры, основанные на событиях), но мы предлагаем вам использовать для этого <em>external events</em>. Это более подробно обсуждается в <a href="#chapter_11_external_events_tradeoffs">[chapter_11_external_events_tradeoffs]</a>, но по сути, если вы реализуете способ сохранения событий в централизованном хранилище, вы можете подписаться на другие контейнеры или другие микросервисы. Затем та же самая концепция использования событий для разделения обязанностей между единицами работы в рамках одного process/service может быть распространена на несколько процессов, которые могут быть различными контейнерами в рамках одной и той же службы или совершенно разными микросервисами.</p></div>
<div class="paragraph"><p>Если вы следуете нашему подходу, ваш API для распределения задач-это ваше событие <span class=".keep-together">классы—</span>или их JSON-представление. Это дает вам большую гибкость в том, кому вы распределяете задачи; они не обязательно должны быть службами Python. Celery&#8217;s API для распределения задач&#8201;&#8212;&#8201;это, по сути, "имя функции плюс аргументы", что является более ограничительным и только для Python.</p></div>
</div></div>
</div>
</div>
<div class="sect2">
<h3 id="_вариант_1_уровень_сервиса_принимает_события_из_модели_и_помещает_их_в_шину_сообщений">Вариант 1. Уровень сервиса Принимает События из Модели и Помещает их в Шину сообщений</h3>
<div class="paragraph"><p>Наша доменная модель вызывает события, и наша шина сообщений будет вызывать правые обработчики всякий раз, когда происходит событие. Теперь все, что нам нужно,&#8201;&#8212;&#8201;это соединить их. Нам нужно что-то, чтобы перехватить события из модели и передать их в шину сообщений&#8201;&#8212;&#8201;этап <em>publishing</em>.</p></div>
<div class="paragraph"><p>Самый простой способ сделать это&#8201;&#8212;&#8201;добавить код в наш сервисный слой:</p></div>
<div class="exampleblock" id="service_talks_to_messagebus">
<div class="title">Example 99. Уровень обслуживания с явной шиной сообщений (src/allocation/service_layer/services.py)</div>
<div class="content">
<div class="listingblock non-head">
<div class="content"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">messagebus</span>
<span class="o">...</span>

<span class="k">def</span> <span class="nf">allocate</span><span class="p">(</span>
        <span class="n">orderid</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">sku</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">qty</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">uow</span><span class="p">:</span> <span class="n">unit_of_work</span><span class="o">.</span><span class="n">AbstractUnitOfWork</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">line</span> <span class="o">=</span> <span class="n">OrderLine</span><span class="p">(</span><span class="n">orderid</span><span class="p">,</span> <span class="n">sku</span><span class="p">,</span> <span class="n">qty</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">uow</span><span class="p">:</span>
        <span class="n">product</span> <span class="o">=</span> <span class="n">uow</span><span class="o">.</span><span class="n">products</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">sku</span><span class="o">=</span><span class="n">line</span><span class="o">.</span><span class="n">sku</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">product</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">InvalidSku</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Invalid sku </span><span class="si">{</span><span class="n">line</span><span class="o">.</span><span class="n">sku</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>  <span class="c1">#<img src="./images/icons/callouts/1.png" alt="1" /></span>
            <span class="n">batchref</span> <span class="o">=</span> <span class="n">product</span><span class="o">.</span><span class="n">allocate</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="n">uow</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">batchref</span>
        <span class="k">finally</span><span class="p">:</span>  <span class="c1">#<img src="./images/icons/callouts/1.png" alt="1" /></span>
            <span class="n">messagebus</span><span class="o">.</span><span class="n">handle</span><span class="p">(</span><span class="n">product</span><span class="o">.</span><span class="n">events</span><span class="p">)</span>  <span class="c1">#<img src="./images/icons/callouts/2.png" alt="2" /></span>
</pre></div></div></div>
</div></div>
<div class="colist arabic"><table>
<tr><td><img src="./images/icons/callouts/1.png" alt="1" /></td><td>
Мы сохраняем <code>try/finally</code> из нашей уродливой более ранней реализации (мы еще не избавились от <em>всех</em> исключений, просто <code>OutOfStock</code>).
</td></tr>
<tr><td><img src="./images/icons/callouts/2.png" alt="2" /></td><td>
Но теперь, вместо того чтобы напрямую зависеть от инфраструктуры электронной почты, уровень сервиса отвечает только за передачу событий от модели до шины сообщений.
</td></tr>
</table></div>
<div class="paragraph"><p>Это уже позволяет избежать некоторого уродства, которое мы имели в нашей наивной реализации, и у нас есть несколько систем, работающих подобно этой, в которых уровень обслуживания явно собирает события из агрегатов и передает их в шину сообщений.</p></div>
</div>
<div class="sect2">
<h3 id="_вариант_2_уровень_сервиса_создает_свои_собственные_события">Вариант 2: Уровень Сервиса Создает Свои Собственные События</h3>
<div class="paragraph"><p>Другой вариант, который мы использовали, - это сделать так, чтобы уровень сервиса отвечал за создание и инициирование событий напрямую, а не за их создание моделью предметной области:</p></div>
<div class="exampleblock" id="service_layer_raises_events">
<div class="title">Example 100. Service layer calls messagebus.handle directly (src/allocation/service_layer/services.py)</div>
<div class="content">
<div class="listingblock skip">
<div class="content"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">allocate</span><span class="p">(</span>
        <span class="n">orderid</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">sku</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">qty</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">uow</span><span class="p">:</span> <span class="n">unit_of_work</span><span class="o">.</span><span class="n">AbstractUnitOfWork</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">line</span> <span class="o">=</span> <span class="n">OrderLine</span><span class="p">(</span><span class="n">orderid</span><span class="p">,</span> <span class="n">sku</span><span class="p">,</span> <span class="n">qty</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">uow</span><span class="p">:</span>
        <span class="n">product</span> <span class="o">=</span> <span class="n">uow</span><span class="o">.</span><span class="n">products</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">sku</span><span class="o">=</span><span class="n">line</span><span class="o">.</span><span class="n">sku</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">product</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">InvalidSku</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Invalid sku </span><span class="si">{</span><span class="n">line</span><span class="o">.</span><span class="n">sku</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">batchref</span> <span class="o">=</span> <span class="n">product</span><span class="o">.</span><span class="n">allocate</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="n">uow</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span> <span class="c1">#<img src="./images/icons/callouts/1.png" alt="1" /></span>

        <span class="k">if</span> <span class="n">batchref</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">messagebus</span><span class="o">.</span><span class="n">handle</span><span class="p">(</span><span class="n">events</span><span class="o">.</span><span class="n">OutOfStock</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">sku</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">batchref</span>
</pre></div></div></div>
</div></div>
<div class="colist arabic"><table>
<tr><td><img src="./images/icons/callouts/1.png" alt="1" /></td><td>
Как и раньше, мы коммитим событие, даже если ничего не можем зарезервировать, потому что код таким образом проще и легче понимать: мы всегда фиксируем, если что-то не идет не так. Фиксация, когда мы ничего не изменили, безопасна и сохраняет код незагроможденным.
</td></tr>
</table></div>
<div class="paragraph"><p>Опять же, у нас есть приложения в производстве (production), которые реализуют шаблон таким образом.  То, что работает для вас, будет зависеть от конкретных компромиссов, с которыми вы столкнётесь, но мы хотели бы показать вам, что мы считаем наиболее элегантным решением, в котором мы помещаем единицу работы, отвечающую за сбор и обработку событий.</p></div>
</div>
<div class="sect2">
<h3 id="_вариант_3_uow_публикует_события_в_шине_сообщений">Вариант 3: UoW публикует события в шине сообщений</h3>
<div class="paragraph"><p>У UoW уже есть блок <code>try/finally</code>, и он знает обо всех агрегатах, находящихся в данный момент в игре, потому что он предоставляет доступ к репозиторию. Так что это хорошее место для обнаружения событий и передачи их в шину сообщений:</p></div>
<div class="exampleblock" id="uow_with_messagebus">
<div class="title">Example 101. UoW обеспечивает шину сообщений (src/allocation/service_layer/unit_of_work.py)</div>
<div class="content">
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">AbstractUnitOfWork</span><span class="p">(</span><span class="n">abc</span><span class="o">.</span><span class="n">ABC</span><span class="p">):</span>
    <span class="o">...</span>

    <span class="k">def</span> <span class="nf">commit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_commit</span><span class="p">()</span>  <span class="c1">#<img src="./images/icons/callouts/1.png" alt="1" /></span>
        <span class="bp">self</span><span class="o">.</span><span class="n">publish_events</span><span class="p">()</span>  <span class="c1">#<img src="./images/icons/callouts/2.png" alt="2" /></span>

    <span class="k">def</span> <span class="nf">publish_events</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>  <span class="c1">#<img src="./images/icons/callouts/2.png" alt="2" /></span>
        <span class="k">for</span> <span class="n">product</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">products</span><span class="o">.</span><span class="n">seen</span><span class="p">:</span>  <span class="c1">#<img src="./images/icons/callouts/3.png" alt="3" /></span>
            <span class="k">while</span> <span class="n">product</span><span class="o">.</span><span class="n">events</span><span class="p">:</span>
                <span class="n">event</span> <span class="o">=</span> <span class="n">product</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">messagebus</span><span class="o">.</span><span class="n">handle</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>

    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">_commit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

<span class="o">...</span>

<span class="k">class</span> <span class="nc">SqlAlchemyUnitOfWork</span><span class="p">(</span><span class="n">AbstractUnitOfWork</span><span class="p">):</span>
    <span class="o">...</span>

    <span class="k">def</span> <span class="nf">_commit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>  <span class="c1">#<img src="./images/icons/callouts/1.png" alt="1" /></span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</pre></div></div></div>
</div></div>
<div class="colist arabic"><table>
<tr><td><img src="./images/icons/callouts/1.png" alt="1" /></td><td>
Мы изменим наш метод фиксации, чтобы запросить частный метод <code>._commit()</code> из подклассов.
</td></tr>
<tr><td><img src="./images/icons/callouts/2.png" alt="2" /></td><td>
После фиксации мы прогоняем все объекты, которые воспринял наш репозиторий, и передаем их события в шину сообщений.
</td></tr>
<tr><td><img src="./images/icons/callouts/3.png" alt="3" /></td><td>
Это зависит от репозитория, отслеживающего агрегаты, которые были загружены с использованием нового атрибута, <code>.seen</code>, как вы увидите в следующем листинге.
    
    
</td></tr>
</table></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note" />
</td>
<td class="content">Вам интересно, что произойдет, если один из обработчиков выйдет из строя? Мы подробно обсудим обработку ошибок в <a href="#chapter_10_commands">[chapter_10_commands]</a>.</td>
</tr></table>
</div>
<div class="exampleblock" id="repository_tracks_seen">
<div class="title">Example 102. Репозиторий отслеживает агрегаты, которые проходят через него (src/allocation/adapters/repository.py)</div>
<div class="content">
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">AbstractRepository</span><span class="p">(</span><span class="n">abc</span><span class="o">.</span><span class="n">ABC</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">seen</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>  <span class="c1"># type: Set[model.Product]  #<img src="./images/icons/callouts/1.png" alt="1" /></span>

    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">product</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">Product</span><span class="p">):</span>  <span class="c1">#<img src="./images/icons/callouts/2.png" alt="2" /></span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add</span><span class="p">(</span><span class="n">product</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">seen</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">product</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sku</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">model</span><span class="o">.</span><span class="n">Product</span><span class="p">:</span>  <span class="c1">#<img src="./images/icons/callouts/3.png" alt="3" /></span>
        <span class="n">product</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get</span><span class="p">(</span><span class="n">sku</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">product</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">seen</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">product</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">product</span>

    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">_add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">product</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">Product</span><span class="p">):</span>  <span class="c1">#<img src="./images/icons/callouts/2.png" alt="2" /></span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>  <span class="c1">#<img src="./images/icons/callouts/3.png" alt="3" /></span>
    <span class="k">def</span> <span class="nf">_get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sku</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">model</span><span class="o">.</span><span class="n">Product</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>



<span class="k">class</span> <span class="nc">SqlAlchemyRepository</span><span class="p">(</span><span class="n">AbstractRepository</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session</span> <span class="o">=</span> <span class="n">session</span>

    <span class="k">def</span> <span class="nf">_add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">product</span><span class="p">):</span>  <span class="c1">#<img src="./images/icons/callouts/2.png" alt="2" /></span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">product</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sku</span><span class="p">):</span>  <span class="c1">#<img src="./images/icons/callouts/3.png" alt="3" /></span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">Product</span><span class="p">)</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">sku</span><span class="o">=</span><span class="n">sku</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
</pre></div></div></div>
</div></div>
<div class="colist arabic"><table>
<tr><td><img src="./images/icons/callouts/1.png" alt="1" /></td><td>
Чтобы UoW мог публиковать новые события, он должен иметь возможность запрашивать репозиторий, для каких объектов <code>Product</code> использовались во время этого сеанса. Мы используем <code>set</code> под названием` .seen` для их хранения. Это означает, что наши реализации должны вызывать  <code> super().__ init __() </code> .
    
</td></tr>
<tr><td><img src="./images/icons/callouts/2.png" alt="2" /></td><td>
Родительский метод <code>add()</code> добавляет элементы в <code>.seen</code> и теперь требует jn подклассов реализацию <code>._add()</code>.
</td></tr>
<tr><td><img src="./images/icons/callouts/3.png" alt="3" /></td><td>
Аналогично, <code>.get()</code> делегирует функцию <code>._get ()</code>, которая должна быть реализована подклассами, чтобы захватить видимые объекты.
</td></tr>
</table></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note" />
</td>
<td class="content">Использование методов <code><em>._underscorey()</em></code> и подклассов определенно не является единственным способом реализации этих шаблонов. Попробуйте воспользоваться <a href="#get_rid_of_commit">"Упражнения для читателя"</a> в этой главе и поэкспериментируйте с некоторыми альтернативами.</td>
</tr></table>
</div>
<div class="paragraph"><p>После того, как UoW и репозиторий будут сотрудничать таким образом, чтобы автоматически отслеживать живые объекты и обрабатывать их события, уровень сервиса может быть полностью свободен от проблем с обработкой событий:</p></div>
<div class="exampleblock" id="services_clean">
<div class="title">Example 103. Сервисный слой снова чист (src/allocation/service_layer/services.py)</div>
<div class="content">
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">allocate</span><span class="p">(</span>
        <span class="n">orderid</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">sku</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">qty</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">uow</span><span class="p">:</span> <span class="n">unit_of_work</span><span class="o">.</span><span class="n">AbstractUnitOfWork</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">line</span> <span class="o">=</span> <span class="n">OrderLine</span><span class="p">(</span><span class="n">orderid</span><span class="p">,</span> <span class="n">sku</span><span class="p">,</span> <span class="n">qty</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">uow</span><span class="p">:</span>
        <span class="n">product</span> <span class="o">=</span> <span class="n">uow</span><span class="o">.</span><span class="n">products</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">sku</span><span class="o">=</span><span class="n">line</span><span class="o">.</span><span class="n">sku</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">product</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">InvalidSku</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Invalid sku </span><span class="si">{</span><span class="n">line</span><span class="o">.</span><span class="n">sku</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">batchref</span> <span class="o">=</span> <span class="n">product</span><span class="o">.</span><span class="n">allocate</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="n">uow</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">batchref</span>
</pre></div></div></div>
</div></div>
<div class="paragraph"><p>Мы также должны помнить, что надо изменить фейки в сервисном слое и заставить их вызывать <code>super()</code> в нужных местах, а также реализовать методы c двойным подчёркиванием ("<em>str</em>","<em>repr</em>"), но изменения минимальны:</p></div>
<div class="exampleblock" id="services_tests_ugly_fake_messagebus">
<div class="title">Example 104. Фейки сервисного уровня нуждаются в настройке (tests/unit/test_services.py)</div>
<div class="content">
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">FakeRepository</span><span class="p">(</span><span class="n">repository</span><span class="o">.</span><span class="n">AbstractRepository</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">products</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_products</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">products</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">product</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_products</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">product</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sku</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">next</span><span class="p">((</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_products</span> <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">sku</span> <span class="o">==</span> <span class="n">sku</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>

<span class="o">...</span>

<span class="k">class</span> <span class="nc">FakeUnitOfWork</span><span class="p">(</span><span class="n">unit_of_work</span><span class="o">.</span><span class="n">AbstractUnitOfWork</span><span class="p">):</span>
    <span class="o">...</span>

    <span class="k">def</span> <span class="nf">_commit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">committed</span> <span class="o">=</span> <span class="kc">True</span>
</pre></div></div></div>
</div></div>
<div class="sidebarblock nobreakinside less_space" id="get_rid_of_commit">
<div class="content">
<div class="title">Упражнения для читателя</div>
<div class="paragraph"><p>Вы находите все эти методы <code>._add ()</code> и <code>._commit()</code> "супер-навороченными", по словам нашего любимого технического обозревателя Хайнека? Это "возбудит у вас желание шмякнуть Гарри по голове плюшевой змеей"? Эй, наши куски кода предназначены только для примеров, а не для идеального решения! Почему бы не пойти и не глянуть, сможешь ли ты сделать лучше?</p></div>
<div class="paragraph"><p>Одним из способов <em>пеподнять композицию над наследованием</em> было бы реализовать класс-декоратор:</p></div>
<div class="exampleblock" id="tracking_repo_wrapper">
<div class="title">Example 105. Обертка добавляет функциональность, а затем делегирует (src/adapters/repository.py)</div>
<div class="content">
<div class="listingblock skip">
<div class="content"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">TrackingRepository</span><span class="p">:</span>
    <span class="n">seen</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">Product</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">repo</span><span class="p">:</span> <span class="n">AbstractRepository</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">seen</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>  <span class="c1"># type: Set[model.Product]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_repo</span> <span class="o">=</span> <span class="n">repo</span>

    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">product</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">Product</span><span class="p">):</span>  <span class="c1">#<img src="./images/icons/callouts/1.png" alt="1" /></span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_repo</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">product</span><span class="p">)</span>  <span class="c1">#<img src="./images/icons/callouts/1.png" alt="1" /></span>
        <span class="bp">self</span><span class="o">.</span><span class="n">seen</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">product</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sku</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">model</span><span class="o">.</span><span class="n">Product</span><span class="p">:</span>
        <span class="n">product</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_repo</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">sku</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">product</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">seen</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">product</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">product</span>
</pre></div></div></div>
</div></div>
<div class="colist arabic"><table>
<tr><td><img src="./images/icons/callouts/1.png" alt="1" /></td><td>
Обернув репозиторий, мы можем вызывать фактические методы <code>.add ()</code> и <code>.get ()</code>, избегая волшебных методов с двойным подчёркиванием.
</td></tr>
</table></div>
<div class="paragraph"><p>Посмотрите, можете ли вы применить аналогичный шаблон к нашему классу UoW, чтобы избавиться и от тех Java-подобных методов <code>_commit()</code>. Вы можете найти код наhttps://github.com/cosmicpython/code/tree/chapter_08_events_and_message_bus_exercise[GitHub].</p></div>
<div class="paragraph"><p>Переключение всех ABC на <code>typing.Protocol</code> - хороший способ заставить себя
избегайте использования наследования. Дайте нам знать, если у вас получится что-нибудь приятное!</p></div>
</div></div>
<div class="paragraph"><p>Возможно, вы начинаете беспокоиться о том, что поддержание этих фейков будет бременем для обслуживания. Нет никаких сомнений, что это работа, но по нашему опыту это не так уж много работы. Как только ваш проект  запущен и работает, интерфейс для вашего репозитория и абстракций UoW действительно не сильно меняется. И если вы используете ABC, это поможет вам вспомнить, когда что-то выходит из синхронизации.</p></div>
</div>
<div class="sect2">
<h3 id="_подведение_итогов_2">Подведение итогов</h3>
<div class="paragraph"><p>События домена дают нам возможность управлять рабочими процессами в нашей системе. Мы часто обнаруживаем, слушая наших экспертов в предметной области, что они выражают требования причинным или временным образом - например, «Когда мы пытаемся распределить запасы, но их нет в наличии, мы должны отправить электронное письмо отделу снабжения».</p></div>
<div class="paragraph"><p>Волшебные слова "When X, then Y" часто говорят нам о событии, которое мы можем сделать конкретным в нашей системе. Рассматривая события как first-class вещи в нашей модели, мы делаем наш код более тестируемым и наблюдаемым, а также изолируем проблемы.</p></div>
<div class="paragraph"><p>И <a href="#chapter_08_events_and_message_bus_tradeoffs">[chapter_08_events_and_message_bus_tradeoffs]</a> показывает компромиссы, как мы их видим.</p></div>
<div class="tableblock" id="chapter_08_events_and_message_bus_tradeoffs">
<table rules="all"
width="100%"
frame="border"
cellspacing="0" cellpadding="4">
<caption class="title">Table 5. Domain events: компромиссы</caption>
<col width="50%" />
<col width="50%" />
<thead>
<tr>
<th align="left" valign="top">Плюсы</th>
<th align="left" valign="top">Минусы</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left" valign="top"><div><div class="ulist"><ul>
<li>
<p>
Шина сообщений (message bus) дает нам хороший способ разделить обязанности, когда мы должны предпринять несколько действий в ответ на запрос.
</p>
</li>
<li>
<p>
Обработчики событий (Event handlers) хорошо отделены от "основной" логики приложения, что позволяет легко изменить их реализацию позже.
</p>
</li>
<li>
<p>
Доменные события (Domain events)&#8201;&#8212;&#8201;это отличный способ моделирования реального мира, и мы можем использовать их как часть нашего делового языка при моделировании с заинтересованными сторонами.
</p>
</li>
</ul></div></div></td>
<td align="left" valign="top"><div><div class="ulist"><ul>
<li>
<p>
Шина сообщений&#8201;&#8212;&#8201;это еще одна вещь, которая кружит вам голову. Реализация, в которой единица работы вызывает для нас события, может это  <em>изящно</em>  и волшебно. Но, когда мы вызываем <code>commit</code>, не очевидно, что мы также собираемся отправить электронное письмо людям.
</p>
</li>
<li>
<p>
Более того, этот скрытый код обработки событий выполняется <em>synchronously</em>, что означает, что ваша функция уровня сервиса не завершится до тех пор, пока не будут завершены все обработчики для любых событий. Это может привести к неожиданным проблемам с производительностью в ваших web endpoints
  (adding asynchronous processing is possible but makes things even <em>more</em> confusing).

</p>
</li>
<li>
<p>
В более общем плане, управляемые событиями рабочие процессы могут сбивать с толку, потому что после того, как вещи разделены по цепочке из нескольких обработчиков, в системе нет единого места, где вы могли бы понять, как будет выполняться запрос.
</p>
</li>
<li>
<p>
Вы также открываете для себя возможность возникновения циклических зависимостей между вашими обработчиками событий и бесконечными циклами.


</p>
</li>
</ul></div></div></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p>Однако события полезны не только для отправки электронной почты. В <a href="#chapter_07_aggregate">[chapter_07_aggregate]</a> мы потратили много времени, убеждая вас, что вы должны определить агрегаты или границы, где мы гарантируем согласованность. Люди часто спрашивают: "Что мне делать, если мне нужно изменить несколько агрегатов в рамках запроса?" Теперь у нас есть инструменты, необходимые для ответа на этот вопрос.</p></div>
<div class="paragraph"><p>Если у нас есть две вещи, которые могут быть транзакционно изолированы (например, заказ и <span class=".keep-together">product</span>), то мы можем сделать их <em>eventually consistent</em> (в конечном итоге согласованными) с помощью событий. Когда заказ отменяется, мы должны найти продукты, которые были ему назначены, и удалить <span class=".keep-together">allocations</span>.</p></div>
<div class="sidebarblock nobreakinside less_space">
<div class="content">
<div class="title">Обзор Событий домена и шины сообщений</div>
<div class="paragraph"><p></p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
События способствуют реализации принципа единой ответственности
</dt>
<dd>
<p>
        Код запутывается, когда мы смешиваем несколько задач в одном месте. События могут помочь нам поддерживать порядок, отделяя основные варианты использования от второстепенных. Мы также используем события для связи между агрегатами, поэтому нам не нужно запускать длительные транзакции, которые блокируются для нескольких таблиц.
</p>
</dd>
<dt class="hdlist1">
Шина сообщений направляет сообщения обработчикам
</dt>
<dd>
<p>
    Вы можете думать о шине сообщений как о словаре, который сопоставляет события (events) с их потребителями(consumers). Словарь ничего не "знает" о смысле событий; это просто кусок тупой инфраструктуры для передачи сообщений по всей системе.
</p>
</dd>
<dt class="hdlist1">
Вариант 1: Уровень сервиса вызывает события и передает их в шину сообщений
</dt>
<dd>
<p>
    Самый простой способ начать использовать события в вашей системе-это вызвать их из обработчиков, вызвав <code>bus.handle(some_new_event)</code> после того, как вы зафиксируете свою единицу работы.
    
</p>
</dd>
<dt class="hdlist1">
Вариант 2: Доменная модель вызывает события, сервисный уровень передает их в шину сообщений
</dt>
<dd>
<p>
    Логика того, когда поднимать событие, действительно должна жить с моделью, таким образом, мы можем улучшить дизайн и тестируемость нашей системы, подняв события из модели предметной области. Наши обработчики легко собирают события с объектов модели после <code>commit</code> "фиксации" и передают их в шину.
    
</p>
</dd>
<dt class="hdlist1">
Вариант 3: UoW собирает события из агрегатов и передает их в шину сообщений
</dt>
<dd>
<p>
    Добавление bus.handle (aggregate.events) к каждому обработчику раздражает, поэтому мы можем прибраться, сделав нашу единицу работы ответственной за создание событий, которые были вызваны загруженными объектами. Это наиболее сложный дизайн, и он может полагаться на магию ORM, но после настройки он понятен и прост в использовании.
    
    
</p>
</dd>
</dl></div>
</div></div>
<div class="paragraph"><p>В <a href="#chapter_09_all_messagebus">[chapter_09_all_messagebus]</a> мы рассмотрим эту идею более подробно при построении более сложного рабочего процесса с нашей новой шиной сообщений.</p></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="chapter_09_all_messagebus">Едем в город на автобусе сообщений</h2>
<div class="sectionbody">
<div class="paragraph"><p>В этой главе мы начнем делать события более фундаментальными для внутренней структуры нашего приложения. Мы перейдем из текущего состояния в <a href="#maps_chapter_08_before">[maps_chapter_08_before]</a>, где события являются необязательным побочным эффектом &#8230;</p></div>
<div class="imageblock" id="maps_chapter_08_before">
<div class="content">
<img src="images/apwp_0901.png" alt="images/apwp_0901.png" />
</div>
<div class="title">Figure 31. Раньше: шина сообщений является необязательным дополнением</div>
</div>
<div class="paragraph"><p>&#8230;к ситуации в <a href="#map_chapter_08_after">[map_chapter_08_after]</a>, где всё идет по шине сообщений, а наше приложение было принципиально преобразовано в процессор сообщений.</p></div>
<div class="imageblock" id="map_chapter_08_after">
<div class="content">
<img src="images/apwp_0902.png" alt="images/apwp_0902.png" />
</div>
<div class="title">Figure 32. Шина сообщений теперь является основной точкой входа на уровень сервиса.</div>
</div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/tip.png" alt="Tip" />
</td>
<td class="content">
<div class="paragraph"><p>Код для этой главы находится в ветке chapter_09_all_messagebus. <a href="https://oreil.ly/oKNkn">на GitHub</a>:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>git clone https://github.com/cosmicpython/code.git
cd code
git checkout chapter_09_all_messagebus
# или, чтобы кодировать вместе, проверьте предыдущую главу:
git checkout chapter_08_events_and_message_bus</code></pre>
</div></div>
</td>
</tr></table>
</div>
<div class="sect2 pagebreak-before less_space">
<h3 id="_новое_требование_приводит_нас_к_новой_архитектуре">Новое требование приводит нас к новой архитектуре</h3>
<div class="paragraph"><p>Рич Хикки говорит о <em>situated software</em>, то есть о программном обеспечении, которое работает в течение длительных периодов времени, управляя реальным процессом. Примеры включают системы управления складом, логистические планировщики и системы расчета заработной платы.</p></div>
<div class="paragraph"><p>Такое программное обеспечение сложно написать, потому что в реальном мире физических объектов и ненадежных людей постоянно происходят неожиданные вещи. Например:</p></div>
<div class="ulist"><ul>
<li>
<p>
Во время инвентаризации мы обнаруживаем, что три <код>ПРУЖИННЫЙ МАТРАС</код>были повреждены водой из-за протекающей крыши.
</p>
</li>
<li>
<p>
У груза <code>RELIABLE-FORK</code>s отсутствует необходимая документация и он застрял на таможне, где находится уже в течение нескольких недель. Три  <code>RELIABLE-FORK</code>s впоследствии не проходят проверку безопасности и уничтожаются.
</p>
</li>
<li>
<p>
Глобальная нехватка блесток означает, что мы не сможем изготовить следующую партию <code>SPARKLY-BOOKCASE</code>.
</p>
</li>
</ul></div>
<div class="paragraph"><p>В таких ситуациях мы узнаем о необходимости изменения количества партий, когда они уже находятся в системе. Может быть, кто-то ошибся номером в декларации, а может быть, какие-то диваны упали с грузовика. После разговора с представителями компании<span class="footnote"><br />[ Моделирование на основе событий настолько популярно, что для облегчения сбора требований на основе событий и разработки модели предметной области была разработана практика под названием <em>event storming</em>.]<br /></span>

мы моделируем ситуацию, как на <a href="#batch_changed_events_flow_diagram">[batch_changed_events_flow_diagram]</a>.</p></div>
<div class="imageblock" id="batch_changed_events_flow_diagram">
<div class="content">
<img src="images/apwp_0903.png" alt="images/apwp_0903.png" />
</div>
<div class="title">Figure 33. Изменение количества партии означает освобождение и перераспределение (deallocate and reallocate)</div>
</div>
<div class="listingblock image-source">
<div class="content">
<pre><code>[ditaa, apwp_0903]
+----------+    /----\      +------------+       +--------------------+
| Batch    |--&gt; |RULE| --&gt;  | Deallocate | ----&gt; | AllocationRequired |
| Quantity |    \----/      +------------+-+     +--------------------+-+
| Changed  |                  | Deallocate | ----&gt; | AllocationRequired |
+----------+                  +------------+-+     +--------------------+-+
                                | Deallocate | ----&gt; | AllocationRequired |
                                +------------+       +--------------------+</code></pre>
</div></div>
<div class="paragraph"><p>Событие, которое мы назовем <code>BatchQuantityChanged</code>, должно привести нас к изменению количества в партии, да, но также и к применению <em>бизнес правила</em>: если новое количество опускается до меньшего, чем уже распределённое общее количество, нам нужно <em>dealocate</em> освободить места в этих заказы из этой партии. Затем каждый из них потребует нового распределения, которое мы можем зафиксировать как событие под названием <code>AllocationRequired</code> Требуемое распределение.</p></div>
<div class="paragraph"><p>Возможно, вы уже ожидаете, что наша внутренняя шина сообщений и события помогут реализовать это требование. Мы могли бы определить службу под названием <code>change_batch_quantity</code>, которая знает, как корректировать количество партий, а также как <em>deallocate</em> (освобождать) любые избыточные строки заказа, а затем каждое освобождение может генерировать событие <code>AllocationRequired</code>, которое может быть перенаправлено существующей службе <code>allocate</code> (распределения) в отдельные транзакции. И снова наша шина сообщений помогает нам обеспечивать соблюдение принципа единой ответственности и позволяет нам делать выбор в отношении транзакций и целостности данных.</p></div>
<div class="sect3">
<h4 id="_представим_себе_изменение_архитектуры_всё_будет_span_class_keep_together_event_handler_span_обработчик_событий">Представим себе изменение архитектуры: всё будет <span class=".keep-together">event handler</span> Обработчик событий</h4>
<div class="paragraph"><p>Но прежде чем запрыгнуть в это, подумай, куда мы направляемся.  Существует два вида потоков через нашу систему:</p></div>
<div class="ulist"><ul>
<li>
<p>
Вызовы API, которые обрабатываются функцией уровня сервиса
</p>
</li>
<li>
<p>
Внутренние события (которые могут быть вызваны как побочный эффект функции уровня сервиса) и их обработчики (которые, в свою очередь, вызывают функции уровня сервиса)
</p>
</li>
</ul></div>
<div class="paragraph"><p>Разве не было бы проще, если бы все было обработчиком событий?  Если мы переосмыслим наши вызовы API как захват событий, функции уровня сервиса также могут быть обработчиками событий, и нам больше не нужно проводить различие между внутренними и внешними обработчиками событий:</p></div>
<div class="ulist"><ul>
<li>
<p>
<code>services.allocate()</code> может быть обработчиком события <code>AllocationRequired</code> и может выдавать события <code>Allocated</code> в качестве его выходных данных.
</p>
</li>
<li>
<p>
<code>services.add_batch()</code> может быть обработчиком события <code>BatchCreated</code>.<span class="footnote"><br />[Если вы немного читали об архитектуре, управляемой событиями, вы можете подумать: "Некоторые из этих событий больше похожи на команды!" Терпение граждане! Мы пытаемся ввести одну концепцию за раз.   В <a href="#chapter_10_commands">следующая глава</a>, мы введем различие между командами и событиями.]<br /></span>
  
</p>
</li>
</ul></div>
<div class="paragraph"><p>Наше новое требование будет соответствовать той же схеме:</p></div>
<div class="ulist"><ul>
<li>
<p>
Событие под названием <code>BatchQuantityChanged</code> может вызывать обработчик под названием <code>change_batch_quantity()</code>.
  
</p>
</li>
<li>
<p>
И новые события <code>AllocationRequired</code>, которые он может вызвать, также могут быть переданы в `services.allocate() `, поэтому нет концептуальной разницы между совершенно новым распределением, исходящим от API, и перераспределением, которое запускается изнутри deallocate.
  
</p>
</li>
</ul></div>
<div class="paragraph"><p>Все это звучит как-то чересчур? Давайте работать над всем этим постепенно.  Мы будем следовать за рабочим процессом <a href="https://oreil.ly/W3RZM">Подготовительный рефакторинг</a>, он же гласит "Сделайте изменение легким; затем сделайте легкое изменение":</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
Мы рефакторингуем наш уровень обслуживания в обработчики событий. Мы можем привыкнуть к идее о том, что события-это способ описания входов в систему. В частности, существующая функция <code>services.allocate()</code> станет обработчиком события под названием <code>AllocationRequired</code>.
</p>
</li>
<li>
<p>
Мы создаем сквозной тест,который помещает события <code>BatchQuantityChanged</code> в систему и принимает выходящие события <code>Allocated</code>.
</p>
</li>
<li>
<p>
Наша реализация концептуально будет очень простой: новый обработчик событий <code>BatchQuantityChanged</code>, реализация которого будет выдавать события <code>AllocationRequired</code>, которые, в свою очередь, будут обрабатываться точно таким же обработчиком распределений, который использует API.
</p>
</li>
</ol></div>
<div class="paragraph"><p>По пути мы сделаем небольшую настройку шины сообщений и UoW, перенеся ответственность за размещение (put) новых событий на шине сообщений в саму шину сообщений.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_рефакторинг_сервисных_функций_для_обработчиков_сообщений">Рефакторинг сервисных функций для обработчиков сообщений</h3>
<div class="paragraph"><p>Мы начинаем с определения двух событий, которые фиксируют наши текущие входные данные API - <code> AllocationRequired </code> и <code>BatchCreated</code>:</p></div>
<div class="exampleblock" id="two_new_events">
<div class="title">Example 106. События BatchCreated и AllocationRequired (src/allocation/domain/events.py)</div>
<div class="content">
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">BatchCreated</span><span class="p">(</span><span class="n">Event</span><span class="p">):</span>
    <span class="n">ref</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">sku</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">qty</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">eta</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">date</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

<span class="o">...</span>

<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">AllocationRequired</span><span class="p">(</span><span class="n">Event</span><span class="p">):</span>
    <span class="n">orderid</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">sku</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">qty</span><span class="p">:</span> <span class="nb">int</span>
</pre></div></div></div>
</div></div>
<div class="paragraph"><p>Затем мы переименовываем <em>services.py</em> в <em>handlers.py</em>; мы добавляем обработчик текущих сообщений для <code>send_out_of_stock_notification</code>; и самое главное, мы меняем все обработчики так, чтобы у них были одинаковые входные данные, событие и UoW:</p></div>
<div class="exampleblock" id="services_to_handlers">
<div class="title">Example 107. Обработчики и сервисы - это одно и то же (src/allocation/service_layer/handlers.py)</div>
<div class="content">
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">add_batch</span><span class="p">(</span>
        <span class="n">event</span><span class="p">:</span> <span class="n">events</span><span class="o">.</span><span class="n">BatchCreated</span><span class="p">,</span> <span class="n">uow</span><span class="p">:</span> <span class="n">unit_of_work</span><span class="o">.</span><span class="n">AbstractUnitOfWork</span>
<span class="p">):</span>
    <span class="k">with</span> <span class="n">uow</span><span class="p">:</span>
        <span class="n">product</span> <span class="o">=</span> <span class="n">uow</span><span class="o">.</span><span class="n">products</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">sku</span><span class="o">=</span><span class="n">event</span><span class="o">.</span><span class="n">sku</span><span class="p">)</span>
        <span class="o">...</span>


<span class="k">def</span> <span class="nf">allocate</span><span class="p">(</span>
        <span class="n">event</span><span class="p">:</span> <span class="n">events</span><span class="o">.</span><span class="n">AllocationRequired</span><span class="p">,</span> <span class="n">uow</span><span class="p">:</span> <span class="n">unit_of_work</span><span class="o">.</span><span class="n">AbstractUnitOfWork</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">line</span> <span class="o">=</span> <span class="n">OrderLine</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">orderid</span><span class="p">,</span> <span class="n">event</span><span class="o">.</span><span class="n">sku</span><span class="p">,</span> <span class="n">event</span><span class="o">.</span><span class="n">qty</span><span class="p">)</span>
    <span class="o">...</span>


<span class="k">def</span> <span class="nf">send_out_of_stock_notification</span><span class="p">(</span>
        <span class="n">event</span><span class="p">:</span> <span class="n">events</span><span class="o">.</span><span class="n">OutOfStock</span><span class="p">,</span> <span class="n">uow</span><span class="p">:</span> <span class="n">unit_of_work</span><span class="o">.</span><span class="n">AbstractUnitOfWork</span><span class="p">,</span>
<span class="p">):</span>
    <span class="n">email</span><span class="o">.</span><span class="n">send</span><span class="p">(</span>
        <span class="s1">&#39;stock@made.com&#39;</span><span class="p">,</span>
        <span class="sa">f</span><span class="s1">&#39;Out of stock for </span><span class="si">{</span><span class="n">event</span><span class="o">.</span><span class="n">sku</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
    <span class="p">)</span>
</pre></div></div></div>
</div></div>
<div class="paragraph"><p>Это изменение станет более ясным если помотреть на различие:</p></div>
<div class="exampleblock" id="services_to_handlers_diff">
<div class="title">Example 108. Переход от сервисов к обработчикам (src/allocation/service_layer/handlers.py)</div>
<div class="content">
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span> def add_batch(
<span class="gd">-        ref: str, sku: str, qty: int, eta: Optional[date],</span>
<span class="gd">-        uow: unit_of_work.AbstractUnitOfWork</span>
<span class="gi">+        event: events.BatchCreated, uow: unit_of_work.AbstractUnitOfWork</span>
 ):
     with uow:
<span class="gd">-        product = uow.products.get(sku=sku)</span>
<span class="gi">+        product = uow.products.get(sku=event.sku)</span>
     ...


 def allocate(
<span class="gd">-        orderid: str, sku: str, qty: int,</span>
<span class="gd">-        uow: unit_of_work.AbstractUnitOfWork</span>
<span class="gi">+        event: events.AllocationRequired, uow: unit_of_work.AbstractUnitOfWork</span>
 ) -&gt; str:
<span class="gd">-    line = OrderLine(orderid, sku, qty)</span>
<span class="gi">+    line = OrderLine(event.orderid, event.sku, event.qty)</span>
     ...

<span class="gi">+</span>
<span class="gi">+def send_out_of_stock_notification(</span>
<span class="gi">+        event: events.OutOfStock, uow: unit_of_work.AbstractUnitOfWork,</span>
<span class="gi">+):</span>
<span class="gi">+    email.send(</span>
     ...
</pre></div></div></div>
</div></div>
<div class="paragraph"><p>Попутно мы сделали API нашего сервисного уровня более структурированным и последовательным. Это было рассеяние примитивов, и теперь используются четко определенные объекты (см. Следующую главу).</p></div>
<div class="sidebarblock nobreakinside less_space">
<div class="content">
<div class="title">От Domain Objects через Primitive Obsession к <span class=". keep-together">событиям в качестве интерфейса</span></div>
<div class="paragraph"><p>Некоторые из вас, возможно, помнят <a href="#primitive_obsession">[primitive_obsession]</a>, в котором мы изменили наш API сервисного уровня с точки зрения доменных объектов на примитивы. А теперь мы возвращаемся назад, но к другим объектам?  Что это дает?</p></div>
<div class="paragraph"><p>В кругах ОО люди говорят о <em>primitive obsession</em> как об антипаттере: Они скорее всего порекомендовали  бы, избегать примитивов в общедоступных API и вместо этого оборачивать их пользовательскими классами значений. В мире Python многие люди отнесутся к этому весьма скептически. При бездумном применении это, безусловно, рецепт ненужной сложности. Так что, по сути, мы этим не занимаемся.</p></div>
<div class="paragraph"><p>Переход от доменных объектов к примитивам принес нам хорошую развязку: наш клиентский код больше не был связан непосредственно с доменом, поэтому уровень сервиса мог представить API, который остается неизменным, даже если мы решим внести изменения в нашу модель, и наоборот.</p></div>
<div class="paragraph"><p>Итак, мы отступили? Ну, наши основные объекты модели предметной области по-прежнему свободны варьироваться, но вместо этого мы связали внешний мир с нашими классами событий. Они тоже часть домена, но есть надежда, что они меняются реже, так что они разумный артефакт для пары.</p></div>
<div class="paragraph"><p>И что мы приобрели? Теперь при вызове варианта использования в нашем приложении нам больше не нужно запоминать конкретную комбинацию примитивов, а только один класс событий, представляющий входные данные для нашего приложения. Это концептуально довольно мило. Кроме того, как вы увидите в <a href="#appendix_validation">[appendix_validation]</a>, эти классы событий могут быть хорошим местом для некоторой проверки входных данных.</p></div>
</div></div>
<div class="sect3">
<h4 id="_the_message_bus_now_collects_events_from_the_uow">The Message Bus Now Collects Events from the UoW</h4>
<div class="paragraph"><p>Наши обработчики событий теперь нуждаются в UoW. Кроме того, поскольку наша шина сообщений становится всё более центральной для нашего приложения, имеет смысл явно возложить на неё ответственность за сбор и обработку новых событий. До сих пор существовала некоторая циклическая зависимость между UoW и шиной сообщений, так что это сделает её односторонней.  Вместо того, чтобы иметь события UoW <em>push</em> на шине сообщений, мы будем иметь события message bus <em>pull</em> из UoW.</p></div>
<div class="exampleblock" id="handle_has_uow_and_queue">
<div class="title">Example 109. Handle принимает UoW и управляет очередью (src/allocation/service_layer/messagebus.py)</div>
<div class="content">
<div class="listingblock non-head">
<div class="content"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">handle</span><span class="p">(</span><span class="n">event</span><span class="p">:</span> <span class="n">events</span><span class="o">.</span><span class="n">Event</span><span class="p">,</span> <span class="n">uow</span><span class="p">:</span> <span class="n">unit_of_work</span><span class="o">.</span><span class="n">AbstractUnitOfWork</span><span class="p">):</span>  <span class="c1">#<img src="./images/icons/callouts/1.png" alt="1" /></span>
    <span class="n">queue</span> <span class="o">=</span> <span class="p">[</span><span class="n">event</span><span class="p">]</span>  <span class="c1">#<img src="./images/icons/callouts/2.png" alt="2" /></span>
    <span class="k">while</span> <span class="n">queue</span><span class="p">:</span>
        <span class="n">event</span> <span class="o">=</span> <span class="n">queue</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  <span class="c1">#<img src="./images/icons/callouts/3.png" alt="3" /></span>
        <span class="k">for</span> <span class="n">handler</span> <span class="ow">in</span> <span class="n">HANDLERS</span><span class="p">[</span><span class="nb">type</span><span class="p">(</span><span class="n">event</span><span class="p">)]:</span>  <span class="c1">#<img src="./images/icons/callouts/3.png" alt="3" /></span>
            <span class="n">handler</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">uow</span><span class="o">=</span><span class="n">uow</span><span class="p">)</span>  <span class="c1">#<img src="./images/icons/callouts/4.png" alt="4" /></span>
            <span class="n">queue</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">uow</span><span class="o">.</span><span class="n">collect_new_events</span><span class="p">())</span>  <span class="c1">#<img src="./images/icons/callouts/5.png" alt="5" /></span>
</pre></div></div></div>
</div></div>
<div class="colist arabic"><table>
<tr><td><img src="./images/icons/callouts/1.png" alt="1" /></td><td>
Шина сообщений теперь проходит UoW при каждом запуске.
</td></tr>
<tr><td><img src="./images/icons/callouts/2.png" alt="2" /></td><td>
Когда мы начинаем обрабатывать наше первое событие, мы запускаем очередь.
</td></tr>
<tr><td><img src="./images/icons/callouts/3.png" alt="3" /></td><td>
Мы извлекаем события из передней части очереди и вызываем их обработчики (<span class=". keep-together"><code>HANDLERS</code></span> dict не изменился; он по-прежнему сопоставляет типы событий с функциями обработчиков).
</td></tr>
<tr><td><img src="./images/icons/callouts/4.png" alt="4" /></td><td>
Шина сообщений передает UoW каждому обработчику.
</td></tr>
<tr><td><img src="./images/icons/callouts/5.png" alt="5" /></td><td>
После завершения каждого обработчика мы собираем все новые сгенерированные события и добавляем их в очередь.
</td></tr>
</table></div>
<div class="paragraph"><p>В <em>unit_of_work.py</em> 'publish_events()` становится менее активным методом, <code>collect_new_events()</code>:</p></div>
<div class="exampleblock" id="uow_collect_new_events">
<div class="title">Example 110. UoW больше не помещает события прямо в шину (src/allocation/service_layer/unit_of_work.py)</div>
<div class="content">
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span><span class="gd">-from . import messagebus  #<img src="./images/icons/callouts/1.png" alt="1" /></span>
<span class="gd">-</span>


 class AbstractUnitOfWork(abc.ABC):
<span class="gu">@@ -23,13 +21,11 @@ class AbstractUnitOfWork(abc.ABC):</span>

     def commit(self):
         self._commit()
<span class="gd">-        self.publish_events()  #<img src="./images/icons/callouts/2.png" alt="2" /></span>

<span class="gd">-    def publish_events(self):</span>
<span class="gi">+    def collect_new_events(self):</span>
         for product in self.products.seen:
             while product.events:
<span class="gd">-                event = product.events.pop(0)</span>
<span class="gd">-                messagebus.handle(event)</span>
<span class="gi">+                yield product.events.pop(0)  #<img src="./images/icons/callouts/3.png" alt="3" /></span>
</pre></div></div></div>
</div></div>
<div class="colist arabic"><table>
<tr><td><img src="./images/icons/callouts/1.png" alt="1" /></td><td>
Модуль <code>unit_of_work</code> теперь больше не зависит от <code>messagebus</code>.
</td></tr>
<tr><td><img src="./images/icons/callouts/2.png" alt="2" /></td><td>
Мы больше не выполняем <code>publish_events</code> автоматически при фиксации. Вместо этого шина сообщений отслеживает очередь событий.
</td></tr>
<tr><td><img src="./images/icons/callouts/3.png" alt="3" /></td><td>
И UoW больше не размещает активные события в шину сообщений; он просто делает их доступными.
</td></tr>
</table></div>
</div>
<div class="sect3 pagebreak-before less_space">
<h4 id="_наши_тесты_тоже_написаны_в_терминах_событий">Наши тесты тоже написаны в терминах событий</h4>
<div class="paragraph"><p>Наши тесты теперь работают, создавая события и помещая их в шину сообщений, а не вызывая функции сервисного уровня напрямую:</p></div>
<div class="exampleblock" id="handler_tests">
<div class="title">Example 111. Тесты обработчиков используют события (tests/unit/test_handlers.py)</div>
<div class="content">
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span>class TestAddBatch:

     def test_for_new_product(self):
         uow = FakeUnitOfWork()
<span class="gd">-        services.add_batch(&quot;b1&quot;, &quot;CRUNCHY-ARMCHAIR&quot;, 100, None, uow)</span>
<span class="gi">+        messagebus.handle(</span>
<span class="gi">+            events.BatchCreated(&quot;b1&quot;, &quot;CRUNCHY-ARMCHAIR&quot;, 100, None), uow</span>
<span class="gi">+        )</span>
         assert uow.products.get(&quot;CRUNCHY-ARMCHAIR&quot;) is not None
         assert uow.committed

...

 class TestAllocate:

     def test_returns_allocation(self):
         uow = FakeUnitOfWork()
<span class="gd">-        services.add_batch(&quot;batch1&quot;, &quot;COMPLICATED-LAMP&quot;, 100, None, uow)</span>
<span class="gd">-        result = services.allocate(&quot;o1&quot;, &quot;COMPLICATED-LAMP&quot;, 10, uow)</span>
<span class="gi">+        messagebus.handle(</span>
<span class="gi">+            events.BatchCreated(&quot;batch1&quot;, &quot;COMPLICATED-LAMP&quot;, 100, None), uow</span>
<span class="gi">+        )</span>
<span class="gi">+        result = messagebus.handle(</span>
<span class="gi">+            events.AllocationRequired(&quot;o1&quot;, &quot;COMPLICATED-LAMP&quot;, 10), uow</span>
<span class="gi">+        )</span>
         assert result == &quot;batch1&quot;
</pre></div></div></div>
</div></div>
</div>
<div class="sect3">
<h4 id="temporary_ugly_hack">Временный Наглый Взлом:  шина сообщений должна возвращать результаты</h4>
<div class="paragraph"><p>Наш API и наш уровень сервиса в настоящее время хотят узнать выделенную ссылку на пакет, когда они вызывают наш обработчик <code>allocate()</code>. Это означает, что нам нужно временно взломать нашу шину сообщений, чтобы она возвращала события:</p></div>
<div class="exampleblock" id="hack_messagebus_results">
<div class="title">Example 112. Message bus returns results (src/allocation/service_layer/messagebus.py)</div>
<div class="content">
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span> def handle(event: events.Event, uow: unit_of_work.AbstractUnitOfWork):
<span class="gi">+    results = []</span>
     queue = [event]
     while queue:
         event = queue.pop(0)
         for handler in HANDLERS[type(event)]:
<span class="gd">-            handler(event, uow=uow)</span>
<span class="gi">+            results.append(handler(event, uow=uow))</span>
             queue.extend(uow.collect_new_events())
<span class="gi">+    return results</span>
</pre></div></div></div>
</div></div>
<div class="paragraph"><p>Это потому, что мы смешиваем обязанности чтения и записи в нашей системе. Мы вернемся, чтобы исправить эту неприятность в <a href="#chapter_12_cqrs">[chapter_12_cqrs]</a>.</p></div>
</div>
<div class="sect3">
<h4 id="_изменение_нашего_api_для_работы_с_событиями">Изменение нашего API для работы с событиями</h4>
<div class="exampleblock" id="flask_uses_messagebus">
<div class="title">Example 113. Diff при замене Flask на шину сообщений (src/allocation/entrypoints/flask_app.py)</div>
<div class="content">
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span> @app.route(&quot;/allocate&quot;, methods=[&#39;POST&#39;])
 def allocate_endpoint():
     try:
<span class="gd">-        batchref = services.allocate(</span>
<span class="gd">-            request.json[&#39;orderid&#39;],  #<img src="./images/icons/callouts/1.png" alt="1" /></span>
<span class="gd">-            request.json[&#39;sku&#39;],</span>
<span class="gd">-            request.json[&#39;qty&#39;],</span>
<span class="gd">-            unit_of_work.SqlAlchemyUnitOfWork(),</span>
<span class="gi">+        event = events.AllocationRequired(  #<img src="./images/icons/callouts/2.png" alt="2" /></span>
<span class="gi">+            request.json[&#39;orderid&#39;], request.json[&#39;sku&#39;], request.json[&#39;qty&#39;],</span>
         )
<span class="gi">+        results = messagebus.handle(event, unit_of_work.SqlAlchemyUnitOfWork())  #<img src="./images/icons/callouts/3.png" alt="3" /></span>
<span class="gi">+        batchref = results.pop(0)</span>
     except InvalidSku as e:
</pre></div></div></div>
</div></div>
<div class="colist arabic"><table>
<tr><td><img src="./images/icons/callouts/1.png" alt="1" /></td><td>
Вместо вызова уровня сервиса с кучей примитивов, извлеченных из запроса JSON &#8230;
</td></tr>
<tr><td><img src="./images/icons/callouts/2.png" alt="2" /></td><td>
Создаем событие.
</td></tr>
<tr><td><img src="./images/icons/callouts/3.png" alt="3" /></td><td>
Затем передаем его в шину сообщений.
</td></tr>
</table></div>
<div class="paragraph"><p>И мы должны вернуться к полностью функциональному приложению, но теперь полностью управляемому событиями:</p></div>
<div class="ulist"><ul>
<li>
<p>
То, что раньше было функциями сервисного уровня, теперь стало обработчиками событий.
</p>
</li>
<li>
<p>
Это делает их такими же, как функции, которые мы вызываем для обработки внутренних событий, вызванных нашей моделью предметной области.
</p>
</li>
<li>
<p>
Мы используем события в качестве структуры данных для сбора входных данных в систему, а также для передачи внутренних рабочих пакетов.
</p>
</li>
<li>
<p>
Теперь все приложение лучше всего описать как процессор сообщений или, если хотите, процессор событий.  Мы поговорим об этом различии в следующей главе<a href="#chapter_10_commands">[chapter_10_commands]</a>.
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="_реализация_нашего_нового_требования_requirement">Реализация нашего нового требования (Requirement)</h3>
<div class="paragraph"><p>Мы закончили с фазой рефакторинга. Давайте посмотрим, действительно ли мы "сделали изменение легким."  Давайте реализуем наше новое требование, показанное в <a href="#reallocation_sequence_diagram">[reallocation_sequence_diagram]</a>: мы получим в качестве входных данных некоторые новые события <code>BatchQuantityChanged</code> и передадим их обработчику, который, в свою очередь, может выдать некоторые события <code>AllocationRequired</code>, а те, в свою очередь, вернутся к нашему существующему обработчику для перераспределения.</p></div>
<div class="imageblock width-75" id="reallocation_sequence_diagram">
<div class="content">
<img src="images/apwp_0904.png" alt="images/apwp_0904.png" />
</div>
<div class="title">Figure 34. Диаграмма последовательности для потока перераспределения</div>
</div>
<div class="listingblock image-source">
<div class="content">
<pre><code>[plantuml, apwp_0904, config=plantuml.cfg]
@startuml
scale 4

API -&gt; MessageBus : BatchQuantityChanged event

group BatchQuantityChanged Handler + Unit of Work 1
    MessageBus -&gt; Domain_Model : change batch quantity
    Domain_Model -&gt; MessageBus : emit AllocationRequired event(s)
end


group AllocationRequired Handler + Unit of Work 2 (or more)
    MessageBus -&gt; Domain_Model : allocate
end

@enduml</code></pre>
</div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/warning.png" alt="Warning" />
</td>
<td class="content">Когда вы разделяете вещи таким образом на две единицы работы, то у вас получаются две транзакции базы данных, поэтому вы открываете себя для проблем целостности: что-то может произойти, и это означает, что первая транзакция завершается, а вторая-нет. Вам нужно будет подумать о том, приемлемо ли это, и нужно ли вам замечать, когда это происходит, и что-то с этим делать.     См. <a href="#footguns">[footguns]</a> для более подробного обсуждения.
    
    </td>
</tr></table>
</div>
<div class="sect3">
<h4 id="_наше_новое_событие">Наше новое событие</h4>
<div class="paragraph"><p>Событие, которое говорит нам, что количество партии изменилось, простое; ему просто нужна ссылка на партию и новое количество:</p></div>
<div class="exampleblock" id="batch_quantity_changed_event">
<div class="title">Example 114. Новое событие (src/allocation/domain/events.py)</div>
<div class="content">
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">BatchQuantityChanged</span><span class="p">(</span><span class="n">Event</span><span class="p">):</span>
    <span class="n">ref</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">qty</span><span class="p">:</span> <span class="nb">int</span>
</pre></div></div></div>
</div></div>
</div>
</div>
<div class="sect2">
<h3 id="test-driving-ch9">Test-Driving нового Handler</h3>
<div class="paragraph"><p>Следуя урокам, извлеченным из <a href="#chapter_04_service_layer">[chapter_04_service_layer]</a>, мы можем работать на «высокой передаче» и писать наши модульные тесты на максимально возможном уровне абстракции с точки зрения событий. Вот как они могут выглядеть:</p></div>
<div class="exampleblock" id="test_change_batch_quantity_handler">
<div class="title">Example 115. Тесты обработчика для change_batch_quantity (tests/unit/test_handlers.py)</div>
<div class="content">
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">TestChangeBatchQuantity</span><span class="p">:</span>

    <span class="k">def</span> <span class="nf">test_changes_available_quantity</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">uow</span> <span class="o">=</span> <span class="n">FakeUnitOfWork</span><span class="p">()</span>
        <span class="n">messagebus</span><span class="o">.</span><span class="n">handle</span><span class="p">(</span>
            <span class="n">events</span><span class="o">.</span><span class="n">BatchCreated</span><span class="p">(</span><span class="s2">&quot;batch1&quot;</span><span class="p">,</span> <span class="s2">&quot;ADORABLE-SETTEE&quot;</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="n">uow</span>
        <span class="p">)</span>
        <span class="p">[</span><span class="n">batch</span><span class="p">]</span> <span class="o">=</span> <span class="n">uow</span><span class="o">.</span><span class="n">products</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">sku</span><span class="o">=</span><span class="s2">&quot;ADORABLE-SETTEE&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">batches</span>
        <span class="k">assert</span> <span class="n">batch</span><span class="o">.</span><span class="n">available_quantity</span> <span class="o">==</span> <span class="mi">100</span>  <span class="c1">#<img src="./images/icons/callouts/1.png" alt="1" /></span>

        <span class="n">messagebus</span><span class="o">.</span><span class="n">handle</span><span class="p">(</span><span class="n">events</span><span class="o">.</span><span class="n">BatchQuantityChanged</span><span class="p">(</span><span class="s2">&quot;batch1&quot;</span><span class="p">,</span> <span class="mi">50</span><span class="p">),</span> <span class="n">uow</span><span class="p">)</span>

        <span class="k">assert</span> <span class="n">batch</span><span class="o">.</span><span class="n">available_quantity</span> <span class="o">==</span> <span class="mi">50</span>  <span class="c1">#<img src="./images/icons/callouts/1.png" alt="1" /></span>


    <span class="k">def</span> <span class="nf">test_reallocates_if_necessary</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">uow</span> <span class="o">=</span> <span class="n">FakeUnitOfWork</span><span class="p">()</span>
        <span class="n">event_history</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">events</span><span class="o">.</span><span class="n">BatchCreated</span><span class="p">(</span><span class="s2">&quot;batch1&quot;</span><span class="p">,</span> <span class="s2">&quot;INDIFFERENT-TABLE&quot;</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="n">events</span><span class="o">.</span><span class="n">BatchCreated</span><span class="p">(</span><span class="s2">&quot;batch2&quot;</span><span class="p">,</span> <span class="s2">&quot;INDIFFERENT-TABLE&quot;</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">()),</span>
            <span class="n">events</span><span class="o">.</span><span class="n">AllocationRequired</span><span class="p">(</span><span class="s2">&quot;order1&quot;</span><span class="p">,</span> <span class="s2">&quot;INDIFFERENT-TABLE&quot;</span><span class="p">,</span> <span class="mi">20</span><span class="p">),</span>
            <span class="n">events</span><span class="o">.</span><span class="n">AllocationRequired</span><span class="p">(</span><span class="s2">&quot;order2&quot;</span><span class="p">,</span> <span class="s2">&quot;INDIFFERENT-TABLE&quot;</span><span class="p">,</span> <span class="mi">20</span><span class="p">),</span>
        <span class="p">]</span>
        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">event_history</span><span class="p">:</span>
            <span class="n">messagebus</span><span class="o">.</span><span class="n">handle</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">uow</span><span class="p">)</span>
        <span class="p">[</span><span class="n">batch1</span><span class="p">,</span> <span class="n">batch2</span><span class="p">]</span> <span class="o">=</span> <span class="n">uow</span><span class="o">.</span><span class="n">products</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">sku</span><span class="o">=</span><span class="s2">&quot;INDIFFERENT-TABLE&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">batches</span>
        <span class="k">assert</span> <span class="n">batch1</span><span class="o">.</span><span class="n">available_quantity</span> <span class="o">==</span> <span class="mi">10</span>
        <span class="k">assert</span> <span class="n">batch2</span><span class="o">.</span><span class="n">available_quantity</span> <span class="o">==</span> <span class="mi">50</span>

        <span class="n">messagebus</span><span class="o">.</span><span class="n">handle</span><span class="p">(</span><span class="n">events</span><span class="o">.</span><span class="n">BatchQuantityChanged</span><span class="p">(</span><span class="s2">&quot;batch1&quot;</span><span class="p">,</span> <span class="mi">25</span><span class="p">),</span> <span class="n">uow</span><span class="p">)</span>

        <span class="c1"># order1 or order2 will be deallocated, so we&#39;ll have 25 - 20</span>
        <span class="k">assert</span> <span class="n">batch1</span><span class="o">.</span><span class="n">available_quantity</span> <span class="o">==</span> <span class="mi">5</span>  <span class="c1">#<img src="./images/icons/callouts/2.png" alt="2" /></span>
        <span class="c1"># and 20 will be reallocated to the next batch</span>
        <span class="k">assert</span> <span class="n">batch2</span><span class="o">.</span><span class="n">available_quantity</span> <span class="o">==</span> <span class="mi">30</span>  <span class="c1">#<img src="./images/icons/callouts/2.png" alt="2" /></span>
</pre></div></div></div>
</div></div>
<div class="colist arabic"><table>
<tr><td><img src="./images/icons/callouts/1.png" alt="1" /></td><td>
Простой случай будет тривиально легко реализовать; мы просто модифицируем количество.
</td></tr>
<tr><td><img src="./images/icons/callouts/2.png" alt="2" /></td><td>
Но если мы попытаемся изменить количество на меньшее, чем было выделено, нам нужно будет исключить по крайней мере один заказ, и перераспределить его на новую ожидаемую партию.
</td></tr>
</table></div>
<div class="sect3">
<h4 id="_реализация">Реализация</h4>
<div class="paragraph"><p>Наш новый обработчик очень прост:</p></div>
<div class="exampleblock" id="change_quantity_handler">
<div class="title">Example 116. Обработчик делегирует уровень модели (src/allocation/service_layer/handlers.py)</div>
<div class="content">
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">change_batch_quantity</span><span class="p">(</span>
        <span class="n">event</span><span class="p">:</span> <span class="n">events</span><span class="o">.</span><span class="n">BatchQuantityChanged</span><span class="p">,</span> <span class="n">uow</span><span class="p">:</span> <span class="n">unit_of_work</span><span class="o">.</span><span class="n">AbstractUnitOfWork</span>
<span class="p">):</span>
    <span class="k">with</span> <span class="n">uow</span><span class="p">:</span>
        <span class="n">product</span> <span class="o">=</span> <span class="n">uow</span><span class="o">.</span><span class="n">products</span><span class="o">.</span><span class="n">get_by_batchref</span><span class="p">(</span><span class="n">batchref</span><span class="o">=</span><span class="n">event</span><span class="o">.</span><span class="n">ref</span><span class="p">)</span>
        <span class="n">product</span><span class="o">.</span><span class="n">change_batch_quantity</span><span class="p">(</span><span class="n">ref</span><span class="o">=</span><span class="n">event</span><span class="o">.</span><span class="n">ref</span><span class="p">,</span> <span class="n">qty</span><span class="o">=</span><span class="n">event</span><span class="o">.</span><span class="n">qty</span><span class="p">)</span>
        <span class="n">uow</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</pre></div></div></div>
</div></div>
<div class="paragraph"><p>Мы понимаем, что нам понадобится новый тип запроса в нашем репозитории:</p></div>
<div class="exampleblock" id="get_by_batchref">
<div class="title">Example 117. Новый тип запроса в нашем репозитории (src/allocation/adapters/repository.py)</div>
<div class="content">
<div class="listingblock">
<div class="content"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">AbstractRepository</span><span class="p">(</span><span class="n">abc</span><span class="o">.</span><span class="n">ABC</span><span class="p">):</span>
    <span class="o">...</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sku</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">model</span><span class="o">.</span><span class="n">Product</span><span class="p">:</span>
        <span class="o">...</span>

    <span class="k">def</span> <span class="nf">get_by_batchref</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batchref</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">model</span><span class="o">.</span><span class="n">Product</span><span class="p">:</span>
        <span class="n">product</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_by_batchref</span><span class="p">(</span><span class="n">batchref</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">product</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">seen</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">product</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">product</span>

    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">_add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">product</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">Product</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">_get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sku</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">model</span><span class="o">.</span><span class="n">Product</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">_get_by_batchref</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batchref</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">model</span><span class="o">.</span><span class="n">Product</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>
    <span class="o">...</span>

<span class="k">class</span> <span class="nc">SqlAlchemyRepository</span><span class="p">(</span><span class="n">AbstractRepository</span><span class="p">):</span>
    <span class="o">...</span>

    <span class="k">def</span> <span class="nf">_get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sku</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">Product</span><span class="p">)</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">sku</span><span class="o">=</span><span class="n">sku</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_get_by_batchref</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batchref</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">Product</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">Batch</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">orm</span><span class="o">.</span><span class="n">batches</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">reference</span> <span class="o">==</span> <span class="n">batchref</span><span class="p">,</span>
        <span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
</pre></div>
</td></tr></table></div></div>
</div></div>
<div class="paragraph"><p>И в нашем FakeRepository:</p></div>
<div class="exampleblock" id="fakerepo_get_by_batchref">
<div class="title">Example 118. Обновление фейкового репо тоже (tests/unit/test_handlers.py)</div>
<div class="content">
<div class="listingblock non-head">
<div class="content"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">FakeRepository</span><span class="p">(</span><span class="n">repository</span><span class="o">.</span><span class="n">AbstractRepository</span><span class="p">):</span>
    <span class="o">...</span>

    <span class="k">def</span> <span class="nf">_get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sku</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">next</span><span class="p">((</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_products</span> <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">sku</span> <span class="o">==</span> <span class="n">sku</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_by_batchref</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batchref</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">next</span><span class="p">((</span>
            <span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_products</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">batches</span>
            <span class="k">if</span> <span class="n">b</span><span class="o">.</span><span class="n">reference</span> <span class="o">==</span> <span class="n">batchref</span>
        <span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
</pre></div></div></div>
</div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note" />
</td>
<td class="content">Мы добавляем запрос в наш репозиторий, чтобы упростить реализацию этого варианта использования. Пока наш запрос возвращает единственную совокупность, мы не нарушаем никаких правил. Если вы обнаружите, что пишете сложные запросы к своим репозиториям, возможно, вам захочется рассмотреть другой дизайн. Такие методы, как <code>get_most_popular_products</code> или <code>find_products_by_order_id</code>, в частности, определенно вызовут щекотку в области нашего шестого чувства. В <a href="#chapter_11_external_events">[chapter_11_external_events]</a> и <a href="#epilogue_1_how_to_get_there_from_here">epilogue</a> есть несколько советов по управлению сложными запросами.
    </td>
</tr></table>
</div>
</div>
<div class="sect3">
<h4 id="_новый_метод_модели_предметной_области">Новый метод модели предметной области</h4>
<div class="paragraph"><p>Мы добавляем в модель новый метод, который выполняет изменение количества и освобождение(ий) встроенным и публикует новое событие. Мы также модифицируем существующую функцию выделения для публикации события:</p></div>
<div class="exampleblock" id="change_batch_model_layer">
<div class="title">Example 119. Наша модель развивается в соответствии с новыми требованиями (src/allocation/domain/model.py)</div>
<div class="content">
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Product</span><span class="p">:</span>
    <span class="o">...</span>

    <span class="k">def</span> <span class="nf">change_batch_quantity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ref</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">qty</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="n">batch</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">b</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">batches</span> <span class="k">if</span> <span class="n">b</span><span class="o">.</span><span class="n">reference</span> <span class="o">==</span> <span class="n">ref</span><span class="p">)</span>
        <span class="n">batch</span><span class="o">.</span><span class="n">_purchased_quantity</span> <span class="o">=</span> <span class="n">qty</span>
        <span class="k">while</span> <span class="n">batch</span><span class="o">.</span><span class="n">available_quantity</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">batch</span><span class="o">.</span><span class="n">deallocate_one</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">events</span><span class="o">.</span><span class="n">AllocationRequired</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">orderid</span><span class="p">,</span> <span class="n">line</span><span class="o">.</span><span class="n">sku</span><span class="p">,</span> <span class="n">line</span><span class="o">.</span><span class="n">qty</span><span class="p">)</span>
            <span class="p">)</span>
<span class="o">...</span>

<span class="k">class</span> <span class="nc">Batch</span><span class="p">:</span>
    <span class="o">...</span>

    <span class="k">def</span> <span class="nf">deallocate_one</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">OrderLine</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_allocations</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
</pre></div></div></div>
</div></div>
<div class="paragraph"><p>Подключаем наш новый обработчик:</p></div>
<div class="exampleblock" id="full_messagebus">
<div class="title">Example 120. Шина сообщений растет (src/allocation/service_layer/messagebus.py)</div>
<div class="content">
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span><span class="n">HANDLERS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">events</span><span class="o">.</span><span class="n">BatchCreated</span><span class="p">:</span> <span class="p">[</span><span class="n">handlers</span><span class="o">.</span><span class="n">add_batch</span><span class="p">],</span>
    <span class="n">events</span><span class="o">.</span><span class="n">BatchQuantityChanged</span><span class="p">:</span> <span class="p">[</span><span class="n">handlers</span><span class="o">.</span><span class="n">change_batch_quantity</span><span class="p">],</span>
    <span class="n">events</span><span class="o">.</span><span class="n">AllocationRequired</span><span class="p">:</span> <span class="p">[</span><span class="n">handlers</span><span class="o">.</span><span class="n">allocate</span><span class="p">],</span>
    <span class="n">events</span><span class="o">.</span><span class="n">OutOfStock</span><span class="p">:</span> <span class="p">[</span><span class="n">handlers</span><span class="o">.</span><span class="n">send_out_of_stock_notification</span><span class="p">],</span>

<span class="p">}</span>  <span class="c1"># type: Dict[Type[events.Event], List[Callable]]</span>
</pre></div></div></div>
</div></div>
<div class="paragraph"><p>И наше новое требование полностью выполнено.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="fake_message_bus">Опционально: Модульное тестирование Event Handlers изолированно с Fake Message Bus</h3>
<div class="paragraph"><p>Наш основной тест для рабочего процесса перераспределения-это <em>edge-to-edge</em> (см. Пример кода в <a href="#test-driving-ch9">[test-driving-ch9]</a>). Он использует реальную шину сообщений и тестирует весь поток, где обработчик событий <code>BatchQuantityChanged</code> запускает освобождение и выдает новые события <code>AllocationRequired</code>, которые, в свою очередь, обрабатываются их собственными обработчиками. Один тест охватывает цепочку из нескольких событий и обработчиков.</p></div>
<div class="paragraph"><p>В зависимости от сложности цепочки событий вы можете решить, что хотите протестировать некоторые обработчики отдельно друг от друга. Вы можете сделать это с помощью "поддельной" шины сообщений.</p></div>
<div class="paragraph"><p>В нашем случае мы фактически вмешиваемся, изменяя метод <code>publish_events()</code> в <code>FakeUnitOfWork</code> и отделяя его от реальной шины сообщений, вместо этого заставляя его записывать события, которые он видит:</p></div>
<div class="exampleblock" id="fake_messagebus">
<div class="title">Example 121. Шина фальшивых сообщений реализована в UoW (tests/unit/test_handlers.py)</div>
<div class="content">
<div class="listingblock non-head">
<div class="content"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">FakeUnitOfWorkWithFakeMessageBus</span><span class="p">(</span><span class="n">FakeUnitOfWork</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">events_published</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># type: List[events.Event]</span>

    <span class="k">def</span> <span class="nf">publish_events</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">product</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">products</span><span class="o">.</span><span class="n">seen</span><span class="p">:</span>
            <span class="k">while</span> <span class="n">product</span><span class="o">.</span><span class="n">events</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">events_published</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">product</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
</pre></div></div></div>
</div></div>
<div class="paragraph"><p>Теперь, когда мы вызываем <code>messagebus.handle()</code> используя <code>FakeUnitOfWorkWithFakeMessageBus</code>, он запускает только обработчик этого события. Таким образом, мы можем написать более изолированный модульный тест: вместо проверки всех побочных эффектов мы просто проверяем, что <code>BatchQuantityChanged</code> приводит к <code>AllocationRequired</code>, если количество падает ниже уже выделенного общего количества:</p></div>
<div class="exampleblock nobreakinside less_space" id="test_handler_in_isolation">
<div class="title">Example 122. Тестирование перераспределения в изоляции (tests/unit/test_handlers.py)</div>
<div class="content">
<div class="listingblock non-head">
<div class="content"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">test_reallocates_if_necessary_isolated</span><span class="p">():</span>
    <span class="n">uow</span> <span class="o">=</span> <span class="n">FakeUnitOfWorkWithFakeMessageBus</span><span class="p">()</span>

    <span class="c1"># test setup as before</span>
    <span class="n">event_history</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">events</span><span class="o">.</span><span class="n">BatchCreated</span><span class="p">(</span><span class="s2">&quot;batch1&quot;</span><span class="p">,</span> <span class="s2">&quot;INDIFFERENT-TABLE&quot;</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
        <span class="n">events</span><span class="o">.</span><span class="n">BatchCreated</span><span class="p">(</span><span class="s2">&quot;batch2&quot;</span><span class="p">,</span> <span class="s2">&quot;INDIFFERENT-TABLE&quot;</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">()),</span>
        <span class="n">events</span><span class="o">.</span><span class="n">AllocationRequired</span><span class="p">(</span><span class="s2">&quot;order1&quot;</span><span class="p">,</span> <span class="s2">&quot;INDIFFERENT-TABLE&quot;</span><span class="p">,</span> <span class="mi">20</span><span class="p">),</span>
        <span class="n">events</span><span class="o">.</span><span class="n">AllocationRequired</span><span class="p">(</span><span class="s2">&quot;order2&quot;</span><span class="p">,</span> <span class="s2">&quot;INDIFFERENT-TABLE&quot;</span><span class="p">,</span> <span class="mi">20</span><span class="p">),</span>
    <span class="p">]</span>
    <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">event_history</span><span class="p">:</span>
        <span class="n">messagebus</span><span class="o">.</span><span class="n">handle</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">uow</span><span class="p">)</span>
    <span class="p">[</span><span class="n">batch1</span><span class="p">,</span> <span class="n">batch2</span><span class="p">]</span> <span class="o">=</span> <span class="n">uow</span><span class="o">.</span><span class="n">products</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">sku</span><span class="o">=</span><span class="s2">&quot;INDIFFERENT-TABLE&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">batches</span>
    <span class="k">assert</span> <span class="n">batch1</span><span class="o">.</span><span class="n">available_quantity</span> <span class="o">==</span> <span class="mi">10</span>
    <span class="k">assert</span> <span class="n">batch2</span><span class="o">.</span><span class="n">available_quantity</span> <span class="o">==</span> <span class="mi">50</span>

    <span class="n">messagebus</span><span class="o">.</span><span class="n">handle</span><span class="p">(</span><span class="n">events</span><span class="o">.</span><span class="n">BatchQuantityChanged</span><span class="p">(</span><span class="s2">&quot;batch1&quot;</span><span class="p">,</span> <span class="mi">25</span><span class="p">),</span> <span class="n">uow</span><span class="p">)</span>

    <span class="c1"># assert on new events emitted rather than downstream side-effects</span>
    <span class="p">[</span><span class="n">reallocation_event</span><span class="p">]</span> <span class="o">=</span> <span class="n">uow</span><span class="o">.</span><span class="n">events_published</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">reallocation_event</span><span class="p">,</span> <span class="n">events</span><span class="o">.</span><span class="n">AllocationRequired</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">reallocation_event</span><span class="o">.</span><span class="n">orderid</span> <span class="ow">in</span> <span class="p">{</span><span class="s1">&#39;order1&#39;</span><span class="p">,</span> <span class="s1">&#39;order2&#39;</span><span class="p">}</span>
    <span class="k">assert</span> <span class="n">reallocation_event</span><span class="o">.</span><span class="n">sku</span> <span class="o">==</span> <span class="s1">&#39;INDIFFERENT-TABLE&#39;</span>
</pre></div></div></div>
</div></div>
<div class="paragraph"><p>Хотите вы этого или нет, зависит от сложности вашей цепочки событий. Мы говорим: начните с сквозного тестирования и прибегайте к нему только в случае необходимости.</p></div>
<div class="sidebarblock nobreakinside less_space">
<div class="content">
<div class="title">Упражнение для читателя</div>
<div class="paragraph"><p>Отличный способ заставить себя действительно понять какой-то код-это его рефакторинг. При обсуждении тестирования обработчиков в изоляции мы использовали нечто под названием <code>FakeUnitOfWorkWithFakeMessageBus</code>, что является излишне сложным и нарушает SRP.</p></div>
<div class="paragraph"><p>Если мы изменим шину сообщений на класс,<span class="footnote"><br />[«Простая» реализация в этой главе по существу использует сам модуль <em>messagebus.py</em> для реализации шаблона Singleton.]<br /></span> тогда создание <code>FakeMessageBus</code> будет более простым:</p></div>
<div class="exampleblock" id="abc_for_fake_messagebus">
<div class="title">Example 123. Абстрактная шина сообщений и ее реальные и поддельные версии</div>
<div class="content">
<div class="listingblock skip">
<div class="content"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">AbstractMessageBus</span><span class="p">:</span>
    <span class="n">HANDLERS</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Type</span><span class="p">[</span><span class="n">events</span><span class="o">.</span><span class="n">Event</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="n">Callable</span><span class="p">]]</span>

    <span class="k">def</span> <span class="nf">handle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="n">events</span><span class="o">.</span><span class="n">Event</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">handler</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">HANDLERS</span><span class="p">[</span><span class="nb">type</span><span class="p">(</span><span class="n">event</span><span class="p">)]:</span>
            <span class="n">handler</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">MessageBus</span><span class="p">(</span><span class="n">AbstractMessageBus</span><span class="p">):</span>
    <span class="n">HANDLERS</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">events</span><span class="o">.</span><span class="n">OutOfStock</span><span class="p">:</span> <span class="p">[</span><span class="n">send_out_of_stock_notification</span><span class="p">],</span>

    <span class="p">}</span>


<span class="k">class</span> <span class="nc">FakeMessageBus</span><span class="p">(</span><span class="n">messagebus</span><span class="o">.</span><span class="n">AbstractMessageBus</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">events_published</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># type: List[events.Event]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">HANDLERS</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">events</span><span class="o">.</span><span class="n">OutOfStock</span><span class="p">:</span> <span class="p">[</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">events_published</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">e</span><span class="p">)]</span>
        <span class="p">}</span>
</pre></div></div></div>
</div></div>
<div class="paragraph"><p>Так что сигайте в код на <a href="https://github.com/cosmicpython/code/tree/chapter_09_all_messagebus">GitHub</a> и посмотрите, сможете ли вы заставить работать версию на основе классов, а затем напишите версию <code>test_reallocates_if_needed_isolated ()</code> из более ранней версии.</p></div>
<div class="paragraph"><p>Мы используем шину сообщений на основе классов в <a href="#chapter_13_dependency_injection">[chapter_13_dependency_injection]</a>, если вам нужно больше вдохновения.</p></div>
</div></div>
</div>
<div class="sect2">
<h3 id="_подведём_итоги">Подведём итоги</h3>
<div class="paragraph"><p>Давайте оглянемся на то, чего мы достигли, и подумаем, "А нафига?".</p></div>
<div class="sect3">
<h4 id="_чего_мы_достигли">Чего мы достигли?</h4>
<div class="paragraph"><p>События (Events) - это простые классы данных, которые определяют структуры данных для входных данных.
        и внутренние сообщения в нашей системе. Это довольно мощно с точки зрения DDD, поскольку события часто очень хорошо переводятся на деловой язык
  (look up <em>event storming</em> if you haven&#8217;t already).</p></div>
<div class="paragraph"><p>Обработчики (Handlers) - это то, как мы реагируем на события. Они могут обратиться к нашей модели или обратиться к внешним службам. Мы можем определить несколько обработчиков для одного события, если захотим. Обработчики также могут вызывать другие события. Это позволяет нам быть очень детальными в отношении того, что делает обработчик, и действительно придерживаться SRP.</p></div>
</div>
<div class="sect3">
<h4 id="_почему_мы_достигли_цели">Почему мы достигли цели?</h4>
<div class="paragraph"><p>Наша основная цель в отношении этих структурных моделей заключается в том, чтобы
        сложность нашего приложения росла медленнее, чем его размер.  Когда мы идем ва-банк на шине сообщений, то как всегда, платим цену с точки зрения архитектурной сложности (См. <a href="#chapter_09_all_messagebus_tradeoffs">[chapter_09_all_messagebus_tradeoffs]</a>), но мы приобретаем себе паттерн, который может обрабатывать сколь угодно сложные требования, не нуждаясь в дальнейших концептуальных или архитектурных изменениях в том, как мы делаем вещи.</p></div>
<div class="paragraph"><p>Здесь мы добавили довольно сложный вариант использования (изменить количество, освободить место, начать новую транзакцию, перераспределить место, опубликовать внешнее уведомление), но в архитектурном плане сложность не требует затрат. Мы добавили новые события, новые обработчики и новый внешний адаптер (для электронной почты), все из которых являются существующими категориями объектов в нашей архитектуре, которые понятны нам  и это легко объяснимы новичкам.  Каждая из наших подвижных частей выполняет одну задачу, они четко связаны друг с другом, и нет никаких неожиданных побочных эффектов.</p></div>
<div class="tableblock" id="chapter_09_all_messagebus_tradeoffs">
<table rules="all"
width="100%"
frame="border"
cellspacing="0" cellpadding="4">
<caption class="title">Table 6. Все приложение - это шина сообщений: компромиссы</caption>
<col width="50%" />
<col width="50%" />
<thead>
<tr>
<th align="left" valign="top">Плюсы</th>
<th align="left" valign="top">Минусы</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left" valign="top"><div><div class="ulist"><ul>
<li>
<p>
Обработчики и сервисы - это одно и то же, так что все проще.
</p>
</li>
<li>
<p>
У нас есть великолепные структуры данных, чтобы ввести их в систему.
</p>
</li>
</ul></div></div></td>
<td align="left" valign="top"><div><div class="ulist"><ul>
<li>
<p>
Шина сообщений по-прежнему остается несколько непредсказуемым способом делать что-то с веб-точки зрения. Вы не знаете заранее, когда все закончится.
</p>
</li>
<li>
<p>
Будет происходить дублирование полей и структуры между объектами модели и событиями, что будет иметь затраты на техническое обслуживание. Добавление поля к одному обычно означает добавление поля по крайней мере к одному из других.
</p>
</li>
</ul></div></div></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p>Теперь вам может быть интересно, откуда берутся эти события <code>BatchQuantityChanged</code>? Ответ станет понятен через пару глав.  Но сначала давайте поговорим о событиях в сравнении с командами <a href="#chapter_10_commands">events versus commands</a>.</p></div>
</div>
</div>
</div>
</div>
</div>
<div id="footnotes"><hr /></div>
<div id="footer">
<div id="footer-text">
Last updated
 2021-02-21 21:50:45 RTZ 2 (зима)
</div>
</div>
</body>
</html>
